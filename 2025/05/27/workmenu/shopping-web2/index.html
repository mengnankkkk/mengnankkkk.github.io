<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>shopping-web项目八股分析 | mengnankkのblog</title><meta name="keywords" content="spring boot,java"><meta name="author" content="mengnankkzhou"><meta name="copyright" content="mengnankkzhou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="shopping-web项目八股分析"><meta name="application-name" content="shopping-web项目八股分析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="shopping-web项目八股分析"><meta property="og:url" content="https://blog.tokenlen.top/2025/05/27/workmenu/shopping-web2/index.html"><meta property="og:site_name" content="mengnankkのblog"><meta property="og:description" content="身份认证与权限校验使用令牌技术实现身份验证，用自定栏截器完成用户认证，并结合 ThreadLocal进行截器校验，保障系统安全访间。 基于Spring Boot + JWT的完整身份认证示例，包含：  JWT生成和解析工具类 认证拦截器（拦截请求验证JWT） ThreadLocal存储当前用户信息"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837601.jpeg?_r_=3d911e72-8ab7-c087-1c68-d635f2561984"><meta property="article:author" content="mengnankkzhou"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837601.jpeg?_r_=3d911e72-8ab7-c087-1c68-d635f2561984"><meta name="description" content="身份认证与权限校验使用令牌技术实现身份验证，用自定栏截器完成用户认证，并结合 ThreadLocal进行截器校验，保障系统安全访间。 基于Spring Boot + JWT的完整身份认证示例，包含：  JWT生成和解析工具类 认证拦截器（拦截请求验证JWT） ThreadLocal存储当前用户信息"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.tokenlen.top/2025/05/27/workmenu/shopping-web2/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走啊，那种事情不要啊","backTitle":"♪(^∇^*)欢迎回家！！！！"},
  LA51: undefined,
  greetingBox: {"enable":"ture","default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://comment.tokenlen.top/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"\tbd9428de12b54b96b2f1b4e69aeee81f","mailMd5":"F37442226DA71492"},
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: mengnankkzhou","link":"链接: ","source":"来源: mengnankkのblog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'mengnankkのblog',
  title: 'shopping-web项目八股分析',
  postAI: '',
  pageFillDescription: '身份认证与权限校验, 问题解析, 1.JWT的组成, 2.为什么要设置 exp以及如何处理过期？, 3.对称加密（HS256）与非对称加密（RS256）的区别？, 4.HandlerInterceptor 与 Filter 的区别？, 5.如何配置某些路径放行？, 6.Spring Boot 默认哪些静态资源路径？是否会被拦截？, 7.为什么要在 afterCompletion 清理 ThreadLocal？, 8.并发场景下 ThreadLocal 的适用与限制？, 9.如何安全地存储用户密码？, 10.为什么不要把敏感信息（如密码）放到 JWT 里？, 11.Token 在前端如何存储（localStorage vs HttpOnly Cookie）？, 1.你们的认证机制是怎么做的？为什么用 JWT？, 2.如何设计 Token 刷新机制？, 3.为什么使用 ThreadLocal？是否存在线程安全问题？, 4.为什么要使用两个拦截器？不能一个实现所有功能吗？, 5.Token 在前端如何存储？如何防止被盗用？, 6.为什么要使用 Access Token 和 Refresh Token 双 token？, 7.Refresh Token 要不要存 Redis？, 8.Refresh Token 过期后怎么办？, 9.如何防止 Refresh Token 被盗用？, 接口支档编写与测试, 1.Swagger 有什么作用？使用它有什么优势？, 2.Swagger 在 Spring Boot 项目中如何接入？, 3.Swagger 与 Postman 有何区别？, 4.如何通过 Swagger 实现接口 Mock？, 5.MOCK是啥, 八股回答, 1.优惠劵的超卖重复问题使用lua脚本保持原子性, 2.lua脚本执行异常, 3.使用 Redis+Lua 做原子操作时网络延迟对 CAS 操作的影响及如何保证并发原子性？, 4.在 校园餐饮系统 项目里你用 AOP 实现了操作日志自动记录讲讲 AOP 切点是怎么定义的怎么确保只拦截到需要记录日志的关键业务方法又不会过度拦截影响系统性能呀？, 5.在 校园餐饮系统 项目里你提到用了 Redis 存储 token 缓解压力能讲讲具体怎么设计 key 的结构以及如何保障 token 存储和读取的高效性与安全性不？, 6.那么优惠劵的发放呢？一些列的问题呢, 7.看你在优惠劵的发放的时候使用限流怎么设计的, 8.你项目里用了JWT加双 Token具体是怎么设计的？两个 Token 各自的作用是什么？拦截器又分别处理什么逻辑？比如有没有考虑过 Token 过期、刷新机制或者防重放攻击的问题？, 9.校园餐饮系统中用 Redis + Lua 脚本 解决支付与库存扣减一致性问题的回答, 10.为什么要用 ThreadLocal 保存用户信息？和直接传参或放到全局变量有什么区别？, 11.你限流是怎么做的？为什么选 Bucket4j？AOP 在这里起了什么作用？, 12.为什么发放优惠券要用 Lua 脚本？脚本中都做了哪些事？你如何保证幂等性和原子性？, 13.操作日志是怎么自动记录的？为什么要用 AOP 实现？, 14.你说用 Nginx 解决了跨域问题是怎么配置的？有没有考虑过 CORS 方案？, 15.CORS跨域问题身份认证与权限校验使用令牌技术实现身份验证用自定栏截器完成用户认证并结合进行截器校验保障系统安全访间基于的完整身份认证示例包含生成和解析工具类认证拦截器拦截请求验证存储当前用户信息配置拦截器注册简单的用户控制器示例问题解析的组成头部描述签名的元数据包含签名算法令牌的类型通常为编码作为一个片段存放业务数据和标准声明定义签发者主题受众过期时间签发时间用户自定义但要避免冲突双方约定的自定义字段如签名用再加上密钥通过指定算法如计算得到防止数据被篡改接收方用相同算法和密钥校验签名为什么要设置以及如何处理过期限制令牌的有效期降低泄露后滥用风险强制客户端定期获取新令牌有助于权限变更及时生效自动处理过期自动拒绝在解析时库如会抛出拦截器过滤器捕获后返回机制短时有效长期有效且存放更安全过期后客户端用向专门接口换取新的服务端黑名单对关键场景可在等存储过期或手动废弃的列表拦截时进一步比对对称加密与非对称加密的区别特性对称非对称密钥同一个密钥用于签名和校验使用私钥签名公钥校验安全性只要共享密钥不会泄露多服务时需安全分发密钥私钥只在签发端保存公钥可公开泄露风险低性能速度快运算相对慢一些应用场景小规模或单体应用部署简单分布式微服务或第三方验证场景私钥保护更好与的区别方面加载时机最早容器启动时配置位于之前在内部调用前后拦截接口职责通用请求预处理如日志跨域请求包装字符编码更贴近可以访问信息做方法级鉴权配置方式等实现注册方法如何配置某些路径放行比如我们让他不用登录就能看的一些页面商品展示等等在拦截器注册时通过拦截所有放行认证相关放行如果是可在内部判断请求或在中设置与默认哪些静态资源路径是否会被拦截默认路径下是否被拦截的拦截器默认只拦截但静态资源由处理优先级高于一般的调用如果在中使用了拦截所有且拦截匹配到静态资源路径就有可能拦截但通常我们会在或直接排除静态资源目录确保静态资源正常加载为什么要在清理存储的数据与当前线程绑定在高并发环境下使用线程池复用线程如果不手动清理后续请求可能读取到上一个用户的信息导致数据泄露或安全漏洞保证在请求处理完毕后无论正常或异常都能移除数据防止内存泄露或者是如果不清理的话因为是弱引用的很容易被清理其还有的键一直在那里呆着所以要使用清理或者是查找与当前线程关联的并将键值对设置为当前线程和是在中关闭并发场景下的适用与限制适用存放与当前请求当前线程强关联的数据如用户上下文事务避免在方法间频繁传参限制必须在请求结束后清理否则线程复用会导致上下文串库不能跨线程如异步执行线程池任务共享如果在子线程里尝试取数据需要显式传递或使用但要注意风险大量数据存放会增加内存压力或者是如果不清理的话因为是弱引用的很容易被清理其还有的键一直在那里呆着所以要使用清理或者是查找与当前线程关联的并将键值对设置为当前线程和是在中关闭如何安全地存储用户密码一定要哈希切忌明文存储使用强单向哈希算法推荐默认支持加盐每个用户使用独立随机盐防止彩虹表攻击适当迭代增加计算成本防止暴力破解为什么不要把敏感信息如密码放到里可被任意方解码不具备机密性即使签名防篡改也无法防止任何人读取其中的明文数据应只放必要的非敏感标识如敏感数据应在后台按需查询在前端如何存储存储方式优点缺点简单易用可直接读写易受攻击恶意脚本可读取并窃取无法读取能自动随请求带上防止需防范可配合双重提交最佳实践推荐将存在的中如果仍需在中访问可用短时写入但严格防同时配合令牌白名单内容安全策略等你们的认证机制是怎么做的为什么用前后端分离架构下使用无状态令牌用户登录后由服务端生成后续请求携带完成身份验证与传统相比不依赖服务端存储更适合分布式微服务场景签名机制可防止被伪造可携带等信息减少数据库查询如何设计刷新机制在拦截器中检查剩余有效时间当临近过期例如剩余分钟时自动生成新并通过响应头或返回提高用户体验避免频繁重新登录可配合强化安全性为什么使用是否存在线程安全问题将用户信息与线程绑定避免在每个方法中重复查询传参减少数据库压力在层可直接通过获取用户信息提升性能如从降到线程安全性保障每个线程有独立副本使用线程池时必须手动否则用户数据串用安全隐患限制必须在请求结束后清理否则线程复用会导致上下文串库不能跨线程如异步执行线程池任务共享如果在子线程里尝试取数据需要显式传递或使用但要注意风险大量数据存放会增加内存压力或者是如果不清理的话因为是弱引用的很容易被清理其还有的键一直在那里呆着所以要使用清理或者是查找与当前线程关联的并将键值对设置为当前线程和是在中关闭为什么要使用两个拦截器不能一个实现所有功能吗职责单一遵循单一职责原则代码更清晰可维护性更好一级负责认证二级负责续签分层逻辑解耦便于扩展和测试也方便后期引入更多层如角色校验日志记录等在前端如何存储如何防止被盗用推荐使用的存储防止脚本读取防结合属性防止攻击避免把存在中易被攻击读取可选使用双提升安全性为什么要使用和双短期有效暴露风险小保护用户无需频繁登录避免频繁验证数据库或提高性能配合双拦截器自动刷新增强用户体验要不要存建议存可主动登出注销可强制下线可限制一个用户只有一个有效提高安全性不应被频繁验证但一旦泄露影响很大过期后怎么办前端收到后无法再自动续签引导用户重新登录后端返回特定错误码区分与失效如何防止被盗用限制设备标识等加入黑名单机制建议设置存储防止接口支档编写与测试使用编写接口支档开发过程中进行接口联调测试提升开发效率是一套开放源代码项目用于生成描述调用和可视化风格服务的工具集主要包括提供一个交互式文档页面可以直接测试接口在线编辑规范文档根据文档生成客户端或服务端模板代码常见注解注解作用用于方法上描述接口作用用于方法参数上描述参数用于实体类字段上描述字段用于上分组描述描述请求体描述响应码与内容示例用户接口用户相关接口文档新增用户用户信息添加成功根据获取用户张三有什么作用使用它有什么优势可以自动生成接口文档支持接口调试提升前后端联调效率优势包括接口文档自动同步无需手写维护可视化交互式页面便于测试接口支持导出规范便于生成或接口在项目中如何接入使用依赖添加依赖后即可自动扫描注解的方法生成接口文档常用注解包括等与有何区别更适合开发阶段自动生成文档和接口调试更适合接口自动化测试团队共享测试集合压测脚本等两者可互补导出规范可导入执行如何通过实现接口本身不提供功能但可以通过提供在线使用配合工具如实现本地模拟返回固定数据用于前端调试是啥用于在真实对象不可用未完成或不方便调用时使用伪造的替代对象来模拟其行为本质使用假的对象或返回结果代替真实依赖或真实数据方便开发和测试性能与部署优化使用缓存热门菜品数据居应对高并发减少数据库访尚缩短接口响应时间配置作为日服务器外理静态资源赔部置反同代单及负的律提升系统稳定性与响应能力八股回答优惠劵的超卖重复问题使用脚本保持原子性使用脚本实现购买优惠券的原子性操作常用于防止并发问题比如超卖重复领取等是单线程的它执行脚本时会串行执行整个脚本内容所以可以用脚本在内部实现多个命令的原子执行避免并发问题场景需求用户未领取过优惠券库存扣减库存记录用户领取状态优惠券库存领取记录的存储库存领取记录用户判断是否领取过已领取获取库存库存不足扣减库存记录用户成功上面的脚本内容重复领取库存不足领取成功优惠券库存减关键是要防止超卖即多个请求同时扣库存导致数据错乱一种常见做法是使用乐观锁数据表中给优惠券记录加个版本号或更新时间戳更新库存时带上版本号或时间戳条件例如脚本执行异常提到脚本执行异常时因为库存字段不可见被拦截这里具体是指的权限问题还是脚本中对字段的引用方式有问题比如有没有检查过脚本里的是否和中存储的一致脚本执行超时脚本的执行是原子性的会阻塞实例如果脚本执行时间过长会导致其他客户端请求被阻塞甚至客户端连接超时有一个配置默认为秒超出这个时间脚本就会被终止保持脚本短小精悍脚本应该只包含最核心需要原子性执行的逻辑复杂的非原子性的业务逻辑应该在客户端侧完成避免昂贵的操作避免在脚本中执行等会遍历大量数据的命令如果确实需要处理大量数据考虑将大键拆分成小键或者在客户端分批处理增量处理如果必须在脚本中处理大量数据例如清理过期键考虑使用命令的变体进行增量迭代并将脚本设计为分批执行监控检查的看是否有或命令长时间执行使用做原子操作时网络延迟对操作的影响及如何保证并发原子性脚本在中执行是单线程原子性的只要你把逻辑写在脚本中整个脚本执行期间不会被其他命令打断因此从侧来看无论多少并发请求同时来脚本内的检查更新都是串行执行且原子完成网络延迟影响主要体现在客户端发送请求和接收结果的时延但不影响端脚本执行的原子性例如两个客户端几乎同时发送请求会顺序执行两个脚本避免数据竞争但网络延迟可能导致客户端感知延迟或重试保证多个并发请求下原子性的建议务必把校验库存和扣减库存的操作写到同一个脚本中保证原子执行避免客户端先读库存再决定是否写因读写分开易出现竞态条件可以结合的事务机制但比不上脚本原子性简单可靠另外设置合理超时和重试机制防止网络异常导致操作丢失在校园餐饮系统项目里你用实现了操作日志自动记录讲讲切点是怎么定义的怎么确保只拦截到需要记录日志的关键业务方法又不会过度拦截影响系统性能呀我们系统中使用了来统一记录用户的操作日志包括登录日志和业务行为日志整体设计思路是基于自定义注解切面编程策略模式来实现灵活可扩展的日志记录体系我们定义了一个自定义注解用于标记需要记录的操作方法注解中可以配置以下元信息登录日志业务日志操作行为描述如删除用户切面实现日志拦截逻辑获取方法签名与参数根据注解元信息决定日志类型执行方法并记录执行结果将日志对象封装后交由策略类处理日志记录策略设计策略模式记录用户登录成功失败时间等记录用户执行的业务操作如删除用户策略选择通过实现支持按日志类型动态扩展如何保证只拦截关键方法避免性能问题只对使用注解的方法进行拦截确保业务无关方法不被扫描避免性能浪费切面逻辑尽量精简只做元信息解析和日志上下文构建真正的日志落盘交给异步任务处理或消息队列对不需要记录的查询类接口不加注解完全绕过切面执行保障系统整体响应效率日志可选择输出到文件使用或存入数据库供后期审计特殊场景下如操作异常支持记录异常栈与执行耗时追问问和有什么区别为什么你选用答能拿到方法执行前后的控制权包括返回值和异常更适合记录执行结果和耗时问怎么处理日志失败落盘慢的问题答日志落盘可异步执行或通过异步解耦避免阻塞主流程在校园餐饮系统项目里你提到用了存储缓解压力能讲讲具体怎么设计的结构以及如何保障存储和读取的高效性与安全性不我们使用存储用户的以提升系统性能并减少数据库压力整体设计分为三部分设计存储结构安全机制结构设计这种格式能明确标识类型和所属用户保证唯一性和可读性避免冲突的存储结构我们使用的字符串结构或哈希结构存储取决于业务是否需要额外附加字段如生成时间设备信息设置合理的过期时间如天使用或命令控制生命周期的生成与安全性保障使用生成签名采用算法密钥保存在服务端配置中心或安全的中本身包含用户信息过期时间等生成后只将下发到前端则存于中服务端管理防止伪造认证流程登录时生成返回给前端存入为前端过期后携带请求刷新接口后端校验中的校验通过后重新生成新对提前防止问题防缓存穿透使用布隆过滤器记录有效用户或常见请求防止恶意请求频繁查询失败并打爆数据库防击穿为热点用户的设置合理避免同一时间大批用户同时失效防雪崩设置加入随机因子避免大批同时过期权限校验请求时验证是否属于当前防止越权操作那么优惠劵的发放呢一些列的问题呢一关于优惠券类型的常见问题如何区分和应用不同类型的优惠券逻辑面试点策略模式优惠金额计算方式答法我们用策略模式来封装每种优惠券的优惠逻辑如满减折扣无门槛每种类型对应一个策略类实现统一的接口方法这样能在运行时动态选择策略便于扩展和维护二关于接口设计的追问为什么接口是这样的有没有考虑幂等性和安全性接口可能会被重复调用是否幂等有没有做权限控制防止其他用户伪造请求答法在使用优惠券时为防止重复使用我们使用实现原子操作同时标记优惠券为已使用此外接口采用登录态校验验证当前操作用户是否拥有该优惠券敏感操作都要求用户登录并记录操作日志三关于并发处理和限领逻辑如果多用户并发领取优惠券如何防止超发答法发放流程中我们使用的或脚本实现优惠券库存的原子扣减保证不会发放超过设定数量同时加锁防止并发条件下库存扣减不一致如何限制每个用户只能领取一次答法中设置一个标识键发放前先判断这个键是否存在避免重复发放也可以结合布隆过滤器提前过滤无效请求四关于时间与状态校验限时券怎么判断是否有效服务端怎么处理时间逻辑答法每张优惠券记录中保存有效时间范围使用时服务端比对当前时间是否在有效期内同时定时任务每天扫描过期优惠券标记为已过期五关于优惠券使用过程的逻辑判断使用时如果有多个优惠券怎么选最优答法前端可以请求一个推荐最优券的接口我们在服务端遍历用户可用券调用各个策略类计算预期优惠返回最高优惠金额对应的券六关于优惠券与订单系统结合问题如果下单失败了优惠券是否要恢复答法下单失败如支付失败库存不足时我们会在事务回滚后将优惠券状态重置为未使用为了避免并发问题使用分布式事务如消息队列或回滚标记七进阶设计问题优惠券支持异步发放和定时生效吗答法是的可以结合定时任务如或实现定时发放发放时间和有效时间字段分离发放时写入延时队列当生效时间到达时插入到用户优惠券表中八可能让你设计代码结构的问题优惠券模块的结构划分是怎样的答法示意接口及实现金额计算工具类九安全性问题用户伪造优惠券试图套用别人的优惠券怎么办答法每次使用时不仅要校验优惠券是否存在还要校验当前登录用户是否是该优惠券持有人只有归属校验通过才能使用看你在优惠劵的发放的时候使用限流怎么设计的我们在优惠券领取接口中用令牌桶实现限流注解定义注解标注需要限流的方法参数包括每分钟次时间单位分钟按用户限流切面实现通过切面拦截注解方法获取参数后生成唯一限流例如然后调用令牌桶服务校验令牌桶用脚本实现原子性校验核心是根据时间戳计算可生成的新令牌数不足时拒绝请求比如用户抢优惠券时同一每分钟最多次请求防止恶意刷接口防重复领取避免用户短时间内多次点击接口导致优惠券超发保护服务端峰值流量时限制请求频率防止或数据库被击穿线上遇到过同一下多个用户被误限的情况后来把改为用户减少了误判率切面类如何获取注解获取方法上的注解生成限流用户调用令牌桶校验请求频繁请稍后再试为什么选令牌桶而不是漏桶令牌桶适合突发流量漏桶适合平滑流量使用原子的存储令牌桶使用时间戳来校验令牌桶脚本简化版限流桶容量令牌生成速率个秒当前时间戳请求令牌数读取上次更新时间和剩余令牌数计算可生成的新令牌数够发令牌更新状态允许访问拒绝访问你项目里用了加双具体是怎么设计的两个各自的作用是什么拦截器又分别处理什么逻辑比如有没有考虑过过期刷新机制或者防重放攻击的问题天有效期放在请求头用于日常接口认证用加密密钥服务端持有放在前端的天有效期存在值是随机字符串且绑定用户防止盗用放在中安全措施说明使用防止中间人劫持只读使用加密防篡改存结合用户存储支持设置有效控制生命周期黑名单机制登出用户退出登录时可删除中立即失效防止多端同时登录可使用为限制单个登录会话刷新接口限流防止被滥用加防重放限频刷新重发保护设置短期使用标记防止并发重复刷新退出策略用户点击退出删除中的或设置为无效标记因为是不可被撤销可考虑实现黑名单机制例如中维护一张黑名单黑名单适用于高安全场景如后台管理系统但会略增加接口访问时的查询压力拦截器认证拦截器先检查请求头是否有没有就返回有则解析校验用户信息是否存在第一个拦截器先校验请求头是否有没有的话直接返回第二个拦截器在有效时额外检查是否快过期比如剩余时间分钟如果是就用去换全新的和这里要注意刷新时的原子性避免并发问题刷新拦截器如果剩余有效期分钟就用请求头中的去校验校验通过的话生成新的和新会覆盖中的旧值保证单设备登录校验失败的话直接让用户重新登录危险前端或攻击者拿到密钥如部署泄露浏览器调试泄露就可以伪造合法内容是可解密的攻击者可猜测或修改然后重新签名如果服务端未验证签名有些误用场景会只解析不校验更容易被利用但还是更快计算算开销低对称密钥管理更简单适用于内部系统或中小型项目开发成本更低不涉及证书管理公私钥分发措施说明使用强密钥至少的复杂密钥不可硬编码进前端或代码中启用防止被中间人劫持签名校验每次都校验的签名防止伪造缩短有效期缩小攻击窗口存结合用户防重放防伪造黑名单机制登出清除登出时使无效检查等指纹防止被别人拿去复用校园餐饮系统中用脚本解决支付与库存扣减一致性问题的回答扣减库存商品服务扣除余额或生成支付单支付服务创建订单记录订单服务我们在库存服务中使用了脚本来实现本地原子扣减库存用户去重校验以解决高并发下的库存超卖问题为什么使用脚本因为本身是单线程的脚本在内部执行时具备原子性整个脚本要么全部成功要么全部失败回滚我们把两个关键操作封装为一体执行检查库存是否充足判断用户是否已领取防止重复操作若都满足原子扣减库存并记录领取状态脚本大致逻辑如下伪代码库存不足已领取过扣减成功该方式解决的是单点库存系统下的原子性问题但它本身不等同于分布式事务用来防止支付成功脚本执行失败用户实际支付了但库存未扣数据不一致但若中间失败就可能导致与数据不一致我们改进方式为对写数据库后的数据变化通过或投递通知更新或者在数据变更时先删除缓存模式由下次读时自动加载新数据加入失败重试机制确保最终一致性为什么要用保存用户信息和直接传参或放到全局变量有什么区别我们将登录成功后的用户信息如权限解析出来并存入这样做可以避免频繁从数据库或获取用户信息在整个线程生命周期内一次请求任何地方都可以通过拿到用户信息避免层层传参比如日志记录数据权限控制业务层注入当前用户等场景都能简化处理和全局变量的区别是保证每个线程有独立副本不会产生线程安全问题你限流是怎么做的为什么选在这里起了什么作用我们使用的是基于的注解式限流方案自定义注解在需要限流的接口上标记使用拦截该注解方法提取用户标识或用户请求路径作为限流在拦截逻辑中使用构建令牌桶对该做分布式限流为什么选支持多种限流算法令牌桶漏桶支持等分布式存储语义丰富可设置恢复速率最大突发数等参数优点分布式环境可用多实例共享限流状态实现接入方便解耦代码为什么发放优惠券要用脚本脚本中都做了哪些事你如何保证幂等性和原子性脚本用于中实现发券逻辑是为了保证整个操作的原子性避免并发发放导致超卖脚本逻辑主要包含检查库存是否大于判断当前用户是否已领取若未领取库存充足则减库存标记用户已领取返回发放成功这些步骤在脚本中一次性执行具备原子性防止线程交错出现并发漏洞为保证幂等性我们用的操作或判重集合避免重复领取操作日志是怎么自动记录的为什么要用实现我们使用注解方式自动记录用户操作行为无需每个业务手动写日志自定义注解下单操作通过拦截这些方法自动记录用户从拿地址请求时间执行耗时方法名称操作模块请求参数和响应结果可脱敏优势解耦业务逻辑和日志收集可灵活扩展如写入数据库配合登录拦截器还能自动记录登录时间等行为你说用解决了跨域问题是怎么配置的有没有考虑过方案我们通过配置反向代理将前端请求转发至后端服务并统一处理跨域这样前端调用时相当于同源请求避免了浏览器警告当然在开发环境我们也启用了的配置用于本地调试跨域请求生产环境由完成统一处理跨域问题一个页面发起的请求只能是与当前页域名相同的路径这能有效的阻止跨站攻击因此跨域问题是针对的一种限制跨域浏览器对于的同源策略的限制下面几种情况都属于跨域域名不同与端口不同与二级域名不同与和也属于跨域是一个标准全称是跨域资源共享它允许浏览器向跨源服务器发出请求从而克服了只能同源使用的限制需要浏览器和服务器同时支持目前所有浏览器都支持该功能浏览器不能低于实现在网关中编写一个配置类并且注册已经帮我们写好了的跨域过滤器内部已经实现了刚才所讲的判定逻辑我们直接用就好了服务端可以通过拦截器统一实现不必每次都去进行跨域判定的编写在网关中创建一个的跨域访问过滤器类添加配置信息允许的域不要写否则就无法使用了是否发送信息允许的请求方式允许的头信息添加映射路径我们拦截一切请求返回新的',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-06-25 21:39:11',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/rss2.xml" title="mengnankkのblog" type="application/rss+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">mengnankkのblog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://imgbed.mengnankk.asia/202407021650088.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imgbed.mengnankk.asia/202407021650088.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 1.05rem;">BF<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 1.05rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 1.05rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 1.05rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 1.05rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 1.05rem;">FI<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 1.05rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>12</sup></a><a href="/tags/Nginx/" style="font-size: 1.05rem;">Nginx<sup>1</sup></a><a href="/tags/XSS/" style="font-size: 1.05rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>2</sup></a><a href="/tags/docker/" style="font-size: 1.05rem;">docker<sup>1</sup></a><a href="/tags/football/" style="font-size: 1.05rem;">football<sup>1</sup></a><a href="/tags/git/" style="font-size: 1.05rem;">git<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>52</sup></a><a href="/tags/juc/" style="font-size: 1.05rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 1.05rem;">jvm<sup>2</sup></a><a href="/tags/leetcode/" style="font-size: 1.05rem;">leetcode<sup>8</sup></a><a href="/tags/mysql/" style="font-size: 1.05rem;">mysql<sup>16</sup></a><a href="/tags/net/" style="font-size: 1.05rem;">net<sup>6</sup></a><a href="/tags/php/" style="font-size: 1.05rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 1.05rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 1.05rem;">python<sup>3</sup></a><a href="/tags/redis/" style="font-size: 1.05rem;">redis<sup>3</sup></a><a href="/tags/rocketmq/" style="font-size: 1.05rem;">rocketmq<sup>2</sup></a><a href="/tags/shell/" style="font-size: 1.05rem;">shell<sup>4</sup></a><a href="/tags/spring/" style="font-size: 1.05rem;">spring<sup>2</sup></a><a href="/tags/spring-boot/" style="font-size: 1.05rem;">spring boot<sup>14</sup></a><a href="/tags/sql/" style="font-size: 1.05rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>3</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 1.05rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 1.05rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>18</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 1.05rem;">正则表达式<sup>2</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 1.05rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>9</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 1.05rem;">面试<sup>15</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">22</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/" itemprop="url">java</a><i class="anzhiyufont anzhiyu-icon-angle-right post-meta-separator"></i><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/%E9%A1%B9%E7%9B%AE/" itemprop="url">项目</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/spring-boot/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>spring boot</span></a><a class="article-meta__tags" href="/tags/java/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>java</span></a></span></div></div><h1 class="post-title" itemprop="name headline">shopping-web项目八股分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-05-26T16:00:00.000Z" title="发表于 2025-05-27 00:00:00">2025-05-27</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-06-25T13:39:11.699Z" title="更新于 2025-06-25 21:39:11">2025-06-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">9.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>33分钟</span></span><span class="post-meta-separator"></span><span id="" data-flag-title="shopping-web项目八股分析"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为济南"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>济南</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837601.jpeg?_r_=3d911e72-8ab7-c087-1c68-d635f2561984"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.tokenlen.top/2025/05/27/workmenu/shopping-web2/"><header><a class="post-meta-categories" href="/categories/java/" itemprop="url">java</a><a class="post-meta-categories" href="/categories/java/%E9%A1%B9%E7%9B%AE/" itemprop="url">项目</a><a href="/tags/spring-boot/" tabindex="-1" itemprop="url">spring boot</a><a href="/tags/java/" tabindex="-1" itemprop="url">java</a><h1 id="CrawlerTitle" itemprop="name headline">shopping-web项目八股分析</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">mengnankkzhou</span><time itemprop="dateCreated datePublished" datetime="2025-05-26T16:00:00.000Z" title="发表于 2025-05-27 00:00:00">2025-05-27</time><time itemprop="dateCreated datePublished" datetime="2025-06-25T13:39:11.699Z" title="更新于 2025-06-25 21:39:11">2025-06-25</time></header><h1 id="身份认证与权限校验"><a href="#身份认证与权限校验" class="headerlink" title="身份认证与权限校验"></a>身份认证与权限校验</h1><p>使用令牌技术实现身份验证，用自定栏截器完成用户认证，并结合 ThreadLocal进行截器校验，保障系统安全访间。</p>
<p><strong>基于Spring Boot + JWT的完整身份认证示例</strong>，包含：</p>
<ul>
<li>JWT生成和解析工具类</li>
<li>认证拦截器（拦截请求验证JWT）</li>
<li>ThreadLocal存储当前用户信息</li>
<li>配置拦截器注册</li>
<li>简单的用户控制器示例</li>
</ul>
<h3 id="问题解析"><a href="#问题解析" class="headerlink" title="问题解析"></a>问题解析</h3><h4 id="1-JWT的组成"><a href="#1-JWT的组成" class="headerlink" title="1.JWT的组成"></a>1.JWT的组成</h4><p>Header（头部）:描述签名的元数据，包含alg(签名算法) HS256，RS256,typ(令牌的类型)通常为JWT，base64URL编码作为一个片段</p>
<p>Payload：存放业务数据和标准声明（Claims），</p>
<p><strong>RFC定义</strong>：<code>iss</code>（签发者）、<code>sub</code>（主题）、<code>aud</code>（受众）、<code>exp</code>（过期时间）、<code>iat</code>（签发时间）</p>
<p><strong>Public Claims</strong>：用户自定义，但要避免冲突</p>
<p><strong>Private Claims</strong>：双方约定的自定义字段（如 <code>userId</code>、<code>roles</code>）</p>
<p>Signature（签名）：</p>
<p>用 <code>Base64Url(Header) + &quot;.&quot; + Base64Url(Payload)</code>，再加上密钥，通过指定算法（如 HMAC SHA256）计算得到。</p>
<p>防止数据被篡改：接收方用<strong>相同算法和密钥校验签名</strong>。</p>
<h4 id="2-为什么要设置-exp，以及如何处理过期？"><a href="#2-为什么要设置-exp，以及如何处理过期？" class="headerlink" title="2.为什么要设置 exp，以及如何处理过期？"></a>2.为什么要设置 <code>exp</code>，以及如何处理过期？</h4><p>限制令牌的有效期，降低泄露后滥用风险，强制客户端<strong>定期获取新令牌</strong>，有助于权限变更及时生效。</p>
<p>自动处理过期：</p>
<p><strong>自动拒绝</strong>：在解析 JWT 时，库（如 jjwt）会抛出 <code>ExpiredJwtException</code>，拦截器／过滤器捕获后返回 <code>401 Unauthorized</code>。</p>
<p><strong>Refresh Token</strong> 机制：</p>
<p>Access Token（短时有效）+ Refresh Token（长期有效且存放更安全）</p>
<p>Access Token 过期后，客户端用 Refresh Token 向专门接口换取新的 Access Token。</p>
<p><strong>服务端黑名单</strong>：对关键场景，可在 Redis 等存储过期或手动废弃的 Token ID 列表，拦截时进一步比对。</p>
<h3 id="3-对称加密（HS256）与非对称加密（RS256）的区别？"><a href="#3-对称加密（HS256）与非对称加密（RS256）的区别？" class="headerlink" title="3.对称加密（HS256）与非对称加密（RS256）的区别？"></a>3.对称加密（HS256）与非对称加密（RS256）的区别？</h3><div class="table-container">
<table>
<thead>
<tr>
<th>特性</th>
<th>HS256（对称）</th>
<th>RS256（非对称）</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>密钥</strong></td>
<td>同一个密钥用于签名和校验</td>
<td>使用私钥签名，公钥校验</td>
</tr>
<tr>
<td><strong>安全性</strong></td>
<td>只要共享密钥不会泄露；多服务时需安全分发密钥</td>
<td>私钥只在签发端保存，公钥可公开，泄露风险低</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>HMAC 速度快</td>
<td>RSA 运算相对慢一些</td>
</tr>
<tr>
<td><strong>应用场景</strong></td>
<td>小规模或单体应用，部署简单</td>
<td>分布式/微服务或第三方验证场景，私钥保护更好</td>
</tr>
</tbody>
</table>
</div>
<h3 id="4-HandlerInterceptor-与-Filter-的区别？"><a href="#4-HandlerInterceptor-与-Filter-的区别？" class="headerlink" title="4.HandlerInterceptor 与 Filter 的区别？"></a>4.<code>HandlerInterceptor</code> 与 <code>Filter</code> 的区别？</h3><div class="table-container">
<table>
<thead>
<tr>
<th>方面</th>
<th>Filter</th>
<th>HandlerInterceptor</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>加载时机</strong></td>
<td>最早，Servlet 容器启动时配置，位于 Spring MVC 之前</td>
<td>在 Spring MVC 内部，Controller 调用前后拦截</td>
</tr>
<tr>
<td><strong>接口</strong></td>
<td><code>javax.servlet.Filter</code></td>
<td><code>org.springframework.web.servlet.HandlerInterceptor</code></td>
</tr>
<tr>
<td><strong>职责</strong></td>
<td>通用请求预处理：如日志、跨域、请求包装、字符编码</td>
<td>更贴近 MVC：可以访问 Handler（Controller）信息，做方法级鉴权</td>
</tr>
<tr>
<td><strong>配置方式</strong></td>
<td><code>@WebFilter</code>、<code>FilterRegistrationBean</code> 等</td>
<td>实现 <code>WebMvcConfigurer#addInterceptors</code> 注册</td>
</tr>
<tr>
<td><strong>方法</strong></td>
<td><code>doFilter</code></td>
<td><code>preHandle</code>、<code>postHandle</code>、<code>afterCompletion</code></td>
</tr>
</tbody>
</table>
</div>
<h3 id="5-如何配置某些路径放行？"><a href="#5-如何配置某些路径放行？" class="headerlink" title="5.如何配置某些路径放行？"></a>5.如何配置某些路径放行？</h3><p>比如我们让他不用登录就能看的一些页面，商品展示等等</p>
<p>在 Spring MVC 拦截器注册时，通过 <code>excludePathPatterns(...)</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">registry.addInterceptor(jwtInterceptor)</span><br><span class="line">        .addPathPatterns(<span class="string">&quot;/api/**&quot;</span>)           <span class="comment">// 拦截所有 /api/**</span></span><br><span class="line">        .excludePathPatterns(</span><br><span class="line">            <span class="string">&quot;/api/auth/**&quot;</span>,                  <span class="comment">// 放行认证相关</span></span><br><span class="line">            <span class="string">&quot;/swagger-ui/**&quot;</span>, <span class="string">&quot;/v3/api-docs&quot;</span>  <span class="comment">// 放行 Swagger</span></span><br><span class="line">        );</span><br></pre></td></tr></table></figure>
<p>如果是 Filter，可在内部判断请求 URI，或在 <code>FilterRegistrationBean</code> 中设置 <code>setUrlPatterns</code> 与 <code>setOrder</code>。</p>
<h3 id="6-Spring-Boot-默认哪些静态资源路径？是否会被拦截？"><a href="#6-Spring-Boot-默认哪些静态资源路径？是否会被拦截？" class="headerlink" title="6.Spring Boot 默认哪些静态资源路径？是否会被拦截？"></a>6.Spring Boot 默认哪些静态资源路径？是否会被拦截？</h3><ul>
<li><strong>默认路径（classpath 下）</strong><ul>
<li><code>/static</code></li>
<li><code>/public</code></li>
<li><code>/resources</code></li>
<li><code>/META-INF/resources</code></li>
</ul>
</li>
<li><strong>是否被拦截？</strong><ul>
<li>Spring MVC 的拦截器默认只拦截 <code>/**</code>，但静态资源由 <code>ResourceHttpRequestHandler</code> 处理，优先级高于一般的 Controller 调用。</li>
<li><strong>如果</strong>在 <code>addInterceptors</code> 中使用了拦截所有 <code>/**</code>，且拦截匹配到静态资源路径，就有可能拦截；但通常我们会在 <code>excludePathPatterns(&quot;/**/*.js&quot;, &quot;/**/*.css&quot;, &quot;/**/*.png&quot;, ...&quot;)</code> 或直接排除静态资源目录，确保静态资源正常加载。</li>
</ul>
</li>
</ul>
<h3 id="7-为什么要在-afterCompletion-清理-ThreadLocal？"><a href="#7-为什么要在-afterCompletion-清理-ThreadLocal？" class="headerlink" title="7.为什么要在 afterCompletion 清理 ThreadLocal？"></a>7.为什么要在 <code>afterCompletion</code> 清理 <code>ThreadLocal</code>？</h3><p><code>ThreadLocal</code> 存储的数据与当前线程绑定。</p>
<p>在高并发环境下，使用线程池复用线程，如果不手动清理，后续请求可能读取到上一个用户的信息，导致<strong>数据泄露</strong>或<strong>安全漏洞</strong>。</p>
<p><code>afterCompletion</code> 保证在请求处理完毕后无论正常或异常，都能移除数据，防止内存泄露。</p>
<p>或者是如果不清理的话，因为是弱引用，ThreadLocal的key很容易被清理，其还有null的键，一直在那里呆着。所以要使用remove清理或者是，查找与当前线程关联的Map并将键值对设置为当前线程和null，Huoz是在finally中关闭ThreadLocal。</p>
<h3 id="8-并发场景下-ThreadLocal-的适用与限制？"><a href="#8-并发场景下-ThreadLocal-的适用与限制？" class="headerlink" title="8.并发场景下 ThreadLocal 的适用与限制？"></a>8.并发场景下 <code>ThreadLocal</code> 的适用与限制？</h3><p><strong>适用</strong>：</p>
<ul>
<li>存放与当前请求、当前<strong>线程强关联的数据</strong>（如用户上下文、事务 ID）</li>
<li>避免在方法间频繁传参</li>
</ul>
<p><strong>限制</strong>：</p>
<ul>
<li>必须在请求<strong>结束后清理</strong>，否则线程复用会导致“上下文串库”</li>
<li>不能跨线程（如异步执行、线程池任务）共享；如果在子线程里尝试取数据，需要显式传递或使用 <code>InheritableThreadLocal</code>（但要注意 GC 风险）</li>
<li>大量数据存放会增加内存压力</li>
</ul>
<p>或者是如果不清理的话，因为是弱引用，ThreadLocal的key很容易被清理，其还有null的键，一直在那里呆着。所以要使用remove清理或者是，查找与当前线程关联的Map并将键值对设置为当前线程和null，Huoz是在finally中关闭ThreadLocal。</p>
<h3 id="9-如何安全地存储用户密码？"><a href="#9-如何安全地存储用户密码？" class="headerlink" title="9.如何安全地存储用户密码？"></a>9.如何安全地存储用户密码？</h3><p><strong>一定要哈希</strong>，切忌明文存储。</p>
<p><strong>使用强单向哈希算法</strong>，推荐：</p>
<ul>
<li>BCrypt（Spring Security 默认支持）</li>
<li>Argon2、PBKDF2</li>
</ul>
<p><strong>加盐</strong>：每个用户使用<strong>独立随机盐</strong>，防止彩虹表攻击。</p>
<p><strong>适当迭代</strong>：增加计算成本，防止暴力破解。</p>
<h3 id="10-为什么不要把敏感信息（如密码）放到-JWT-里？"><a href="#10-为什么不要把敏感信息（如密码）放到-JWT-里？" class="headerlink" title="10.为什么不要把敏感信息（如密码）放到 JWT 里？"></a>10.为什么不要把敏感信息（如密码）放到 JWT 里？</h3><p><strong>JWT Payload 可被任意方 Base64Url 解码</strong>，不具备机密性。</p>
<p>即使<strong>签名防篡改</strong>，也无法防止任何人读取其中的明文数据。</p>
<p>应只放必要的非敏感标识（如 <code>userId</code>、<code>roles</code>），<strong>敏感数据应在后台按需查询</strong>。</p>
<h3 id="11-Token-在前端如何存储（localStorage-vs-HttpOnly-Cookie）？"><a href="#11-Token-在前端如何存储（localStorage-vs-HttpOnly-Cookie）？" class="headerlink" title="11.Token 在前端如何存储（localStorage vs HttpOnly Cookie）？"></a>11.Token 在前端如何存储（localStorage vs HttpOnly Cookie）？</h3><div class="table-container">
<table>
<thead>
<tr>
<th>存储方式</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>localStorage</strong></td>
<td>简单易用，JS 可直接读写</td>
<td>易受 XSS 攻击：恶意脚本可读取并窃取 Token</td>
</tr>
<tr>
<td><strong>HttpOnly Cookie</strong></td>
<td>JS 无法读取，能自动随请求带上，防止 XSS</td>
<td>需防范 CSRF（可配合 SameSite、双重提交 Cookie）</td>
</tr>
</tbody>
</table>
</div>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>推荐将 <strong>Access Token</strong> 存在 <strong>HttpOnly</strong>、Secure、SameSite=strict 的 Cookie 中；</li>
<li>如果仍需在 JS 中访问，可用 Refresh Token 短时写入 <code>localStorage</code>，但严格防 XSS。</li>
<li>同时配合 CSRF 令牌、CORS 白名单、内容安全策略（CSP）等。</li>
</ul>
<h3 id="1-你们的认证机制是怎么做的？为什么用-JWT？"><a href="#1-你们的认证机制是怎么做的？为什么用-JWT？" class="headerlink" title="1.你们的认证机制是怎么做的？为什么用 JWT？"></a>1.<strong>你们的认证机制是怎么做的？为什么用 JWT？</strong></h3><p>前后端分离架构下使用 <strong>JWT 无状态令牌</strong>，用户登录后由服务端生成 Token，后续请求携带 Token 完成身份验证</p>
<p>与传统 Session 相比，JWT 不依赖服务端存储，<strong>更适合分布式微服务场景</strong></p>
<p>签名机制可防止 Token 被伪造，Payload 可携带 <code>userId</code> 等信息减少数据库查询</p>
<h3 id="2-如何设计-Token-刷新机制？"><a href="#2-如何设计-Token-刷新机制？" class="headerlink" title="2.如何设计 Token 刷新机制？"></a>2.如何设计 Token 刷新机制？</h3><p>在拦截器中检查 Token 剩余有效时间</p>
<p>当 Token 临近过期（例如剩余 &lt;5 分钟）时，<strong>自动生成新 Token 并通过响应头或 Cookie 返回</strong></p>
<p>提高用户体验，避免频繁重新登录</p>
<p>可配合 Refresh Token 强化安全性</p>
<h3 id="3-为什么使用-ThreadLocal？是否存在线程安全问题？"><a href="#3-为什么使用-ThreadLocal？是否存在线程安全问题？" class="headerlink" title="3.为什么使用 ThreadLocal？是否存在线程安全问题？"></a>3.为什么使用 ThreadLocal？是否存在线程安全问题？</h3><p>ThreadLocal 将<strong>用户信息与线程</strong>绑定，避免在每个方法中重复查询、传参，减少数据库/Redis 压力</p>
<p>在 Controller 层可直接通过 <code>UserHolder.get()</code> 获取用户信息，提升性能（如从 200ms 降到 20ms）</p>
<p><strong>线程安全性保障</strong>：</p>
<ul>
<li>每个线程有独立副本</li>
<li>使用线程池时必须手动 <code>remove()</code>，否则用户数据串用 → 安全隐患</li>
</ul>
<p><strong>限制</strong>：</p>
<ul>
<li>必须在请求<strong>结束后清理</strong>，否则线程复用会导致“上下文串库”</li>
<li>不能跨线程（如异步执行、线程池任务）共享；如果在子线程里尝试取数据，需要显式传递或使用 <code>InheritableThreadLocal</code>（但要注意 GC 风险）</li>
<li>大量数据存放会增加内存压力</li>
</ul>
<p>或者是如果不清理的话，因为是弱引用，ThreadLocal的key很容易被清理，其还有null的键，一直在那里呆着。所以要使用remove清理或者是，查找与当前线程关联的Map并将键值对设置为当前线程和null，Huoz是在finally中关闭ThreadLocal。</p>
<h3 id="4-为什么要使用两个拦截器？不能一个实现所有功能吗？"><a href="#4-为什么要使用两个拦截器？不能一个实现所有功能吗？" class="headerlink" title="4.为什么要使用两个拦截器？不能一个实现所有功能吗？"></a>4.<strong>为什么要使用两个拦截器？不能一个实现所有功能吗？</strong></h3><p>职责单一，遵循 <strong>单一职责原则</strong>，代码更清晰、可维护性更好</p>
<p>一级负责认证，二级负责续签，分层逻辑解耦，便于扩展和测试</p>
<p>也方便后期引入更多层（如角色校验、日志记录等）</p>
<h3 id="5-Token-在前端如何存储？如何防止被盗用？"><a href="#5-Token-在前端如何存储？如何防止被盗用？" class="headerlink" title="5.Token 在前端如何存储？如何防止被盗用？"></a>5.Token 在前端如何存储？如何防止被盗用？</h3><p>推荐使用 <strong>HttpOnly + Secure 的 Cookie 存储 Token</strong>，防止 JS 脚本读取（防 XSS）</p>
<p>结合 <code>SameSite=Strict</code> 属性防止 CSRF 攻击</p>
<p>避免把 Token 存在 localStorage 中，localStorage 易被 XSS 攻击读取</p>
<p>可选使用双 Token：Access Token + Refresh Token，提升安全性</p>
<h3 id="6-为什么要使用-Access-Token-和-Refresh-Token-双-token？"><a href="#6-为什么要使用-Access-Token-和-Refresh-Token-双-token？" class="headerlink" title="6.为什么要使用 Access Token 和 Refresh Token 双 token？"></a>6.为什么要使用 Access Token 和 Refresh Token 双 token？</h3><p>Access Token 短期有效，暴露风险小；</p>
<p>Refresh Token 保护用户无需频繁登录；</p>
<p>避免频繁验证数据库或 Redis，提高性能；</p>
<p>配合双拦截器自动刷新，增强用户体验。</p>
<h3 id="7-Refresh-Token-要不要存-Redis？"><a href="#7-Refresh-Token-要不要存-Redis？" class="headerlink" title="7.Refresh Token 要不要存 Redis？"></a>7.<strong>Refresh Token 要不要存 Redis？</strong></h3><p>建议存 Redis：</p>
<ul>
<li>可主动登出/注销 refresh token；</li>
<li>可强制下线；</li>
<li>可限制一个用户只有一个有效 refresh token；</li>
<li>提高安全性（Refresh Token 不应被频繁验证，但一旦泄露影响很大）。</li>
</ul>
<h3 id="8-Refresh-Token-过期后怎么办？"><a href="#8-Refresh-Token-过期后怎么办？" class="headerlink" title="8.Refresh Token 过期后怎么办？"></a>8.Refresh Token 过期后怎么办？</h3><p>前端收到 401 后无法再自动续签；</p>
<p>引导用户重新登录；</p>
<p>后端返回特定错误码区分 access 与 refresh 失效。</p>
<h3 id="9-如何防止-Refresh-Token-被盗用？"><a href="#9-如何防止-Refresh-Token-被盗用？" class="headerlink" title="9.如何防止 Refresh Token 被盗用？"></a>9.如何防止 Refresh Token 被盗用？</h3><p>限制 IP、设备标识（User-Agent）等；</p>
<p>加入 Redis 黑名单机制；</p>
<p>建议设置 HttpOnly Cookie 存储 refresh token，防止 XSS；</p>
<h1 id="接口支档编写与测试"><a href="#接口支档编写与测试" class="headerlink" title="接口支档编写与测试"></a>接口支档编写与测试</h1><p>使用Swagger编写接口支档，开发过程中进行接口联调测试提升开发效率</p>
<p>Swagger 是一套 <strong>开放源代码项目</strong>，用于生成、描述、调用和可视化 RESTful 风格 Web 服务的工具集。主要包括：</p>
<ul>
<li>Swagger UI：提供一个交互式文档页面，可以直接测试接口。</li>
<li>Swagger Editor：在线编辑 OpenAPI 规范文档。</li>
<li>Swagger Codegen：根据文档生成客户端 SDK 或服务端模板代码。</li>
</ul>
<p>常见注解：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>注解</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@Operation(summary = &quot;...&quot;)</code></td>
<td>用于方法上，描述接口作用</td>
</tr>
<tr>
<td><code>@Parameter(name = &quot;...&quot;)</code></td>
<td>用于方法参数上，描述参数</td>
</tr>
<tr>
<td><code>@Schema(description = &quot;...&quot;)</code></td>
<td>用于实体类字段上，描述字段</td>
</tr>
<tr>
<td><code>@Tag(name = &quot;...&quot;)</code></td>
<td>用于 Controller 上，分组描述</td>
</tr>
<tr>
<td><code>@RequestBody</code> + <code>@Schema</code></td>
<td>描述请求体</td>
</tr>
<tr>
<td><code>@ApiResponse(responseCode = &quot;200&quot;, description = &quot;...&quot;)</code></td>
<td>描述响应码与内容</td>
</tr>
</tbody>
</table>
</div>
<p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/user&quot;)</span></span><br><span class="line"><span class="meta">@Tag(name = &quot;用户接口&quot;, description = &quot;用户相关接口文档&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;新增用户&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">addUser</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Parameter(description = &quot;用户信息&quot;)</span> UserDTO user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">&quot;添加成功: &quot;</span> + user.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;根据ID获取用户&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UserDTO&gt; <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDTO</span>();</span><br><span class="line">        user.setUsername(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">25</span>);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="1-Swagger-有什么作用？使用它有什么优势？"><a href="#1-Swagger-有什么作用？使用它有什么优势？" class="headerlink" title="1.Swagger 有什么作用？使用它有什么优势？"></a>1.Swagger 有什么作用？使用它有什么优势？</h4><p>Swagger 可以<strong>自动生成接口文档</strong>，支持接口调试，提升前后端联调效率。优势包括：</p>
<ul>
<li>接口文档自动同步，无需手写维护</li>
<li>可视化交互式页面，便于测试接口</li>
<li>支持导出 OpenAPI 规范，便于生成 SDK 或 Mock 接口</li>
</ul>
<h4 id="2-Swagger-在-Spring-Boot-项目中如何接入？"><a href="#2-Swagger-在-Spring-Boot-项目中如何接入？" class="headerlink" title="2.Swagger 在 Spring Boot 项目中如何接入？"></a>2.Swagger 在 Spring Boot 项目中如何接入？</h4><p>使用 <code>springdoc-openapi</code> 依赖，添加依赖后即可自动扫描 <code>@RestController</code> 注解的方法生成接口文档，常用注解包括 <code>@Operation</code>、<code>@Schema</code>、<code>@Parameter</code> 等。</p>
<h4 id="3-Swagger-与-Postman-有何区别？"><a href="#3-Swagger-与-Postman-有何区别？" class="headerlink" title="3.Swagger 与 Postman 有何区别？"></a>3.Swagger 与 Postman 有何区别？</h4><p>Swagger 更适合开发阶段自动生成文档和接口调试；</p>
<p>Postman 更适合接口自动化测试、团队共享测试集合、压测脚本等；</p>
<p>两者可互补：Swagger 导出 OpenAPI 规范，Postman 可导入执行。</p>
<h4 id="4-如何通过-Swagger-实现接口-Mock？"><a href="#4-如何通过-Swagger-实现接口-Mock？" class="headerlink" title="4.如何通过 Swagger 实现接口 Mock？"></a>4.如何通过 Swagger 实现接口 Mock？</h4><p>Swagger 本身不提供 Mock 功能，但可以通过：</p>
<ul>
<li>SwaggerHub 提供在线 Mock；</li>
<li>使用 Swagger JSON 配合工具如 <a target="_blank" rel="noopener" href="https://github.com/stoplightio/prism">Prism</a>、[WireMock] 实现；</li>
<li>本地模拟返回固定数据，用于前端调试。</li>
</ul>
<h4 id="5-MOCK是啥"><a href="#5-MOCK是啥" class="headerlink" title="5.MOCK是啥"></a>5.MOCK是啥</h4><p><strong>用于在真实对象不可用、未完成或不方便调用时，使用伪造的“替代对象”来模拟其行为</strong>。</p>
<p>本质：使用假的对象或返回结果，代替真实依赖或真实数据，方便开发和测试。</p>
<p>性能与部署优化：使用Redis缓存热门菜品数据居，应对高并发，减少数据库访尚，缩短接口响应时间：配置g作为日P服务器，外理静态资源赔部置、反同代单及负的律，提升系统稳定性与响应能力</p>
<h1 id="八股回答"><a href="#八股回答" class="headerlink" title="八股回答"></a>八股回答</h1><h2 id="1-优惠劵的超卖重复问题，使用lua脚本保持原子性"><a href="#1-优惠劵的超卖重复问题，使用lua脚本保持原子性" class="headerlink" title="1.优惠劵的超卖重复问题，使用lua脚本保持原子性"></a>1.优惠劵的超卖重复问题，使用lua脚本保持原子性</h2><p><strong>使用 Lua 脚本实现购买优惠券的原子性操作</strong>，常用于防止并发问题，比如<strong>超卖</strong>、<strong>重复领取</strong>等。</p>
<p>Redis 是<strong>单线程</strong>的，它执行 Lua 脚本时会<strong>串行执行整个脚本内容</strong>，所以可以用 Lua 脚本在 Redis 内部实现多个命令的<strong>原子执行</strong>，避免并发问题。</p>
<p>场景需求：</p>
<ul>
<li>用户未领取过优惠券</li>
<li>库存 &gt; 0</li>
<li>扣减库存，记录用户领取状态</li>
</ul>
<p><code>stock:coupon:&#123;couponId&#125;</code>：优惠券库存</p>
<p><code>user:coupon:&#123;couponId&#125;</code>：领取记录的 Set（存储 userId）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-- KEYS[<span class="number">1</span>]：库存Key</span><br><span class="line">-- KEYS[<span class="number">2</span>]：领取记录Key</span><br><span class="line">-- ARGV[<span class="number">1</span>]：用户ID</span><br><span class="line"></span><br><span class="line">-- 判断是否领取过</span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&#x27;sismember&#x27;</span>, KEYS[<span class="number">2</span>], ARGV[<span class="number">1</span>]) == <span class="number">1</span> then</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> -- 已领取</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取库存</span><br><span class="line"><span class="type">local</span> <span class="variable">stock</span> <span class="operator">=</span> tonumber(redis.call(<span class="string">&#x27;get&#x27;</span>, KEYS[<span class="number">1</span>]))</span><br><span class="line"><span class="keyword">if</span> stock &lt;= <span class="number">0</span> then</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> -- 库存不足</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 扣减库存</span><br><span class="line">redis.call(<span class="string">&#x27;decr&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line">-- 记录用户</span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, KEYS[<span class="number">2</span>], ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span> -- 成功</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">String</span> script = <span class="string">&quot;...&quot;</span>; <span class="comment">// 上面的 Lua 脚本内容</span></span><br><span class="line"><span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; keys = <span class="title class_">Arrays</span>.<span class="title function_">asList</span>(<span class="string">&quot;stock:coupon:1001&quot;</span>, <span class="string">&quot;user:coupon:1001&quot;</span>);</span><br><span class="line"><span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; args = <span class="title class_">Arrays</span>.<span class="title function_">asList</span>(<span class="string">&quot;user123&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span> result = jedis.<span class="built_in">eval</span>(script, keys, args);</span><br><span class="line"><span class="keyword">switch</span> ((<span class="title class_">Long</span>) result) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;重复领取&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;库存不足&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;领取成功&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>优惠券库存减 1 关键是要防止超卖，即多个请求同时扣库存导致数据错乱。</p>
<p>一种常见做法是使用 <strong>乐观锁（CAS）</strong>：</p>
<ul>
<li>数据表中给优惠券记录加个 <strong>版本号（version）</strong> 或 <strong>更新时间戳</strong></li>
<li>更新库存时带上版本号或时间戳条件，例如：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE coupon <span class="type">SET</span> <span class="variable">stock</span> <span class="operator">=</span> stock - <span class="number">1</span>, version = version + <span class="number">1</span> </span><br><span class="line"><span class="type">WHERE</span> <span class="variable">coupon_id</span> <span class="operator">=</span> ? AND stock &gt; <span class="number">0</span> <span class="type">AND</span> <span class="variable">version</span> <span class="operator">=</span> ?</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2-lua脚本执行异常"><a href="#2-lua脚本执行异常" class="headerlink" title="2.lua脚本执行异常"></a>2.lua脚本执行异常</h2><p>提到 Lua 脚本执行异常时因为库存字段不可见被拦截，这里具体是指 Redis 的权限问题，还是脚本中对字段的引用方式有问题？比如有没有检查过 Lua 脚本里的 key 是否和 Redis 中存储的一致</p>
<p> 脚本执行超时 (Timeout)：</p>
<p>Lua 脚本的执行是原子性的，会阻塞 Redis 实例。如果脚本执行时间过长，会导致其他客户端请求被阻塞，甚至客户端连接超时。Redis 有一个 <code>lua-time-limit</code> 配置（默认为 5 秒），超出这个时间脚本就会被终止。</p>
<p><strong>保持脚本短小精悍:</strong> Lua 脚本应该只包含最核心、需要原子性执行的逻辑。复杂的、非原子性的业务逻辑应该在客户端侧完成。</p>
<p><strong>避免昂贵的操作:</strong> 避免在脚本中执行 <code>KEYS</code>、<code>SMEMBERS</code>、<code>HGETALL</code> 等会遍历大量数据的命令。如果确实需要处理大量数据，考虑将大键拆分成小键，或者在客户端分批处理。</p>
<p><strong>增量处理:</strong> 如果必须在脚本中处理大量数据（例如清理过期键），考虑使用 <code>SCAN</code> 命令的变体（<code>HSCAN</code>, <code>SSCAN</code>, <code>ZSCAN</code>）进行增量迭代，并将脚本设计为分批执行。</p>
<p><strong>监控 <code>slowlog</code>:</strong> 检查 Redis 的 <code>slowlog</code>，看是否有 <code>EVAL</code> 或 <code>EVALSHA</code> 命令长时间执行。</p>
<h2 id="3-使用-Redis-Lua-做原子操作时，网络延迟对-CAS-操作的影响及如何保证并发原子性？"><a href="#3-使用-Redis-Lua-做原子操作时，网络延迟对-CAS-操作的影响及如何保证并发原子性？" class="headerlink" title="3.使用 Redis+Lua 做原子操作时，网络延迟对 CAS 操作的影响及如何保证并发原子性？"></a>3.使用 Redis+Lua 做原子操作时，网络延迟对 CAS 操作的影响及如何保证并发原子性？</h2><p><strong>Lua 脚本在 Redis 中执行是单线程、原子性的。</strong></p>
<ul>
<li>只要你把 CAS（Compare-And-Set）逻辑写在 Lua 脚本中，整个脚本执行期间不会被其他命令打断。</li>
<li>因此，从 Redis 侧来看，<strong>无论多少并发请求同时来，脚本内的检查+更新都是串行执行且原子完成</strong>。</li>
</ul>
<p><strong>网络延迟影响主要体现在客户端发送请求和接收结果的时延，但不影响 Redis 端脚本执行的原子性。</strong></p>
<ul>
<li>例如两个客户端几乎同时发送请求，Redis 会顺序执行两个 Lua 脚本，避免数据竞争。</li>
<li>但网络延迟可能导致客户端感知延迟或重试。</li>
</ul>
<p><strong>保证多个并发请求下原子性的建议：</strong></p>
<ul>
<li><strong>务必把校验库存和扣减库存的操作写到同一个 Lua 脚本中，保证原子执行。</strong></li>
<li>避免客户端先读库存再决定是否写，因读写分开易出现竞态条件。</li>
<li>可以结合 Redis 的 <code>WATCH</code> + <code>MULTI/EXEC</code> 事务机制，但比不上 Lua 脚本原子性简单可靠。</li>
<li>另外，设置合理超时和重试机制，防止网络异常导致操作丢失。</li>
</ul>
<h2 id="4-在-“校园餐饮系统”-项目里，你用-AOP-实现了操作日志自动记录，讲讲-AOP-切点是怎么定义的，怎么确保只拦截到需要记录日志的关键业务方法，又不会过度拦截影响系统性能呀？"><a href="#4-在-“校园餐饮系统”-项目里，你用-AOP-实现了操作日志自动记录，讲讲-AOP-切点是怎么定义的，怎么确保只拦截到需要记录日志的关键业务方法，又不会过度拦截影响系统性能呀？" class="headerlink" title="4.在 “校园餐饮系统” 项目里，你用 AOP 实现了操作日志自动记录，讲讲 AOP 切点是怎么定义的，怎么确保只拦截到需要记录日志的关键业务方法，又不会过度拦截影响系统性能呀？"></a>4.在 “校园餐饮系统” 项目里，你用 AOP 实现了操作日志自动记录，讲讲 AOP 切点是怎么定义的，怎么确保只拦截到需要记录日志的关键业务方法，又不会过度拦截影响系统性能呀？</h2><p>我们系统中使用了 Spring AOP 来统一记录用户的操作日志，包括登录日志和业务行为日志。整体设计思路是基于 <strong>自定义注解 + 切面编程 + 策略模式</strong> 来实现灵活、可扩展的日志记录体系。</p>
<p>我们定义了一个自定义注解 <code>@LogRecord</code>，用于标记需要记录的操作方法，注解中可以配置以下元信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> LogRecord &#123;</span><br><span class="line">    LogType <span class="title function_">type</span><span class="params">()</span>; <span class="comment">// 登录日志 or 业务日志</span></span><br><span class="line">    String <span class="title function_">action</span><span class="params">()</span>; <span class="comment">// 操作行为描述，如 &quot;删除用户&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>切面实现日志拦截逻辑:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(logRecord)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">recordLog</span><span class="params">(ProceedingJoinPoint pjp, LogRecord logRecord)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 1. 获取方法签名与参数</span></span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) pjp.getSignature();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> signature.getMethod();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 根据注解元信息决定日志类型</span></span><br><span class="line">        <span class="type">LogType</span> <span class="variable">type</span> <span class="operator">=</span> logRecord.type();</span><br><span class="line">        <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> logRecord.action();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 执行方法并记录执行结果</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 将日志对象封装后交由策略类处理</span></span><br><span class="line">        <span class="type">LogContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LogContext</span>(...);</span><br><span class="line">        logStrategyFactory.getStrategy(type).record(context);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>日志记录策略设计（策略模式）:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LogStrategy</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">record</span><span class="params">(LogContext context)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginLogStrategy</span> <span class="keyword">implements</span> <span class="title class_">LogStrategy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">record</span><span class="params">(LogContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// 记录用户登录成功/失败，IP、时间等</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BizLogStrategy</span> <span class="keyword">implements</span> <span class="title class_">LogStrategy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">record</span><span class="params">(LogContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// 记录用户执行的业务操作，如“删除用户”</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>策略选择通过 <code>LogStrategyFactory</code> 实现，支持按日志类型动态扩展。</p>
<p>如何保证只拦截关键方法、避免性能问题：</p>
<p>只对使用 <code>@LogRecord</code> 注解的方法进行拦截，确保业务无关方法不被扫描，避免性能浪费；</p>
<p><strong>切面逻辑尽量精简</strong>，只做元信息解析和日志上下文构建，真正的日志落盘交给异步任务处理或消息队列；</p>
<p>对不需要记录的查询类接口，不加注解，完全绕过切面执行，保障系统整体响应效率。</p>
<p>日志可选择输出到文件（使用 SLF4J + Logback），或存入数据库 / Elasticsearch，供后期审计；</p>
<p>特殊场景下（如操作异常），支持记录异常栈与执行耗时。</p>
<p>追问：：：</p>
<ul>
<li><strong>问</strong>：@Around 和 @Before 有什么区别，为什么你选用 Around？</li>
<li><strong>答</strong>：Around 能拿到方法执行前后的控制权，包括返回值和异常，更适合记录执行结果和耗时。</li>
<li><strong>问</strong>：怎么处理日志失败、落盘慢的问题？</li>
<li><strong>答</strong>：日志落盘可异步执行或通过 MQ 异步解耦，避免阻塞主流程。</li>
</ul>
<h2 id="5-在-“校园餐饮系统”-项目里，你提到用了-Redis-存储-token-缓解压力，能讲讲具体怎么设计-key-的结构，以及如何保障-token-存储和读取的高效性与安全性不？"><a href="#5-在-“校园餐饮系统”-项目里，你提到用了-Redis-存储-token-缓解压力，能讲讲具体怎么设计-key-的结构，以及如何保障-token-存储和读取的高效性与安全性不？" class="headerlink" title="5.在 “校园餐饮系统” 项目里，你提到用了 Redis 存储 token 缓解压力，能讲讲具体怎么设计 key 的结构，以及如何保障 token 存储和读取的高效性与安全性不？"></a>5.在 “校园餐饮系统” 项目里，你提到用了 Redis 存储 token 缓解压力，能讲讲具体怎么设计 key 的结构，以及如何保障 token 存储和读取的高效性与安全性不？</h2><p>我们使用 Redis 存储用户的 <code>refresh token</code>，以提升系统性能并减少数据库压力，整体设计分为三部分：<strong>Key 设计、存储结构、安全机制</strong>。</p>
<p>结构设计：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token:refresh:&#123;userId&#125;</span><br></pre></td></tr></table></figure>
<p>这种格式能明确标识 token 类型和所属用户，保证唯一性和可读性，避免 key 冲突。</p>
<p>Value 的存储结构：</p>
<p>我们使用 Redis 的 <strong>字符串结构（String）</strong> 或 <strong>哈希结构（Hash）</strong> 存储 refresh token，取决于业务是否需要额外附加字段（如生成时间、IP、设备信息）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HSET token:refresh:123 userId 123 token abc123 createdAt 2025-06-19</span><br></pre></td></tr></table></figure>
<p>设置合理的过期时间（如 7 天），使用 <code>EXPIRE</code> 或 <code>SETEX</code> 命令控制 token 生命周期。</p>
<p>Token 的生成与安全性保障：</p>
<p>Token 使用 JWT 生成，签名采用 <strong>HS256 算法</strong>（HMAC + SHA256），密钥保存在服务端配置中心或安全的 KMS（Key Management Service）中。</p>
<p>JWT 本身包含用户信息、过期时间等，生成后只将 <code>access token</code> 下发到前端，<code>refresh token</code> 则存于 Redis 中服务端管理，防止伪造。</p>
<p>认证流程：</p>
<p>登录时生成 access + refresh token：</p>
<ul>
<li>access token 返回给前端；</li>
<li>refresh token 存入 Redis，key 为 <code>token:refresh:&#123;userId&#125;</code>。</li>
</ul>
<p>前端 token 过期后，<strong>携带 refresh token 请求刷新接口</strong>；</p>
<p>后端校验 Redis 中的 refresh token，校验通过后重新生成新 token 对。</p>
<p>提前防止问题：</p>
<p><strong>防缓存穿透</strong>：使用 <strong>布隆过滤器</strong> 记录<strong>有效用户 ID 或常见请求 Key</strong>，防止恶意请求频繁查询 Redis 失败并打爆数据库。</p>
<p><strong>防击穿</strong>：为热点用户的 token <strong>设置合理 TTL</strong>，避免同一时间大批用户同时失效。</p>
<p><strong>防雪崩</strong>：TTL 设置加入随机因子，避免大批 key 同时过期。</p>
<p><strong>权限校验</strong>：请求时验证 token 是否属于当前 userId，防止越权操作。</p>
<h2 id="6-那么优惠劵的发放呢？一些列的问题呢"><a href="#6-那么优惠劵的发放呢？一些列的问题呢" class="headerlink" title="6.那么优惠劵的发放呢？一些列的问题呢"></a>6.那么优惠劵的发放呢？一些列的问题呢</h2><p>✅ 一、关于优惠券类型的常见问题</p>
<p>❓1. 如何区分和应用不同类型的优惠券逻辑？</p>
<p><strong>面试点</strong>：策略模式、优惠金额计算方式。</p>
<p><strong>答法</strong>：</p>
<blockquote>
<p>我们用策略模式来封装每种优惠券的优惠逻辑（如满减、折扣、无门槛）。每种类型对应一个策略类，实现统一的接口方法 <code>calculateDiscount(OrderInfo order)</code>，这样能在运行时动态选择策略，便于扩展和维护。</p>
</blockquote>
<hr>
<p>✅ 二、关于接口设计的追问</p>
<p>❓2. 为什么接口是这样的？有没有考虑幂等性和安全性？</p>
<ul>
<li><code>POST /use</code> 接口可能会被重复调用，是否<strong>幂等</strong>？</li>
<li>有没有做权限控制，防止其他用户伪造请求？</li>
</ul>
<p><strong>答法</strong>：</p>
<blockquote>
<p>在使用优惠券时，为防止重复使用，我们使用 Redis + Lua 实现原子操作，同时标记优惠券为“已使用”。此外接口采用登录态校验，验证当前操作用户是否拥有该优惠券。敏感操作都要求用户登录，并记录操作日志。</p>
</blockquote>
<hr>
<p>✅ 三、关于并发处理和限领逻辑</p>
<p>❓3. 如果多用户并发领取优惠券，如何防止超发？</p>
<p><strong>答法</strong>：</p>
<blockquote>
<p>发放流程中，我们使用 Redis 的 <code>DECR</code> 或 Lua 脚本实现优惠券库存的原子扣减，保证不会发放超过设定数量。同时加锁防止并发条件下库存扣减不一致。</p>
</blockquote>
<hr>
<p>❓4. 如何限制每个用户只能领取一次？</p>
<p><strong>答法</strong>：</p>
<blockquote>
<p>Redis 中设置一个标识键：<code>user:coupon:received:&#123;couponId&#125;:&#123;userId&#125;</code>，发放前先判断这个键是否存在，避免重复发放。也可以结合布隆过滤器提前过滤无效请求。</p>
</blockquote>
<hr>
<p>✅ 四、关于时间与状态校验</p>
<p>❓5. 限时券怎么判断是否有效？服务端怎么处理时间逻辑？</p>
<p><strong>答法</strong>：</p>
<blockquote>
<p>每张优惠券记录中保存有效时间范围。使用时，服务端比对当前时间是否在有效期内。同时定时任务每天扫描过期优惠券，标记为“已过期”。</p>
</blockquote>
<hr>
<p>✅ 五、关于优惠券使用过程的逻辑判断</p>
<p>❓6. 使用时如果有多个优惠券，怎么选最优？</p>
<p><strong>答法</strong>：</p>
<blockquote>
<p>前端可以请求一个“推荐最优券”的接口，我们在服务端遍历用户可用券，调用各个策略类计算预期优惠，返回最高优惠金额对应的券。</p>
</blockquote>
<hr>
<p>✅ 六、关于优惠券与订单系统结合问题</p>
<p>❓7. 如果下单失败了，优惠券是否要恢复？</p>
<p><strong>答法</strong>：</p>
<blockquote>
<p>下单失败（如支付失败、库存不足）时，我们会在事务回滚后将优惠券状态重置为“未使用”。为了避免并发问题，使用分布式事务（如消息队列、TCC）或 Redis 回滚标记。</p>
</blockquote>
<hr>
<p>✅ 七、进阶设计问题</p>
<p>❓8. 优惠券支持“异步发放”和“定时生效”吗？</p>
<p><strong>答法</strong>：</p>
<blockquote>
<p>是的，可以结合定时任务（如 Quartz 或 Spring Schedule）实现定时发放；发放时间和有效时间字段分离，发放时写入 Redis 延时队列，当生效时间到达时插入到用户优惠券表中。</p>
</blockquote>
<hr>
<p>✅ 八、可能让你设计代码结构的问题</p>
<p>❓9. 优惠券模块的结构划分是怎样的？</p>
<p><strong>答法</strong>（示意）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- entity（Coupon, UserCoupon）</span><br><span class="line">- controller（CouponController）</span><br><span class="line">- service（CouponService、UseStrategy接口及实现）</span><br><span class="line">- repository（MyBatis-Plus Mapper）</span><br><span class="line">- util（金额计算工具类）</span><br></pre></td></tr></table></figure>
<hr>
<p>✅ 九、安全性问题</p>
<p>❓10. 用户伪造优惠券 ID，试图套用别人的优惠券怎么办？</p>
<p><strong>答法</strong>：</p>
<blockquote>
<p>每次使用时不仅要校验优惠券 ID 是否存在，还要校验当前登录用户是否是该优惠券持有人，只有归属校验通过才能使用。</p>
</blockquote>
<h2 id="7-看你在优惠劵的发放的时候使用限流，怎么设计的"><a href="#7-看你在优惠劵的发放的时候使用限流，怎么设计的" class="headerlink" title="7.看你在优惠劵的发放的时候使用限流，怎么设计的"></a>7.看你在优惠劵的发放的时候使用限流，怎么设计的</h2><p>我们在优惠券领取接口中用 AOP + 令牌桶实现限流</p>
<ul>
<li><strong>注解定义</strong>：<code>@RateLimit</code> 注解标注需要限流的方法，参数包括 <code>limitCount=5</code>（每分钟 5 次）、<code>time=1</code>（时间单位分钟）、<code>keyType=&quot;USER_IP&quot;</code>（按用户 IP+ID 限流）。</li>
<li><strong>切面实现</strong>：通过 <code>@Around</code> 切面拦截注解方法，获取参数后生成唯一限流 key（例如 <code>rate_limit:user_123:192.168.1.1</code>），然后调用 Redis 令牌桶服务校验。</li>
<li><strong>Redis 令牌桶</strong>：用 Lua 脚本实现原子性校验，核心是根据时间戳计算可生成的新令牌数，不足时拒绝请求。比如用户抢优惠券时，同一 IP+ID 每分钟最多 5 次请求，防止恶意刷接口。</li>
</ul>
<ol>
<li><strong>防重复领取</strong>：避免用户短时间内多次点击接口，导致优惠券<strong>超发</strong>；</li>
<li><strong>保护服务端</strong>：峰值流量时限制请求频率，防止 Redis 或数据库被击穿。线上遇到过同一 WiFi 下多个用户被误限的情况，后来把 key 改为`IP+用户ID，减少了误判率。”</li>
</ol>
<p>切面类如何获取注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.example.RateLimit)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rateLimitPointcut</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Around(&quot;rateLimitPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 获取方法上的注解</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ((MethodSignature) joinPoint.getSignature()).getMethod();</span><br><span class="line">        <span class="type">RateLimit</span> <span class="variable">rateLimit</span> <span class="operator">=</span> method.getAnnotation(RateLimit.class);</span><br><span class="line">        <span class="type">int</span> <span class="variable">limitCount</span> <span class="operator">=</span> rateLimit.limitCount();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> rateLimit.time();</span><br><span class="line">        <span class="type">String</span> <span class="variable">keyType</span> <span class="operator">=</span> rateLimit.keyType();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 生成限流key（IP+用户ID）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> generateKey(joinPoint, keyType);</span><br><span class="line">        <span class="comment">// 调用Redis令牌桶校验</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">allow</span> <span class="operator">=</span> redisBucketService.tryAcquire(key, limitCount, time, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">if</span> (!allow) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;请求频繁，请稍后再试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么选令牌桶而不是漏桶？</p>
<p>令牌桶适合突发流量，漏桶适合平滑流量</p>
<p>使用redis+lua原子的存储令牌桶，使用时间戳来校验。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">-- 令牌桶Lua脚本（简化版）</span><br><span class="line"><span class="type">local</span> <span class="variable">key</span> <span class="operator">=</span> KEYS[<span class="number">1</span>]  -- 限流key</span><br><span class="line"><span class="type">local</span> <span class="variable">capacity</span> <span class="operator">=</span> tonumber(ARGV[<span class="number">1</span>])  -- 桶容量</span><br><span class="line"><span class="type">local</span> <span class="variable">rate</span> <span class="operator">=</span> tonumber(ARGV[<span class="number">2</span>])  -- 令牌生成速率（个/秒）</span><br><span class="line"><span class="type">local</span> <span class="variable">now</span> <span class="operator">=</span> tonumber(ARGV[<span class="number">3</span>])  -- 当前时间戳</span><br><span class="line"><span class="type">local</span> <span class="variable">requested</span> <span class="operator">=</span> tonumber(ARGV[<span class="number">4</span>])  -- 请求令牌数</span><br><span class="line"></span><br><span class="line">-- 读取上次更新时间和剩余令牌数</span><br><span class="line"><span class="type">local</span> <span class="variable">last</span> <span class="operator">=</span> redis.call(<span class="string">&#x27;hget&#x27;</span>, key, <span class="string">&#x27;last&#x27;</span>)</span><br><span class="line"><span class="type">local</span> <span class="variable">tokens</span> <span class="operator">=</span> tonumber(redis.call(<span class="string">&#x27;hget&#x27;</span>, key, <span class="string">&#x27;tokens&#x27;</span>) or <span class="number">0</span>)</span><br><span class="line">last = last or now</span><br><span class="line"></span><br><span class="line">-- 计算可生成的新令牌数</span><br><span class="line"><span class="type">local</span> <span class="variable">delta</span> <span class="operator">=</span> now - last</span><br><span class="line"><span class="type">local</span> <span class="variable">newTokens</span> <span class="operator">=</span> math.min(capacity, tokens + delta * rate)</span><br><span class="line"><span class="keyword">if</span> newTokens &gt;= requested then</span><br><span class="line">    -- 够发令牌，更新状态</span><br><span class="line">    redis.call(<span class="string">&#x27;hset&#x27;</span>, key, <span class="string">&#x27;last&#x27;</span>, now)</span><br><span class="line">    redis.call(<span class="string">&#x27;hset&#x27;</span>, key, <span class="string">&#x27;tokens&#x27;</span>, newTokens - requested)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>  -- 允许访问</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>  -- 拒绝访问</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h2 id="8-你项目里用了JWT加双-Token，具体是怎么设计的？两个-Token-各自的作用是什么？拦截器又分别处理什么逻辑？比如有没有考虑过-Token-过期、刷新机制，或者防重放攻击的问题？"><a href="#8-你项目里用了JWT加双-Token，具体是怎么设计的？两个-Token-各自的作用是什么？拦截器又分别处理什么逻辑？比如有没有考虑过-Token-过期、刷新机制，或者防重放攻击的问题？" class="headerlink" title="8.你项目里用了JWT加双 Token，具体是怎么设计的？两个 Token 各自的作用是什么？拦截器又分别处理什么逻辑？比如有没有考虑过 Token 过期、刷新机制，或者防重放攻击的问题？"></a>8.你项目里用了JWT加双 Token，具体是怎么设计的？两个 Token 各自的作用是什么？拦截器又分别处理什么逻辑？比如有没有考虑过 Token 过期、刷新机制，或者防重放攻击的问题？</h2><p>token:</p>
<ul>
<li><strong>access token</strong>（7 天有效期）：放在请求头，用于日常接口认证，用 HS256 加密（密钥服务端持有）；放在前端的localStorage/jwt</li>
<li><strong>refresh token</strong>（15 天有效期）：存在 Redis，值是随机字符串，且绑定用户 ID ，防止盗用。放在redis中</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>安全措施</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>使用 HTTPS</td>
<td>防止中间人劫持 token</td>
</tr>
<tr>
<td>access token 只读</td>
<td>JWT 使用 HS256 加密，防篡改</td>
</tr>
<tr>
<td>refresh token 存 Redis</td>
<td>结合用户 ID 存储，支持设置 TTL，有效控制生命周期</td>
</tr>
<tr>
<td>黑名单机制（登出）</td>
<td>用户退出登录时可删除 Redis 中 refresh token，立即失效</td>
</tr>
<tr>
<td>防止多端同时登录</td>
<td>Redis 可使用 userId 为 key，限制 refresh token 单个登录会话</td>
</tr>
<tr>
<td>Token 刷新接口限流</td>
<td>防止 refresh token 被滥用（加防重放、限频）</td>
</tr>
<tr>
<td>Token 刷新重发保护</td>
<td>Redis 设置短期 refresh token 使用标记，防止并发重复刷新</td>
</tr>
</tbody>
</table>
</div>
<p>退出策略：</p>
<p>用户点击退出：</p>
<ul>
<li>删除 Redis 中的 refresh token（或设置为无效标记）；</li>
<li>access token 因为是 JWT，不可被撤销，可考虑实现<strong>黑名单机制</strong>（例如 Redis 中维护一张 token 黑名单）；</li>
</ul>
<p>黑名单适用于<strong>高安全场景</strong>（如后台管理系统），但会略增加接口访问时的 Redis 查询压力。</p>
<p>jwt拦截器：</p>
<ol>
<li><strong>认证拦截器</strong>：先检查请求头是否有 access token，没有就返回 401；有则解析 token，校验用户信息是否存在。</li>
</ol>
<ul>
<li>第一个拦截器先校验请求头是否有 access token，没有的话直接返回 401；第二个拦截器在 access token 有效时，额外检查是否快过期（比如剩余时间 &lt; 10 分钟），如果是就用 refresh token 去 Redis 换全新的 access token 和 refresh token（这里要注意刷新时的原子性，避免并发问题）。</li>
</ul>
<ol>
<li>刷新拦截器：如果 access token 剩余有效期 &lt; 10 分钟，就用请求头中的 refresh token 去 Redis 校验：<ul>
<li>校验通过的话，生成新的 access token 和 refresh token（新 refresh token 会覆盖 Redis 中的旧值，保证单设备登录）；</li>
<li>校验失败的话，直接让用户重新登录。</li>
</ul>
</li>
</ol>
<p>危险：</p>
<p>前端或攻击者<strong>拿到密钥（如部署泄露、浏览器调试泄露）</strong>，就可以伪造合法 token。</p>
<p>token 内容是可解密的，攻击者可<strong>猜测或修改 payload</strong>，然后重新签名。</p>
<p>如果服务端<strong>未验证签名</strong>（有些误用场景会只解析不校验），更容易被利用。</p>
<p>但还是sh256更快，计算算开销低；对称密钥管理更简单，适用于内部系统或中小型项目；</p>
<p>开发成本更低，不涉及证书管理、公私钥分发；</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>措施</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>✅ 使用强密钥</td>
<td>至少 256 bit 的复杂密钥，不可硬编码进前端或代码中</td>
</tr>
<tr>
<td>✅ 启用 HTTPS</td>
<td>防止 token 被中间人劫持</td>
</tr>
<tr>
<td>✅ token 签名校验</td>
<td>每次都校验 JWT 的签名，防止伪造</td>
</tr>
<tr>
<td>✅ 缩短 access token 有效期</td>
<td>缩小攻击窗口</td>
</tr>
<tr>
<td>✅ refresh token 存 Redis</td>
<td>结合用户 ID 防重放、防伪造</td>
</tr>
<tr>
<td>✅ 黑名单机制 + 登出清除</td>
<td>登出时使 refresh token 无效</td>
</tr>
<tr>
<td>✅ 检查 UA/IP 等指纹</td>
<td>防止 token 被别人拿去复用</td>
</tr>
</tbody>
</table>
</div>
<h2 id="9-校园餐饮系统”中用-Redis-Lua-脚本-解决支付与库存扣减一致性问题的回答"><a href="#9-校园餐饮系统”中用-Redis-Lua-脚本-解决支付与库存扣减一致性问题的回答" class="headerlink" title="9.校园餐饮系统”中用 Redis + Lua 脚本 解决支付与库存扣减一致性问题的回答"></a>9.校园餐饮系统”中用 <strong>Redis + Lua 脚本</strong> 解决支付与库存扣减一致性问题的回答</h2><p>扣减库存（商品服务）</p>
<p>扣除余额或生成支付单（支付服务）</p>
<p>创建订单记录（订单服务）</p>
<p>我们在库存服务中使用了 Redis + Lua 脚本 来实现<strong>本地原子扣减库存 + 用户去重校验</strong>，以解决高并发下的库存超卖问题。</p>
<p><strong>为什么使用 Lua 脚本？</strong><br> 因为 Redis 本身是单线程的，Lua 脚本在 Redis 内部执行时具备<strong>原子性</strong>：整个脚本要么全部成功、要么全部失败（回滚）。我们把两个关键操作封装为一体执行：</p>
<ul>
<li>检查库存是否充足</li>
<li>判断用户是否已领取（防止重复操作）</li>
<li>若都满足，原子扣减库存并记录领取状态</li>
</ul>
<p><strong>脚本大致逻辑如下（伪代码）：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if redis.get(stock_key) &lt;= 0 then</span><br><span class="line">  return 0  -- 库存不足</span><br><span class="line">end</span><br><span class="line">if redis.sismember(user_set, user_id) then</span><br><span class="line">  return 1  -- 已领取过</span><br><span class="line">end</span><br><span class="line">redis.decr(stock_key)</span><br><span class="line">redis.sadd(user_set, user_id)</span><br><span class="line">return 2  -- 扣减成功</span><br></pre></td></tr></table></figure>
<blockquote>
<p>✅ 该方式解决的是<strong>单点库存系统</strong>下的原子性问题，但它本身<strong>不等同于分布式事务</strong>。</p>
</blockquote>
<p>用来防止    支付成功 → Redis 脚本执行失败 → 用户实际支付了，但库存未扣 → 数据不一致！</p>
<p>但若中间失败就可能导致 Redis 与 MySQL 数据不一致。我们改进方式为：</p>
<ul>
<li>对写数据库后的数据变化，<strong>通过 binlog 或 MQ 投递</strong>通知 Redis 更新；</li>
<li>或者在数据变更时 <strong>先删除缓存（Cache Aside 模式）</strong>，由下次读时自动加载新数据；</li>
<li>加入失败重试机制，确保最终一致性。</li>
</ul>
<h2 id="10-为什么要用-ThreadLocal-保存用户信息？和直接传参或放到全局变量有什么区别？"><a href="#10-为什么要用-ThreadLocal-保存用户信息？和直接传参或放到全局变量有什么区别？" class="headerlink" title="10.为什么要用 ThreadLocal 保存用户信息？和直接传参或放到全局变量有什么区别？"></a>10.为什么要用 ThreadLocal 保存用户信息？和直接传参或放到全局变量有什么区别？</h2><p>我们将登录成功后的用户信息（如 userId、权限）解析出来并存入 <code>ThreadLocal&lt;UserDTO&gt;</code>：</p>
<ul>
<li>这样做可以避免频繁从数据库或 Redis 获取用户信息；</li>
<li>在整个线程生命周期内（一次请求），任何地方都可以通过 ThreadLocal 拿到用户信息，避免层层传参；</li>
<li>比如日志记录、数据权限控制、业务层注入当前用户等场景都能简化处理。</li>
</ul>
<p>和全局变量的区别是，ThreadLocal 保证每个线程有独立副本，不会产生线程安全问题。</p>
<h2 id="11-你限流是怎么做的？为什么选-Bucket4j？AOP-在这里起了什么作用？"><a href="#11-你限流是怎么做的？为什么选-Bucket4j？AOP-在这里起了什么作用？" class="headerlink" title="11.你限流是怎么做的？为什么选 Bucket4j？AOP 在这里起了什么作用？"></a>11.你限流是怎么做的？为什么选 Bucket4j？AOP 在这里起了什么作用？</h2><p>我们使用的是 <strong>基于 AOP 的注解式限流方案</strong>：</p>
<ul>
<li>自定义注解 <code>@RateLimit(...)</code>，在需要限流的接口上标记；</li>
<li>使用 Spring AOP 拦截该注解方法，提取用户标识（IP 或用户 ID）+ 请求路径作为限流 key；</li>
<li>在拦截逻辑中使用 <strong>Bucket4j + Redis backend</strong> 构建令牌桶，对该 key 做分布式限流。</li>
</ul>
<p><strong>为什么选 Bucket4j？</strong></p>
<ul>
<li>支持多种限流算法（令牌桶、漏桶）</li>
<li>支持 Redis、Hazelcast 等分布式存储</li>
<li>语义丰富，可设置恢复速率、最大突发数等参数</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>分布式环境可用（多实例共享限流状态）</li>
<li>AOP 实现接入方便、解耦代码</li>
</ul>
<h2 id="12-为什么发放优惠券要用-Lua-脚本？脚本中都做了哪些事？你如何保证幂等性和原子性？"><a href="#12-为什么发放优惠券要用-Lua-脚本？脚本中都做了哪些事？你如何保证幂等性和原子性？" class="headerlink" title="12.为什么发放优惠券要用 Lua 脚本？脚本中都做了哪些事？你如何保证幂等性和原子性？"></a>12.为什么发放优惠券要用 Lua 脚本？脚本中都做了哪些事？你如何保证幂等性和原子性？</h2><p>Lua 脚本用于 Redis 中实现发券逻辑，是为了保证整个操作的<strong>原子性</strong>，避免并发发放导致超卖。</p>
<p>脚本逻辑主要包含：</p>
<ol>
<li>检查库存是否大于 0；</li>
<li>判断当前用户是否已领取；</li>
<li>若未领取、库存充足，则：<ul>
<li>减库存；</li>
<li>标记用户已领取；</li>
<li>返回发放成功。</li>
</ul>
</li>
</ol>
<p>这些步骤在脚本中<strong>一次性执行，具备原子性</strong>，防止线程交错出现并发漏洞。</p>
<p>为保证<strong>幂等性</strong>，我们用 Redis 的 <code>SETNX</code> 操作或 <code>SADD</code> 判重集合，避免重复领取。</p>
<h2 id="13-操作日志是怎么自动记录的？为什么要用-AOP-实现？"><a href="#13-操作日志是怎么自动记录的？为什么要用-AOP-实现？" class="headerlink" title="13.操作日志是怎么自动记录的？为什么要用 AOP 实现？"></a>13.操作日志是怎么自动记录的？为什么要用 AOP 实现？</h2><p>我们使用 AOP + 注解方式自动记录用户操作行为，无需每个业务手动写日志。</p>
<ul>
<li>自定义注解 <code>@OperationLog(value=&quot;下单操作&quot;)</code></li>
<li>通过 AOP 拦截这些方法，自动记录：<ul>
<li>用户 ID（从 ThreadLocal 拿）</li>
<li>IP 地址、请求时间、执行耗时</li>
<li>方法名称、操作模块</li>
<li>请求参数和响应结果（可脱敏）</li>
</ul>
</li>
</ul>
<p><strong>优势：</strong></p>
<ul>
<li>解耦业务逻辑和日志收集</li>
<li>可灵活扩展（如写入 Elasticsearch、数据库、MQ）</li>
<li>配合登录拦截器还能自动记录登录 IP、时间等行为</li>
</ul>
<h2 id="14-你说用-Nginx-解决了跨域问题，是怎么配置的？有没有考虑过-CORS-方案？"><a href="#14-你说用-Nginx-解决了跨域问题，是怎么配置的？有没有考虑过-CORS-方案？" class="headerlink" title="14.你说用 Nginx 解决了跨域问题，是怎么配置的？有没有考虑过 CORS 方案？"></a>14.你说用 Nginx 解决了跨域问题，是怎么配置的？有没有考虑过 CORS 方案？</h2><p>我们通过 Nginx 配置反向代理，将前端请求 <code>/api/**</code> 转发至后端服务，并统一处理跨域：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /api/ &#123;</span><br><span class="line">    proxy_pass http://backend-service/;</span><br><span class="line">    add_header Access-Control-Allow-Origin *;</span><br><span class="line">    add_header Access-Control-Allow-Methods GET,POST,OPTIONS;</span><br><span class="line">    add_header Access-Control-Allow-Headers Authorization,Content-Type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样前端调用 <code>/api/xxx</code> 时，相当于同源请求，避免了浏览器 CORS 警告。</p>
<p>当然，在开发环境我们也启用了 Spring 的 CORS 配置（<code>CorsFilter</code>），用于本地调试跨域请求，生产环境由 Nginx 完成统一处理。</p>
<h2 id="15-CORS跨域问题"><a href="#15-CORS跨域问题" class="headerlink" title="15.CORS跨域问题"></a>15.CORS跨域问题</h2><p>一个页面发起的ajax请求，只能是与<strong>当前页域名相同</strong>的路径，这能有效的阻止跨站攻击。因此，跨域问题 是针对ajax的一种限制。</p>
<p>跨域：浏览器对于javascript的同源策略的限制。下面几种情况都属于跨域：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、域名不同  www.jd.com 与 www.taobao.com</span><br><span class="line">2、端口不同  www.jd.com:8080 与 www.jd.com:8081</span><br><span class="line">3、二级域名不同 item.jd.com 与 miaosha.jd.com</span><br><span class="line">4、http和https也属于跨域</span><br></pre></td></tr></table></figure>
<p>CORS是一个W3C标准，全称是”跨域资源共享”（Cross-origin resource sharing）。它允许浏览器向跨源服务器，发出<a href="https://link.zhihu.com/?target=http%3A//www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html">XMLHttpRequest</a>请求，从而克服了AJAX只能<a href="https://link.zhihu.com/?target=http%3A//www.ruanyifeng.com/blog/2016/04/same-origin-policy.html">同源</a>使用的限制。</p>
<p>CORS需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能，IE浏览器不能低于IE10</p>
<p>实现：</p>
<p>在网关（zuul）中编写一个配置类，并且注册CorsFilter：</p>
<p>SpringMVC已经帮我们写好了CORS的跨域过滤器：CorsFilter ,内部已经实现了刚才所讲的判定逻辑，我们直接用就好了。</p>
<p>服务端可以通过拦截器统一实现，不必每次都去进行跨域判定的编写。</p>
<p>在网关中创建一个CorsFilter的跨域访问过滤器类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HandouCorsConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CorsFilter <span class="title function_">corsFilter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//1.添加CORS配置信息</span></span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        <span class="comment">//1) 允许的域,不要写*，否则cookie就无法使用了</span></span><br><span class="line">        config.addAllowedOrigin(<span class="string">&quot;http://manage.handou.com&quot;</span>);</span><br><span class="line">        <span class="comment">//2) 是否发送Cookie信息</span></span><br><span class="line">        config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//3) 允许的请求方式</span></span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">// 4）允许的头信息</span></span><br><span class="line">        config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.添加映射路径，我们拦截一切请求</span></span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">configSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        configSource.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.返回新的CorsFilter.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsFilter</span>(configSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">mengnankkzhou</div><div class="post-copyright__author_desc">不要走捏</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.tokenlen.top/2025/05/27/workmenu/shopping-web2/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.tokenlen.top/2025/05/27/workmenu/shopping-web2/')">shopping-web项目八股分析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.tokenlen.top/2025/05/27/workmenu/shopping-web2/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=shopping-web项目八股分析&amp;url=https://blog.tokenlen.top/2025/05/27/workmenu/shopping-web2/&amp;pic=https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837601.jpeg?_r_=3d911e72-8ab7-c087-1c68-d635f2561984" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.tokenlen.top" target="_blank">mengnankkのblog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/java/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>java<span class="categoryesPageCount">25</span></a><a class="post-meta__box__categoryes" href="/categories/java/%E9%A1%B9%E7%9B%AE/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>项目<span class="categoryesPageCount">12</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/spring-boot/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>spring boot<span class="tagsPageCount">14</span></a><a class="post-meta__box__tags" href="/tags/java/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>java<span class="tagsPageCount">52</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=aca3126e-c689-e724-3c7a-5abe15d5a1e5" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/05/25/java-stack/jvm1/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722380.jpg?_r_=24ac49bc-48b2-4d53-6dc9-1c32d9d0ca69" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JVM-java虚拟机</div></div></a></div><div class="next-post pull-right"><a href="/2025/05/27/workmenu/shopping-web/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202408081510678.jpg?_r_=fb683432-50d5-eced-6518-359c8f05ec9d" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">shopping-web项目逻辑分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/07/01/workmenu/dianping/" title="黑马点评项目逻辑功能分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=aca3126e-c689-e724-3c7a-5abe15d5a1e5" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-01</div><div class="title">黑马点评项目逻辑功能分析</div></div></a></div><div><a href="/2025/07/01/workmenu/dianping1/" title="黑马点评项目逻辑功能分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712175.jpg?_r_=b5dae4a2-d037-e78f-9a9e-69e198968293" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-01</div><div class="title">黑马点评项目逻辑功能分析</div></div></a></div><div><a href="/2025/07/01/workmenu/dianping2/" title="黑马点评项目知识分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=73a4f20f-5c9f-4302-1b46-7f07eaae3cb1" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-01</div><div class="title">黑马点评项目知识分析</div></div></a></div><div><a href="/2025/06/12/workmenu/mydb2/" title="Mydb自定义数据库八股"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=bc54680d-035c-841f-89f6-35222b02c140" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-12</div><div class="title">Mydb自定义数据库八股</div></div></a></div><div><a href="/2025/06/10/workmenu/reggie2/" title="瑞吉外卖逻辑分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712181.jpg?_r_=c56a79a3-29fa-bb20-05ce-6c6e72c3c1b5" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-10</div><div class="title">瑞吉外卖逻辑分析</div></div></a></div><div><a href="/2025/06/07/doc/shopping-mengnankk/" title="shopping项目文档面试八股"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712175.jpg?_r_=7e651389-019d-4160-6d37-dcdd134ff4d1" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-07</div><div class="title">shopping项目文档面试八股</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Valine</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">清风拂柳影，碧水映花香。</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">mengnankkzhou</h1><div class="author-info__desc">不要走捏</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/mengnankkkk" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/440831872" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410021212939.jpg) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.</span> <span class="toc-text">身份认证与权限校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90"><span class="toc-number">1.0.1.</span> <span class="toc-text">问题解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-JWT%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">1.JWT的组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%AE%BE%E7%BD%AE-exp%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E8%BF%87%E6%9C%9F%EF%BC%9F"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">2.为什么要设置 exp，以及如何处理过期？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%EF%BC%88HS256%EF%BC%89%E4%B8%8E%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%EF%BC%88RS256%EF%BC%89%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">1.0.2.</span> <span class="toc-text">3.对称加密（HS256）与非对称加密（RS256）的区别？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-HandlerInterceptor-%E4%B8%8E-Filter-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">1.0.3.</span> <span class="toc-text">4.HandlerInterceptor 与 Filter 的区别？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E6%9F%90%E4%BA%9B%E8%B7%AF%E5%BE%84%E6%94%BE%E8%A1%8C%EF%BC%9F"><span class="toc-number">1.0.4.</span> <span class="toc-text">5.如何配置某些路径放行？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Spring-Boot-%E9%BB%98%E8%AE%A4%E5%93%AA%E4%BA%9B%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E8%B7%AF%E5%BE%84%EF%BC%9F%E6%98%AF%E5%90%A6%E4%BC%9A%E8%A2%AB%E6%8B%A6%E6%88%AA%EF%BC%9F"><span class="toc-number">1.0.5.</span> <span class="toc-text">6.Spring Boot 默认哪些静态资源路径？是否会被拦截？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%9C%A8-afterCompletion-%E6%B8%85%E7%90%86-ThreadLocal%EF%BC%9F"><span class="toc-number">1.0.6.</span> <span class="toc-text">7.为什么要在 afterCompletion 清理 ThreadLocal？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B-ThreadLocal-%E7%9A%84%E9%80%82%E7%94%A8%E4%B8%8E%E9%99%90%E5%88%B6%EF%BC%9F"><span class="toc-number">1.0.7.</span> <span class="toc-text">8.并发场景下 ThreadLocal 的适用与限制？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%A6%82%E4%BD%95%E5%AE%89%E5%85%A8%E5%9C%B0%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%EF%BC%9F"><span class="toc-number">1.0.8.</span> <span class="toc-text">9.如何安全地存储用户密码？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%A6%81%E6%8A%8A%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%EF%BC%88%E5%A6%82%E5%AF%86%E7%A0%81%EF%BC%89%E6%94%BE%E5%88%B0-JWT-%E9%87%8C%EF%BC%9F"><span class="toc-number">1.0.9.</span> <span class="toc-text">10.为什么不要把敏感信息（如密码）放到 JWT 里？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-Token-%E5%9C%A8%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8%EF%BC%88localStorage-vs-HttpOnly-Cookie%EF%BC%89%EF%BC%9F"><span class="toc-number">1.0.10.</span> <span class="toc-text">11.Token 在前端如何存储（localStorage vs HttpOnly Cookie）？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%A0%E4%BB%AC%E7%9A%84%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6%E6%98%AF%E6%80%8E%E4%B9%88%E5%81%9A%E7%9A%84%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8-JWT%EF%BC%9F"><span class="toc-number">1.0.11.</span> <span class="toc-text">1.你们的认证机制是怎么做的？为什么用 JWT？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1-Token-%E5%88%B7%E6%96%B0%E6%9C%BA%E5%88%B6%EF%BC%9F"><span class="toc-number">1.0.12.</span> <span class="toc-text">2.如何设计 Token 刷新机制？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-ThreadLocal%EF%BC%9F%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">1.0.13.</span> <span class="toc-text">3.为什么使用 ThreadLocal？是否存在线程安全问题？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E4%B8%A4%E4%B8%AA%E6%8B%A6%E6%88%AA%E5%99%A8%EF%BC%9F%E4%B8%8D%E8%83%BD%E4%B8%80%E4%B8%AA%E5%AE%9E%E7%8E%B0%E6%89%80%E6%9C%89%E5%8A%9F%E8%83%BD%E5%90%97%EF%BC%9F"><span class="toc-number">1.0.14.</span> <span class="toc-text">4.为什么要使用两个拦截器？不能一个实现所有功能吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Token-%E5%9C%A8%E5%89%8D%E7%AB%AF%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8%EF%BC%9F%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E8%A2%AB%E7%9B%97%E7%94%A8%EF%BC%9F"><span class="toc-number">1.0.15.</span> <span class="toc-text">5.Token 在前端如何存储？如何防止被盗用？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8-Access-Token-%E5%92%8C-Refresh-Token-%E5%8F%8C-token%EF%BC%9F"><span class="toc-number">1.0.16.</span> <span class="toc-text">6.为什么要使用 Access Token 和 Refresh Token 双 token？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-Refresh-Token-%E8%A6%81%E4%B8%8D%E8%A6%81%E5%AD%98-Redis%EF%BC%9F"><span class="toc-number">1.0.17.</span> <span class="toc-text">7.Refresh Token 要不要存 Redis？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-Refresh-Token-%E8%BF%87%E6%9C%9F%E5%90%8E%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">1.0.18.</span> <span class="toc-text">8.Refresh Token 过期后怎么办？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2-Refresh-Token-%E8%A2%AB%E7%9B%97%E7%94%A8%EF%BC%9F"><span class="toc-number">1.0.19.</span> <span class="toc-text">9.如何防止 Refresh Token 被盗用？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%94%AF%E6%A1%A3%E7%BC%96%E5%86%99%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="toc-number">2.</span> <span class="toc-text">接口支档编写与测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Swagger-%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%EF%BC%9F%E4%BD%BF%E7%94%A8%E5%AE%83%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E5%8A%BF%EF%BC%9F"><span class="toc-number">2.0.0.1.</span> <span class="toc-text">1.Swagger 有什么作用？使用它有什么优势？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Swagger-%E5%9C%A8-Spring-Boot-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%A6%82%E4%BD%95%E6%8E%A5%E5%85%A5%EF%BC%9F"><span class="toc-number">2.0.0.2.</span> <span class="toc-text">2.Swagger 在 Spring Boot 项目中如何接入？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Swagger-%E4%B8%8E-Postman-%E6%9C%89%E4%BD%95%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">2.0.0.3.</span> <span class="toc-text">3.Swagger 与 Postman 有何区别？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87-Swagger-%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3-Mock%EF%BC%9F"><span class="toc-number">2.0.0.4.</span> <span class="toc-text">4.如何通过 Swagger 实现接口 Mock？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-MOCK%E6%98%AF%E5%95%A5"><span class="toc-number">2.0.0.5.</span> <span class="toc-text">5.MOCK是啥</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E8%82%A1%E5%9B%9E%E7%AD%94"><span class="toc-number">3.</span> <span class="toc-text">八股回答</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BC%98%E6%83%A0%E5%8A%B5%E7%9A%84%E8%B6%85%E5%8D%96%E9%87%8D%E5%A4%8D%E9%97%AE%E9%A2%98%EF%BC%8C%E4%BD%BF%E7%94%A8lua%E8%84%9A%E6%9C%AC%E4%BF%9D%E6%8C%81%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-number">3.1.</span> <span class="toc-text">1.优惠劵的超卖重复问题，使用lua脚本保持原子性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-lua%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E5%BC%82%E5%B8%B8"><span class="toc-number">3.2.</span> <span class="toc-text">2.lua脚本执行异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8-Redis-Lua-%E5%81%9A%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E6%97%B6%EF%BC%8C%E7%BD%91%E7%BB%9C%E5%BB%B6%E8%BF%9F%E5%AF%B9-CAS-%E6%93%8D%E4%BD%9C%E7%9A%84%E5%BD%B1%E5%93%8D%E5%8F%8A%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%B9%B6%E5%8F%91%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%9F"><span class="toc-number">3.3.</span> <span class="toc-text">3.使用 Redis+Lua 做原子操作时，网络延迟对 CAS 操作的影响及如何保证并发原子性？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%9C%A8-%E2%80%9C%E6%A0%A1%E5%9B%AD%E9%A4%90%E9%A5%AE%E7%B3%BB%E7%BB%9F%E2%80%9D-%E9%A1%B9%E7%9B%AE%E9%87%8C%EF%BC%8C%E4%BD%A0%E7%94%A8-AOP-%E5%AE%9E%E7%8E%B0%E4%BA%86%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97%E8%87%AA%E5%8A%A8%E8%AE%B0%E5%BD%95%EF%BC%8C%E8%AE%B2%E8%AE%B2-AOP-%E5%88%87%E7%82%B9%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9A%E4%B9%89%E7%9A%84%EF%BC%8C%E6%80%8E%E4%B9%88%E7%A1%AE%E4%BF%9D%E5%8F%AA%E6%8B%A6%E6%88%AA%E5%88%B0%E9%9C%80%E8%A6%81%E8%AE%B0%E5%BD%95%E6%97%A5%E5%BF%97%E7%9A%84%E5%85%B3%E9%94%AE%E4%B8%9A%E5%8A%A1%E6%96%B9%E6%B3%95%EF%BC%8C%E5%8F%88%E4%B8%8D%E4%BC%9A%E8%BF%87%E5%BA%A6%E6%8B%A6%E6%88%AA%E5%BD%B1%E5%93%8D%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E5%91%80%EF%BC%9F"><span class="toc-number">3.4.</span> <span class="toc-text">4.在 “校园餐饮系统” 项目里，你用 AOP 实现了操作日志自动记录，讲讲 AOP 切点是怎么定义的，怎么确保只拦截到需要记录日志的关键业务方法，又不会过度拦截影响系统性能呀？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%9C%A8-%E2%80%9C%E6%A0%A1%E5%9B%AD%E9%A4%90%E9%A5%AE%E7%B3%BB%E7%BB%9F%E2%80%9D-%E9%A1%B9%E7%9B%AE%E9%87%8C%EF%BC%8C%E4%BD%A0%E6%8F%90%E5%88%B0%E7%94%A8%E4%BA%86-Redis-%E5%AD%98%E5%82%A8-token-%E7%BC%93%E8%A7%A3%E5%8E%8B%E5%8A%9B%EF%BC%8C%E8%83%BD%E8%AE%B2%E8%AE%B2%E5%85%B7%E4%BD%93%E6%80%8E%E4%B9%88%E8%AE%BE%E8%AE%A1-key-%E7%9A%84%E7%BB%93%E6%9E%84%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C-token-%E5%AD%98%E5%82%A8%E5%92%8C%E8%AF%BB%E5%8F%96%E7%9A%84%E9%AB%98%E6%95%88%E6%80%A7%E4%B8%8E%E5%AE%89%E5%85%A8%E6%80%A7%E4%B8%8D%EF%BC%9F"><span class="toc-number">3.5.</span> <span class="toc-text">5.在 “校园餐饮系统” 项目里，你提到用了 Redis 存储 token 缓解压力，能讲讲具体怎么设计 key 的结构，以及如何保障 token 存储和读取的高效性与安全性不？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%82%A3%E4%B9%88%E4%BC%98%E6%83%A0%E5%8A%B5%E7%9A%84%E5%8F%91%E6%94%BE%E5%91%A2%EF%BC%9F%E4%B8%80%E4%BA%9B%E5%88%97%E7%9A%84%E9%97%AE%E9%A2%98%E5%91%A2"><span class="toc-number">3.6.</span> <span class="toc-text">6.那么优惠劵的发放呢？一些列的问题呢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%9C%8B%E4%BD%A0%E5%9C%A8%E4%BC%98%E6%83%A0%E5%8A%B5%E7%9A%84%E5%8F%91%E6%94%BE%E7%9A%84%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8%E9%99%90%E6%B5%81%EF%BC%8C%E6%80%8E%E4%B9%88%E8%AE%BE%E8%AE%A1%E7%9A%84"><span class="toc-number">3.7.</span> <span class="toc-text">7.看你在优惠劵的发放的时候使用限流，怎么设计的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E4%BD%A0%E9%A1%B9%E7%9B%AE%E9%87%8C%E7%94%A8%E4%BA%86JWT%E5%8A%A0%E5%8F%8C-Token%EF%BC%8C%E5%85%B7%E4%BD%93%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%BE%E8%AE%A1%E7%9A%84%EF%BC%9F%E4%B8%A4%E4%B8%AA-Token-%E5%90%84%E8%87%AA%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E6%8B%A6%E6%88%AA%E5%99%A8%E5%8F%88%E5%88%86%E5%88%AB%E5%A4%84%E7%90%86%E4%BB%80%E4%B9%88%E9%80%BB%E8%BE%91%EF%BC%9F%E6%AF%94%E5%A6%82%E6%9C%89%E6%B2%A1%E6%9C%89%E8%80%83%E8%99%91%E8%BF%87-Token-%E8%BF%87%E6%9C%9F%E3%80%81%E5%88%B7%E6%96%B0%E6%9C%BA%E5%88%B6%EF%BC%8C%E6%88%96%E8%80%85%E9%98%B2%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">3.8.</span> <span class="toc-text">8.你项目里用了JWT加双 Token，具体是怎么设计的？两个 Token 各自的作用是什么？拦截器又分别处理什么逻辑？比如有没有考虑过 Token 过期、刷新机制，或者防重放攻击的问题？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%A0%A1%E5%9B%AD%E9%A4%90%E9%A5%AE%E7%B3%BB%E7%BB%9F%E2%80%9D%E4%B8%AD%E7%94%A8-Redis-Lua-%E8%84%9A%E6%9C%AC-%E8%A7%A3%E5%86%B3%E6%94%AF%E4%BB%98%E4%B8%8E%E5%BA%93%E5%AD%98%E6%89%A3%E5%87%8F%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%E7%9A%84%E5%9B%9E%E7%AD%94"><span class="toc-number">3.9.</span> <span class="toc-text">9.校园餐饮系统”中用 Redis + Lua 脚本 解决支付与库存扣减一致性问题的回答</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8-ThreadLocal-%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%EF%BC%9F%E5%92%8C%E7%9B%B4%E6%8E%A5%E4%BC%A0%E5%8F%82%E6%88%96%E6%94%BE%E5%88%B0%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">3.10.</span> <span class="toc-text">10.为什么要用 ThreadLocal 保存用户信息？和直接传参或放到全局变量有什么区别？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E4%BD%A0%E9%99%90%E6%B5%81%E6%98%AF%E6%80%8E%E4%B9%88%E5%81%9A%E7%9A%84%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89-Bucket4j%EF%BC%9FAOP-%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B5%B7%E4%BA%86%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%EF%BC%9F"><span class="toc-number">3.11.</span> <span class="toc-text">11.你限流是怎么做的？为什么选 Bucket4j？AOP 在这里起了什么作用？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%91%E6%94%BE%E4%BC%98%E6%83%A0%E5%88%B8%E8%A6%81%E7%94%A8-Lua-%E8%84%9A%E6%9C%AC%EF%BC%9F%E8%84%9A%E6%9C%AC%E4%B8%AD%E9%83%BD%E5%81%9A%E4%BA%86%E5%93%AA%E4%BA%9B%E4%BA%8B%EF%BC%9F%E4%BD%A0%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%B9%82%E7%AD%89%E6%80%A7%E5%92%8C%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%9F"><span class="toc-number">3.12.</span> <span class="toc-text">12.为什么发放优惠券要用 Lua 脚本？脚本中都做了哪些事？你如何保证幂等性和原子性？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97%E6%98%AF%E6%80%8E%E4%B9%88%E8%87%AA%E5%8A%A8%E8%AE%B0%E5%BD%95%E7%9A%84%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8-AOP-%E5%AE%9E%E7%8E%B0%EF%BC%9F"><span class="toc-number">3.13.</span> <span class="toc-text">13.操作日志是怎么自动记录的？为什么要用 AOP 实现？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-%E4%BD%A0%E8%AF%B4%E7%94%A8-Nginx-%E8%A7%A3%E5%86%B3%E4%BA%86%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%EF%BC%8C%E6%98%AF%E6%80%8E%E4%B9%88%E9%85%8D%E7%BD%AE%E7%9A%84%EF%BC%9F%E6%9C%89%E6%B2%A1%E6%9C%89%E8%80%83%E8%99%91%E8%BF%87-CORS-%E6%96%B9%E6%A1%88%EF%BC%9F"><span class="toc-number">3.14.</span> <span class="toc-text">14.你说用 Nginx 解决了跨域问题，是怎么配置的？有没有考虑过 CORS 方案？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-CORS%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-number">3.15.</span> <span class="toc-text">15.CORS跨域问题</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/07/01/workmenu/dianping/" title="黑马点评项目逻辑功能分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=aca3126e-c689-e724-3c7a-5abe15d5a1e5" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="黑马点评项目逻辑功能分析"/></a><div class="content"><a class="title" href="/2025/07/01/workmenu/dianping/" title="黑马点评项目逻辑功能分析">黑马点评项目逻辑功能分析</a><time datetime="2025-06-30T16:00:00.000Z" title="发表于 2025-07-01 00:00:00">2025-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/01/workmenu/dianping1/" title="黑马点评项目逻辑功能分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712175.jpg?_r_=b5dae4a2-d037-e78f-9a9e-69e198968293" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="黑马点评项目逻辑功能分析"/></a><div class="content"><a class="title" href="/2025/07/01/workmenu/dianping1/" title="黑马点评项目逻辑功能分析">黑马点评项目逻辑功能分析</a><time datetime="2025-06-30T16:00:00.000Z" title="发表于 2025-07-01 00:00:00">2025-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/01/workmenu/dianping2/" title="黑马点评项目知识分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=73a4f20f-5c9f-4302-1b46-7f07eaae3cb1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="黑马点评项目知识分析"/></a><div class="content"><a class="title" href="/2025/07/01/workmenu/dianping2/" title="黑马点评项目知识分析">黑马点评项目知识分析</a><time datetime="2025-06-30T16:00:00.000Z" title="发表于 2025-07-01 00:00:00">2025-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/30/towork/wokiing2/" title="面试面经"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722382.jpg?_r_=7041dda1-de61-b304-f93c-972fe17f8a06" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="面试面经"/></a><div class="content"><a class="title" href="/2025/06/30/towork/wokiing2/" title="面试面经">面试面经</a><time datetime="2025-06-29T16:00:00.000Z" title="发表于 2025-06-30 00:00:00">2025-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/27/workmenu/damai1/" title="大麦网业务分析-1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221818490.jpeg?_r_=7ff44af8-2bd2-beb0-ff43-fc28fbb2aa62" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="大麦网业务分析-1"/></a><div class="content"><a class="title" href="/2025/06/27/workmenu/damai1/" title="大麦网业务分析-1">大麦网业务分析-1</a><time datetime="2025-06-26T16:00:00.000Z" title="发表于 2025-06-27 00:00:00">2025-06-27</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Framework-Hexo-4e88f8?style=flat&logo=hexo" 
       title="博客框架为 Hexo" alt="Hexo">
</a>
<a style="margin-inline:5px" target="_blank" href="https://github.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Source-Github-24292f?style=flat&logo=github" 
       title="本站项目由 GitHub 托管" alt="GitHub">
</a>
<a style="margin-inline:5px" target="_blank" href="https://vercel.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-Vercel-000000?style=flat&logo=vercel" 
       title="使用 Vercel 部署" alt="Vercel">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.qlu.edu.cn/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/University-齐鲁工业大学-0056a2?style=flat&logo=university" 
       title="齐鲁工业大学" alt="齐鲁工业大学">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.aliyun.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-阿里云-ff6a00?style=flat&logo=aliyun" 
       title="使用阿里云服务" alt="阿里云">
</a>
<a style="margin-inline:5px" target="_blank" href="https://cloud.tencent.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-腾讯云-0a73b8?style=flat&logo=tencent-cloud" 
       title="使用腾讯云服务" alt="腾讯云">
</a></p>
</div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2025 By <a class="footer-bar-link" href="/" title="mengnankkzhou" target="_blank">mengnankkzhou</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="鲁ICP备2024110758号">鲁ICP备2024110758号</a><a class="footer-bar-link" href="https://blog.tokenlen.top/rss2.xml" title="Rss">Rss</a><a class="footer-bar-link cc" href="/pravite" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">146</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">43</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">25</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 0.88rem;">BF<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 0.88rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 0.88rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 0.88rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 0.88rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 0.88rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 0.88rem;">FI<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 0.88rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>12</sup></a><a href="/tags/Nginx/" style="font-size: 0.88rem;">Nginx<sup>1</sup></a><a href="/tags/XSS/" style="font-size: 0.88rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>2</sup></a><a href="/tags/docker/" style="font-size: 0.88rem;">docker<sup>1</sup></a><a href="/tags/football/" style="font-size: 0.88rem;">football<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>52</sup></a><a href="/tags/juc/" style="font-size: 0.88rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 0.88rem;">jvm<sup>2</sup></a><a href="/tags/leetcode/" style="font-size: 0.88rem;">leetcode<sup>8</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>16</sup></a><a href="/tags/net/" style="font-size: 0.88rem;">net<sup>6</sup></a><a href="/tags/php/" style="font-size: 0.88rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 0.88rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 0.88rem;">python<sup>3</sup></a><a href="/tags/redis/" style="font-size: 0.88rem;">redis<sup>3</sup></a><a href="/tags/rocketmq/" style="font-size: 0.88rem;">rocketmq<sup>2</sup></a><a href="/tags/shell/" style="font-size: 0.88rem;">shell<sup>4</sup></a><a href="/tags/spring/" style="font-size: 0.88rem;">spring<sup>2</sup></a><a href="/tags/spring-boot/" style="font-size: 0.88rem;">spring boot<sup>14</sup></a><a href="/tags/sql/" style="font-size: 0.88rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>3</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 0.88rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 0.88rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>18</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 0.88rem;">正则表达式<sup>2</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 0.88rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>9</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 0.88rem;">面试<sup>15</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 mengnankkzhou 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@3.2.2/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://comment.tokenlen.top/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, "siu~~~~~"))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://comment.tokenlen.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '3ZpuzQHHKWfFH59QFYmcuCvr-gzGzoHsz',
      appKey: '8DIvljObQp853ueQMZzpb9Gx',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Twikoo' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://comment.tokenlen.top/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>