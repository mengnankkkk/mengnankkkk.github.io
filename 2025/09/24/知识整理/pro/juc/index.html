<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>JUC八股分析 | mengnankkのblog</title><meta name="keywords" content="面试"><meta name="author" content="mengnankkzhou"><meta name="copyright" content="mengnankkzhou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="JUC八股分析"><meta name="application-name" content="JUC八股分析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="JUC八股分析"><meta property="og:url" content="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/juc/index.html"><meta property="og:site_name" content="mengnankkのblog"><meta property="og:description" content="JUC 1.线程池常见的坑   线程池的参数配置：核心线程的数量，和最大线程的数量是业务场景来的，CPU密集型，比如数据的计算业务，就是CPU的数量+1。 IO密集型根据业务压测的值来决定的，最佳线程数&amp;#x3D;（（线程等待时间+线程CPU时间）&amp;#x2F;线程CPU时间）*CPU数量   比如，我们服务器CPU核数"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712177.jpg?_r_=bffe3125-e84a-0997-69ce-69203ebc3bdd"><meta property="article:author" content="mengnankkzhou"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712177.jpg?_r_=bffe3125-e84a-0997-69ce-69203ebc3bdd"><meta name="description" content="JUC 1.线程池常见的坑   线程池的参数配置：核心线程的数量，和最大线程的数量是业务场景来的，CPU密集型，比如数据的计算业务，就是CPU的数量+1。 IO密集型根据业务压测的值来决定的，最佳线程数&amp;#x3D;（（线程等待时间+线程CPU时间）&amp;#x2F;线程CPU时间）*CPU数量   比如，我们服务器CPU核数"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/juc/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走啊，那种事情不要啊","backTitle":"♪(^∇^*)欢迎回家！！！！"},
  LA51: undefined,
  greetingBox: {"enable":"ture","default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://comment.tokenlen.top/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"\tbd9428de12b54b96b2f1b4e69aeee81f","mailMd5":"F37442226DA71492"},
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: mengnankkzhou","link":"链接: ","source":"来源: mengnankkのblog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'mengnankkのblog',
  title: 'JUC八股分析',
  postAI: '',
  pageFillDescription: 'JUC, 1.线程池常见的坑, 2.AQS的大局解析, 3.waitsleepnotify的区别, 4.异步编排, 5.synchronized 锁升级的细节追问, 6.ThreadLocal, 7.谈谈怎么理解线程安全的, 8.**@ConditionalOnClass**设计内涵, 9.ThreadLocal 在线程池中的失效问题, 10.如何保证三个线程有序执行任务, 11.ReentrantLock 和 synchronized 在性能上到底差异在哪？, 12 JMM 内存模型与 volatile 的可见性保证, 13.死锁线程池常见的坑线程池的参数配置核心线程的数量和最大线程的数量是业务场景来的密集型比如数据的计算业务就是的数量密集型根据业务压测的值来决定的最佳线程数线程等待时间线程时间线程时间数量比如我们服务器核数为核任务线程耗时线程等待等等耗时那么最佳线程数线程那我们最大线程数就是个共享线程池次要的逻辑拖垮主要的逻辑避免所有的业务都共享一个线程池防止一个次要的业务一直在执行业务占用线程池而主要的业务并没有足够的线程数来执行影响到了我们主要的服务这样做是不合理的我们应该要做线程池的隔离使用方法的时候使用带超时时间的因为他是阻塞的防止被其他抢占是中一个注解他不是线程池他其实是不会复用线程适合执行大量短时间的线程还是尽量自己定义一个异步的线程池然后使用来注册使用线程池的时候不使用参数来自定义命名这样导致后期不好排查问题和回溯问题使用提交任务不会把异常直接抛出来最好我们在之中进行进行捕获或者是在时捕获并记录异常线程池使用完之后记得关闭防止内存泄漏的问题最好线程池设计成单例的模式长期运行的全局线程池如管理的不需手动关闭临时线程池需在中调用线程池不要和事务一起使用使用的时候依赖于当前线程的线程上下文而线程池的线程和当前事务的线程不是一个线程事务的上下文不会传递导致线程池中的业务代码不在事务中执行事务就失效了我们可以将事务放在线程池之外进行这是最好的方法或者是使用支持事务上下文传递的机制如消息队列保证一致性我们要负责监控线程池状态比如当前活跃的线程池的数量队列的长度拒绝的次数要配置合理的拒绝策略比如一个需要快速获取结果的线程就需要胚子和这样的话谁提交谁执行回退给调用的线程执行过程判断核心线程数是否已满当前运行的线程数是则直接创建一个新的核心线程来执行任务即使其他核心线程现在是空闲的否进入判断任务队列是否已满是否成功是任务入队成功等待空闲线程来处理否进入判断最大线程数是否已满当前运行的线程数是则创建一个新的非核心线程来执行任务否进入执行拒绝策略调用的大局解析分析的设计思想是将同步状态的管理和线程的排队阻塞唤醒机制进行分离它采用的是模板方法设计模式本身提供了一套通用的线程排队和管理框架而将具体的同步状态即锁的获取与释放逻辑交给子类去实现底层通过一个的变量的队列来实现线程安全的资源性抢夺表示资源的状态独占锁里面没人占就是已经上锁可重入锁里面数字代表可重入的次数提供了和这三个方法来安全地读写其中是一个原子操作它利用了级别的指令保证了在高并发场景下修改的线程安全这是实现所有同步器的基础线程要抢不到锁就会被挂到队列里面进行排队队列是双向链表实现的队列节点记录了等待状态信息等节点结构队列中的每个节点都封装了一个等待获取锁的线程的关键属性包括节点所包装的线程指向前驱和后继节点的指针构成双向链表节点的状态非常关键例如表示后继节点需要被唤醒表示节点因超时或中断已取消等待统一的排队与唤醒机制当一个线程尝试获取同步状态失败时例如返回就会将这个线程包装成一个节点并将其以自旋的方式安全地插入到队列的尾部然后该线程就会在这个队列中排队当持有锁的线程释放同步状态时例如调用方法获取锁和解锁的过程获取锁尝试用修改从到如果成功则获取锁成功将锁持有者设为当前线程如果失败说明锁被占用则将当前线程包装成一个节点加入到队列的尾部加入队列后线程会自旋一小会儿再次尝试获取锁如果还是失败则调用挂起当前线程等待被唤醒释放锁修改的值比如减如果变为说明锁已完全释放则找到队列头节点的下一个节点调用唤醒它让它去竞争锁独占锁的入队过程剖析以为例我们来详细看一下线程获取锁失败后的入队过程这个过程主要发生在的方法中这是由子类实现的方法它定义了获取锁的具体逻辑包括处理可重入公平与非公平策略等如果此方法返回表示成功获取锁方法直接结束如果返回表示获取锁失败需要进入排队流程当失败此方法被调用负责将当前线程包装成一个并加入到队列尾部首先它会创建一个代表当前线程的模式为独占模式的新节点然后它会尝试一次快速路径的操作试图直接将新节点设置为队尾如果快速路径失败通常是因为有其他线程也在同时修改队尾则会进入一个被称为的方法方法内部是一个死循环自旋通过不断尝试直到成功将节点原子地添加到队尾为止这个自旋操作保证了在高并发下入队操作的线程安全节点成功入队后方法负责处理后续的逻辑在队列中自旋阻塞以及被唤醒后再次尝试获取锁线程进入一个近乎死循环的流程在每次循环中它会检查当前节点的前驱节点是否是头节点如果是这意味着它排在最前面有资格去获取锁于是它会再次调用如果成功它就会将自己设置为新的节点并将旧的节点断开连接帮助然后方法返回如果不是或者尝试获取锁再次失败线程就需要被挂起挂起等待在挂起之前线程会调用方法检查并设置前驱节点的为这个状态的含义是前驱节点当你释放锁的时候请务必唤醒我后继节点设置成功后线程就会调用其内部的核心就是此时当前线程就会被挂起放弃进入等待状态至此一个获取锁失败的线程就完成了从尝试获取到封装成节点再到安全入队最后被挂起的完整流程唤醒机制与的本质区别当一个线程调用释放锁时的方法会唤醒节点的后继节点这个唤醒操作底层依赖的就是是一个非常底层的线程工具类和是它的核心方法工作原理每个线程都有一个与之关联的许可这个许可是一个二元信号量要么是要么是如果线程的是它会消耗掉这个并立即返回如果是线程就会被阻塞直到有其他线程为它颁发它会将指定线程的设置为如果这个线程当前正因而阻塞它会立即被唤醒如果它当前没有被阻塞那么下一次它调用时就会直接消耗掉这个而不会阻塞精确唤醒正是利用了的这个特性当一个线程释放锁时它能准确地从队列中找到需要被唤醒的下一个节点并直接唤醒那个特定的线程这是一种点对点的精确的通知机制的区别和的主要区别在于所属类不同是类的方法是类的静态方法会释放对象锁而保持锁不释放必须在同步代码块中调用没有此限制需要或来唤醒而在超时或被中断时自动恢复使用场景上用于线程间的协作用于简单的延时操作方法使当前线程进入等待状态将其从运行状态转变为等待状态并将其加入到等待池中依赖关系不同必须在代码块中调用它们依赖于对象的监视器锁一个线程必须先持有这个对象的锁才能调用该对象的或方法是一个更底层的静态的方法它不依赖于任何锁可以在任何地方调用它直接作用于线程本身唤醒的精确性不同是从等待队列中随机唤醒一个线程你无法指定唤醒哪一个则会唤醒所有等待的线程造成惊群效应大量被唤醒的线程会再次竞争同一个锁导致不必要的上下文切换开销能够精确唤醒指定的线程利用这一点实现了高效有序的唤醒调用顺序的灵活性如果在之前被调用那么这个信号就会丢失可以在之前调用给予线程的不会丢失如果一个线程先被然后它再调用它将不会阻塞这个特性使得在处理并发时能够避免一些棘手的竞态条件中断响应调用的线程被中断时会抛出异常并且会清除中断状态调用的线程被中断时方法会返回但不会抛出异常它可以通过来检查中断状态正是利用这一点在方法中处理中断总结一下是关键字和监视器模型的一部分而是一个更底层更灵活的线程阻塞原语选择而非正是看中了它的精确唤醒能力和与锁解耦的灵活性这使得能够构建出比更高效功能更强大的同步器异步编排在我看来异步编排的核心思想是将多个独立的耗时的异步任务尤其是密集型任务组合编排起来让它们尽可能地并行执行最终汇总结果从而极大地缩短整体的响应时间这在微服务架构中尤其重要在现代开发中实现异步编排最核心的工具就是举一个我们项目中非常典型的例子获取商品详情页数据一个商品详情页通常需要展示多种信息而这些信息可能来自不同的微服务或数据库表任务调用商品服务获取商品基本信息任务调用用户服务获取当前用户的优惠券信息任务调用评论服务获取商品的热门评论任务调用推荐服务获取相关商品推荐如果采用传统的同步调用方式总耗时将是的累加但实际上这四个任务没有任何依赖关系完全可以并行执行通过异步编排理想情况下的总耗时将仅仅取决于耗时最长的那一个任务即性能会得到指数级的提升实现任务并行化为每一个独立的调用任务创建一个实例关键是使用方法并为其提供一个自定义的线程池这可以避免耗尽服务器如的业务线程池结果编排与组合当所有并行的任务都完成后我需要将它们的结果组合成一个最终的我会使用来等待所有任务完成最终结果处理在完成后通过或来执行最终的组装逻辑异常处理与超时控制在生产环境中还需要考虑健壮性我会使用来处理任何一个异步任务的失败返回一个默认值或降级数据同时使用为整个编排流程设置一个最大等待时间防止因为某个下游服务缓慢而导致整个请求长时间阻塞锁升级的细节追问线程是如何从偏向锁升级到轻量级锁的是如何判断偏向失效的偏向锁的核心思想是它偏向于第一个获取它的线程认为在接下来的执行中锁将一直被这个线程持有偏向状态当一个线程第一次获取锁时会通过操作尝试将锁对象头中的线程指向当前线程如果成功就获取了偏向锁升级触发点当另一个线程线程尝试获取这个已经被线程持有的偏向锁时升级过程就被触发了偏向锁的撤销首先线程的操作会失败会检查中记录的线程是否是线程会暂停线程在一个全局安全点然后检查线程是否还存活如果线程已经执行完毕那么锁对象恢复到无锁状态线程可以重新尝试获取如果线程仍然存活且还在同步块内说明发生了真正的竞争此时偏向锁就会被撤销锁对象头的会被修改清除偏向锁标志并升级为轻量级锁的状态同时线程的栈帧中会创建锁记录指向锁对象之后线程和线程都会在轻量级锁的状态下进行竞争通过自旋只不过目前在中被默认禁用并在被完全移除因为偏向锁的撤销消耗的性能是比较大的那轻量级锁又是如何升级到重量级锁的自旋失败后发生了什么轻量级锁的核心思想是它认为锁的竞争时间会非常短线程只需要稍等一下自旋就可以拿到锁从而避免了线程阻塞和唤醒带来的内核态切换开销轻量级锁的获取线程在自己的栈帧中创建锁记录然后通过操作尝试将锁对象的指向这个锁记录如果成功就获取了轻量级锁自旋等待如果失败说明锁已被其他线程持有当前线程并不会立即阻塞而是会进行自旋即执行一个空循环不断地重试操作升级触发点升级到重量级锁主要有两种情况自旋失败自旋的次数是有限的会动态调整比如次如果一个线程自旋了指定次数后仍然没有获取到锁就认为竞争已经非常激烈了不适合再空耗现代采用的是自适应自旋这意味着自旋的次数不是固定的会根据上一次在该锁上的自旋时间以及锁的拥有者的状态来决定自旋的次数如果对于某个锁自旋很少成功那么下一次可能会减少自旋次数甚至不自旋反之如果自旋经常成功会认为自旋的期望收益很高可能会允许更长的自旋时间竞争者过多如果在自旋过程中又有第三个线程也来竞争这把锁那么也会立即触发升级锁膨胀一旦触发升级锁就会膨胀为重量级锁它会向操作系统申请一个互斥量并创建一个与之关联的对象锁对象的会被修改指向一个重量级锁的监视器对象并更新锁标志位为表示该锁已进入重量级状态所有等待锁的线程包括正在自旋的线程和后来者都不再自旋而是会被阻塞并放入的等待队列中内部维护了两个队列竞争队列和等待队列未能获取到锁的线程如线程和会被封装成特定的节点放入队列中然后这些线程会调用操作系统提供的同步原语例如下的从而被挂起阻塞进入状态并让出当持有锁的线程释放锁时会唤醒等待队列中的一个线程进行新一轮的锁竞争这个过程就涉及到了操作系统的互斥量和线程的上下文切换锁的升级是单向的只能从低级别到高级别不能降级在的实现中为什么是操作系统层面的动作线程调度权用户程序本身没有权力去剥夺一个正在运行的线程的使用权并把它挂起这个权力属于操作系统的内核内核维护着所有进程和线程的状态并负责调度哪个线程在哪个核心上运行系统调用当需要阻塞一个线程时它必须通过系统调用向操作系统内核发出请求这个请求会触发一次从用户态到内核态的切换用户态到内核态切换的性能消耗上下文保存与恢复在切换时需要保存当前用户态线程的所有运行状态包括寄存器值程序计数器栈指针等然后加载内核执行相关操作所需要的上下文当操作完成后再从内核态切回用户态这个过程需要恢复之前保存的用户线程上下文这一来一回是纯粹的性能开销缓存失效切换到内核态运行时可能会使用与用户态程序不同的数据和指令这会导致的高速缓存以及地址翻译后备缓冲器中的缓存数据失效当切回用户态时需要重新从主内存加载数据这会显著降低程序的执行速度内核处理开销内核执行线程的挂起和后续的唤醒调度本身也需要时间唤醒过程当持有重量级锁的线程执行完同步代码块释放锁时它会唤醒中的一个或多个等待线程这个唤醒过程同样需要陷入内核态由操作系统来完成操作系统会将某个被唤醒的线程的状态从改为并将其放入就绪队列等待下一次被调度既然用弱引用会导致内存泄漏那为什么的设计者不把也设计成强引用呢或者为什么不把也设计成弱引用为什么不能是强引用假设是强引用那么对象会通过这个强引用着对象只要线程本身不消亡这个强引用链对象就一直存在这意味着即使我们在业务代码中已经不再使用某个对象了比如只要这个线程还在线程池中被复用这个对象本身就永远无法被回收这会导致对象本身的泄漏比现在的情况更糟糕为什么不能是弱引用的核心目的就是让我们存放一些与线程绑定的数据这些数据通常是我们业务逻辑中需要用到的对象比如用户信息对象数据库连接等如果我们把也设计成弱引用那么当一次发生时只要这个对象在其他地方没有被强引用它就可能被意外地回收掉这会导致我们调用时突然得到一个值这完全违背了的设计初衷会引发严重的业务逻辑错误我们存放进去的对象必须保证在之前是可靠存在的所以必须是强引用因此只能做出了个权衡使用弱引用是为了当对象本身在外部不再被使用时能够回收它从而让中的的变为为后续的清理提供了可能性使用强引用是为了保证我们存放的数据的生命周期是可控的不会被意外回收谈谈怎么理解线程安全的线程安全指的是当多个线程同时访问一个对象或方法时无论操作系统如何调度这些线程也无需调用方在代码中去做额外的同步处理都能保证程序的正确性不会出现数据损坏或不一致的情况线程不安全的问题通常会表现在三个方面原子性一个或多个操作作为一个不可分割的整体来进行要去这个操作序列必须由一个线程独占完整的去执行不能被其他线程所干扰调不可被中断可见性一个线程修改了一个共享变量的值这个修改的值能够被其他线程看到但是实际在的高速缓存下对指令做出的重排序操作导致共享变量的值对其他线程不是立即课件的缓存读的旧值有序性写的代码的顺序和实际代码的顺序不一致是由于编译器和处理器层面对指令重排优化导致的可能会导致可见性问题我们可以使用或者是直接加或者是直接加锁或者使用原子类的或者是线程安全的设计内涵面试官提出了一个非常精妙的问题这行代码能编译通过说明肯定存在于中那为什么还需要这个注解呢未能理解系列注解是为了解决通用模块在不同应用环境下的适配性问题而不是为了解决当前项目中的类是否存在的问题确实如果在我当前的项目中写这个条件判断看起来是多余的因为如果不存在我的项目根本无法编译通过这个注解的真正威力体现在开发通用的模块时想象一下我们正在开发一个这个希望能够同时支持阿里云短信和腾讯云短信我们的会提供两个自动配置类和负责创建阿里云短信服务的负责创建腾讯云短信服务的一个使用者应用项目在他的项目中引入了我们的他可能只想使用阿里云短信所以他只会在他的中添加阿里云的依赖而不会添加腾讯云的这时我们的如何智能地判断只加载阿里云的而不去加载腾讯云的呢如果去加载腾讯云的会因为缺少腾讯云的包而直接抛出导致应用启动失败我们就是使用在上我们会这样写当使用者的应用启动时会解析我们中的这两个自动配置类在解析时它会检查当前应用的中是否存在因为使用者添加了阿里云的依赖所以这个类存在条件满足这个配置类就会被加载阿里云的就会被创建在解析时它会检查中是否存在因为使用者没有添加腾讯云的依赖所以这个类不存在条件不满足这个配置类就会被优雅地跳过不会被加载从而避免了并不是为了判断我们自己项目里的类是否存在而是为了让我们开发的通用模块能够智能地感知和适配它所运行的应用环境根据应用环境中引入了哪些依赖来动态地决定哪些功能应该被激活这是实现约定大于配置和开箱即用的关键魔法之一在线程池中的失效问题之所以能够实现父子线程间的数据传递是因为在创建子线程时子线程的构造函数会检查父线程的这个如果它不为空子线程就会将父线程中的所有值拷贝一份到自己的中关键在于这个值的拷贝动作只发生在子线程被创建的那一瞬间在线程池的场景下工作线程通常在系统启动时就已经被预先创建好了并存放在池中当我们提交一个任务时线程池只是从池中取出一个已经存在的线程来执行我们的任务并没有这个动作为了解决这个问题阿里巴巴开源了一个非常强大的工具它专门用于解决在使用线程池等会池化线程的组件时实现父子线程任务提交者与任务执行者之间的上下文传递问题的优点在于它通过或手动包装的方式对线程池的等方法以及任务进行了装饰任务提交时当我们调用被装饰过的时会捕获当前线程父线程的值并将其打包进一个或对象中任务执行前当线程池中的某个工作线程开始执行这个被包装过的时在其方法的块开始处会将被打包的父线程值回放到当前工作线程的中任务执行后在块中会清理当前工作线程的将其恢复到执行任务之前的状态从而避免了数据串扰如何保证三个线程有序执行任务方案使用方案你需要自己管理锁状态变量循环防止伪唤醒保证锁释放代码量大且极易出错使用会唤醒所有等待的线程造成不必要的竞争而使用又存在风险如果错误地唤醒了不该被唤醒的线程比如唤醒了而不是信号就可能丢失导致程序死锁方案升级版提供了比更强大的功能对象则将机制从一个锁只有一个等待队列升级为一个锁可以有多个独立的等待队列我们可以为每个线程的等待室创建一个实现精准的点对点唤醒彻底避免了的信号丢失问题创建一个实例创建一个状态变量例如用于标识当前应该哪个线程执行为每个线程创建一个对象线程的逻辑获取锁在中执行块中执行任务更新状态精准唤醒线程线程和的逻辑与类似分别在自己的上并在执行完任务后更新并下一个线程的实现了有序执行通过实现了精准唤醒比更高效比更安全但还是比较复杂方案信号量接力信号量是控制同时访问特定资源的线程数量的工具我们可以创建两个初始许可为的信号量作为两个线程之间的接力棒创建两个信号量和线程的逻辑执行任务执行完毕后释放一个给的许可线程的逻辑首先尝试获取来自的许可如果许可未被释放将在此阻塞获取到许可后执行任务执行完毕后释放一个给的许可线程的逻辑首先尝试获取来自的许可获取到许可后执行任务代码清晰简单但需要创建个对象如果线程数量很多会增加一些对象管理的开销方案会创建一个单线程的线程池这个线程池的核心特性是它内部有一个无界的来存放任务并且永远只有一个工作线程来从队列中取出并执行任务这就天然地保证了所有提交给它的任务都会严格按照提交的顺序来串行执行创建一个单线程执行器定义三个任务或按顺序提交任务关闭线程池严格来说这是三个任务有序执行而不是三个不同的线程有序执行因为所有任务都是由同一个工作线程来执行的如果面试官的题目严格要求必须是三个不同的预先创建好的线程那么这个方案就不完全符合字面要求和在性能上到底差异在哪实现它是的关键字由层面直接实现其核心依赖于操作系统底层的互斥量开销获取和释放需要进行用户态到内核态的切换这是一个非常昂贵的操作涉及到线程上下文的切换和调度会消耗大量的时间实现它是一个类位于包下其核心是基于框架实现的开销在底层利用了这一原子指令和关键字在无竞争或低竞争的情况下可以通过操作直接在用户态完成锁的获取完全避免了内核态的切换因此性能极高性能一定优于这个说法在之前是成立的但在之后对进行了翻天覆地的优化引入了锁升级机制使其性能在很多场景下已经不输甚至优于偏向锁在只有一个线程访问同步块的场景下几乎没有同步开销性能极高轻量级锁当出现少量线程交替竞争时会使用自旋的方式尝试获取锁自旋也是在用户态完成的避免了线程阻塞和内核态切换性能同样很高重量级锁只有当竞争非常激烈自旋多次仍无法获取锁时才会升级为重量级锁退化到依赖操作系统的只不过有更多的功能可中断等待允许线程在等待锁的过程中响应中断可超时等待可以避免死等多条件变量一个可以创建多个对象实现更精细的线程通信内存模型与的可见性保证可见性并非指物理内存的划分而是一个抽象的用于规范多线程环境下内存访问行为的模型主内存这是所有线程共享的区域中所有的实例变量静态变量和数组元素都存储在这里工作内存这是每个线程私有的区域线程不能直接读写主内存中的变量而是需要先把变量从主内存拷贝一份副本到自己的工作内存中这个副本可能是的高速缓存寄存器等线程的所有操作读取赋值等都是针对其工作内存中的副本进行的操作完成后线程会在某个不确定的时间将修改后的变量值写回到主内存可见性问题的产生在这种模型下可见性问题就显而易见了如果线程修改了其工作内存中的共享变量但没有及时将其写回主内存那么线程在读取时仍然会从主内存读取旧值或者使用自己工作内存中更旧的缓存值此时线程的修改对线程就是不可见的如何保证立即可见关键字正是为了解决这个问题当一个变量被声明为后会对所有线程施加两条特殊的规则写操作的强制刷新当一个线程修改了一个变量的值会强制该线程立即将这个修改后的值从其工作内存写回到主内存中读操作的强制失效与加载当一个线程准备读取一个变量时会强制该线程先使其工作内存中关于该变量的副本失效然后必须直接从主内存中重新加载最新的值通过这一写一读的强制规定巧妙地打通了主内存与工作内存之间的壁垒任何线程对变量的写操作都会立刻被同步到主内存而任何线程对变量的读操作都必须从主内存获取这就确保了变量的修改对所有其他线程是立即可见的禁止重排性指令重排序的动机为了提升性能编译器和处理器可能会在不改变单线程程序执行结果的前提下对指令的执行顺序进行调整例如将没有数据依赖关系的指令并行执行但在多线程环境下这种优化可能会导致意想不到的严重后果例如著名的双重检查锁定单例模式失效问题内存屏障的作用为了禁止特定类型的重排序的实现依赖于一种特殊的底层硬件指令内存屏障也称内存栅栏或内存栅障内存屏障就像一个栅栏它向编译器和发出明确的指令所有在屏障之前的指令必须在屏障之前执行完毕所有在屏障之后的指令必须在屏障之后才能开始执行严禁将屏障前后的指令进行重排序即任何指令都不能越过这个屏障如何插入内存屏障针对变量的读写操作规定了具体的内存屏障插入策略在每个写操作之前插入一个屏障作用保证在写操作执行前其前面的所有普通写操作都已经执行完毕并且结果对其他处理器可见在每个写操作之后插入一个屏障作用防止写与后面可能有的读写或普通读写发生重排序这是最关键也是开销最大的屏障在每个读操作之后插入一个屏障和一个屏障作用保证读操作之后的所有普通读操作都在其后执行作用保证读操作之后的所有普通写操作都在其后执行通过在变量的读写操作前后插入这些精心设计的内存屏障成功地阻止了编译器和处理器对相关代码的激进优化从而确保了程序在并发环境下的有序性在所有内存屏障中屏障是功能最强开销最大的一个它通常被称为全能屏障它的作用是确保屏障之前的所有内存写操作的结果对屏障之后的所有内存读操作都是可见的具体作用可以分解为两部分刷新处理器写缓冲它会强制将当前处理器写缓冲中的所有数据刷新到主内存中这保证了在屏障之前的所有写操作其结果都对其他处理器变得可见清空处理器无效化队列它会处理无效化队列中的消息强制使本地缓存中与主内存不一致的数据失效这保证了在屏障之后的读操作能够获取到主内存中最新的数据死锁死锁定义指两个或两个以上的线程在执行过程中因争夺资源而造成的一种互相等待的现象若无外力干涉它们都将无法推进下去死锁的四个必要条件必须同时满足互斥条件一个资源每次只能被一个线程使用占有并等待一个线程因请求资源而阻塞时对已获得的资源保持不放不可剥夺线程已获得的资源在未使用完之前不能被强行剥夺只能在使用完后由自己释放循环等待若干线程之间形成一种头尾相接的循环等待资源关系如何避免死锁要避免死锁只需破坏上述四个必要条件中的任意一个即可破坏占有并等待实行资源一次性分配策略即线程在运行前一次性申请所有需要的资源破坏不可剥夺当一个线程占有部分资源并请求其他资源时如果请求不到可以主动释放它当前占有的资源接口的方法提供了这种可能性破坏循环等待最常用采用资源有序分配法对所有资源进行统一编号所有线程在申请资源时必须严格按照资源编号的递增或递减顺序进行申请这样就不会形成环路',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-10-07 19:41:16',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/rss2.xml" title="mengnankkのblog" type="application/rss+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">mengnankkのblog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://imgbed.mengnankk.asia/202407021650088.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imgbed.mengnankk.asia/202407021650088.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 1.05rem;">BF<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 1.05rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 1.05rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 1.05rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 1.05rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 1.05rem;">FI<sup>1</sup></a><a href="/tags/Go/" style="font-size: 1.05rem;">Go<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 1.05rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>12</sup></a><a href="/tags/OS/" style="font-size: 1.05rem;">OS<sup>1</sup></a><a href="/tags/WEB/" style="font-size: 1.05rem;">WEB<sup>1</sup></a><a href="/tags/XSS/" style="font-size: 1.05rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>2</sup></a><a href="/tags/football/" style="font-size: 1.05rem;">football<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>61</sup></a><a href="/tags/juc/" style="font-size: 1.05rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 1.05rem;">jvm<sup>2</sup></a><a href="/tags/markdown/" style="font-size: 1.05rem;">markdown<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 1.05rem;">mysql<sup>17</sup></a><a href="/tags/net/" style="font-size: 1.05rem;">net<sup>7</sup></a><a href="/tags/paper/" style="font-size: 1.05rem;">paper<sup>1</sup></a><a href="/tags/php/" style="font-size: 1.05rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 1.05rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 1.05rem;">python<sup>3</sup></a><a href="/tags/shell/" style="font-size: 1.05rem;">shell<sup>4</sup></a><a href="/tags/sql/" style="font-size: 1.05rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>3</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">操作系统<sup>2</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 1.05rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 1.05rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>20</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 1.05rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>9</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" style="font-size: 1.05rem;">软件工程<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" style="font-size: 1.05rem;">软件项目管理<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 1.05rem;">面试<sup>46</sup></a><a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 1.05rem;">项目<sup>3</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/01/"><span class="card-archive-list-date">一月 2026</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">十一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">26</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">15</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E7%BB%8F/" itemprop="url">面经</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>面试</span></a></span></div></div><h1 class="post-title" itemprop="name headline">JUC八股分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-10-07T11:41:16.354Z" title="更新于 2025-10-07 19:41:16">2025-10-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">10.7k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>33分钟</span></span><span class="post-meta-separator"></span><span id="" data-flag-title="JUC八股分析"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为济南"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>济南</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712177.jpg?_r_=bffe3125-e84a-0997-69ce-69203ebc3bdd"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/juc/"><header><a class="post-meta-categories" href="/categories/%E9%9D%A2%E7%BB%8F/" itemprop="url">面经</a><a href="/tags/%E9%9D%A2%E8%AF%95/" tabindex="-1" itemprop="url">面试</a><h1 id="CrawlerTitle" itemprop="name headline">JUC八股分析</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">mengnankkzhou</span><time itemprop="dateCreated datePublished" datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time><time itemprop="dateCreated datePublished" datetime="2025-10-07T11:41:16.354Z" title="更新于 2025-10-07 19:41:16">2025-10-07</time></header><h1>JUC</h1>
<h2 id="1-线程池常见的坑">1.线程池常见的坑</h2>
<ol>
<li>
<p>线程池的参数配置：核心线程的数量，和最大线程的数量是业务场景来的，CPU密集型，比如数据的计算业务，就是CPU的数量+1。</p>
<p>IO密集型根据业务压测的值来决定的，最佳线程数=（（线程等待时间+线程CPU时间）/线程CPU时间）*CPU数量</p>
</li>
</ol>
<p>比如，我们服务器CPU核数为8核，任务线程CPU耗时20ms,线程等待等等耗时80ms，那么最佳线程数=（80+20）/20*8=40线程，那我们最大线程数就是80个</p>
<ol start="2">
<li>共享线程池，次要的逻辑拖垮主要的逻辑。避免所有的业务都共享一个线程池，防止一个次要的业务一直在执行业务，占用线程池。而主要的业务并没有足够的线程数来执行，影响到了我们主要的服务。这样做是不合理的。我们应该要做线程池的隔离，使用Future.get方法的时候，使用带超时时间的，因为他是阻塞的，防止被其他抢占。</li>
<li>@Async是Spring中一个注解，他不是线程池，他其实是SimpleAsyncTaskExecutor，不会复用线程，适合执行大量短时间的线程。还是尽量自己定义一个异步的线程池，然后使用@EnableAsync来注册</li>
<li>使用线程池的时候，不使用threadfactory参数来自定义命名，这样导致后期不好排查问题和回溯问题</li>
<li>使用submit提交任务，不会把异常直接抛出来。最好我们在submit之中进行try-catch进行捕获，或者是在 <code>Future.get()</code> 时捕获并记录异常。</li>
<li>线程池使用完之后，记得关闭，防止内存泄漏的问题。最好线程池设计成单例的模式。长期运行的全局线程池（如 Spring 管理的）不需手动关闭，临时线程池需在 finally 中调用 <code>shutdown()</code>。</li>
<li>线程池不要和事务一起使用，使用@Transtation的时候，依赖于当前线程的线程上下文，而线程池的线程和当前事务的线程不是一个线程，事务的上下文不会传递，导致线程池中的业务代码不在事务中执行，事务就失效了。我们可以将事务放在线程池之外进行，这是最好的方法，或者是使用支持事务上下文传递的机制（如 <code>TransactionAwareDataSourceProxy</code>、消息队列保证一致性）</li>
<li>我们要负责监控线程池状态，比如当前活跃的线程池的数量，队列的长度，拒绝的次数</li>
<li>要配置合理的拒绝策略，比如一个需要快速获取结果的线程，就需要胚子和callerrunpolicy，这样的话，谁提交谁执行，回退给调用的线程。</li>
<li>执行过程：</li>
</ol>
<ul>
<li>Step 1: 判断核心线程数是否已满？
<ul>
<li>当前运行的线程数 &lt; <code>corePoolSize</code>？</li>
<li><strong>是：</strong> 则<strong>直接创建一个新的核心线程</strong>来执行任务，即使其他核心线程现在是空闲的。</li>
<li><strong>否：</strong> 进入 Step 2。</li>
</ul>
</li>
<li>Step 2: 判断任务队列是否已满？
<ul>
<li><code>workQueue.offer(task)</code> 是否成功？</li>
<li><strong>是：</strong> 任务入队成功，等待空闲线程来处理。</li>
<li><strong>否：</strong> 进入 Step 3。</li>
</ul>
</li>
<li>Step 3: 判断最大线程数是否已满？
<ul>
<li>当前运行的线程数 &lt; <code>maximumPoolSize</code>？</li>
<li><strong>是：</strong> 则<strong>创建一个新的非核心线程</strong>来执行任务。</li>
<li><strong>否：</strong> 进入 Step 4。</li>
</ul>
</li>
<li>Step 4: 执行拒绝策略。
<ul>
<li>调用 <code>rejectedExecutionHandler.rejectedExecution(task, this)</code>。</li>
</ul>
</li>
</ul>
<h2 id="2-AQS的大局解析">2.AQS的大局解析</h2>
<p>AQS分析：</p>
<p>AQS (AbstractQueuedSynchronizer) 的设计思想是<strong>将同步状态的管理和线程的排队、阻塞、唤醒机制进行分离</strong>。它采用的是<strong>模板方法设计模式</strong>，AQS 本身提供了一套通用的线程排队和管理框架，而将具体的同步状态（即“锁”的获取与释放逻辑）交给子类去实现。</p>
<p>底层通过一个volatile的state变量+FIFO的队列来实现线程安全的资源性抢夺</p>
<p>state表示资源的状态，独占锁里面0没人占，1就是已经上锁。可重入锁里面数字代表可重入的次数,AQS 提供了 <code>getState()</code>、<code>setState()</code> 和 <code>compareAndSetState()</code> (CAS) 这三个方法来安全地读写 <code>state</code>。其中，<code>compareAndSetState()</code> 是一个<strong>原子操作</strong>，它利用了 CPU 级别的 CAS 指令，保证了在高并发场景下修改 <code>state</code> 的线程安全。这是实现所有同步器的基础。</p>
<p>线程要抢不到锁，就会被挂到队列里面进行排队，队列是双向链表实现的CLH队列，节点记录了等待状态，信息等</p>
<p><strong>节点结构 (Node)</strong>：队列中的每个节点（<code>Node</code>）都封装了一个等待获取锁的线程。<code>Node</code> 的关键属性包括：</p>
<ul>
<li><code>thread</code>: 节点所包装的线程。</li>
<li><code>prev</code> / <code>next</code>: 指向前驱和后继节点的指针，构成双向链表。</li>
<li><code>waitStatus</code>: 节点的状态，非常关键。例如 <code>SIGNAL</code> (-1) 表示后继节点需要被唤醒；<code>CANCELLED</code> (1) 表示节点因超时或中断已取消等待。</li>
</ul>
<p><strong>统一的排队与唤醒机制</strong>： 当一个线程尝试获取同步状态失败时（例如，<code>tryAcquire</code> 返回 <code>false</code>），AQS 就会将这个线程包装成一个 <code>Node</code> 节点，并将其以<strong>自旋 + CAS</strong> 的方式安全地插入到队列的尾部。然后，该线程就会在这个队列中“排队”。 当持有锁的线程释放同步状态时（例如，调用 <code>release</code> 方法），</p>
<p>AQS获取锁和解锁的过程：</p>
<ul>
<li>获取锁 (acquire)：
<ol>
<li>尝试用 <strong>CAS</strong> 修改 <code>state</code> 从 0 到 1。</li>
<li>如果成功，则获取锁成功，将锁持有者设为当前线程。</li>
<li>如果失败，说明锁被占用。则将当前线程包装成一个 Node 节点，<strong>加入到 CLH 队列的尾部</strong>。</li>
<li>加入队列后，线程会<strong>自旋</strong>一小会儿，再次尝试获取锁。如果还是失败，则调用 <code>LockSupport.park()</code> <strong>挂起</strong>当前线程，等待被唤醒。</li>
</ol>
</li>
<li>释放锁 (release)：
<ol>
<li>修改 <code>state</code> 的值（比如减1）。</li>
<li>如果 <code>state</code> 变为 0，说明锁已完全释放。</li>
<li>则找到 CLH 队列头节点的<strong>下一个节点</strong>，调用 <code>LockSupport.unpark()</code> <strong>唤醒</strong>它，让它去竞争锁。</li>
</ol>
</li>
</ul>
<p>独占锁的入队过程剖析：</p>
<p>以 <code>ReentrantLock.lock()</code> 为例，我们来详细看一下线程获取锁失败后的入队过程。这个过程主要发生在 AQS 的 <code>acquire(int arg)</code> 方法中。</p>
<ol>
<li><strong><code>tryAcquire(arg)</code></strong>：
<ul>
<li>这是由子类 <code>ReentrantLock</code> 实现的方法，它定义了“获取锁”的具体逻辑，包括处理可重入、公平与非公平策略等。</li>
<li>如果此方法返回 <code>true</code>，表示成功获取锁，<code>acquire</code> 方法直接结束。</li>
<li>如果返回 <code>false</code>，表示获取锁失败，需要进入排队流程。</li>
</ul>
</li>
<li><strong><code>addWaiter(Node.EXCLUSIVE)</code></strong>：
<ul>
<li>当 <code>tryAcquire</code> 失败，此方法被调用，负责将当前线程包装成一个 <code>Node</code> 并加入到队列尾部。</li>
<li>首先，它会创建一个代表当前线程的、模式为<strong>独占模式</strong>（<code>Node.EXCLUSIVE</code>）的新节点。</li>
<li>然后，它会尝试一次“快速路径”的 CAS 操作，试图直接将新节点设置为队尾。</li>
<li>如果快速路径失败（通常是因为有其他线程也在同时修改队尾），则会进入一个被称为 <code>enq(Node node)</code> 的方法。<code>enq</code> 方法内部是一个<strong>死循环（自旋）</strong>，通过 CAS 不断尝试，直到成功将节点原子地添加到队尾为止。这个自旋操作保证了在高并发下入队操作的线程安全。</li>
</ul>
</li>
<li><strong><code>acquireQueued(Node node, int arg)</code></strong>：
<ul>
<li>节点成功入队后，<code>acquireQueued</code> 方法负责处理后续的逻辑：<strong>在队列中自旋、阻塞以及被唤醒后再次尝试获取锁</strong>。</li>
<li>线程进入一个近乎死循环的流程。在每次循环中，它会检查当前节点的前驱节点是否是头节点 (<code>head</code>)。
<ul>
<li><strong>如果是</strong>，这意味着它排在最前面，有资格去获取锁。于是它会再次调用 <code>tryAcquire(arg)</code>。如果成功，它就会将自己设置为新的 <code>head</code> 节点，并将旧的 <code>head</code> 节点断开连接（帮助 GC），然后方法返回。</li>
<li><strong>如果不是</strong>，或者尝试获取锁再次失败，线程就需要被挂起（Park）。</li>
</ul>
</li>
</ul>
</li>
<li><strong>挂起等待</strong>：
<ul>
<li>在挂起之前，线程会调用 <code>shouldParkAfterFailedAcquire</code> 方法，检查并设置前驱节点的 <code>waitStatus</code> 为 <code>SIGNAL</code>。这个状态的含义是：“前驱节点，当你释放锁的时候，请务必唤醒我（后继节点）”。</li>
<li>设置成功后，线程就会调用 <code>parkAndCheckInterrupt()</code>，其内部的核心就是 <code>LockSupport.park(this)</code>，此时当前线程就会被<strong>挂起</strong>，放弃 CPU，进入等待状态。</li>
</ul>
</li>
</ol>
<p>至此，一个获取锁失败的线程，就完成了从尝试获取、到封装成节点、再到安全入队、最后被挂起的完整流程。</p>
<p><code>LockSupport.park()</code> 唤醒机制与 <code>Object.wait/notify</code> 的本质区别:</p>
<p>当一个线程调用 <code>unlock()</code> 释放锁时，AQS 的 <code>release</code> 方法会唤醒 <code>head</code> 节点的后继节点，这个唤醒操作底层依赖的就是 <code>LockSupport.unpark(Thread thread)</code>。</p>
<p><code>LockSupport</code> 是一个非常底层的线程工具类，<code>park()</code> 和 <code>unpark()</code> 是它的核心方法。</p>
<ul>
<li><strong>工作原理</strong>：每个线程都有一个与之关联的 “许可”（permit），这个许可是一个二元信号量（要么是 0，要么是 1）。
<ul>
<li><code>LockSupport.park()</code>：如果线程的 permit 是 1，它会消耗掉这个 permit 并立即返回；如果 permit 是 0，线程就会被阻塞，直到有其他线程为它颁发 permit。</li>
<li><code>LockSupport.unpark(Thread thread)</code>：它会将指定线程 <code>thread</code> 的 permit 设置为 1。如果这个线程当前正因 <code>park()</code> 而阻塞，它会立即被唤醒；如果它当前没有被阻塞，那么下一次它调用 <code>park()</code> 时，就会直接消耗掉这个 permit 而不会阻塞。</li>
</ul>
</li>
<li><strong>精确唤醒</strong>：AQS 正是利用了 <code>unpark(thread)</code> 的这个特性。当一个线程释放锁时，它能准确地从 CLH 队列中找到需要被唤醒的下一个节点，并直接唤醒那个<strong>特定的线程</strong>。这是一种<strong>点对点</strong>的、精确的通知机制。</li>
</ul>
<h2 id="3-wait-sleep-notify的区别">3.wait,sleep,notify的区别</h2>
<p>wait()和sleep()的主要区别在于：</p>
<ol>
<li>所属类不同，wait()是Object类的方法，sleep()是Thread类的静态方法；</li>
<li>wait()会释放对象锁，而sleep()保持锁不释放；</li>
<li>wait()必须在同步代码块中调用，sleep()没有此限制；</li>
<li>wait()需要notify()或notifyAll()来唤醒，而sleep()在超时或被中断时自动恢复；</li>
<li>使用场景上，wait()用于线程间的协作，sleep()用于简单的延时操作。</li>
</ol>
<p>wait()方法使当前线程进入等待状态，将其从运行状态转变为等待状态，并将其加入到等待池中。</p>
<p>Object.wait()/notify():</p>
<ol>
<li><strong>依赖关系不同</strong>：
<ul>
<li><code>wait/notify</code> 必须在 <code>synchronized</code> 代码块中调用，它们依赖于对象的监视器锁（Monitor）。一个线程必须先持有这个对象的 monitor 锁，才能调用该对象的 <code>wait</code> 或 <code>notify</code> 方法。</li>
<li><code>park/unpark</code> 是一个更底层的、静态的方法，它不依赖于任何锁，可以在任何地方调用。它直接作用于线程本身。</li>
</ul>
</li>
<li><strong>唤醒的精确性不同</strong>：
<ul>
<li><code>notify()</code> 是从等待队列中<strong>随机唤醒一个</strong>线程，你无法指定唤醒哪一个。<code>notifyAll()</code> 则会唤醒所有等待的线程，造成“惊群效应”，大量被唤醒的线程会再次竞争同一个锁，导致不必要的上下文切换开销。</li>
<li><code>unpark(thread)</code> 能够<strong>精确唤醒指定的线程</strong>，AQS 利用这一点实现了高效、有序的唤醒。</li>
</ul>
</li>
<li><strong>调用顺序的灵活性</strong>：
<ul>
<li>如果 <code>notify()</code> 在 <code>wait()</code> 之前被调用，那么这个 <code>notify</code> 信号就会<strong>丢失</strong>。</li>
<li><code>unpark()</code> 可以在 <code>park()</code> 之前调用。<code>unpark</code> 给予线程的 “permit” 不会丢失。如果一个线程先被 <code>unpark</code>，然后它再调用 <code>park</code>，它将不会阻塞。这个特性使得 <code>park/unpark</code> 在处理并发时能够避免一些棘手的竞态条件。</li>
</ul>
</li>
<li><strong>中断响应</strong>：
<ul>
<li>调用 <code>wait()</code> 的线程被中断时，会抛出 <code>InterruptedException</code> 异常，并且会清除中断状态。</li>
<li>调用 <code>park()</code> 的线程被中断时，<code>park</code> 方法会返回，但不会抛出异常。它可以通过 <code>Thread.interrupted()</code> 来检查中断状态。AQS 正是利用这一点在 <code>acquireQueued</code> 方法中处理中断。</li>
</ul>
</li>
</ol>
<p><strong>总结一下</strong>，<code>Object.wait/notify</code> 是 Java <code>synchronized</code> 关键字和监视器模型的一部分，而 <code>LockSupport.park/unpark</code> 是一个更底层、更灵活的线程阻塞原语。AQS 选择 <code>LockSupport</code> 而非 <code>wait/notify</code>，正是看中了它的<strong>精确唤醒能力</strong>和<strong>与锁解耦的灵活性</strong>，这使得 AQS 能够构建出比 <code>synchronized</code> 更高效、功能更强大的同步器。</p>
<h2 id="4-异步编排">4.<strong>异步编排</strong></h2>
<p>在我看来，<strong>异步编排的核心思想是，将多个独立的、耗时的异步任务（尤其是I/O密集型任务）组合、编排起来，让它们尽可能地并行执行，最终汇总结果，从而极大地缩短整体的响应时间。</strong> 这在微服务架构中尤其重要。</p>
<p>在现代Java开发中，实现异步编排最核心的工具就是 <strong><code>CompletableFuture</code></strong></p>
<p>举一个我们项目中非常典型的例子：<strong>获取‘商品详情页’数据</strong>。一个商品详情页通常需要展示多种信息，而这些信息可能来自不同的微服务或数据库表：</p>
<ul>
<li><strong>任务A</strong>：调用商品服务，获取商品基本信息。</li>
<li><strong>任务B</strong>：调用用户服务，获取当前用户的优惠券信息。</li>
<li><strong>任务C</strong>：调用评论服务，获取商品的热门评论。</li>
<li><strong>任务D</strong>：调用推荐服务，获取相关商品推荐。</li>
</ul>
<p>如果采用传统的同步调用方式，总耗时将是 <code>A + B + C + D</code> 的累加。但实际上，这四个任务<strong>没有任何依赖关系，完全可以并行执行</strong>。通过异步编排，理想情况下的总耗时将仅仅取决于<strong>耗时最长的那一个任务</strong>，即 <code>Max(A, B, C, D)</code>，性能会得到指数级的提升。</p>
<p>实现：</p>
<ol>
<li><strong>任务并行化</strong>：为每一个独立的调用任务创建一个<code>CompletableFuture</code>实例。关键是使用<code>supplyAsync(Supplier&lt;U&gt; supplier, Executor executor)</code>方法，并为其<strong>提供一个自定义的线程池</strong>。这可以避免耗尽Web服务器（如Tomcat）的业务线程池。</li>
<li><strong>结果编排与组合</strong>：当所有并行的任务都完成后，我需要将它们的结果组合成一个最终的<code>ProductDetailPageDTO</code>。我会使用<code>CompletableFuture.allOf()</code>来等待所有任务完成。</li>
<li><strong>最终结果处理</strong>：在<code>allOf()</code>完成后，通过<code>thenApply()</code>或<code>thenAccept()</code>来执行最终的组装逻辑。</li>
<li><strong>异常处理与超时控制</strong>：在生产环境中，还需要考虑健壮性。我会使用<code>exceptionally()</code>来处理任何一个异步任务的失败，返回一个默认值或降级数据。同时，使用<code>orTimeout()</code>为整个编排流程设置一个最大等待时间，防止因为某个下游服务缓慢而导致整个请求长时间阻塞。</li>
</ol>
<h2 id="5-synchronized-锁升级的“细节追问">5.<strong><code>synchronized</code> 锁升级的“细节追问</strong></h2>
<p>1.<strong>线程是如何从‘偏向锁’升级到‘轻量级锁’的？JVM是如何判断‘偏向’失效的</strong></p>
<p>“偏向锁的核心思想是，它‘偏向’于第一个获取它的线程，认为在接下来的执行中，锁将一直被这个线程持有。</p>
<ol>
<li><strong>偏向状态</strong>：当一个线程第一次获取锁时，JVM会通过<strong>CAS操作</strong>，尝试将锁对象头（Mark Word）中的<strong>线程ID</strong>指向当前线程。如果成功，就获取了偏向锁。</li>
<li><strong>升级触发点</strong>：当<strong>另一个线程</strong>（线程B）尝试获取这个已经被线程A持有的偏向锁时，升级过程就被触发了。</li>
<li><strong>偏向锁的撤销</strong>：
<ul>
<li>首先，线程B的CAS操作会失败。JVM会检查Mark Word中记录的线程ID是否是线程A。</li>
<li>JVM会暂停线程A（在一个<strong>全局安全点</strong>），然后检查线程A是否还存活。</li>
<li>如果线程A<strong>已经执行完毕</strong>，那么锁对象恢复到无锁状态，线程B可以重新尝试获取。</li>
<li>如果线程A<strong>仍然存活且还在同步块内</strong>，说明发生了真正的竞争。此时，偏向锁就会被<strong>撤销（Revoke）</strong>。锁对象头的Mark Word会被修改，清除偏向锁标志，并升级为<strong>轻量级锁</strong>的状态。同时，线程A的栈帧中会创建锁记录（Lock Record），指向锁对象。</li>
<li>之后，线程A和线程B都会在轻量级锁的状态下进行竞争（通过自旋）。</li>
</ul>
</li>
<li>只不过目前在<strong>JDK 15</strong> 中被 <strong>默认禁用</strong>，并在 <strong>JDK 18</strong> 被 <strong>完全移除</strong>。因为偏向锁的撤销消耗的性能是比较大的</li>
</ol>
<p>2.<strong>那轻量级锁又是如何升级到重量级锁的？‘自旋’失败后发生了什么？</strong></p>
<p>轻量级锁的核心思想是，它认为锁的竞争时间会非常短，线程只需要‘稍等一下’（自旋），就可以拿到锁，从而避免了线程阻塞和唤醒带来的内核态切换开销。</p>
<ol>
<li>
<p><strong>轻量级锁的获取</strong>：线程在自己的栈帧中创建锁记录（Lock Record），然后通过<strong>CAS操作</strong>尝试将锁对象的Mark Word指向这个锁记录。如果成功，就获取了轻量级锁。</p>
</li>
<li>
<p><strong>自旋等待</strong>：如果CAS失败，说明锁已被其他线程持有。当前线程并不会立即阻塞，而是会进行<strong>自旋</strong>，即执行一个空循环，不断地重试CAS操作。</p>
</li>
<li>
<p><strong>升级触发点</strong>：升级到重量级锁主要有两种情况：</p>
<ul>
<li><strong>自旋失败</strong>：自旋的次数是有限的（JVM会动态调整，比如10次）。如果一个线程自旋了指定次数后，仍然没有获取到锁，JVM就认为竞争已经非常激烈了，不适合再空耗CPU。</li>
</ul>
<p>现代 JVM 采用的是<strong>自适应自旋（Adaptive Spinning）</strong>。这意味着自旋的次数不是固定的。JVM 会根据上一次在该锁上的自旋时间以及锁的拥有者的状态来决定自旋的次数。如果对于某个锁，自旋很少成功，那么下一次可能会减少自旋次数甚至不自旋；反之，如果自旋经常成功，JVM 会认为自旋的期望收益很高，可能会允许更长的自旋时间。</p>
<ul>
<li><strong>竞争者过多</strong>：如果在自旋过程中，又有<strong>第三个线程</strong>也来竞争这把锁，那么也会立即触发升级。</li>
</ul>
</li>
<li>
<p><strong>锁膨胀（Inflation）</strong>：</p>
<ul>
<li>一旦触发升级，锁就会<strong>膨胀</strong>为重量级锁。</li>
<li>它会向操作系统申请一个互斥量（Mutex），并创建一个与之关联的 <code>ObjectMonitor</code> 对象。锁对象的Mark Word会被修改，指向一个重量级锁的监视器对象（Monitor）。 并更新锁标志位为“10”，表示该锁已进入重量级状态。</li>
<li>所有等待锁的线程（包括正在自旋的线程和后来者）都<strong>不再自旋</strong>，而是会被<strong>阻塞</strong>，并放入Monitor的等待队列中。</li>
</ul>
<p><code>ObjectMonitor</code> 内部维护了两个队列：<code>_EntryList</code>（竞争队列）和 <code>_WaitSet</code>（等待队列）。未能获取到锁的线程（如线程 B 和 C）会被封装成特定的节点，放入 <code>_EntryList</code> 队列中。</p>
<p>然后，这些线程会调用操作系统提供的同步原语（例如 Linux 下的 <code>pthread_mutex_lock</code>），从而<strong>被挂起（阻塞）</strong>，进入 <code>BLOCKED</code> 状态，并让出 CPU。</p>
<ul>
<li>当持有锁的线程释放锁时，会唤醒等待队列中的一个线程，进行新一轮的锁竞争。这个过程就涉及到了操作系统的互斥量（Mutex）和线程的上下文切换。</li>
</ul>
</li>
</ol>
<p>锁的升级是<strong>单向的</strong>，只能从低级别到高级别，不能降级（在HotSpot JVM的实现中）。</p>
<p>3.为什么是操作系统层面的动作？</p>
<ul>
<li><strong>线程调度权</strong>：用户程序本身没有权力去剥夺一个正在运行的线程的 CPU 使用权，并把它挂起。这个权力属于操作系统的内核。内核维护着所有进程和线程的状态，并负责调度哪个线程在哪个 CPU 核心上运行。</li>
<li><strong>系统调用 (System Call)</strong>：当 JVM 需要阻塞一个线程时，它必须通过<strong>系统调用</strong>向操作系统内核发出请求。这个请求会触发一次<strong>从用户态到内核态的切换</strong>。</li>
</ul>
<p><strong>用户态到内核态切换的性能消耗：</strong></p>
<ol>
<li><strong>上下文保存与恢复</strong>：在切换时，CPU 需要保存当前用户态线程的所有运行状态，包括寄存器值、程序计数器、栈指针等。然后加载内核执行相关操作所需要的上下文。当操作完成后，再从内核态切回用户态，这个过程需要恢复之前保存的用户线程上下文。这一来一回是纯粹的性能开销。</li>
<li><strong>CPU 缓存失效</strong>：切换到内核态运行时，可能会使用与用户态程序不同的数据和指令，这会导致 CPU 的高速缓存（L1, L2 Cache）以及 TLB（地址翻译后备缓冲器）中的缓存数据失效。当切回用户态时，需要重新从主内存加载数据，这会显著降低程序的执行速度。</li>
<li><strong>内核处理开销</strong>：内核执行线程的挂起和后续的唤醒调度本身也需要时间。</li>
</ol>
<p><strong>唤醒过程</strong>：当持有重量级锁的线程 A 执行完同步代码块，释放锁时，它会唤醒 <code>_EntryList</code> 中的一个或多个等待线程。这个唤醒过程同样需要陷入内核态，由操作系统来完成。操作系统会将某个被唤醒的线程的状态从 <code>BLOCKED</code> 改为 <code>RUNNABLE</code>，并将其放入就绪队列，等待下一次被 CPU 调度。</p>
<h2 id="6-ThreadLocal">6.ThreadLocal</h2>
<p><strong>既然<code>key</code>用弱引用会导致内存泄漏，那为什么<code>ThreadLocalMap</code>的设计者不把<code>key</code>也设计成强引用呢？或者，为什么不把<code>value</code>也设计成弱引用</strong></p>
<p>1.<strong>为什么Key不能是强引用？</strong></p>
<ul>
<li>假设Key是强引用。那么<code>Thread</code>对象会通过<code>threadLocals</code>这个Map强引用着<code>ThreadLocal</code>对象（Key）。只要线程本身不消亡，这个强引用链（<code>Thread</code> -&gt; <code>ThreadLocalMap</code> -&gt; <code>Entry</code> -&gt; <code>ThreadLocal</code>对象）就一直存在。</li>
<li>这意味着，即使我们在业务代码中已经不再使用某个<code>ThreadLocal</code>对象了（比如，<code>myThreadLocal = null;</code>），只要这个线程还在线程池中被复用，这个<code>ThreadLocal</code>对象本身就<strong>永远无法被GC回收</strong>。这会导致<code>ThreadLocal</code>对象本身的泄漏，比现在的情况更糟糕。”</li>
</ul>
<p>2.<strong>为什么Value不能是弱引用？</strong></p>
<ul>
<li><code>ThreadLocal</code>的核心目的就是让我们存放一些与线程绑定的<strong>数据（Value）</strong>。这些数据通常是我们业务逻辑中需要用到的对象，比如用户信息对象、数据库连接等。</li>
<li>如果我们把Value也设计成弱引用，那么当一次GC发生时，<strong>只要这个Value对象在其他地方没有被强引用，它就可能被意外地回收掉</strong>。</li>
<li>这会导致我们调用<code>threadLocal.get()</code>时，突然得到一个<code>null</code>值，这完全违背了<code>ThreadLocal</code>的设计初衷，会引发严重的业务逻辑错误。我们存放进去的对象，必须保证在<code>remove()</code>之前是可靠存在的。所以，<strong>Value必须是强引用</strong>。”</li>
</ul>
<p>因此只能做出了个权衡：</p>
<ul>
<li><strong>Key使用弱引用</strong>：是为了当<code>ThreadLocal</code>对象本身在外部不再被使用时，GC能够回收它，从而让Map中的Entry的key变为<code>null</code>，为后续的清理（expungeStaleEntry）提供了可能性。</li>
<li><strong>Value使用强引用</strong>：是为了保证我们存放的数据的生命周期是可控的，不会被GC意外回收。</li>
</ul>
<h2 id="7-谈谈怎么理解线程安全的">7.谈谈怎么理解线程安全的</h2>
<p><strong>线程安全</strong>指的是当多个线程同时访问一个对象或方法时，无论操作系统如何调度这些线程，也无需调用方在代码中去做额外的同步处理，都能保证程序的正确性，不会出现数据损坏或不一致的情况。</p>
<p>线程不安全的问题通常会表现在三个方面</p>
<ol>
<li>原子性：一个或多个操作作为一个不可分割的整体来进行，要去这个操作序列，必须由一个线程独占完整的去执行，不能被其他线程所干扰，调不可被中断。i++</li>
<li>可见性：一个线程修改了一个共享变量的值，这个修改的值能够被其他线程看到。但是实际在CPU的高速缓存下，对指令做出的重排序操作，导致共享变量的值，对其他线程不是立即课件的。缓存读的旧值</li>
<li>有序性：写的代码的顺序和实际代码的顺序不一致，是由于编译器和处理器层面对指令重排优化导致的，可能会导致可见性问题</li>
</ol>
<p>我们可以使用voliate或者是直接加synchronized，或者是直接加锁</p>
<p>或者使用原子类的CAS，或者是线程安全的ThreadLocal</p>
<h2 id="8-ConditionalOnClass-设计内涵">8.**<code>@ConditionalOnClass</code>**设计内涵</h2>
<p>面试官提出了一个非常精妙的问题：“<code>@ConditionalOnClass(User.class)</code>这行代码能编译通过，说明<code>User.class</code>肯定存在于classpath中，那为什么还需要这个注解呢？</p>
<p>未能理解<code>@Conditional</code>系列注解是为了解决<strong>通用starter模块在不同应用环境下的适配性</strong>问题，而不是为了解决当前项目中的类是否存在的问题。</p>
<p>确实，如果在我当前的项目中写<code>@ConditionalOnClass(User.class)</code>，这个条件判断看起来是多余的。因为<code>User.class</code>如果不存在，我的项目根本无法编译通过。</p>
<p>这个注解的真正威力体现在<strong>开发通用的starter模块</strong>时。想象一下，我们正在开发一个<code>my-sms-spring-boot-starter</code>，这个starter希望能够同时支持<strong>阿里云短信</strong>和<strong>腾讯云短信</strong>。</p>
<ul>
<li>
<p>我们的starter会提供两个自动配置类：<code>AliyunSmsAutoConfiguration</code> 和 <code>TencentSmsAutoConfiguration</code>。</p>
</li>
<li>
<p><code>AliyunSmsAutoConfiguration</code>负责创建阿里云短信服务的Bean。</p>
</li>
<li>
<p><code>TencentSmsAutoConfiguration</code>负责创建腾讯云短信服务的Bean。</p>
</li>
<li>
<p>一个**使用者（应用项目）*<em>在他的项目中引入了我们的starter。他可能只想使用阿里云短信，所以他只会在他的<code>pom.xml</code>中添加*<em>阿里云的SDK依赖</em></em>，而不会添加腾讯云的。</p>
</li>
<li>
<p>这时，我们的starter如何智能地判断只加载阿里云的Bean，而不去加载腾讯云的Bean呢？（如果去加载腾讯云的Bean，会因为缺少腾讯云SDK的jar包而直接抛出<code>ClassNotFoundException</code>，导致应用启动失败）</p>
</li>
<li>
<p>我们就是使用@ConditionalOnClass</p>
</li>
</ul>
<p>在<code>AliyunSmsAutoConfiguration</code>上，我们会这样写,@ConditionalOnClass(com.aliyun.sms.sdk.SmsClient.class)</p>
<ul>
<li>当使用者的应用启动时，Spring Boot会解析我们starter中的这两个自动配置类。</li>
<li>在解析<code>AliyunSmsAutoConfiguration</code>时，它会检查<strong>当前应用的classpath</strong>中是否存在<code>com.aliyun.sms.sdk.SmsClient.class</code>。因为使用者添加了阿里云的SDK依赖，所以这个类存在，条件满足，这个配置类就会被加载，阿里云的Bean就会被创建。</li>
<li>在解析<code>TencentSmsAutoConfiguration</code>时，它会检查classpath中是否存在<code>com.tencent.cloud.sms.sdk.SmsSender.class</code>。因为使用者<strong>没有</strong>添加腾讯云的SDK依赖，所以这个类不存在，条件不满足，<strong>这个配置类就会被优雅地跳过，不会被加载</strong>，从而避免了<code>ClassNotFoundException</code>。</li>
</ul>
<p><code>@ConditionalOnClass</code>并不是为了判断我们自己项目里的类是否存在，而是为了让我们开发的**通用模块（starter）*<em>能够*<em>智能地感知和适配它所运行的应用环境</em></em>，根据应用环境中引入了哪些依赖，来动态地决定哪些功能应该被激活。这是Spring Boot实现‘约定大于配置’和‘开箱即用’的关键魔法之一</p>
<h2 id="9-ThreadLocal-在线程池中的失效问题">9.<strong><code>ThreadLocal</code> 在线程池中的失效问题</strong></h2>
<ul>
<li><code>InheritableThreadLocal</code>之所以能够实现父子线程间的数据传递，是因为在<code>new Thread()</code>创建子线程时，子线程的构造函数会检查父线程的<code>inheritableThreadLocals</code>这个Map。如果它不为空，子线程就会将父线程Map中的所有值<strong>拷贝</strong>一份到自己的<code>inheritableThreadLocals</code>中。</li>
<li><strong>关键在于</strong>：这个值的拷贝动作，<strong>只发生在子线程被创建的那一瞬间</strong>。</li>
<li>在线程池的场景下，工作线程通常在系统启动时就已经被<strong>预先创建</strong>好了，并存放在池中。当我们提交一个任务时，线程池只是从池中<strong>取出一个已经存在的线程</strong>来执行我们的任务，并<strong>没有<code>new Thread()</code>这个动作</strong>。</li>
</ul>
<p>为了解决这个问题，阿里巴巴开源了一个非常强大的工具——<strong><code>TransmittableThreadLocal</code>（TTL）</strong>。它专门用于解决在使用线程池等会池化线程的组件时，实现父子线程、任务提交者与任务执行者之间的上下文传递问题。</p>
<p>TTL的优点在于它通过<strong>Java Agent</strong>或<strong>手动包装</strong>的方式，对线程池的<code>submit</code>/<code>execute</code>等方法以及<code>Runnable</code>/<code>Callable</code>任务进行了<strong>装饰（Decorate）</strong>。”</p>
<ol>
<li><strong>任务提交时（<code>submit</code>）</strong>：当我们调用被装饰过的<code>threadPool.submit(myRunnable)</code>时，TTL会<strong>捕获</strong>当前线程（父线程）的<code>ThreadLocal</code>值，并将其**‘打包’**进一个<code>TtlRunnable</code>或<code>TtlCallable</code>对象中。</li>
<li><strong>任务执行前（<code>run</code>）</strong>：当线程池中的某个工作线程开始执行这个被包装过的<code>TtlRunnable</code>时，在其<code>run</code>方法的<code>try</code>块开始处，TTL会将被‘打包’的父线程<code>ThreadLocal</code>值，**‘回放’（replay）**到当前工作线程的<code>ThreadLocal</code>中。</li>
<li><strong>任务执行后（<code>finally</code>）</strong>：在<code>finally</code>块中，TTL会<strong>清理</strong>当前工作线程的<code>ThreadLocal</code>，将其恢复到执行任务之前的状态，从而避免了数据串扰。</li>
</ol>
<h2 id="10-如何保证三个线程有序执行任务">10.如何保证三个线程有序执行任务</h2>
<p>方案1：使用**<code>wait/notify</code> 方案**</p>
<p>你需要自己管理锁（<code>synchronized</code>）、状态变量（<code>volatile int state</code>）、<code>while</code>循环（防止伪唤醒）、<code>try-finally</code>（保证锁释放），代码量大且极易出错。</p>
<p>使用<code>notifyAll()</code>会唤醒所有等待的线程，造成不必要的CPU竞争。而使用<code>notify()</code>又存在风险：如果错误地唤醒了不该被唤醒的线程（比如T1唤醒了T3而不是T2），信号就可能丢失，导致程序死锁。</p>
<p>方案2：<strong>升级版 <code>wait/notify</code> - <code>ReentrantLock</code> + <code>Condition</code></strong></p>
<p><code>ReentrantLock</code>提供了比<code>synchronized</code>更强大的功能。<code>Condition</code>对象则将<code>wait/notify</code>机制从“一个锁只有一个等待队列”升级为“<strong>一个锁可以有多个独立的等待队列</strong>”，我们可以为每个线程的“等待室”创建一个<code>Condition</code>，实现精准的“点对点”唤醒，彻底避免了<code>notify()</code>的信号丢失问题。</p>
<ol>
<li>创建一个<code>ReentrantLock</code>实例。</li>
<li>创建一个<code>volatile</code>状态变量，例如<code>volatile int state = 1;</code>，用于标识当前应该哪个线程执行。</li>
<li>为<strong>每个线程</strong>创建一个<code>Condition</code>对象：<code>Condition c1 = lock.newCondition(); Condition c2 = lock.newCondition(); Condition c3 = lock.newCondition();</code></li>
<li>线程T1的逻辑：
<ul>
<li>获取锁 <code>lock.lock()</code>。</li>
<li>在<code>try...finally</code>中执行，<code>finally</code>块中<code>lock.unlock()</code>。</li>
<li><code>while (state != 1)</code>，<code>c1.await()</code>。</li>
<li>执行任务1。</li>
<li>更新状态 <code>state = 2</code>。</li>
<li><strong>精准唤醒</strong>线程T2：<code>c2.signal()</code>。</li>
</ul>
</li>
<li><strong>线程T2和T3的逻辑</strong>与T1类似，分别在自己的<code>Condition</code>上<code>await</code>，并在执行完任务后，更新<code>state</code>并<code>signal</code>下一个线程的<code>Condition</code>。</li>
</ol>
<p>实现了有序执行，通过<code>signal()</code>实现了精准唤醒，比<code>notifyAll()</code>更高效，比<code>notify()</code>更安全。但还是比较复杂</p>
<p>方案3：<strong>信号量接力 - <code>Semaphore</code></strong></p>
<p><code>Semaphore</code>（信号量）是控制同时访问特定资源的线程数量的工具。我们可以创建两个初始许可为0的信号量，作为两个线程之间的“接力棒”。</p>
<ol>
<li>创建两个信号量：<code>Semaphore sem2 = new Semaphore(0);</code> 和 <code>Semaphore sem3 = new Semaphore(0);</code>。</li>
<li>线程T1的逻辑：
<ul>
<li>执行任务1。</li>
<li>执行完毕后，释放一个“给T2的许可”：<code>sem2.release()</code>。</li>
</ul>
</li>
<li>线程T2的逻辑：
<ul>
<li>首先尝试获取“来自T1的许可”，如果许可未被释放，T2将在此阻塞：<code>sem2.acquire()</code>。</li>
<li>获取到许可后，执行任务2。</li>
<li>执行完毕后，释放一个“给T3的许可”：<code>sem3.release()</code>。</li>
</ul>
</li>
<li>线程T3的逻辑：
<ul>
<li>首先尝试获取“来自T2的许可”：<code>sem3.acquire()</code>。</li>
<li>获取到许可后，执行任务3。</li>
</ul>
</li>
</ol>
<p>代码清晰简单，但需要创建N-1个<code>Semaphore</code>对象，如果线程数量很多，会增加一些对象管理的开销。</p>
<p>方案4：<strong><code>SingleThreadExecutor</code></strong></p>
<p><code>Executors.newSingleThreadExecutor()</code>会创建一个<strong>单线程的线程池</strong>。这个线程池的核心特性是：它内部有一个<strong>无界的<code>LinkedBlockingQueue</code>**来存放任务，并且**永远只有一个工作线程</strong>来从队列中取出并执行任务。这就天然地保证了所有提交给它的任务，都会<strong>严格按照提交的顺序（FIFO）来串行执行</strong>。</p>
<ol>
<li>
<p>创建一个单线程执行器：<code>ExecutorService executor = Executors.newSingleThreadExecutor();</code></p>
</li>
<li>
<p>定义三个任务（<code>Runnable</code>或<code>Callable</code>）：<code>task1</code>, <code>task2</code>, <code>task3</code>。</p>
</li>
<li>
<p>按顺序提交任务：java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">executor.submit(task1);</span><br><span class="line">executor.submit(task2);</span><br><span class="line">executor.submit(task3);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>关闭线程池：<code>executor.shutdown()</code>。</p>
</li>
</ol>
<ul>
<li><strong>严格来说，这是“三个任务有序执行”，而不是“三个不同的线程有序执行”</strong>。因为所有任务都是由<strong>同一个</strong>工作线程来执行的。如果面试官的题目严格要求必须是三个<strong>不同的、预先创建好</strong>的线程，那么这个方案就不完全符合字面要求。</li>
</ul>
<h2 id="11-ReentrantLock-和-synchronized-在性能上到底差异在哪？">11.<strong><code>ReentrantLock</code> 和 <code>synchronized</code> 在性能上到底差异在哪？</strong></h2>
<ul>
<li>
<p><code>synchronized</code>：</p>
<ul>
<li><strong>实现</strong>：它是Java的<strong>关键字</strong>，由JVM层面直接实现。其核心依赖于操作系统底层的**<code>Mutex Lock</code>（互斥量）**。</li>
<li><strong>开销</strong>：获取和释放<code>Mutex Lock</code>需要进行<strong>用户态到内核态的切换</strong>，这是一个非常昂贵的操作，涉及到线程上下文的切换和调度，会消耗大量的CPU时间。</li>
</ul>
</li>
<li>
<p><strong><code>ReentrantLock</code></strong>：</p>
<ul>
<li><strong>实现</strong>：它是一个<strong>Java类</strong>，位于<code>java.util.concurrent.locks</code>包下。其核心是基于**AQS（AbstractQueuedSynchronizer）**框架实现的。</li>
<li><strong>开销</strong>：AQS在底层利用了<strong>CAS（Compare-And-Swap）*<em>这一CPU原子指令和*</em><code>volatile</code>**关键字。在**无竞争或低竞争</strong>的情况下，<code>ReentrantLock</code>可以通过CAS操作直接在用户态完成锁的获取，<strong>完全避免了内核态的切换</strong>，因此性能极高。</li>
</ul>
</li>
</ul>
<p><code>ReentrantLock</code>性能一定优于<code>synchronized</code>”这个说法，在JDK 1.6之前是成立的。但在1.6之后，JVM对<code>synchronized</code>进行了翻天覆地的优化，引入了**锁升级（Lock Escalation）**机制，使其性能在很多场景下已经不输甚至优于<code>ReentrantLock</code>。</p>
<ul>
<li><strong>偏向锁</strong>：在只有一个线程访问同步块的场景下，<code>synchronized</code>几乎没有同步开销，性能极高。</li>
<li><strong>轻量级锁</strong>：当出现少量线程交替竞争时，<code>synchronized</code>会使用**自旋（Spinning）**的方式尝试获取锁。自旋也是在用户态完成的，避免了线程阻塞和内核态切换，性能同样很高。</li>
<li><strong>重量级锁</strong>：只有当竞争非常激烈，自旋多次仍无法获取锁时，<code>synchronized</code>才会升级为重量级锁，退化到依赖操作系统的<code>Mutex Lock</code>。</li>
</ul>
<p>只不过ReetrantLock有更多的功能，</p>
<ul>
<li><strong>可中断等待</strong>：<code>lockInterruptibly()</code>允许线程在等待锁的过程中响应中断。</li>
<li><strong>可超时等待</strong>：<code>tryLock(long timeout, TimeUnit unit)</code>可以避免死等。</li>
<li><strong>多条件变量</strong>：一个<code>ReentrantLock</code>可以创建多个<code>Condition</code>对象，实现更精细的线程通信。</li>
</ul>
<h2 id="12-JMM-内存模型与-volatile-的可见性保证">12 JMM 内存模型与 volatile 的可见性保证</h2>
<p>可见性:</p>
<p>a)JMM</p>
<p>JMM 并非指物理内存的划分，而是一个抽象的、用于规范多线程环境下内存访问行为的模型。</p>
<ul>
<li><strong>主内存 (Main Memory)</strong>：这是所有线程共享的区域，Java 中所有的实例变量、静态变量和数组元素都存储在这里。</li>
<li><strong>工作内存 (Working Memory)</strong>：这是每个线程私有的区域。线程不能直接读写主内存中的变量，而是需要先把变量从主内存拷贝一份副本到自己的工作内存中（这个副本可能是 CPU 的高速缓存、寄存器等）。线程的所有操作（读取、赋值等）都是针对其工作内存中的副本进行的。操作完成后，线程会在某个不确定的时间将修改后的变量值写回（flush）到主内存。</li>
</ul>
<p><strong>b) 可见性问题的产生</strong></p>
<p>在这种模型下，可见性问题就显而易见了：如果线程 A 修改了其工作内存中的共享变量 <code>flag</code>，但没有及时将其写回主内存，那么线程 B 在读取 <code>flag</code> 时，仍然会从主内存读取旧值，或者使用自己工作内存中更旧的缓存值。此时，线程 A 的修改对线程 B 就是不可见的。</p>
<p><strong>c) volatile 如何保证立即可见</strong></p>
<p><code>volatile</code> 关键字正是为了解决这个问题。当一个变量被声明为 <code>volatile</code> 后，JMM 会对所有线程施加两条特殊的规则：</p>
<ol>
<li><strong>写操作的强制刷新 (Flush)</strong>：当一个线程修改了一个 <code>volatile</code> 变量的值，JMM 会强制该线程<strong>立即</strong>将这个修改后的值从其工作内存写回到主内存中。</li>
<li><strong>读操作的强制失效 (Invalidate) 与加载 (Load)</strong>：当一个线程准备读取一个 <code>volatile</code> 变量时，JMM 会强制该线程<strong>先使其工作内存中关于该变量的副本失效</strong>，然后必须<strong>直接从主内存中重新加载</strong>最新的值。</li>
</ol>
<p>通过这一写一读的强制规定，<code>volatile</code> 巧妙地打通了主内存与工作内存之间的壁垒。任何线程对 <code>volatile</code> 变量的写操作，都会立刻被同步到主内存；而任何线程对 <code>volatile</code> 变量的读操作，都必须从主内存获取。这就确保了 <code>volatile</code> 变量的修改对所有其他线程是“立即可见”的。</p>
<p>禁止重排性：</p>
<p><strong>a) 指令重排序的动机</strong></p>
<p>为了提升性能，编译器和处理器（CPU）可能会在不改变单线程程序执行结果的前提下，对指令的执行顺序进行调整。例如，将没有数据依赖关系的指令并行执行。但在多线程环境下，这种优化可能会导致意想不到的严重后果（例如著名的“双重检查锁定”单例模式失效问题）。</p>
<p><strong>b) 内存屏障 (Memory Barrier) 的作用</strong></p>
<p>为了禁止特定类型的重排序，<code>volatile</code> 的实现依赖于一种特殊的底层硬件指令——<strong>内存屏障</strong>（也称内存栅栏或内存栅障）。</p>
<p>内存屏障就像一个“栅栏”，它向编译器和 CPU 发出明确的指令：</p>
<ul>
<li>所有在屏障<strong>之前</strong>的指令必须在屏障<strong>之前</strong>执行完毕。</li>
<li>所有在屏障<strong>之后</strong>的指令必须在屏障<strong>之后</strong>才能开始执行。</li>
<li>严禁将屏障前后的指令进行重排序，即任何指令都不能“越过”这个屏障。</li>
</ul>
<p><strong>c) volatile 如何插入内存屏障</strong></p>
<p>JMM 针对 <code>volatile</code> 变量的读写操作，规定了具体的内存屏障插入策略：</p>
<ul>
<li><strong>在每个 volatile 写操作之前</strong>，插入一个 <strong>StoreStore 屏障</strong>。
<ul>
<li>作用：保证在 volatile 写操作执行前，其前面的所有普通写操作都已经执行完毕，并且结果对其他处理器可见。</li>
</ul>
</li>
<li><strong>在每个 volatile 写操作之后</strong>，插入一个 <strong>StoreLoad 屏障</strong>。
<ul>
<li>作用：防止 volatile 写与后面可能有的 volatile 读/写或普通读/写发生重排序。这是最关键也是开销最大的屏障。</li>
</ul>
</li>
<li><strong>在每个 volatile 读操作之后</strong>，插入一个 <strong>LoadLoad 屏障</strong> 和一个 <strong>LoadStore 屏障</strong>。
<ul>
<li><code>LoadLoad</code> 作用：保证 volatile 读操作之后的所有普通读操作，都在其后执行。</li>
<li><code>LoadStore</code> 作用：保证 volatile 读操作之后的所有普通写操作，都在其后执行。</li>
</ul>
</li>
</ul>
<p>通过在 <code>volatile</code> 变量的读写操作前后插入这些精心设计的内存屏障，JMM 成功地阻止了编译器和处理器对 <code>volatile</code> 相关代码的激进优化，从而确保了程序在并发环境下的有序性。</p>
<p>在所有内存屏障中，<code>StoreLoad</code> 屏障是功能最强、开销最大的一个，它通常被称为“全能屏障”（Full Fence）。它的作用是确保屏障之前的所有内存<strong>写</strong>操作的结果，对屏障之后的所有内存<strong>读</strong>操作都是可见的。</p>
<p><strong>具体作用可以分解为两部分：</strong></p>
<ol>
<li><strong>刷新处理器写缓冲 (Flush Store Buffers)</strong>：它会强制将当前处理器写缓冲中的所有数据刷新到主内存中。这保证了在 <code>StoreLoad</code> 屏障之前的所有写操作，其结果都对其他处理器变得可见。</li>
<li><strong>清空处理器无效化队列 (Invalidate Queue)</strong>：它会处理无效化队列中的消息，强制使本地缓存中与主内存不一致的数据失效。这保证了在 <code>StoreLoad</code> 屏障之后的读操作，能够获取到主内存中最新的数据。</li>
</ol>
<h2 id="13-死锁">13.死锁</h2>
<p><strong>死锁定义</strong>：指两个或两个以上的线程在执行过程中，因争夺资源而造成的一种互相等待的现象，若无外力干涉，它们都将无法推进下去。</p>
<p><strong>死锁的四个必要条件</strong>（必须同时满足）：</p>
<ol>
<li><strong>互斥条件 (Mutual Exclusion)</strong>：一个资源每次只能被一个线程使用。</li>
<li><strong>占有并等待 (Hold and Wait)</strong>：一个线程因请求资源而阻塞时，对已获得的资源保持不放。</li>
<li><strong>不可剥夺 (No Preemption)</strong>：线程已获得的资源，在未使用完之前，不能被强行剥夺，只能在使用完后由自己释放。</li>
<li><strong>循环等待 (Circular Wait)</strong>：若干线程之间形成一种头尾相接的循环等待资源关系。</li>
</ol>
<p><strong>如何避免死锁</strong>： 要避免死锁，只需破坏上述四个必要条件中的任意一个即可。</p>
<ol>
<li><strong>破坏“占有并等待”</strong>：实行资源“一次性分配”策略，即线程在运行前一次性申请所有需要的资源。</li>
<li><strong>破坏“不可剥夺”</strong>：当一个线程占有部分资源并请求其他资源时，如果请求不到，可以主动释放它当前占有的资源。<code>Lock</code> 接口的 <code>tryLock</code> 方法提供了这种可能性。</li>
<li><strong>破坏“循环等待”</strong>（最常用）：采用<strong>资源有序分配法</strong>。对所有资源进行统一编号，所有线程在申请资源时，必须严格按照资源编号的递增（或递减）顺序进行申请，这样就不会形成环路。</li>
</ol>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">mengnankkzhou</div><div class="post-copyright__author_desc">不要走捏</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/juc/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/juc/')">JUC八股分析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/juc/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=JUC八股分析&amp;url=https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/juc/&amp;pic=https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712177.jpg?_r_=bffe3125-e84a-0997-69ce-69203ebc3bdd" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.tokenlen.top" target="_blank">mengnankkのblog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E9%9D%A2%E7%BB%8F/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>面经<span class="categoryesPageCount">24</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>面试<span class="tagsPageCount">46</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712181.jpg?_r_=12af9af0-20bb-40c0-4966-46ca2bd66d01" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/jvm/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837447.jpg?_r_=fca00c8a-20fe-3acf-3ca8-c334a38527d1" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JVM八股分析</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/javase/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837709.jpg?_r_=ab390ad4-f1a6-43a2-80f0-af472f739714" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JavaSe八股分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/k8s/" title="k8s八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712178.jpg?_r_=5e36d353-09e5-2a00-f13a-cb8abe664029" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-25</div><div class="title">k8s八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/aicode/" title="aicode八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221838345.jpg?_r_=1f59f222-6395-ca0a-159d-bc8e0bbca5af" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">aicode八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/changjing/" title="场景八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712175.jpg?_r_=bbe2bad7-c867-3ad9-e388-0011d0a1f4f5" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">场景八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/cap/" title="分布式八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202408081510494.jpg?_r_=d41a7842-d56f-1649-0a30-4d2e9f326a1d" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">分布式八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/javase/" title="JavaSe八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837709.jpg?_r_=ab390ad4-f1a6-43a2-80f0-af472f739714" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">JavaSe八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/jvm/" title="JVM八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837447.jpg?_r_=fca00c8a-20fe-3acf-3ca8-c334a38527d1" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">JVM八股分析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Valine</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">清风拂柳影，碧水映花香。</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">mengnankkzhou</h1><div class="author-info__desc">不要走捏</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/mengnankkkk" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/440831872" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410021212939.jpg) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">JUC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%B8%B8%E8%A7%81%E7%9A%84%E5%9D%91"><span class="toc-number">1.1.</span> <span class="toc-text">1.线程池常见的坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-AQS%E7%9A%84%E5%A4%A7%E5%B1%80%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">2.AQS的大局解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-wait-sleep-notify%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.3.</span> <span class="toc-text">3.wait,sleep,notify的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%BC%82%E6%AD%A5%E7%BC%96%E6%8E%92"><span class="toc-number">1.4.</span> <span class="toc-text">4.异步编排</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-synchronized-%E9%94%81%E5%8D%87%E7%BA%A7%E7%9A%84%E2%80%9C%E7%BB%86%E8%8A%82%E8%BF%BD%E9%97%AE"><span class="toc-number">1.5.</span> <span class="toc-text">5.synchronized 锁升级的“细节追问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-ThreadLocal"><span class="toc-number">1.6.</span> <span class="toc-text">6.ThreadLocal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E8%B0%88%E8%B0%88%E6%80%8E%E4%B9%88%E7%90%86%E8%A7%A3%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84"><span class="toc-number">1.7.</span> <span class="toc-text">7.谈谈怎么理解线程安全的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-ConditionalOnClass-%E8%AE%BE%E8%AE%A1%E5%86%85%E6%B6%B5"><span class="toc-number">1.8.</span> <span class="toc-text">8.**@ConditionalOnClass**设计内涵</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-ThreadLocal-%E5%9C%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD%E7%9A%84%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"><span class="toc-number">1.9.</span> <span class="toc-text">9.ThreadLocal 在线程池中的失效问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%89%E4%B8%AA%E7%BA%BF%E7%A8%8B%E6%9C%89%E5%BA%8F%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.10.</span> <span class="toc-text">10.如何保证三个线程有序执行任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-ReentrantLock-%E5%92%8C-synchronized-%E5%9C%A8%E6%80%A7%E8%83%BD%E4%B8%8A%E5%88%B0%E5%BA%95%E5%B7%AE%E5%BC%82%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="toc-number">1.11.</span> <span class="toc-text">11.ReentrantLock 和 synchronized 在性能上到底差异在哪？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-JMM-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E-volatile-%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="toc-number">1.12.</span> <span class="toc-text">12 JMM 内存模型与 volatile 的可见性保证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-%E6%AD%BB%E9%94%81"><span class="toc-number">1.13.</span> <span class="toc-text">13.死锁</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/01/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E8%BF%87%E7%A8%8B/lastteam/os/" title="操作系统"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712181.jpg?_r_=12af9af0-20bb-40c0-4966-46ca2bd66d01" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="操作系统"/></a><div class="content"><a class="title" href="/2026/01/01/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E8%BF%87%E7%A8%8B/lastteam/os/" title="操作系统">操作系统</a><time datetime="2025-12-31T16:00:00.000Z" title="发表于 2026-01-01 00:00:00">2026-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/30/message/book/sa-searchtool/" title="SpringAi工具搜索工具"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712178.jpg?_r_=8148ff34-5f36-6e23-f296-b52877aa9304" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringAi工具搜索工具"/></a><div class="content"><a class="title" href="/2025/12/30/message/book/sa-searchtool/" title="SpringAi工具搜索工具">SpringAi工具搜索工具</a><time datetime="2025-12-29T16:00:00.000Z" title="发表于 2025-12-30 00:00:00">2025-12-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/30/message/PR/saa/add_toolsearch/" title="Spring AI Alibaba 深度解析：动态工具搜索（Tool Search）的设计与实现"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722379.jpg?_r_=8e010e32-1e56-77e2-0fd3-7dfcd65a42ce" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring AI Alibaba 深度解析：动态工具搜索（Tool Search）的设计与实现"/></a><div class="content"><a class="title" href="/2025/12/30/message/PR/saa/add_toolsearch/" title="Spring AI Alibaba 深度解析：动态工具搜索（Tool Search）的设计与实现">Spring AI Alibaba 深度解析：动态工具搜索（Tool Search）的设计与实现</a><time datetime="2025-12-29T16:00:00.000Z" title="发表于 2025-12-30 00:00:00">2025-12-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/30/message/PR/fastjson2/issue1/" title="Fastjson2--fix"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722377.jpg?_r_=134fb933-bc07-99de-5b30-979986d1e3df" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Fastjson2--fix"/></a><div class="content"><a class="title" href="/2025/12/30/message/PR/fastjson2/issue1/" title="Fastjson2--fix">Fastjson2--fix</a><time datetime="2025-12-29T16:00:00.000Z" title="发表于 2025-12-30 00:00:00">2025-12-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/26/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E8%BF%87%E7%A8%8B/lastteam/ruanjiangongcheng/" title="软件工程"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837709.jpg?_r_=50986fb3-b314-8f60-cc79-f942001974b4" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="软件工程"/></a><div class="content"><a class="title" href="/2025/12/26/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E8%BF%87%E7%A8%8B/lastteam/ruanjiangongcheng/" title="软件工程">软件工程</a><time datetime="2025-12-25T16:00:00.000Z" title="发表于 2025-12-26 00:00:00">2025-12-26</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Framework-Hexo-4e88f8?style=flat&logo=hexo" 
       title="博客框架为 Hexo" alt="Hexo">
</a>
<a style="margin-inline:5px" target="_blank" href="https://github.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Source-Github-24292f?style=flat&logo=github" 
       title="本站项目由 GitHub 托管" alt="GitHub">
</a>
<a style="margin-inline:5px" target="_blank" href="https://vercel.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-Vercel-000000?style=flat&logo=vercel" 
       title="使用 Vercel 部署" alt="Vercel">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.qlu.edu.cn/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/University-齐鲁工业大学-0056a2?style=flat&logo=university" 
       title="齐鲁工业大学" alt="齐鲁工业大学">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.aliyun.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-阿里云-ff6a00?style=flat&logo=aliyun" 
       title="使用阿里云服务" alt="阿里云">
</a>
<a style="margin-inline:5px" target="_blank" href="https://cloud.tencent.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-腾讯云-0a73b8?style=flat&logo=tencent-cloud" 
       title="使用腾讯云服务" alt="腾讯云">
</a></p>
</div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2026 By <a class="footer-bar-link" href="/" title="mengnankkzhou" target="_blank">mengnankkzhou</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="鲁ICP备2024110758号">鲁ICP备2024110758号</a><a class="footer-bar-link" href="https://blog.tokenlen.top/rss2.xml" title="Rss">Rss</a><a class="footer-bar-link cc" href="/pravite" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">202</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">62</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">28</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 0.88rem;">BF<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 0.88rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 0.88rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 0.88rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 0.88rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 0.88rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 0.88rem;">FI<sup>1</sup></a><a href="/tags/Go/" style="font-size: 0.88rem;">Go<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 0.88rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>12</sup></a><a href="/tags/OS/" style="font-size: 0.88rem;">OS<sup>1</sup></a><a href="/tags/WEB/" style="font-size: 0.88rem;">WEB<sup>1</sup></a><a href="/tags/XSS/" style="font-size: 0.88rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>2</sup></a><a href="/tags/football/" style="font-size: 0.88rem;">football<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>61</sup></a><a href="/tags/juc/" style="font-size: 0.88rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 0.88rem;">jvm<sup>2</sup></a><a href="/tags/markdown/" style="font-size: 0.88rem;">markdown<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>17</sup></a><a href="/tags/net/" style="font-size: 0.88rem;">net<sup>7</sup></a><a href="/tags/paper/" style="font-size: 0.88rem;">paper<sup>1</sup></a><a href="/tags/php/" style="font-size: 0.88rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 0.88rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 0.88rem;">python<sup>3</sup></a><a href="/tags/shell/" style="font-size: 0.88rem;">shell<sup>4</sup></a><a href="/tags/sql/" style="font-size: 0.88rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>3</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 0.88rem;">操作系统<sup>2</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 0.88rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 0.88rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>20</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 0.88rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>9</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" style="font-size: 0.88rem;">软件工程<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" style="font-size: 0.88rem;">软件项目管理<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 0.88rem;">面试<sup>46</sup></a><a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 0.88rem;">项目<sup>3</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 mengnankkzhou 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@3.2.2/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://comment.tokenlen.top/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, "siu~~~~~"))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://comment.tokenlen.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '3ZpuzQHHKWfFH59QFYmcuCvr-gzGzoHsz',
      appKey: '8DIvljObQp853ueQMZzpb9Gx',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Twikoo' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://comment.tokenlen.top/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>