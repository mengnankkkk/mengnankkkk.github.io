<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>JVM八股分析 | mengnankkのblog</title><meta name="keywords" content="面试"><meta name="author" content="mengnankkzhou"><meta name="copyright" content="mengnankkzhou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="JVM八股分析"><meta name="application-name" content="JVM八股分析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="JVM八股分析"><meta property="og:url" content="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/jvm/index.html"><meta property="og:site_name" content="mengnankkのblog"><meta property="og:description" content="JVM 1.那有哪些对象是可以直接在栈上分配呢？ 在Java中，并不是特定类型的对象能够直接在栈上分配，而是取决于该对象的作用域。JVM通过一种叫做**“逃逸分析”（Escape Analysis）**的技术来判断一个对象是否可以安全地在栈上分配。 如果一个对象的引用没有“逃逸”出它被创建的方法之外"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712178.jpg?_r_=697e18d0-4b05-4e0c-91fd-bbf44bf103dd"><meta property="article:author" content="mengnankkzhou"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712178.jpg?_r_=697e18d0-4b05-4e0c-91fd-bbf44bf103dd"><meta name="description" content="JVM 1.那有哪些对象是可以直接在栈上分配呢？ 在Java中，并不是特定类型的对象能够直接在栈上分配，而是取决于该对象的作用域。JVM通过一种叫做**“逃逸分析”（Escape Analysis）**的技术来判断一个对象是否可以安全地在栈上分配。 如果一个对象的引用没有“逃逸”出它被创建的方法之外"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/jvm/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走啊，那种事情不要啊","backTitle":"♪(^∇^*)欢迎回家！！！！"},
  LA51: undefined,
  greetingBox: {"enable":"ture","default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://comment.tokenlen.top/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"\tbd9428de12b54b96b2f1b4e69aeee81f","mailMd5":"F37442226DA71492"},
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: mengnankkzhou","link":"链接: ","source":"来源: mengnankkのblog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'mengnankkのblog',
  title: 'JVM八股分析',
  postAI: '',
  pageFillDescription: 'JVM, 1.那有哪些对象是可以直接在栈上分配呢？, 2.JMM和一个对象的生命周期, 3.GC, 4.Tomcat如何打破双亲委派？Tomcat类加载顺序？, 5.G1回收器怎么处理大对象？, 6.如果发现 young GC频繁我该怎么定位怎么用 jvm 的指令定位。, 7.GC回收时对象地址的拷贝是怎么实现的那有哪些对象是可以直接在栈上分配呢在中并不是特定类型的对象能够直接在栈上分配而是取决于该对象的作用域通过一种叫做逃逸分析的技术来判断一个对象是否可以安全地在栈上分配如果一个对象的引用没有逃逸出它被创建的方法之外那么它就可能被优化为在栈上分配这样做的好处是当方法执行结束时栈帧被弹出对象的内存会立即被回收无需等待垃圾回收从而提高性能逃逸分析是即时编译器的一项优化技术默认在现代中是开启的只有那些生命周期完全局限于单个方法调用内体积较小且线程安全的对象才最有可能被优化到栈上进行分配未逃逸的定义仅在方法内部使用对象的引用完全封装在方法体内没有被方法返回未赋值给外部变量没有将该对象的引用赋值给任何类变量字段或实例变量未传递给可能逃逸的方法没有将该对象的引用作为参数传递给其他方法或者传递给了但能确定其他方法也不会让它逃逸逃逸的例子比如对象作为方法的返回值他就是逃离了这个方法的作用域对象引用赋值给实例变量也是逃离这个方法的作用域和一个对象的生命周期划分线程共享方法区堆线程私有程序计数器虚拟机栈本地方法栈生命周期创建类加载检查堆内存分配指针碰撞空闲列表初始化零值设置对象头执行方法进行使用回收可达性分析垃圾回收算法分代回收优化手段逃逸分析栈上分配线程本地分配缓冲等优化手段逃逸分析栈上分配和是为了自动化地提升对象分配效率降低压力而设计的一套协同工作的优化组合拳逃逸分析是决策入口它决定了一个不逃逸的对象是否有资格享受栈上分配这一特权从而完全避免对于必须在堆上分配的逃逸对象则为它们提供了线程私有的通道避免了并发分配时的锁竞争当我们在代码中写下时这个对象在中并不是无脑地直接被分配到堆上它会经历一个由即时编译器主导的充满优化的审批流程逃逸分析逃逸分析是一种编译期优化技术它不是直接的优化手段而是一种分析手段编译器会分析一个对象的动态作用域判断这个对象是否有可能逃逸出它的创建方法或当前线程如果逃逸分析的结果是这个对象完全不逃逸那么就会启用一个颠覆性的优化栈上分配是指将那些不逃逸的小对象直接在当前线程的虚拟机栈上进行分配而不是在堆上如果逃逸分析的结果是这个对象逃逸了必须在堆上分配那么并不会立刻去抢占全局的堆内存而是会尝试一个更高效的策略线程本地分配缓冲是为了提升对象在堆上分配的效率而设计的一种机制会在堆的新生代区为每个线程预先分配一小块私有的内存区域这个区域就叫避免并发冲突堆是所有线程共享的如果没有那么每次一个对象多个线程都需要去竞争同一块区的内存这个过程需要加锁比如来保证分配的原子性在高并发下会成为性能瓶颈当一个线程需要分配一个新对象时它会首先尝试在自己的中进行分配因为是线程私有的所以在这个区域内分配对象完全不需要加锁速度极快这是一个简单的指针碰撞操作只有当的空间用完了或者要分配的对象太大放不下时线程才会去申请一个新的或者在全局的区此时需要加锁进行分配然后在堆中是如何分配的呢内存分配方式指针碰撞适用场景当堆内存是绝对规整的时候使用这种情况通常由带有压缩功能的垃圾收集器产生如等底层原理所有已用内存都放在一边所有未用内存放在另一边中间有一个指针作为分界点指示器当需要分配内存时仅仅是把该指针向空闲空间那边挪动一段与对象大小相等的距离这个过程非常高效分配内存的动作等同于一次指针移动空闲列表适用场景当堆内存不是规整的已用内存和空闲内存相互交错时使用这种情况通常由不带压缩功能的垃圾收集器产生如底层原理虚拟机内部会维护一个列表记录着哪些内存块是可用的当需要分配内存时会从这个列表中找到一块足够大的空间划分给对象实例并更新列表上的记录寻找合适空间的过程会比指针碰撞慢并发处理在多线程并发创建对象时如何保证堆上分配的线程安全线程本地分配缓冲核心思想空间换时间避免竞争这是首选和主要的解决方案底层原理在的区会为每一个新创建的线程预先分配一小块私有内存这块内存就是当一个线程需要为新对象分配内存时它会首先在自己的中进行分配因为这是线程私有的所以这个分配过程完全不需要任何同步或加锁可以直接使用指针碰撞的方式快速完成这极大地提升了分配效率只有当线程的用完需要申请新的时或者要分配一个大于剩余空间的大对象时才会触发下面的同步机制失败重试核心思想乐观锁失败则重试这是备用和辅助的解决方案底层原理当一个线程的用完需要申请新或者虚拟机禁用了可以通过关闭线程就必须在共享的区进行内存分配为了保证线程安全虚拟机会采用原子操作来尝试更新内存分配指针具体过程是线程先读取指针的当前位置计算出分配后的新位置然后通过指令尝试将指针的原位置更新为新位置如果更新成功说明分配成功如果更新失败说明在操作期间有其他线程修改了指针当前线程就会自旋重试直到成功为止除了这些内还有一个优化的策略就是堆外内存它是一种手动管理的内存区域不属于的管理范畴通过的方法分配的内存这块内存并不在堆上而是直接向操作系统申请的本地内存特性堆内存堆外内存管理者自动管理开发者手动管理机制分配速度快慢系统调用访问速度快极快与交互时影响受影响可能不受影响大小限制受参数限制受物理内存限制我们可以使用他来完成零拷贝的操作当进行网络或文件操作时如果数据在堆内存中需要先从堆内存拷贝到内核缓冲区再由操作系统发送出去如果数据直接在堆外内存中可以直接将这块内存的地址交给操作系统省去了从用户态到内核态的这次数据拷贝实现了零拷贝极大地提升了性能使用等高性能网络消息框架大量使用堆外内存作为网络通信的缓冲区需要缓存大量数据且不希望对造成巨大压力的场景例如本地缓存框架但是容易出现内存泄漏和排查困难的问题如何定位和分析内存问题的通过监控工具如或者日志通过堆内存再用等工具分析是优化了数据结构减少内存占用还是调整了参数比如回收每个对象从诞生之初就在它的对象头里为它设置了一个年龄计数器占个这个年龄是对象晋升老年代的主要依据绝大多数新创建的对象首先会被分配在新生代的区此时它们的年龄为当区满了之后会触发第一次会扫描区将所有存活的对象复制到新生代的区中的一个我们称之为区在这个复制的过程中这些幸存对象的年龄会加区中所有未被复制的被判定为垃圾的对象都会被一次性清空新生代有两个区我们通常称之为和在任何时刻总有一个是空的另一个是有数据的当下一次发生时会同时扫描区和区即上次存放幸存对象的那个区所有存活的对象都会被再次复制到那个空的区同样在复制过程中这些对象的年龄会再次加清空区和区然后和的角色互换为下一次做准备这个过程会一直重复对象就在和之间来回倒腾每经历一次只要它还活着年龄就会加当一个对象在区中不断地倒腾其年龄达到一个设定的阈值时在下一次中它将不再被复制到另一个区而是被直接晋升到老年代这个年龄阈值可以通过参数来设置默认是因为对象头中的年龄计数器只有个最大能表示的数字就是二进制一个新生代的晋升流程年龄为的时候进入老年代除了年龄达到阈值还有一种情况会触发晋升如果在区中相同年龄的所有对象大小的总和大于空间的一半那么年龄大于或等于该年龄的对象就可以直接进入老年代无需等到这个规则是为了防止区被过度填充如果大量同龄的对象在某次后集中幸存可能会导致区空间不足进而触发更复杂的分配担保机制动态年龄判断可以在这种情况发生前提前将一些年长的对象送到老年代为更年轻的对象腾出空间大对象直接晋升这个对象的大小超过了由参数设定的阈值那么这个大对象将不会被分配在新生代的区而是会被直接分配到老年代在执行之前会检查老年代的连续可用空间是否大于新生代所有对象的总大小或者大于历次晋升到老年代的对象的平均大小如果是那么这次是安全的如果否会进行一次来清理老年代以腾出更多空间如果在过程中区确实无法容纳所有存活对象那么多余的对象就会通过这个分配担保机制被直接移入老年代对象死亡的三个方法引用计数器可达性分析方法可达性分析需要两次标记第一次看是不是没用跟引用链相连第二次看队列中的是不是还没有相连选择标记清除的核心原因是它是一个并发收集器在垃圾收集的大部分阶段用户线程和线程是可以同时运行的而标记整理算法需要移动对象这个过程非常复杂很难与用户线程并发执行所以只能选择实现相对简单的标记清除这也正是产生内存碎片的根本原因的核心优势恰恰在于它的并发标记和并发清除阶段是可以和用户线程一起运行的从而大大缩短了时间的主要发生在初始标记和重新标记这两个非常短暂的阶段你应该强调的总时长很短但不可预测而的虽然也是分阶段的但其总时长可以在一个目标范围内被预测和控制是对整个堆新生代和老年代以及方法区进行的垃圾回收时间非常长应极力避免老年代空间不足从新生代晋升过来的对象大小大于老年代的剩余空间大对象直接在老年代分配时空间不足方法区元空间永久代空间不足加载的类过多或者运行时生成的动态代理类过多导致方法区溢出显式调用代码中手动调用该方法建议执行不推荐使用收集器下的或时空间放不下想晋升到老年代但老年代也没有足够空间在并发标记和清理期间业务线程运行太快导致老年代被填满无法完成回收只能并进行排查方法排查频繁的核心思路是找出导致内存无法被正常回收的原因通常是内存泄漏或不合理的内存配置开启并分析日志通过参数如开启日志使用等工具分析日志查看的频率耗时以及触发原因使用命令行工具查看进程实时监控情况查看老年代元空间的使用率变化如果的使用率持续增长并接近则很可能存在内存泄漏生成和分析堆转储快照在出现时自动或使用手动使用或等工具分析文件重点关注支配树和泄漏嫌疑报告它们能快速定位到持有大量内存无法被回收的对象及其引用链检查代码根据快照分析结果检查代码中是否存在生命周期过长的对象特别是静态集合类等中只增不减的数据资源未关闭如数据库连接等不合理的对象创建如在循环中创建大量临时大对象调整参数如果不是内存泄漏而是内存分配不合理可以考虑调整堆大小新生代与老年代的比例晋升阈值元空间大小等参数如何打破双亲委派类加载顺序为何打破核心原因是为了实现应用之间的隔离性一个标准的服务器可以同时部署多个应用多个包如果遵循标准的双亲委派模型所有应用都会共享同一个父类加载器这会导致依赖冲突应用可能依赖而应用依赖如果都由父加载器加载那么只有一个版本的能被加载另一个应用必然会因类版本不匹配而崩溃隔离失效一个应用的类可以被另一个应用访问到无法实现真正的隔离如何打破通过自定义一个来打破双亲委派模型这个类加载器的方法颠倒了标准的加载顺序先在自己这里找优先在应用自己的目录下和查找类自己找不到再交给爹如果自己找不到才会遵循双亲委派模型向上委托给父加载器这种先己后亲的模式保证了每个应用优先使用自己打包的类库从而实现了应用间的完美隔离类的加载顺序的类加载器体系是一个层次化的结构其加载顺序如下引导类加载器加载自身的核心类库如这是顶层无法被程序直接访问系统类加载器加载系统级别的类如环境变量中指定的类公共类加载器加载和所有应用共享的类库位于安装目录的下如数据库驱动包通常放在这里应用类加载器每个应用都有一个独立的实例它负责加载当前应用的类路径是和它正是打破双亲委派的关键当一个类需要被加载时的查找顺序是自己的目录但有一个例外对于核心类库为了防止覆盖的核心仍然会优先委托给父加载器那么为什么内嵌的仍要打破双亲委派在一个应用中通常只有一个应用所以上面提到的多应用隔离的理由似乎不再成立了但内嵌的仍然保留了打破双亲委派的其原因已经从隔离转变为适配和兼容适配的胖结构一个标准的可执行文件其内部结构是和标准的是无法读取嵌套文件即里的中的类的通过一个自定义的来启动应用这个类加载器懂得如何从嵌套中加载类然而的被设计为从标准的目录结构文件系统路径或包结构中加载类它不认识的胖结构解决方案在启动嵌入式时会创建一个的实例但会巧妙地将其喂食的源头指向能够解析的路径本质上仍然在工作但它的工作目录被动态地设置为了下的资源遵循规范和保持内部机制的兼容性规范中定义了类加载的逻辑比如等的行为都与类加载器紧密相关内部有很多机制如的编译和热加载都严重依赖于的存在和其特定的加载机制选择嵌入而不是重写它为了不破坏这个成熟容器的内部工作原理最安全最可靠的方式就是保留其原有的类加载架构并在此基础上进行适配而不是推倒重来总结在内嵌场景下打破双亲委派的其核心作用已经不再是为了隔离多个应用而是为了作为一个适配器优雅地桥接独特的胖类加载机制和标准容器对类加载环境的期望从而保证了整个服务的正确稳定运行回收器怎么处理大对象关于回收器如何处理大对象这涉及到一个非常特殊的设计整个过程可以分为是什么如何分配和如何回收三个部分来理解首先中不叫大对象而是有一个专门的术语叫做巨型对象定义一个对象的大小如果超过了单个容量的就会被判定为的大小在启动时会根据堆大小将整个堆划分为大约个大小相等的不连续的每个的大小在到之间是的次幂例如一个是那么任何大于的对象都会被视为当遇到一个时它的分配策略和普通对象完全不同不进区它不会在年轻代的区进行分配而是直接在老年代寻找连续的空闲来存放寻找会专门开辟一类特殊的称为来存储这些巨型对象这些在逻辑上属于老年代跨存储如果一个的大小小于一个完整的它就会被放入一个单独的中这个中剩余的空间将会被浪费无法再分配给其他对象这就是内存碎片的来源之一如果一个对象的大小超过了单个的容量会寻找个连续的空闲来存储它并将这些都标记为总结分配过程就是会为巨型对象在老年代直接分配连续的专门的来存放那么如何回收呢的回收有以下几个特点不参与年轻代因为它们直接分配在老年代所以任何一次都不会扫描和回收它们在并发标记周期中被识别的并发标记会扫描整个堆包括如果一个在这个阶段被识别为不再存活它就会被标记为垃圾回收时机混合在并发标记之后如果发现某个中的巨型对象已经完全是垃圾那么在下一次的中这个有可能会被直接回收会评估回收它的收益释放了大量空间和成本几乎为零因为整个都是垃圾如果划算就会把它加入到回收集合中一并清理这是最后的手段如果对象的分配和回收导致了严重的内存碎片使得后续的对象无论是普通对象还是巨型对象都找不到足够的连续空间进行分配时会触发一次会进行空间压缩整理彻底清理这些碎片但这会导致长时间的暂停是我们极力要避免的的优化巨型对象回收的增强为了缓解的压力从开始引入了一个优化在并发标记周期结束后如果发现某个是垃圾可以在下一次发生时顺便回收这个而不需要等到这被称为巨型对象的积极回收将大小超过容量一半的对象定义为它会跳过年轻代直接在老年代分配连续的专门的来存储这些对象的回收不发生在中而是在并发标记确认其死亡后可以在甚至得益于优化中被高效地整体回收但是对象的分配和回收容易导致内存碎片如果碎片问题严重最终可能会退化为代价高昂的因此在实践中我们应该尽量避免创建生命周期很短的巨型对象或者通过调整参数来减少巨型对象的产生如果发现频繁我该怎么定位怎么用的指令定位会按照一个提出假设工具验证分析解决的实战流程来回答当发现也称频繁时根本原因只有一个年轻代空间被快速填满这通常由以下两种情况导致原因一年轻代特别是区设置过小应用的正常运行就需要一定的内存分配速率如果区太小很快就会被填满自然导致频繁原因二应用存在内存分配速率过高的问题代码中可能存在内存泄漏或内存抖动在短时间内创建了大量对象即使这些对象很快就死亡也会瞬间占满区使用进行宏观监控是定位问题的首选命令行工具它轻量无侵入可以实时监控活动先用或找到进程的使用监控情况每秒刷新一次如何分析的输出包含以下关键列和区的使用率区的使用率老年代使用率元空间使用率年轻代的总次数年轻代的总耗时的总次数的总耗时观察列如果这个数字在短时间内比如几秒钟快速稳定地增长就证实了确实非常频繁观察列你会看到区的使用率像心电图一样在短时间内从一个较低的值飙升到接近然后一次后又瞬间降下来周而复始这个心跳的频率越高说明越频繁使用定位内存中的元凶它能生成堆转储快照或查看堆中对象的统计信息如何分析的输出包含四列序号实例数量总字节数类名重点关注和这两列排在最前面的类就是当前在堆中数量最多或占用空间最大的对象关联问题如果频繁通常意味着有大量的短生命周期对象被创建这些对象可能在运行时已经被回收了但我们仍然可以从列表中找到那些创建速率极高的类的蛛丝马迹比如你发现或者某个业务类的实例数量异常地高那么问题很可能就出在创建这些对象的代码上进行代码审查代码审查拿着找到的嫌疑类名去代码库中搜索看看哪些业务逻辑在大量循环地创建这些类的实例常见问题场景在一个循环中反复创建对象进行拼接应该使用不合理地使用了关键字本可以复用的对象却在循环中反复创建日志级别过低如在生产环境输出了大量不必要的字符串对象从数据库或缓存中查询出了巨大的数据集合并创建了大量的对象解决方案优化代码首选如果是代码问题根本的解决方案是优化代码比如使用对象池优化算法减少循环中的对象创建等调优次选如果代码中的内存分配速率是业务所必须的合理的但依然频繁那么就应该考虑调整参数来增大年轻代的空间设置堆的总大小直接设置年轻代的大小增大这个值可以有效降低的频率设置老年代与年轻代的比例老年代年轻代减小这个值相当于增大了年轻代的占比设置区与单个区的比例回收时对象地址的拷贝是怎么实现的对象地址的拷贝或者更准确地说是对象的移动是所有复制和标记整理算法的中必不可少的一环它的实现方式直接关系到的效率这个过程的实现可以从为什么需要拷贝拷贝的是什么以及如何高效地实现拷贝这三个层面来理解为什么拷贝对象的核心目的是为了解决内存碎片化问题通过将所有存活的对象拷贝移动到内存的一端使其紧凑排列就可以在另一端获得一块完整连续的空闲空间这不仅解决了碎片问题还使得后续的内存分配可以恢复使用高效的指针碰撞方式是什么一个对象在虚拟机中的内存布局它主要由三部分组成对象头存储了对象的哈希码分代年龄锁状态标志等指向该对象对应的类元数据的指针数组长度如果是数组对象还会有这部分实例数据对象真正存储有效信息的字段内容对齐填充要求对象起始地址必须是字节的整数倍如果对象大小不是字节的倍数就需要这部分来补齐拷贝的就是这整个对象对象头实例数据对齐填充的完整内存块如何高效地实现拷贝以为例的底层实现的年轻代和老年代回收都是基于复制算法它会将一个或多个称为中的存活对象拷贝到新的空闲中这个过程发生在暂停期间会基于以下的步骤线程会遍历中所有对于每个它会查找那些在并发标记阶段被标记为存活的对象分配新空间在目标空闲中为该对象申请一块大小相同的新内存空间这通常通过高效的线程本地分配缓冲来完成以避免多线程竞争拷贝对象内容执行一次内存块的批量拷贝这通常是通过调用底层高效的之类的函数来完成的将旧地址的整个对象内容原封不动地复制到新分配的内存地址对象被拷贝到新地址后必须在旧对象的对象头中留下一个指向新地址的转发指针这个转发指针的作用是在的后续工作中如果其他对象仍然持有指向这个旧对象的引用当扫描到这个引用时它会通过旧对象头里的转发指针发现该对象已经搬家了并直接将这个引用更新为指向新地址当一个对象被拷贝后线程会立即扫描这个新拷贝的对象内部的所有引用字段如果该对象已经被拷贝即其旧地址的对象头里已经有了转发指针则直接将当前对象的引用更新为转发指针指向的新地址如果该对象还未被拷贝则递归地对这个被引用的对象执行上述的拷贝设置转发指针更新引用的完整流程这个过程就像一个深度优先或广度优先的图遍历从根对象出发一边拷贝存活对象一边修复指向它们的引用直到所有可达的存活对象都被拷贝到新的中并且所有相关的引用都已更新为新地址当中所有的存活对象都被拷贝完毕后这些旧的就可以被整体视为完全空闲并被回收以备后续使用总结以下通过内存批量拷贝如高效地移动对象内容利用转发指针机制在旧对象的对象头记录新地址作为后续引用更新的依据通过递归或迭代的方式遍历对象图一边拷贝对象一边修复指向已移动对象的引用在多线程中通常会使用线程本地分配缓冲来加速新空间的分配并使用等同步原语来保证多线程操作的正确性',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-10-07 18:38:24',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/rss2.xml" title="mengnankkのblog" type="application/rss+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">mengnankkのblog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://imgbed.mengnankk.asia/202407021650088.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imgbed.mengnankk.asia/202407021650088.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 1.05rem;">BF<sup>1</sup></a><a href="/tags/BUG/" style="font-size: 1.05rem;">BUG<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 1.05rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 1.05rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 1.05rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 1.05rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 1.05rem;">FI<sup>1</sup></a><a href="/tags/Github/" style="font-size: 1.05rem;">Github<sup>1</sup></a><a href="/tags/Go/" style="font-size: 1.05rem;">Go<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 1.05rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>12</sup></a><a href="/tags/XSS/" style="font-size: 1.05rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>2</sup></a><a href="/tags/football/" style="font-size: 1.05rem;">football<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>61</sup></a><a href="/tags/juc/" style="font-size: 1.05rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 1.05rem;">jvm<sup>2</sup></a><a href="/tags/markdown/" style="font-size: 1.05rem;">markdown<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 1.05rem;">mysql<sup>17</sup></a><a href="/tags/net/" style="font-size: 1.05rem;">net<sup>7</sup></a><a href="/tags/paper/" style="font-size: 1.05rem;">paper<sup>1</sup></a><a href="/tags/php/" style="font-size: 1.05rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 1.05rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 1.05rem;">python<sup>3</sup></a><a href="/tags/redis/" style="font-size: 1.05rem;">redis<sup>4</sup></a><a href="/tags/shell/" style="font-size: 1.05rem;">shell<sup>4</sup></a><a href="/tags/spring/" style="font-size: 1.05rem;">spring<sup>4</sup></a><a href="/tags/spring-boot/" style="font-size: 1.05rem;">spring boot<sup>14</sup></a><a href="/tags/sql/" style="font-size: 1.05rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>3</sup></a><a href="/tags/%E5%8E%8B%E6%B5%8B/" style="font-size: 1.05rem;">压测<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 1.05rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 1.05rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>20</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 1.05rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>9</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 1.05rem;">面试<sup>46</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">26</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">15</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">22</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E7%BB%8F/" itemprop="url">面经</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>面试</span></a></span></div></div><h1 class="post-title" itemprop="name headline">JVM八股分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-10-07T10:38:24.946Z" title="更新于 2025-10-07 18:38:24">2025-10-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">8.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>27分钟</span></span><span class="post-meta-separator"></span><span id="" data-flag-title="JVM八股分析"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为济南"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>济南</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712178.jpg?_r_=697e18d0-4b05-4e0c-91fd-bbf44bf103dd"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/jvm/"><header><a class="post-meta-categories" href="/categories/%E9%9D%A2%E7%BB%8F/" itemprop="url">面经</a><a href="/tags/%E9%9D%A2%E8%AF%95/" tabindex="-1" itemprop="url">面试</a><h1 id="CrawlerTitle" itemprop="name headline">JVM八股分析</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">mengnankkzhou</span><time itemprop="dateCreated datePublished" datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time><time itemprop="dateCreated datePublished" datetime="2025-10-07T10:38:24.946Z" title="更新于 2025-10-07 18:38:24">2025-10-07</time></header><h1>JVM</h1>
<h2 id="1-那有哪些对象是可以直接在栈上分配呢？">1.那有哪些对象是可以直接在栈上分配呢？</h2>
<p>在Java中，并不是特定<strong>类型</strong>的对象能够直接在栈上分配，而是取决于该对象的<strong>作用域</strong>。JVM通过一种叫做**“逃逸分析”（Escape Analysis）**的技术来判断一个对象是否可以安全地在栈上分配。</p>
<p>如果一个对象的引用没有“逃逸”出它被创建的方法之外，那么它就可能被优化为在栈上分配。这样做的好处是，当方法执行结束时，栈帧被弹出，对象的内存会立即被回收，无需等待垃圾回收（GC），从而提高性能。</p>
<ul>
<li><strong>逃逸分析是JIT（即时编译器）的一项优化技术，默认在现代JVM中是开启的。<strong>只有那些</strong>生命周期完全局限于单个方法调用</strong>内、<strong>体积较小</strong>且<strong>线程安全</strong>的对象，才最有可能被优化到栈上进行分配。</li>
</ul>
<p>未逃逸的定义：</p>
<ol>
<li><strong>仅在方法内部使用</strong>：对象的引用完全封装在方法体内，没有被方法返回。</li>
<li><strong>未赋值给外部变量</strong>：没有将该对象的引用赋值给任何类变量（<code>static</code>字段）或实例变量。</li>
<li><strong>未传递给可能逃逸的方法</strong>：没有将该对象的引用作为参数传递给其他方法，或者传递给了但能确定其他方法也不会让它“逃逸”。</li>
</ol>
<p>逃逸的例子：</p>
<p>比如对象作为方法的返回值，他就是逃离了这个方法的作用域</p>
<p>对象引用赋值给实例变量，也是逃离这个方法的作用域</p>
<h2 id="2-JMM和一个对象的生命周期">2.JMM和一个对象的生命周期</h2>
<p>JMM划分：</p>
<p>​	线程共享：方法区 堆</p>
<p>​	线程私有：程序计数器，虚拟机栈，本地方法栈</p>
<p>生命周期：</p>
<p>​	创建： 类加载检查 -&gt; 堆内存分配（指针碰撞/空闲列表）-&gt; 初始化零值 -&gt; 设置对象头 -&gt; 执行 <code>init</code> 方法。</p>
<p>​	进行使用</p>
<p>​	回收：可达性分析 -&gt; 垃圾回收算法 -&gt; 分代回收(Minor GC, Full GC)</p>
<p>优化手段:</p>
<p>逃逸分析、栈上分配、TLAB（线程本地分配缓冲）等优化手段</p>
<p>逃逸分析、栈上分配和TLAB是JVM为了<strong>自动化地提升对象分配效率、降低GC压力</strong>而设计的一套<strong>协同工作的优化组合拳</strong></p>
<p>逃逸分析是决策入口，它决定了一个不逃逸的对象是否有资格享受<strong>栈上分配</strong>这一‘特权’，从而完全避免GC。对于必须在堆上分配的逃逸对象，<strong>TLAB</strong>则为它们提供了线程私有的‘VIP通道’，避免了并发分配时的锁竞争。</p>
<ol>
<li>当我们在代码中写下 <code>new User()</code> 时，这个<code>User</code>对象在JVM中并不是“无脑地”直接被分配到堆上。它会经历一个由JVM JIT（即时编译器）主导的、充满优化的“审批流程”</li>
<li><strong>逃逸分析</strong>：逃逸分析是一种<strong>编译期优化技术</strong>，它不是直接的优化手段，而是一种<strong>分析手段</strong>。JIT编译器会分析一个<strong>对象的动态作用域</strong>，判断这个对象是否有可能“逃逸”出它的创建方法或当前线程。</li>
<li>如果逃逸分析的结果是：<strong>“这个对象完全不逃逸！”</strong>，那么JVM就会启用一个颠覆性的优化。<strong>栈上分配</strong>是指将那些<strong>不逃逸的小对象</strong>，直接在**当前线程的虚拟机栈（Stack）<strong>上进行分配，而不是在</strong>堆（Heap）**上。</li>
<li>如果逃逸分析的结果是：<strong>“这个对象逃逸了，必须在堆上分配”</strong>，那么JVM并不会立刻去抢占全局的堆内存，而是会尝试一个更高效的策略。</li>
<li><strong>TLAB（线程本地分配缓冲）**是JVM为了**提升对象在堆上分配的效率</strong>而设计的一种机制。JVM会在堆的<strong>新生代（Eden区）**为**每个线程</strong>预先分配一小块<strong>私有的内存区域</strong>，这个区域就叫TLAB。<strong>避免并发冲突</strong>：堆是所有线程共享的。如果没有TLAB，那么每次<code>new</code>一个对象，多个线程都需要去<strong>竞争同一块Eden区的内存</strong>。这个过程需要<strong>加锁</strong>（比如CAS）来保证分配的原子性，在高并发下会成为性能瓶颈。</li>
<li>当一个线程需要分配一个新对象时，它会<strong>首先尝试在自己的TLAB中进行分配</strong>。</li>
<li>因为TLAB是线程私有的，所以在这个区域内分配对象<strong>完全不需要加锁</strong>，速度极快，这是一个简单的**指针碰撞（Bump the Pointer）**操作。</li>
<li>只有当<strong>TLAB的空间用完了</strong>，或者要分配的<strong>对象太大TLAB放不下</strong>时，线程才会去申请一个新的TLAB，或者在全局的Eden区（此时需要加锁）进行分配。</li>
<li>然后在堆中是如何分配的呢？</li>
</ol>
<p>内存分配方式：</p>
<ol>
<li><strong>指针碰撞 (Bump-the-Pointer)</strong>
<ul>
<li><strong>适用场景</strong>：当Java堆内存是<strong>绝对规整</strong>的时候使用。这种情况通常由带有压缩功能的垃圾收集器产生，如 <code>Serial</code>、<code>Parallel Scavenge</code>、<code>G1</code> 等。</li>
<li><strong>底层原理</strong>：所有已用内存都放在一边，所有未用内存放在另一边，中间有一个指针作为分界点指示器。当需要分配内存时，<strong>仅仅是把该指针向空闲空间那边挪动一段与对象大小相等的距离</strong>。这个过程非常高效，分配内存的动作等同于一次指针移动。</li>
</ul>
</li>
<li><strong>空闲列表 (Free List)</strong>
<ul>
<li><strong>适用场景</strong>：当Java堆内存<strong>不是规整的</strong>，已用内存和空闲内存相互交错时使用。这种情况通常由不带压缩功能的垃圾收集器产生，如 <code>CMS</code> (Concurrent Mark Sweep)。</li>
<li><strong>底层原理</strong>：虚拟机内部会维护一个<strong>列表</strong>，记录着哪些内存块是可用的。当需要分配内存时，会从这个列表中找到一块足够大的空间划分给对象实例，并更新列表上的记录。寻找合适空间的过程会比指针碰撞慢。</li>
</ul>
</li>
</ol>
<p>并发处理：在多线程并发创建对象时，如何保证堆上分配的线程安全？</p>
<ol>
<li><strong>线程本地分配缓冲 (TLAB - Thread Local Allocation Buffer)</strong>
<ul>
<li><strong>核心思想</strong>：<strong>空间换时间，避免竞争</strong>。这是<strong>首选和主要的</strong>解决方案。</li>
<li><strong>底层原理</strong>：在JVM的Eden区，会为<strong>每一个新创建的线程预先分配一小块私有内存</strong>，这块内存就是TLAB。当一个线程需要为新对象分配内存时，它会<strong>首先在自己的TLAB中进行分配</strong>。因为这是线程私有的，所以这个分配过程<strong>完全不需要任何同步或加锁</strong>，可以直接使用“指针碰撞”的方式快速完成。这极大地提升了分配效率。</li>
<li>只有当线程的TLAB用完，需要申请新的TLAB时，或者要分配一个大于TLAB剩余空间的大对象时，才会触发下面的同步机制。</li>
</ul>
</li>
<li><strong>CAS + 失败重试 (Compare-And-Swap)</strong>
<ul>
<li><strong>核心思想</strong>：<strong>乐观锁，失败则重试</strong>。这是<strong>备用和辅助的</strong>解决方案。</li>
<li><strong>底层原理</strong>：当一个线程的TLAB用完需要申请新TLAB，或者虚拟机禁用了TLAB（可以通过 <code>-XX:-UseTLAB</code> 关闭），线程就必须在共享的Eden区进行内存分配。为了保证线程安全，虚拟机会采用<strong>CAS原子操作</strong>来尝试更新内存分配指针。</li>
<li>具体过程是：线程先读取指针的当前位置，计算出分配后的新位置，然后通过CAS指令尝试将指针的原位置更新为新位置。如果更新成功，说明分配成功；如果更新失败，说明在操作期间有其他线程修改了指针，当前线程就会<strong>自旋（Spinning）重试</strong>，直到成功为止。</li>
</ul>
</li>
</ol>
<p>除了这些JMM内还有一个优化的策略就是堆外内存，它是一种<strong>手动管理</strong>的内存区域，不属于JVM GC的管理范畴。</p>
<p>通过NIO的<code>ByteBuffer.allocateDirect()</code>方法分配的内存。这块内存并不在Java堆上，而是直接向操作系统申请的本地内存。</p>
<table>
<thead>
<tr>
<th style="text-align:left">特性</th>
<th style="text-align:left">堆内存 (Heap)</th>
<th style="text-align:left">堆外内存 (Off-Heap)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>管理者</strong></td>
<td style="text-align:left">JVM (GC自动管理)</td>
<td style="text-align:left">开发者 (手动管理) / <code>Cleaner</code>机制</td>
</tr>
<tr>
<td style="text-align:left"><strong>分配速度</strong></td>
<td style="text-align:left">快 (TLAB)</td>
<td style="text-align:left">慢 (系统调用)</td>
</tr>
<tr>
<td style="text-align:left"><strong>访问速度</strong></td>
<td style="text-align:left">快</td>
<td style="text-align:left">极快 (与I/O交互时)</td>
</tr>
<tr>
<td style="text-align:left"><strong>GC影响</strong></td>
<td style="text-align:left">受GC影响，可能STW</td>
<td style="text-align:left"><strong>不受GC影响</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>大小限制</strong></td>
<td style="text-align:left">受<code>-Xmx</code>参数限制</td>
<td style="text-align:left">受物理内存限制</td>
</tr>
</tbody>
</table>
<p>我们可以使用他来完成零拷贝的操作</p>
<ul>
<li>当进行网络或文件I/O操作时，如果数据在堆内存中，需要先从<strong>堆内存拷贝到内核缓冲区</strong>，再由操作系统发送出去。</li>
<li>如果数据直接在堆外内存中，JVM可以直接将这块内存的地址交给操作系统，省去了从用户态到内核态的这次数据拷贝，实现了**“零拷贝”**，极大地提升了I/O性能。</li>
</ul>
<p>使用：</p>
<ul>
<li><strong>Netty</strong>、<strong>RocketMQ</strong>等高性能网络/消息框架，大量使用堆外内存作为网络通信的缓冲区。</li>
<li>需要缓存大量数据，且不希望对GC造成巨大压力的场景（例如，本地缓存框架）。</li>
<li>但是,容易出现内存泄漏和排查困难的问题</li>
</ul>
<p><strong>如何定位和分析</strong>内存问题的?</p>
<p>通过监控工具如 Arthas, VisualVM, 或者日志,通过 <code>jmap</code> dump 堆内存，再用 MAT 等工具分析,是优化了数据结构减少内存占用，还是调整了 JVM 参数，比如 <code>-Xmx</code>, <code>-Xms</code></p>
<p>回收：</p>
<p>每个对象从诞生之初，JVM就在它的**对象头（Object Header）**里，为它设置了一个‘年龄计数器’（Age），占4个bit。这个‘年龄’是对象晋升老年代的主要依据</p>
<ul>
<li>绝大多数新创建的对象，首先会被分配在新生代的<strong>Eden区</strong>。此时，它们的<strong>年龄为0</strong>。</li>
<li>当Eden区满了之后，会触发第一次<strong>Minor GC</strong>。</li>
<li>GC会扫描Eden区，将所有<strong>存活的对象</strong>复制到新生代的<strong>Survivor区中的一个（我们称之为To-Survivor区）</strong>。</li>
<li>在这个复制的过程中，这些幸存对象的<strong>年龄会加1</strong>。</li>
<li>Eden区中所有未被复制的（被判定为垃圾的）对象，都会被一次性清空。</li>
<li>新生代有两个Survivor区，我们通常称之为<code>S0</code>和<code>S1</code>。在任何时刻，总有一个是空的（To-Survivor），另一个是有数据的（From-Survivor）。</li>
<li>当<strong>下一次Minor GC</strong>发生时，GC会同时扫描<strong>Eden区</strong>和<strong>From-Survivor区</strong>（即上次存放幸存对象的那个区）。</li>
<li>所有存活的对象，都会被<strong>再次复制</strong>到那个空的<strong>To-Survivor区</strong>。</li>
<li>同样，在复制过程中，这些对象的<strong>年龄会再次加1</strong>。</li>
<li>清空Eden区和From-Survivor区。然后，<code>S0</code>和<code>S1</code>的角色互换，为下一次GC做准备。</li>
<li>这个过程会一直重复。对象就在<code>S0</code>和<code>S1</code>之间来回“倒腾”，每经历一次Minor GC，只要它还活着，年龄就会加1。</li>
<li>当一个对象在Survivor区中不断地“倒腾”，其年龄<strong>达到一个设定的阈值</strong>时，在下一次Minor GC中，它将不再被复制到另一个Survivor区，而是被<strong>直接晋升（Promote）到老年代</strong>。</li>
<li>这个年龄阈值可以通过JVM参数<code>-XX:MaxTenuringThreshold</code>来设置。默认是15，因为对象头中的年龄计数器只有4个bit，最大能表示的数字就是15（二进制<code>1111</code>）。</li>
</ul>
<p>一个新生代的晋升流程Eden -&gt; S0 -&gt; S1 -&gt; … -&gt; Old，年龄为15的时候进入老年代</p>
<p>除了年龄达到阈值，还有一种情况会触发晋升：如果在 Survivor 区中，<strong>相同年龄的所有对象大小的总和，大于 Survivor 空间的一半</strong>，那么<strong>年龄大于或等于该年龄的对象就可以直接进入老年代</strong>，无需等到 <code>MaxTenuringThreshold</code>。这个规则是为了<strong>防止Survivor区被过度填充</strong>。如果大量同龄的对象在某次GC后集中幸存，可能会导致Survivor区空间不足，进而触发更复杂的分配担保机制。动态年龄判断可以在这种情况发生前，提前将一些“年长”的对象送到老年代，为更“年轻”的对象腾出空间。</p>
<p>大对象直接晋升，这个对象的大小超过了由<code>-XX:PretenureSizeThreshold</code>参数设定的阈值，那么这个大对象将<strong>不会</strong>被分配在新生代的Eden区，而是会被<strong>直接分配到老年代</strong>。</p>
<p>在执行Minor GC之前，JVM会检查<strong>老年代的连续可用空间</strong>是否<strong>大于新生代所有对象的总大小</strong>（或者大于历次晋升到老年代的对象的平均大小）。</p>
<ul>
<li>如果<strong>是</strong>，那么这次Minor GC是安全的。如果<strong>否</strong>，JVM会进行一次<strong>Full GC</strong>来清理老年代，以腾出更多空间。</li>
<li>如果在Minor GC过程中，Survivor区确实无法容纳所有存活对象，那么多余的对象就会通过这个<strong>分配担保机制，被直接移入老年代</strong>。</li>
</ul>
<h2 id="3-GC">3.GC</h2>
<p>对象死亡的三个方法，引用计数器，可达性分析，finalize方法，可达性分析需要两次标记，第一次看是不是没用跟引用链相连，第二次看队列中的是不是还没有相连</p>
<p>CMS 选择标记-清除的核心原因是，它是一个**并发（Concurrent）**收集器，在垃圾收集的大部分阶段，<strong>用户线程（Mutator）和 GC 线程是可以同时运行的</strong>。而标记-整理算法需要移动对象，这个过程非常复杂，很难与用户线程并发执行，所以 CMS 只能选择实现相对简单的标记-清除。这也正是 CMS 产生内存碎片的根本原因。</p>
<p>CMS 的核心优势恰恰在于它的<strong>并发标记（Concurrent Mark）**和**并发清除（Concurrent Sweep）*<em>阶段，是*<em>可以和用户线程一起运行的</em></em>，从而大大缩短了 STW 时间。CMS 的 STW 主要发生在</strong>初始标记（Initial Mark）**和**重新标记（Remark）*<em>这两个非常短暂的阶段。你应该强调 CMS 的 STW **总时长很短**，但*<em>不可预测</em></em>；</p>
<p>而 G1 的 STW 虽然也是分阶段的，但其<strong>总时长可以在一个目标范围内被预测和控制</strong>。</p>
<p>Full GC:</p>
<p>Full GC 是对整个 Java 堆（新生代和老年代）以及方法区进行的垃圾回收，STW 时间非常长，应极力避免。</p>
<ol>
<li><strong>老年代空间不足</strong>：
<ul>
<li>从新生代晋升过来的对象大小大于老年代的剩余空间。</li>
<li>大对象直接在老年代分配时，空间不足。</li>
</ul>
</li>
<li><strong>方法区（元空间/永久代）空间不足</strong>：加载的类过多，或者运行时生成的动态代理类过多，导致方法区溢出。</li>
<li><strong>显式调用 <code>System.gc()</code></strong>：代码中手动调用该方法，建议 JVM 执行 Full GC（不推荐使用）。</li>
<li><strong>CMS 收集器下的 <code>Promotion Failed</code> 或 <code>Concurrent Mode Failure</code></strong>：
<ul>
<li><code>Promotion Failed</code>: Minor GC 时，Survivor 空间放不下，想晋升到老年代，但老年代也没有足够空间。</li>
<li><code>Concurrent Mode Failure</code>: 在 CMS 并发标记和清理期间，业务线程运行太快，导致老年代被填满，CMS 无法完成回收，只能STW并进行 Full GC。</li>
</ul>
</li>
</ol>
<p><strong>排查方法</strong> 排查频繁 Full GC 的核心思路是：<strong>找出导致内存无法被正常回收的原因，通常是内存泄漏或不合理的内存配置</strong>。</p>
<ol>
<li><strong>开启并分析 GC 日志</strong>：
<ul>
<li>通过 JVM 参数（如 <code>-Xlog:gc*:file=gc.log:time,level,tags:filecount=5,filesize=10m</code>）开启 GC 日志。</li>
<li>使用 GCeasy、GCViewer 等工具分析日志，查看 Full GC 的频率、耗时以及触发原因。</li>
</ul>
</li>
<li><strong>使用命令行工具</strong>：
<ul>
<li><code>jps</code>：查看 Java 进程 ID。</li>
<li><code>jstat -gcutil &lt;pid&gt; &lt;interval&gt;</code>：实时监控 GC 情况，查看老年代（O）、元空间（M）的使用率变化。如果 O/M 的使用率持续增长并接近 100%，则很可能存在内存泄漏。</li>
</ul>
</li>
<li><strong>生成和分析堆转储快照 (Heap Dump)</strong>：
<ul>
<li>在出现 OOM 时自动 Dump（<code>-XX:+HeapDumpOnOutOfMemoryError</code>），或使用 <code>jmap -dump:format=b,file=heap.hprof &lt;pid&gt;</code> 手动 Dump。</li>
<li>使用 <strong>Eclipse MAT (Memory Analyzer Tool)</strong> 或 <strong>JProfiler</strong> 等工具分析 <code>.hprof</code> 文件。</li>
<li>重点关注 <strong>Dominator Tree（支配树）</strong> 和 <strong>Leak Suspects（泄漏嫌疑）</strong> 报告，它们能快速定位到持有大量内存、无法被回收的对象及其引用链。</li>
</ul>
</li>
<li><strong>检查代码</strong>：根据快照分析结果，检查代码中是否存在：
<ul>
<li>生命周期过长的对象，特别是<strong>静态集合类</strong>（<code>static Map</code> 等）中只增不减的数据。</li>
<li>资源未关闭，如 <code>InputStream</code>、数据库连接、<code>Socket</code> 等。</li>
<li>不合理的对象创建，如在循环中创建大量临时大对象。</li>
</ul>
</li>
<li><strong>调整 JVM 参数</strong>：如果不是内存泄漏，而是内存分配不合理，可以考虑调整堆大小、新生代与老年代的比例、晋升阈值、元空间大小等参数。</li>
</ol>
<h2 id="4-Tomcat如何打破双亲委派？Tomcat类加载顺序？">4.Tomcat如何打破双亲委派？Tomcat类加载顺序？</h2>
<ul>
<li><strong>为何打破</strong>： 核心原因是为了实现<strong>Web应用之间的隔离性</strong>。一个标准的Tomcat服务器可以同时部署多个Web应用（多个<code>.war</code>包）。如果遵循标准的双亲委派模型，所有应用都会共享同一个父类加载器（<code>AppClassLoader</code>）。这会导致：
<ol>
<li><strong>依赖冲突</strong>：应用A可能依赖<code>Spring 4.x</code>，而应用B依赖<code>Spring 5.x</code>。如果都由父加载器加载，那么只有一个版本的Spring能被加载，另一个应用必然会因类版本不匹配而崩溃。</li>
<li><strong>隔离失效</strong>：一个应用的类可以被另一个应用访问到，无法实现真正的隔离。</li>
</ol>
</li>
</ul>
<p><strong>如何打破</strong>： Tomcat通过自定义一个<code>WebAppClassLoader</code>来打破双亲委派模型。这个类加载器的<code>loadClass()</code>方法<strong>颠倒了标准的加载顺序</strong>：</p>
<ol>
<li><strong>先在自己这里找</strong>：优先在Web应用自己的目录下（<code>/WEB-INF/classes</code>和<code>/WEB-INF/lib</code>）查找类。</li>
<li><strong>自己找不到，再交给爹</strong>：如果自己找不到，<strong>才</strong>会遵循双亲委派模型，向上委托给父加载器。</li>
</ol>
<p>这种“<strong>先己后亲</strong>”的模式，保证了每个Web应用优先使用自己打包的类库，从而实现了应用间的完美隔离</p>
<hr>
<p>类的加载顺序？<br>
Tomcat的类加载器体系是一个层次化的结构，其加载顺序如下：</p>
<ol>
<li><strong>Bootstrap (引导类加载器)</strong>：加载JVM自身的核心类库，如<code>java.lang.*</code>。这是顶层，无法被Java程序直接访问。</li>
<li><strong>System (系统类加载器)</strong>：加载JVM系统级别的类，如<code>CLASSPATH</code>环境变量中指定的类。</li>
<li><strong>Common (公共类加载器)</strong>：加载Tomcat和所有Web应用<strong>共享</strong>的类库，位于Tomcat安装目录的<code>/lib</code>下。如数据库驱动<code>jar</code>包通常放在这里。</li>
<li><strong>WebApp (Web应用类加载器)</strong>：每个Web应用都有一个独立的<code>WebAppClassLoader</code>实例。它负责加载当前应用的类，路径是<code>/WEB-INF/classes</code>和<code>/WEB-INF/lib</code>。<strong>它正是打破双亲委派的关键</strong>。</li>
</ol>
<p>当一个类需要被加载时，Tomcat的查找顺序是：<strong>WebApp自己的目录 -&gt; Common -&gt; System -&gt; Bootstrap</strong>。但有一个例外，对于Java核心类库（<code>java.*</code>, <code>javax.*</code>），为了防止覆盖JVM的核心API，<code>WebAppClassLoader</code>仍然会优先委托给父加载器。</p>
<hr>
<p>那么为什么内嵌的Tomcat仍要打破双亲委派？</p>
<p>在一个Spring Boot应用中，通常只有一个Web应用，所以上面提到的“多应用隔离”的理由似乎不再成立了。但内嵌的Tomcat仍然保留了打破双亲委派的<code>WebAppClassLoader</code>，其原因已经从“隔离”转变为**“适配”和“兼容”**：</p>
<ol>
<li><strong>适配Spring Boot的“胖Jar”结构</strong>：
<ul>
<li>一个标准的Spring Boot可执行<code>jar</code>文件，其内部结构是<code>BOOT-INF/classes</code>和<code>BOOT-INF/lib</code>。标准的<code>AppClassLoader</code>是<strong>无法读取</strong>嵌套<code>jar</code>文件（即<code>BOOT-INF/lib</code>里的<code>jar</code>）中的类的。</li>
<li>Spring Boot通过一个自定义的<code>LaunchedURLClassLoader</code>来启动应用，这个类加载器<strong>懂得如何从嵌套<code>jar</code>中加载类</strong>。</li>
<li>然而，Tomcat的<code>WebAppClassLoader</code>被设计为从标准的Web目录结构（文件系统路径或<code>war</code>包结构）中加载类。它不认识Spring Boot的胖<code>jar</code>结构。</li>
<li><strong>解决方案</strong>：Spring Boot在启动嵌入式Tomcat时，会创建一个Tomcat的<code>WebAppClassLoader</code>实例，但会巧妙地将其**“喂食”的源头**指向<code>LaunchedURLClassLoader</code>能够解析的路径。本质上，<code>WebAppClassLoader</code>仍然在工作，但它的“工作目录”被Spring Boot动态地设置为了<code>BOOT-INF</code>下的资源。</li>
</ul>
</li>
<li><strong>遵循Servlet规范和保持Tomcat内部机制的兼容性</strong>：
<ul>
<li>Servlet规范中定义了类加载的逻辑，比如<code>ServletContext.getResourceAsStream()</code>等API的行为都与类加载器紧密相关。</li>
<li>Tomcat内部有很多机制，如<strong>JSP的编译和热加载</strong>，都严重依赖于<code>WebAppClassLoader</code>的存在和其特定的加载机制。</li>
<li>Spring Boot选择<strong>嵌入</strong>Tomcat，而不是<strong>重写</strong>它。为了不破坏Tomcat这个成熟容器的内部工作原理，最安全、最可靠的方式就是<strong>保留其原有的类加载架构</strong>，并在此基础上进行适配，而不是推倒重来。</li>
</ul>
</li>
</ol>
<p><strong>总结</strong>：在Spring Boot内嵌场景下，Tomcat打破双亲委派的<code>WebAppClassLoader</code>，其核心作用已经<strong>不再是为了隔离多个Web应用，而是为了作为一个“适配器”，优雅地桥接Spring Boot独特的胖Jar类加载机制和标准Servlet容器对类加载环境的期望</strong>，从而保证了整个Web服务的正确、稳定运行。</p>
<h2 id="5-G1回收器怎么处理大对象？">5.G1回收器怎么处理大对象？</h2>
<p>关于G1回收器如何处理大对象，这涉及到G1一个非常特殊的设计——<strong>Humongous Region</strong>。</p>
<p>整个过程可以分为**“是什么”、“如何分配”<strong>和</strong>“如何回收”**三个部分来理解。</p>
<ul>
<li>首先，G1中不叫“大对象”，而是有一个专门的术语，叫做**“巨型对象”（Humongous Object）**。
<ul>
<li><strong>定义</strong>：一个对象的大小如果<strong>超过了单个Region容量的50%</strong>，就会被判定为Humongous Object。</li>
<li><strong>Region的大小</strong>：G1在启动时会根据堆大小将整个堆划分为大约2048个大小相等的、不连续的Region。每个Region的大小在1MB到32MB之间，是2的N次幂。例如，一个Region是2MB，那么任何大于1MB的对象都会被视为Humongous Object。</li>
</ul>
</li>
<li>当G1遇到一个Humongous Object时，它的分配策略和普通对象完全不同：</li>
</ul>
<ol>
<li><strong>不进Eden区</strong>：它不会在年轻代的Eden区进行分配，而是直接在老年代寻找连续的空闲Region来存放。</li>
<li><strong>寻找Humongous Region</strong>：G1会专门开辟一类特殊的Region，称为<strong>Humongous Region</strong>，来存储这些巨型对象。这些Region在逻辑上属于老年代。</li>
<li>跨Region存储：
<ul>
<li>如果一个Humongous Object的大小小于一个完整的Region，它就会被放入一个单独的Humongous Region中。这个Region中<strong>剩余的空间将会被浪费</strong>，无法再分配给其他对象。这就是<strong>内存碎片</strong>的来源之一。</li>
<li>如果一个对象的大小超过了单个Region的容量，G1会寻找<strong>N个连续的空闲Region</strong>来存储它，并将这些Region都标记为Humongous Region。</li>
</ul>
</li>
</ol>
<p><strong>总结分配过程就是</strong>：<strong>G1会为巨型对象在老年代直接分配连续的、专门的Humongous Region来存放。</strong></p>
<p>那么如何回收呢？</p>
<p>Humongous Object的回收有以下几个特点：</p>
<ol>
<li><strong>不参与年轻代GC (Young GC)</strong>：因为它们直接分配在老年代，所以任何一次Young GC都不会扫描和回收它们。</li>
<li><strong>在并发标记周期中被识别</strong>：G1的并发标记（Concurrent Marking）会扫描整个堆，包括Humongous Region。如果一个Humongous Object在这个阶段被识别为不再存活，它就会被标记为垃圾。</li>
<li><strong>回收时机</strong>：
<ul>
<li><strong>混合GC (Mixed GC)</strong>：在并发标记之后，如果G1发现某个Humongous Region中的巨型对象已经完全是垃圾，那么在下一次的<strong>Mixed GC</strong>中，这个Region<strong>有可能会被直接回收</strong>。G1会评估回收它的收益（释放了大量空间）和成本（几乎为零，因为整个Region都是垃圾），如果划算，就会把它加入到回收集合（CSet）中一并清理。</li>
<li><strong>Full GC</strong>：这是最后的手段。如果Humongous对象的分配和回收导致了<strong>严重的内存碎片</strong>，使得后续的对象（无论是普通对象还是巨型对象）都找不到足够的连续空间进行分配时，G1会触发一次<strong>Full GC</strong>。Full GC会进行<strong>空间压缩整理</strong>，彻底清理这些碎片，但这会导致长时间的“Stop-the-World”暂停，是我们极力要避免的。</li>
<li><strong>JDK 8u60+ 的优化 - 巨型对象回收的增强</strong>：为了缓解Full GC的压力，从JDK 8u60开始，G1引入了一个优化。在并发标记周期结束后，如果发现某个Humongous Object是垃圾，G1<strong>可以在下一次Young GC发生时，顺便回收这个Humongous Region</strong>，而不需要等到Mixed GC。这被称为“<strong>Eager Reclamation of Humongous Objects</strong>”（巨型对象的积极回收）。</li>
</ul>
</li>
</ol>
<p>G1将大小超过Region容量一半的对象定义为<strong>Humongous Object</strong>。它会跳过年轻代，直接在老年代分配<strong>连续的、专门的Humongous Region</strong>来存储。这些对象的回收<strong>不发生在Young GC中</strong>，而是在并发标记确认其死亡后，可以在<strong>Mixed GC甚至Young GC（得益于Eager Reclamation优化）中被高效地整体回收</strong>。但是，Humongous对象的分配和回收容易导致<strong>内存碎片</strong>，如果碎片问题严重，最终可能会退化为代价高昂的<strong>Full GC</strong>。因此，在实践中，我们应该尽量避免创建生命周期很短的巨型对象，或者通过调整 <code>-XX:G1HeapRegionSize</code> 参数来减少巨型对象的产生。</p>
<h2 id="6-如果发现-young-GC频繁，我该怎么定位，怎么用-jvm-的指令定位。">6.如果发现 young GC频繁，我该怎么定位，怎么用 jvm 的指令定位。</h2>
<p>会按照一个**“提出假设 -&gt; 工具验证 -&gt; 分析解决”**的实战流程来回答。</p>
<p>当发现Young GC（也称Minor GC）频繁时，根本原因只有一个：<strong>年轻代空间被快速填满</strong>。这通常由以下两种情况导致：</p>
<ol>
<li><strong>原因一：年轻代（特别是Eden区）设置过小</strong>。应用的正常运行就需要一定的内存分配速率，如果Eden区太小，很快就会被填满，自然导致频繁YGC。</li>
<li><strong>原因二：应用存在内存分配速率过高的问题</strong>。代码中可能存在“内存泄漏”或“内存抖动”，在短时间内创建了大量对象，即使这些对象很快就死亡，也会瞬间占满Eden区。</li>
</ol>
<p>使用<code>jstat</code>进行宏观监控,<code>jstat</code>是定位GC问题的<strong>首选命令行工具</strong>，它轻量、无侵入，可以实时监控GC活动。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 1. 先用 jps 或 ps -ef | grep java 找到Java进程的PID</span><br><span class="line">jps -l</span><br><span class="line"></span><br><span class="line"># 2. 使用 jstat 监控GC情况，每秒刷新一次</span><br><span class="line">jstat -gcutil &lt;PID&gt; 1000</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>如何分析</strong>: <code>jstat -gcutil</code>的输出包含以下关键列：</p>
<ul>
<li><code>S0</code>, <code>S1</code>: Survivor 0和1区的使用率。</li>
<li><code>E</code>: <strong>Eden区的使用率</strong>。</li>
<li><code>O</code>: 老年代使用率。</li>
<li><code>M</code>: 元空间使用率。</li>
<li><code>YGC</code>: <strong>年轻代GC的总次数</strong>。</li>
<li><code>YGCT</code>: <strong>年轻代GC的总耗时</strong>。</li>
<li><code>FGC</code>: Full GC的总次数。</li>
<li><code>FGCT</code>: Full GC的总耗时。</li>
</ul>
</li>
<li>
<p><strong>观察<code>YGC</code>列</strong>：如果这个数字在短时间内（比如几秒钟）快速、稳定地增长，就证实了YGC确实非常频繁。</p>
</li>
<li>
<p><strong>观察<code>E</code>列</strong>：你会看到Eden区的使用率像心电图一样，在短时间内从一个较低的值飙升到接近100%，然后一次YGC后又瞬间降下来，周而复始。这个“心跳”的频率越高，说明YGC越频繁。</p>
</li>
</ul>
<p>使用<code>jmap</code>定位内存中的“元凶”,它能生成堆转储快照（heap dump）或查看堆中对象的统计信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -histo &lt;PID&gt; | <span class="built_in">head</span> -n 20</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>如何分析</strong>: <code>jmap -histo</code>的输出包含四列：<code>num</code>(序号), <code>instances</code>(实例数量), <code>bytes</code>(总字节数), <code>class name</code>(类名)。
<ul>
<li><strong>重点关注</strong>：<strong><code>instances</code>和<code>bytes</code>这两列</strong>。排在最前面的类，就是当前在堆中<strong>数量最多</strong>或<strong>占用空间最大</strong>的对象。</li>
<li><strong>关联YGC问题</strong>: 如果YGC频繁，通常意味着有大量的<strong>短生命周期对象</strong>被创建。这些对象可能在<code>jmap</code>运行时已经被回收了。但我们仍然可以从列表中找到那些<strong>创建速率极高</strong>的类的蛛丝马迹。比如，你发现<code>java.lang.String</code>、<code>byte[]</code>、或者某个业务DTO类的实例数量异常地高，那么问题很可能就出在创建这些对象的代码上。</li>
</ul>
</li>
</ul>
<p>进行代码审查：</p>
<ol>
<li>
<p><strong>代码审查</strong>: 拿着<code>jmap</code>找到的嫌疑类名，去代码库中搜索，看看哪些业务逻辑在大量、循环地创建这些类的实例。</p>
<ul>
<li>常见问题场景:
<ul>
<li>在一个循环中，反复创建<code>String</code>对象进行拼接（应该使用<code>StringBuilder</code>）。</li>
<li>不合理地使用了<code>new</code>关键字，本可以复用的对象却在循环中反复创建。</li>
<li>日志级别过低（如DEBUG），在生产环境输出了大量不必要的字符串对象。</li>
<li>从数据库或缓存中查询出了巨大的数据集合，并创建了大量的DTO/VO对象。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>解决方案</strong>:</p>
<ul>
<li>
<p><strong>优化代码 (首选)</strong>: 如果是代码问题，<strong>根本的解决方案是优化代码</strong>。比如使用对象池、优化算法、减少循环中的对象创建等。</p>
</li>
<li>
<p>JVM调优 (次选): 如果代码中的内存分配速率是业务所必须的、合理的，但YGC依然频繁，那么就应该考虑调整JVM参数来</p>
<p>增大年轻代的空间。</p>
<ul>
<li><code>-Xms</code> / <code>-Xmx</code>: 设置堆的总大小。</li>
<li><code>-Xmn</code>: <strong>直接设置年轻代的大小</strong>。增大这个值可以有效降低YGC的频率。</li>
<li><code>-XX:NewRatio=N</code>: 设置老年代与年轻代的比例（<code>老年代/年轻代</code>）。减小这个值，相当于增大了年轻代的占比。</li>
<li><code>-XX:SurvivorRatio=N</code>: 设置Eden区与单个Survivor区的比例。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="7-GC回收时对象地址的拷贝是怎么实现的">7.GC回收时对象地址的拷贝是怎么实现的</h2>
<p>对象地址的拷贝，或者更准确地说，是<strong>对象的移动（Moving）</strong>，是所有**“复制”（Copying）<strong>和</strong>“标记-整理”（Mark-Compact）**算法的GC中必不可少的一环。它的实现方式直接关系到GC的效率。</p>
<p>这个过程的实现，可以从**“为什么需要拷贝”<strong>、</strong>“拷贝的是什么”<strong>以及</strong>“如何高效地实现拷贝”**这三个层面来理解。</p>
<p>为什么？拷贝对象的核心目的是为了<strong>解决内存碎片化</strong>问题。</p>
<p>通过将所有存活的对象**拷贝（移动）*<em>到内存的一端，使其紧凑排列，GC就可以在另一端获得一块*<em>完整、连续的空闲空间</em></em>。这不仅解决了碎片问题，还使得后续的内存分配可以恢复使用高效的“指针碰撞”方式。</p>
<p>是什么？</p>
<p>一个Java对象在HotSpot虚拟机中的内存布局。它主要由三部分组成：</p>
<ol>
<li><strong>对象头 (Header)</strong>：
<ul>
<li><strong>Mark Word</strong>: 存储了对象的哈希码、GC分代年龄、锁状态标志等。</li>
<li><strong>Klass Pointer</strong>: 指向该对象对应的类元数据（Klass）的指针。</li>
<li><strong>数组长度</strong>: 如果是数组对象，还会有这部分。</li>
</ul>
</li>
<li><strong>实例数据 (Instance Data)</strong>：对象真正存储有效信息的字段内容。</li>
<li><strong>对齐填充 (Padding)</strong>：HotSpot VM要求对象起始地址必须是8字节的整数倍，如果对象大小不是8字节的倍数，就需要这部分来补齐。</li>
</ol>
<p><strong>GC拷贝的就是这整个对象（对象头 + 实例数据 + 对齐填充）的完整内存块。</strong></p>
<p>如何高效地实现拷贝？以G1为例的底层实现</p>
<p>G1的年轻代和老年代回收，都是基于“复制”算法。它会将一个或多个Region（称为CSet，Collection Set）中的存活对象，拷贝到新的空闲Region中。这个过程发生在“Stop-the-World”（STW）暂停期间。</p>
<p>会基于以下的步骤：</p>
<ul>
<li>GC线程会遍历CSet中所有Region。对于每个Region，它会查找那些在<strong>并发标记</strong>阶段被标记为存活的对象。</li>
<li><strong>分配新空间</strong>：在目标空闲Region中，为该对象申请一块大小相同的新内存空间。这通常通过高效的**线程本地分配缓冲（TLAB）**来完成，以避免多线程竞争。</li>
<li><strong>拷贝对象内容</strong>：执行一次<strong>内存块的批量拷贝</strong>。这通常是通过调用底层高效的<code>memcpy</code>之类的函数来完成的，将旧地址的整个对象内容原封不动地复制到新分配的内存地址。</li>
<li>对象被拷贝到新地址后，<strong>必须在旧对象的对象头（Mark Word）中，留下一个指向新地址的“转发指针”</strong>。</li>
<li>这个转发指针的作用是：在GC的后续工作中，如果其他对象仍然持有指向这个旧对象的引用，当GC扫描到这个引用时，它会通过旧对象头里的转发指针，发现该对象已经“搬家”了，并直接将这个引用<strong>更新为指向新地址</strong>。</li>
<li>当一个对象被拷贝后，GC线程会立即扫描这个<strong>新拷贝的对象</strong>内部的<strong>所有引用字段</strong>。
<ul>
<li><strong>如果该对象已经被拷贝</strong>（即其旧地址的对象头里已经有了转发指针），则直接将当前对象的引用更新为转发指针指向的新地址。</li>
<li><strong>如果该对象还未被拷贝</strong>，则<strong>递归地</strong>对这个被引用的对象执行上述的拷贝、设置转发指针、更新引用的完整流程。</li>
</ul>
</li>
<li>这个过程就像一个<strong>深度优先或广度优先的图遍历</strong>。从根对象（GC Roots）出发，一边拷贝存活对象，一边修复指向它们的引用，直到所有可达的存活对象都被拷贝到新的Region中，并且所有相关的引用都已更新为新地址。</li>
</ul>
<p>当CSet中所有的存活对象都被拷贝完毕后，这些旧的Region就可以被整体视为<strong>完全空闲</strong>，并被回收以备后续使用。</p>
<p>总结以下：</p>
<ul>
<li>通过<strong>内存批量拷贝</strong>（如<code>memcpy</code>）高效地移动对象内容。</li>
<li>利用<strong>转发指针</strong>机制，在旧对象的对象头记录新地址，作为后续引用更新的依据。</li>
<li>通过<strong>递归或迭代</strong>的方式，遍历对象图，一边拷贝对象，一边修复指向已移动对象的引用。</li>
<li>在多线程GC中，通常会使用<strong>线程本地分配缓冲（TLAB）**来加速新空间的分配，并使用**CAS</strong>等同步原语来保证多线程操作的正确性。</li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">mengnankkzhou</div><div class="post-copyright__author_desc">不要走捏</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/jvm/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/jvm/')">JVM八股分析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/jvm/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=JVM八股分析&amp;url=https://blog.tokenlen.top/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/jvm/&amp;pic=https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712178.jpg?_r_=697e18d0-4b05-4e0c-91fd-bbf44bf103dd" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.tokenlen.top" target="_blank">mengnankkのblog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E9%9D%A2%E7%BB%8F/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>面经<span class="categoryesPageCount">24</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>面试<span class="tagsPageCount">46</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712181.jpg?_r_=6132de7c-3f14-7921-6714-c04567cf01cb" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/mybatis/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg?_r_=9a7f77d7-c884-9139-822c-9630a7d7efd9" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Mybatis八股分析</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/javase/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837602.jpg?_r_=38026470-36cd-7126-e534-28f8ca207950" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JavaSe八股分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/k8s/" title="k8s八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202408081510095.jpg?_r_=1946ef44-9122-9e20-2a98-3d3d64834e08" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-25</div><div class="title">k8s八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/aicode/" title="aicode八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722379.jpg?_r_=2c454395-7291-5686-d45b-0b5e827300ee" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">aicode八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/cap/" title="分布式八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221818490.jpeg?_r_=a63d9e27-eaca-87ee-f73c-6890f3a02225" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">分布式八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/changjing/" title="场景八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712177.jpg?_r_=8febae7b-426b-3e45-e836-e0d8b9fbf060" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">场景八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/juc/" title="JUC八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221818490.jpeg?_r_=da192e4a-671b-689f-fd04-6641e95e4391" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">JUC八股分析</div></div></a></div><div><a href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/javase/" title="JavaSe八股分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837602.jpg?_r_=38026470-36cd-7126-e534-28f8ca207950" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-24</div><div class="title">JavaSe八股分析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Valine</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">清风拂柳影，碧水映花香。</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">mengnankkzhou</h1><div class="author-info__desc">不要走捏</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/mengnankkkk" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/440831872" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410021212939.jpg) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">JVM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%82%A3%E6%9C%89%E5%93%AA%E4%BA%9B%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%9C%A8%E6%A0%88%E4%B8%8A%E5%88%86%E9%85%8D%E5%91%A2%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">1.那有哪些对象是可以直接在栈上分配呢？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-JMM%E5%92%8C%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.2.</span> <span class="toc-text">2.JMM和一个对象的生命周期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-GC"><span class="toc-number">1.3.</span> <span class="toc-text">3.GC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Tomcat%E5%A6%82%E4%BD%95%E6%89%93%E7%A0%B4%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%EF%BC%9FTomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F%EF%BC%9F"><span class="toc-number">1.4.</span> <span class="toc-text">4.Tomcat如何打破双亲委派？Tomcat类加载顺序？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-G1%E5%9B%9E%E6%94%B6%E5%99%A8%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86%E5%A4%A7%E5%AF%B9%E8%B1%A1%EF%BC%9F"><span class="toc-number">1.5.</span> <span class="toc-text">5.G1回收器怎么处理大对象？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%A6%82%E6%9E%9C%E5%8F%91%E7%8E%B0-young-GC%E9%A2%91%E7%B9%81%EF%BC%8C%E6%88%91%E8%AF%A5%E6%80%8E%E4%B9%88%E5%AE%9A%E4%BD%8D%EF%BC%8C%E6%80%8E%E4%B9%88%E7%94%A8-jvm-%E7%9A%84%E6%8C%87%E4%BB%A4%E5%AE%9A%E4%BD%8D%E3%80%82"><span class="toc-number">1.6.</span> <span class="toc-text">6.如果发现 young GC频繁，我该怎么定位，怎么用 jvm 的指令定位。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-GC%E5%9B%9E%E6%94%B6%E6%97%B6%E5%AF%B9%E8%B1%A1%E5%9C%B0%E5%9D%80%E7%9A%84%E6%8B%B7%E8%B4%9D%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84"><span class="toc-number">1.7.</span> <span class="toc-text">7.GC回收时对象地址的拷贝是怎么实现的</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/" title="日志系统设计"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712181.jpg?_r_=6132de7c-3f14-7921-6714-c04567cf01cb" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="日志系统设计"/></a><div class="content"><a class="title" href="/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/" title="日志系统设计">日志系统设计</a><time datetime="2025-10-08T16:00:00.000Z" title="发表于 2025-10-09 00:00:00">2025-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/new-stack/k8s1/" title="K8S"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202408081510550.jpg?_r_=8d94cc26-3730-44e8-cecf-b90132b1f448" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S"/></a><div class="content"><a class="title" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/new-stack/k8s1/" title="K8S">K8S</a><time datetime="2025-09-24T16:00:00.000Z" title="发表于 2025-09-25 00:00:00">2025-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/k8s/" title="k8s八股分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202408081510095.jpg?_r_=1946ef44-9122-9e20-2a98-3d3d64834e08" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s八股分析"/></a><div class="content"><a class="title" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/k8s/" title="k8s八股分析">k8s八股分析</a><time datetime="2025-09-24T16:00:00.000Z" title="发表于 2025-09-25 00:00:00">2025-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/aicode/" title="aicode八股分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722379.jpg?_r_=2c454395-7291-5686-d45b-0b5e827300ee" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="aicode八股分析"/></a><div class="content"><a class="title" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/aicode/" title="aicode八股分析">aicode八股分析</a><time datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/cap/" title="分布式八股分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221818490.jpeg?_r_=a63d9e27-eaca-87ee-f73c-6890f3a02225" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式八股分析"/></a><div class="content"><a class="title" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/cap/" title="分布式八股分析">分布式八股分析</a><time datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Framework-Hexo-4e88f8?style=flat&logo=hexo" 
       title="博客框架为 Hexo" alt="Hexo">
</a>
<a style="margin-inline:5px" target="_blank" href="https://github.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Source-Github-24292f?style=flat&logo=github" 
       title="本站项目由 GitHub 托管" alt="GitHub">
</a>
<a style="margin-inline:5px" target="_blank" href="https://vercel.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-Vercel-000000?style=flat&logo=vercel" 
       title="使用 Vercel 部署" alt="Vercel">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.qlu.edu.cn/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/University-齐鲁工业大学-0056a2?style=flat&logo=university" 
       title="齐鲁工业大学" alt="齐鲁工业大学">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.aliyun.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-阿里云-ff6a00?style=flat&logo=aliyun" 
       title="使用阿里云服务" alt="阿里云">
</a>
<a style="margin-inline:5px" target="_blank" href="https://cloud.tencent.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-腾讯云-0a73b8?style=flat&logo=tencent-cloud" 
       title="使用腾讯云服务" alt="腾讯云">
</a></p>
</div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2025 By <a class="footer-bar-link" href="/" title="mengnankkzhou" target="_blank">mengnankkzhou</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="鲁ICP备2024110758号">鲁ICP备2024110758号</a><a class="footer-bar-link" href="https://blog.tokenlen.top/rss2.xml" title="Rss">Rss</a><a class="footer-bar-link cc" href="/pravite" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">193</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">57</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">27</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 0.88rem;">BF<sup>1</sup></a><a href="/tags/BUG/" style="font-size: 0.88rem;">BUG<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 0.88rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 0.88rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 0.88rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 0.88rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 0.88rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 0.88rem;">FI<sup>1</sup></a><a href="/tags/Github/" style="font-size: 0.88rem;">Github<sup>1</sup></a><a href="/tags/Go/" style="font-size: 0.88rem;">Go<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 0.88rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>12</sup></a><a href="/tags/XSS/" style="font-size: 0.88rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>2</sup></a><a href="/tags/football/" style="font-size: 0.88rem;">football<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>61</sup></a><a href="/tags/juc/" style="font-size: 0.88rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 0.88rem;">jvm<sup>2</sup></a><a href="/tags/markdown/" style="font-size: 0.88rem;">markdown<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>17</sup></a><a href="/tags/net/" style="font-size: 0.88rem;">net<sup>7</sup></a><a href="/tags/paper/" style="font-size: 0.88rem;">paper<sup>1</sup></a><a href="/tags/php/" style="font-size: 0.88rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 0.88rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 0.88rem;">python<sup>3</sup></a><a href="/tags/redis/" style="font-size: 0.88rem;">redis<sup>4</sup></a><a href="/tags/shell/" style="font-size: 0.88rem;">shell<sup>4</sup></a><a href="/tags/spring/" style="font-size: 0.88rem;">spring<sup>4</sup></a><a href="/tags/spring-boot/" style="font-size: 0.88rem;">spring boot<sup>14</sup></a><a href="/tags/sql/" style="font-size: 0.88rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>3</sup></a><a href="/tags/%E5%8E%8B%E6%B5%8B/" style="font-size: 0.88rem;">压测<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 0.88rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 0.88rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>20</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 0.88rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>9</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 0.88rem;">面试<sup>46</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 mengnankkzhou 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@3.2.2/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://comment.tokenlen.top/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, "siu~~~~~"))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://comment.tokenlen.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '3ZpuzQHHKWfFH59QFYmcuCvr-gzGzoHsz',
      appKey: '8DIvljObQp853ueQMZzpb9Gx',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Twikoo' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://comment.tokenlen.top/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>