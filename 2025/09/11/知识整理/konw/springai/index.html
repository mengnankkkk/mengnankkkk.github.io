<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>AI技术源码分析 | mengnankkのblog</title><meta name="keywords" content="java,springAI"><meta name="author" content="mengnankkzhou"><meta name="copyright" content="mengnankkzhou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="AI技术源码分析"><meta name="application-name" content="AI技术源码分析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="AI技术源码分析"><meta property="og:url" content="https://blog.tokenlen.top/2025/09/11/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/springai/index.html"><meta property="og:site_name" content="mengnankkのblog"><meta property="og:description" content="Spring AI Alibaba Graph 旨在利用 Spring AI 作为桥梁，连接阿里巴巴的大语言模型（如通义千wen）和图数据库（如阿里云 GDB），以实现通过自然语言与复杂关联数据进行交互的目的。 底层核心原理是 Text-to-Cypher&amp;#x2F;Gremlin，即将用户的自然语言问题，通"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=4b7543c8-82eb-c73e-e489-4adfeccbdaa1"><meta property="article:author" content="mengnankkzhou"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=4b7543c8-82eb-c73e-e489-4adfeccbdaa1"><meta name="description" content="Spring AI Alibaba Graph 旨在利用 Spring AI 作为桥梁，连接阿里巴巴的大语言模型（如通义千wen）和图数据库（如阿里云 GDB），以实现通过自然语言与复杂关联数据进行交互的目的。 底层核心原理是 Text-to-Cypher&amp;#x2F;Gremlin，即将用户的自然语言问题，通"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.tokenlen.top/2025/09/11/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/springai/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走啊，那种事情不要啊","backTitle":"♪(^∇^*)欢迎回家！！！！"},
  LA51: undefined,
  greetingBox: {"enable":"ture","default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://comment.tokenlen.top/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"\tbd9428de12b54b96b2f1b4e69aeee81f","mailMd5":"F37442226DA71492"},
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: mengnankkzhou","link":"链接: ","source":"来源: mengnankkのblog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'mengnankkのblog',
  title: 'AI技术源码分析',
  postAI: '',
  pageFillDescription: 'Spring AI Alibaba Graph, 设计思想, 架构, 三大核心, Google GraphRAG, 知识图谱Graph-bulider, 基本流程, 查询语言 Cypher, 优化检索, 知识图谱的设计, 逻辑设计, 模块设计, 数据Model设计, 分布式微服务设计, 遇到问题及其解决, 提示词工程, AI记忆力amp多轮对话的实现, 短期记忆, 中期记忆, 长期个性化记忆, 记忆上下文构建, 性能问题解决, SSE, nl2sql, 核心旨在利用作为桥梁连接阿里巴巴的大语言模型如通义千和图数据库如阿里云以实现通过自然语言与复杂关联数据进行交互的目的底层核心原理是即将用户的自然语言问题通过大语言模型动态翻译成图数据库的专业查询语言设计思想图数据库非常擅长处理实体之间的复杂关系例如社交网络中的朋友的朋友金融风控中的资金链路电商中的共同购买等但要查询这些数据需要使用专门的图查询语言如阿里云支持或这些语言学习门槛高普通业务人员无法直接使用架构的核心思想就是解决这个问题让充当一个智能的翻译官流程赋予上下文知识一个通用的不知道你的图数据库里有什么因此必须在查询时动态地告诉图的模式包括节点标签例如人公司产品边标签例如为工作投资了购买了属性每个节点和边上可能有的属性例如节点有属性利用的代码生成能力大语言模型本质上是一个强大的序列生成器它不仅能生成文章也能生成代码通过精巧的提示工程我们可以引导将用户的自然语言问题结合我们提供的图生成一段完全正确的或查询代码自动化执行与反馈生成查询代码后程序自动执行它并将结果返回为了提升用户体验甚至可以将图数据库返回的结构化数据再次交给让它用自然语言进行总结和概括架构实际流程用户提问用户通过前端界面或输入自然语言问题查询投资了阿里巴巴的所有人的姓名应用接收一个基于和构建的后端服务接收到这个请求构建精确的这是最关键的一步程序会动态构建一个发给的它通常包含以下部分入口开发者代码调用查詢投資了阿里巴巴的所有人委派将请求委派给检索首先调用其持有的方法假设会连接数据库执行或类似命令获取并格式化为文本构建使用将上一步获取的文本和用户问题填充到一个预设的模板中生成最终的对象生成调用捕获此调用向通义千问发送请求解析通义千问返回一个包含查询的使用从中提取出纯净的查询字符串执行拿到查询字符串后调用返回使用执行查询并将结果返回这个结果最终沿着调用链返回给开发者三大核心图存储的统一抽象设计目的将上层的逻辑与底层具体的图数据库阿里云等完全解耦无论底层是什么图数据库对上层来说它们都只是一个核心方法这是实现的信息来源此方法负责连接到底层数据库并提取其信息节点标签边标签属性等将其格式化为一个可以喂给的字符串这是执行查询的统一入口它接收生成的查询字符串如或并通过具体的数据库驱动来执行它然后返回结果设计模式策略模式用户可以根据自己的数据库类型注入不同的实现例如而上层的代码无需任何改动一个抽象类的实现问题挑战的信息密度挑战提示词爆炸与成本问题当图的变得非常庞大时成百上千种节点和边返回的字符串会非常长这不仅会急剧增加调用的成本更严重的是过长的充斥着大量无关信息的上下文反而可能降低的理解和推理能力导致生成错误的查询的知识密度不足只定义了结构但没有定义语义例如一个的边其属性是正是负代表什么业务含义仅从中无法得知解决一个更先进的实现不应该仅仅是暴力地返回整个它应该进化为一个智能检索器知识图谱化向量化将图的本身节点标签边标签属性及其注释也构建成一个小型知识图谱或将其向量化存储两阶段当用户提问时第一阶段先对用户的问题进行向量相似度搜索从海量的中检索出与问题最相关的子图例如问题关于交易就只提取等相关的节点和边第二阶段再将这个高度相关的精简的子图喂给去生成查询动态数据样本还可以被增强为除了返回还能动态地从图中抓取几条与问题相关的实际数据样本例如几条交易记录一并作为上下文提供给这能极大地帮助理解数据格式和语义提升查询准确率面向用户的核心入口设计目的隐藏所有内部复杂的交互流程获取构建调用解析响应执行查询为最终用户提供一个极其简单的接口核心方法剖析这是最核心的方法开发者只需要传入自然语言问题就可以得到图数据库的查询结果它的默认实现会编排下面要讲的和来完成整个流程交互与智能的核心设计目的专门负责处理与大语言模型之间的所有交互实现核心的转换逻辑核心依赖注入它会被注入一个实例和一个的实例工厂内部会使用一个来创建这个工厂是提示工程的具体体现它会接收获取到的和用户问题然后把它们组装成一个结构化高质量的模板调用它使用注入的将生成的发送给例如通义千问响应解析它还包含一个因为的返回内容可能不只是纯粹的查询语句例如可能包含在的代码块中或者有一些解释性的文字负责从的原始响应中精确地提取出可执行的查询代码这一步是保证系统稳定性的关键的核心目标是从非结构化文本中构建图以优化的检索效果传统的向量检索只能找到与问题表面相似的文本片段却忽略了文档内部和文档之间隐藏的深层语义关联的核心思想就是通过从文本中提取实体和关系来构建知识图谱并利用图的社区结构来发现这些深层关联从而为提供更全面更具上下文的背景信息图的角色在这里图不是最终的知识库而是一个为了提升检索质量而生成的中间索引结构最终答案的来源依然是原始的文本的流程分为离线索引和在线查询两个阶段阶段一离线索引数据预处理实体与关系提取系统读取所有源文档如利用遍历这些文本提取出关键的实体人事物概念以及它们之间的关系图谱构建将提取出的实体作为节点关系作为边构建一个全局的知识图谱社区检测在构建好的图上运行图算法如算法将整个图划分成若干个高内聚低耦合的语义社区每个社区代表了一组在语义上紧密相关的主题或事件社区摘要利用为每一个检测出的社区生成一个高度概括的摘要描述阶段二在线查询应答用户提问用户提问用户提出一个问题多路检索系统并行地在两个层面上进行检索全局检索在所有社区摘要上进行向量检索快速定位到与问题最相关的几个社区局部检索同时也在所有原始文本块上进行传统的向量检索上下文构建这是的核心创新一旦通过全局检索定位到了一个或多个相关社区系统不再是只返回几个零散的文本块而是将整个社区内的所有实体关系以及关联的原始文本块作为一个完整的结构化的上下文提供出来生成答案将这个极其丰富且上下文完整的社区信息包喂给让它基于这些信息生成最终的高质量的答案知识图谱基本流程定义图谱模式节点类型定义你要抽取的实体类别例如人物组织产品地点关系类型定义实体之间可能存在的关系例如任职于创立了位于属性定义节点或关系可能包含的属性例如节点可以有等属性类似于图实体对象以及他们的关系和属性数据准备与预处理收集用于信息抽取的原始非结构化文本数据如新闻文章公司报告技术文档等根据需要进行清洗去除无关信息如标签广告等提示词工程注入属性查询在中清晰地列出预定义的节点类型和关系类型要求以标准易于解析的格式如返回结果这对于后续的自动化处理至关重要指定输入输出格式提供示例在中给出个输入文本输出的例子能极大提升的抽取准确率和格式一致性提供示例便于进行输入输出你是一个信息抽取专家请从下面的文本中根据我提供的抽取出所有实体和关系节点类型关系类型从指向文本张三是阿里巴巴的一名算法工程师而李四则在腾讯工作输出格式请严格按照以下格式输出不要添加任何额外解释张三李四阿里巴巴腾讯张三阿里巴巴李四腾讯调用进行抽取将准备好的文本和精心设计的批量发送给获取结构化的输出结果后处理与校验格式校验验证返回的是否是合法的实体对齐归一化阿里阿里巴巴可能指向同一实体需要进行归一化处理关系校验检查关系是否符合定义例如关系必须连接和数据持久化将校验过的实体和关系数据转换为图数据库如的查询语句通常是然后批量导入到数据库中完成知识图谱的构建查询语言查找名字是的人使用子句进行更复杂的过滤查找所有和是朋友的人给添加一个属性移除的属性给再添加一个标签删除和她所有朋友的关系删除没有关系的节点孤立的节点删除节点及其所有关联的关系非常常用需要删除的人优化检索智能分块按语义分块利用库如或中的尝试按句子段落标题等语义边界进行切分并设置重叠区域来保留上下文联系面向实体命题的分块对于更高级的应用可以先用提取出文本中的核心命题或实体关系然后将这些结构化的信息作为检索单元这能实现更精准的原子化信息检索文档结构化解析针对等文件不仅仅是提取纯文本解析其标题表格列表等结构化信息并将这些元数据与文本块一同索引对后续的元数据过滤至关重要优化嵌入模型选择合适的模型不同的模型有不同的优势例如系列模型在中英文任务上表现优异而的则在多语言和综合性能上领先你需要根据你的主要语种和应用场景进行选型和评测领域微调如果你的业务数据具有非常强的领域特性如法律医疗通用模型可能无法很好地理解专业术语的语义在这种情况下使用领域数据对模型进行微调可以显著提升检索效果数据清洗去除文档中的噪声如标签页眉页脚广告语不相关的图片描述等添加元数据为每个文本块添加丰富的元数据如来源文档章节标题作者发布日期等生成假设性问题使用为每个文本块生成几个它可能回答的问题并将这些问题与文本块一起进行向量化这样当用户的查询与某个假设性问题相似时就能更容易地找到对应的原文这个方法也称为效果显著检索使用混合检索语义检索即向量检索擅长理解概念意图和模糊查询关键词检索如传统的算法擅长匹配精确的关键词术语等优势当用户查询的新特性时关键词检索能精准定位到这个版本号而语义检索能理解新特性这个概念两者结合能大幅提升召回率和准确率许多现代向量数据库如都原生支持混合检索优化参数向量数据库通常使用近似最近邻算法来加速检索最主流的是和构建索引时的邻居节点数越高索引质量越好但构建越慢查询时搜索的邻居节点数越高越精确但延迟也越高聚类中心的数量查询时要搜索的聚类中心数量优化策略根据你的业务场景对延迟和精度的要求通过实验来调整这些参数找到最佳的平衡点例如对于离线分析任务可以调高精度参数对于在线实时问答则需要优先保证低延迟检索后处理优化重排序在通过算法快速召回例如个候选文档后再使用一个更强大更精确但计算量也更大的模型对这批候选结果进行重新排序工作原理初步检索使用的是双编码器模型它独立地为和生成向量而重排序通常使用交叉编码器模型它将和同时输入模型进行计算能更精准地判断两者间的相关性效果能有效地将最相关的文档从提升到极大地改善了送给的上下文质量是一个常用的开源模型查询转换查询重写让将口语化的模糊的查询改写为更清晰更结构化的查询子问题分解当用户提出一个复杂问题时例如对比和的优缺点并说明应用场景可以先让将其分解成多个独立的子问题的优点是什么的优点是什么的应用场景等然后对每个子问题分别进行检索最后汇总结果让从一个具体问题中提炼出一个更泛化更高层次的问题对这个高层次问题进行检索获取更宏观的背景知识有助于回答原始的具体问题多路路由建立多个子索引根据文档的主题或来源如技术文档索引市场分析索引法律条款索引建立不同的向量索引查询路由器在检索前先用一个分类器来判断用户的查询属于哪个主题然后仅在对应的子索引中进行检索优势大大缩小了检索范围提升了速度和精度避免了不同主题间的知识干扰动态构建知识图谱一个系统最怕的就是知识库过时和答案不可信幻觉因此让知识图谱能够动态更新并让所有答案都可溯源是最高阶的要求目标将知识图谱的构建与查询打通并为每一次查询结果提供证据实现知识抽取与写入流水线创建一个知识抽取它持续地读取新的非结构化文档利用的信息抽取能力将文本转化为结构化的实体关系实体三元组将这些三元组转化为图数据库的写入语句如通过将新知识写入知识图谱为知识添加证据元数据在执行上述写入操作时最重要的一点是为每一个创建的节点和关系都附加上来源元数据马云年阿里巴巴年报阿里巴巴年阿里巴巴年报修改的返回结果使其不仅包含数据也包含数据对应的等元数据在最终生成答案的中明确指示你必须根据提供的来源信息为你的答案提供引用知识图谱的设计逻辑设计初始化知识图谱走类似首先将用户输入的信息转换为三元组的形式存储为节点和关系注意使用函数还需要标记来源作为证据然后同样的数据经过嵌入模型向量化存储在向量数据库中根据输入的信息的相关度新建子索引细化处理分析已有知识图谱的查询将输入的语言转为语言进行查询同时在向量数据库中进行关键词查询和语义搜索两个数据库同时搜索出结果将其放入重排模型进行查询然后将最后结果交给进行输出模块设计数据处理数据源适配器负责从不同数据源本地文件系统拉取数据为每种数据源实现一个独立的适配器插件输出统一格式的对象包含内容元数据来源等知识抽取服务接收进行预处理信息抽取和格式化预处理清洗文本去除标签无关字符智能分块使用等策略将长文本切分为有意义的信息抽取设计包含定义和输出格式的调用从中抽取出实体关系属性生成结构化的数据向量化调用模型将每个向量化打包消息将结构化和向量化的打包成一个消息输出向消息队列的特定如发送消息异步写入消费者订阅消息队列实现双模态数据的持久化写入消费者消费解析其中的结构化将其转换为幂等的语句关键设计节点属性必须包含来源关联向量库等溯源信息批量写入写入消费者消费提取向量和元数据元数据中必须包含从写入后生成的用于反向关联根据预设策略如按文档来源将数据写入的指定子索引集合中智能查询将用户自然语言问题高效精准地转化为基于知识的答案查询编排服务作为查询流程的大脑接收转发的用户请求编排整个查询过程生成调用将用户问题转换为查询增加安全防护对生成的进行语法校验和规则检查如限制查询深度防止恶意或低效查询查询任务分发并发地向三个执行器分发任务查询执行器执行语义查询执行器执行向量相似度搜索关键词查询执行器执行全文检索或查询融合与重排引擎收集并发查询的结果进行融合排序筛选出最佳上下文结果规范化将三路查询返回的异构结果图路径文本块转换为统一的对象列表对象结构处理技巧对于结果需将其路径或节点属性渲染成一段通顺的文本作为初步融合与去重合并三个列表并根据内容相似性进行去重调用重排模型将融合后的列表例如和原始用户问题一起发送给重排模型模型会对每个与问题的相关性进行打分筛选根据重排模型的得分选出最相关的个如作为最终上下文答案合成服务基于筛选出的高质量上下文生成最终答案构建最终模板如下请根据以下上下文信息用严谨专业的语气回答用户的问题在回答时请明确引用信息的来源上下文插入用户问题原始问题调用生成使用流式调用将生成的答案实时返回给前端数据设计节点等节点属性全局唯一标识符实体名称知识来源其他业务属性格式时间戳关系等关系属性关系来源的文档或句子关系强度集合分布式微服务设计遇到问题及其解决数据库的一致性问题因为我们使用一个图数据库一个向量库所以我们的数据库如何保证一致性呢写操作需要同时成功写入和两个异构系统无法使用传统的两阶段提交实现分布式事务解决方案采用事务性发件箱消息队列模式保证最终一致性改造知识抽取服务当服务完成信息抽取和向量化后不要直接向发消息而是在同一个本地数据库事务中将存入一张本地的表并将业务数据的状态更新这样保证了只要业务成功要发送的消息就一定被持久化了引入消息中继部署一个独立的服务推荐使用专门负责扫描表一旦发现新消息就将其可靠地投递到并在成功投递后标记或删除表中的对应记录效果这个模式将业务操作和消息发送解耦彻底避免了业务成功但消息没发出去或消息发出去了但业务回滚了的经典问题保证了消息至少成功发布一次消息幂等的处理至少一次的消息投递保证意味着消费者可能会收到重复消息同时网络或消费者崩溃可能导致消息丢失依靠的持久性保证消费者的幂等设计防止消息丢失生产者侧在消息中继服务中设置的确保消息被所有确认后才算成功消费者侧关闭消费者的改为手动提交偏移量只有当数据成功写入和后才在代码中显式调用如果写入失败程序抛出异常偏移量不会被提交下次重启后会重新消费这条消息保证消费者幂等在消息中生成一个全局唯一的写入消费者操作天生就是幂等的无需额外处理写入消费者在写入前先根据主键检查数据是否已存在如果存在则执行更新操作如果不存在则执行插入或者消费者可以维护一个已处理的记录例如存在中并设置在处理消息前先检查是否已被处理引入缓存来解决记忆力的问题查询链路长调用成本高延迟大多轮对话需要维持上下文记忆引入作为多级缓存和会话存储多级缓存策略缓存层用户问题字符串生成的字符串对于高频通用的问题可以秒级响应缓存层查询结果查询或向量查询序列化的查询结果对于热点数据查询直接返回缓存结果无需穿透到数据库缓存失效与更新策略采用作为基本失效策略例如缓存小时这是一种简单有效的折衷进阶策略采用事件驱动的缓存失效当知识沉淀流水线更新了某部分知识时可以向一个专门的发送消息订阅该的服务负责精确地删除相关的缓存记忆性会话管理方案使用来存储每一轮对话的上下文数据结构使用的或消息消息流程用户发起新一轮对话时传入后端服务从中加载最近的轮对话历史将对话历史当前问题检索到的一起构建成发送给将当前的问答对存回的对应的列表中框架集成等框架的等记忆模块可以很容易地与自定义的存储后端如集成冗余数据如何在两个物理隔离的数据库间建立逻辑引用并优化存储成本通过关联各司其职写入消费者先行消费者处理消息通过操作在中创建节点会自动为节点生成一个内部但我们最好自己生成一个业务上的并存为属性消息增强与转发消费者成功写入后它需要将这个写回消息中或者发送一条包含和关联关系的新消息到另一个写入消费者后行消费者监听这条被增强后的消息这样在写入时它就能拿到对应的并将其存入记录的字段中效果这样就建立了一个从到的单向引用查询时可以从结果中轻松找到对应的节点进行更深度的图遍历成本优化再次强调中只存储结构化数据和少量元数据完整的原始文本块只在中存储一份需要时通过上述关联进行查询异构结果的融合策略和如何合并成一个有序的渲染规范融合去重关键函数将图路径转为自然语言描述关键函数根据路径长度关系权重等计算得分简单的做法是直接按分数排序但效果更好能平衡不同召回源的排序偏差这里简化为排序基于内容相似性如相似度或进行去重保留最高分的网络延迟处理复杂的分布式调用链条生成代码的不可控性解决全链路异步化严格的防护栏与超时控制降低延迟全链路异步在后端大量使用让三路查询结果融合调用等密集型操作完全异步化最大化利用计算资源连接池确保所有数据库和外部服务的客户端都配置了合理的连接池稳定性与安全模板化与参数化对于特定意图的查询与其让从头生成不如预定义一些查询模板让只负责填充模板中的参数这极大提升了稳定性和安全性执行前静态分析在执行生成的前可以使用的库在中对其进行抽象语法树解析通过分析可以实施非常精细的规则例如禁止不带的全图扫描限制路径的最大长度禁止写入操作如运行时超时在中为每个查询设置一个严格的执行超时时间这是最后的也是最有效的防线可以防止一个糟糕的查询拖垮整个数据库提示词工程记忆力多轮对话的实现短期记忆使用滑动窗口来实现固定窗口大小在每次请求时只将最近的轮对话例如最近轮作为上下文连同当前问题一起发送给但是容易出现上下文丢失一旦对话超过轮最早的信息就会被永久丢弃如果用户在第轮提到的关键信息如我叫张三在第轮时就忘了记忆僵化无法识别哪些历史信息是重要的哪些是无关紧要的闲聊存储使用的数据结构是最佳选择每个对应一个数据模型中的每个元素是一个字符串如你好流程用户发来消息附带从中用获取最近的条记录将这条记录和当前问题一起构建成获取的回答后将当前的用户问题和回答用和命令存入保持其大小不超过框架支持中的就是这个模式的直接实现中期记忆随着对话的进行不再保留全部历史而是调用对越来越长的对话历史进行滚动总结形成一个摘要每次请求时将历史摘要最近几轮对话作为上下文可以作为中期记忆作为每个会话结束的总结实现存储摘要可以存在的或中或者持久化到的某个字段流程设定一个阈值例如每轮对话触发一次总结当对话达到轮时启动一个后台任务或在当前请求中将当前的旧摘要轮对话发送给并附上请总结以下对话将返回的新摘要更新到数据库中构建下一次请求的时结构为这是我们之前的对话摘要接下来是最近的几轮对话用户问题框架支持中的提供了此功能长期个性化记忆这是一种结构化长期记忆的方案在对话过程中实时地使用一个或专门的模型来抽取出对话中出现的关键实体属性和关系并将这些结构化信息存入知识图谱如或关系型数据库可以个性化存储用户的消息可以深度思考跨会话的消息设计在中定义用户中心节点以及等节点异步抽取流程在每轮对话结束后将对话内容发送到一个后台处理服务该服务调用为从以下文本中抽取出人名地名用户偏好等实体信息并以格式返回服务解析生成语句如音乐周杰伦更新知识图谱查询与注入在每轮对话开始时除了加载短期记忆还要根据当前问题中的实体查询知识图谱获取相关背景知识例如如果用户问给我推荐几首歌可以先查询图谱中该用户的音乐偏好然后将该用户喜欢周杰伦这个事实注入到最终的中让做出更个性化的推荐记忆上下文构建职责就是根据当前的对话和用户输入从各个记忆层中并行地获取相关信息并按照预设的优先级和格式组装成最终注入到中的上下文层接收到用户请求调用该方法内部并行启动三路记忆的加载构建器等待所有结果返回然后按照长期中期短期的优先级组装成一个结构化的上下文字符串将组装好的和填入最终的模板中调用并将结果流式返回给用户在后台将当前的问答对异步地发送到的触发短期和长期记忆的更新通过会话超时或用户登出等事件触发事件更新中期记忆性能问题解决查询链路延迟过高在高并发下即使用户平均响应时间尚可但总有或的用户会经历无法忍受的慢响应的并行设计虽好但木桶的最短板决定了最终性能数据库层面比如图数据库中查询的信息都要加上索引增快查询速度使用和进行分析防止全表扫描合理配置堆内存和页缓存引入新的缓存实现三级缓存架构本地缓存缓存但是要注意数据的一致性可以引用新的中间件来保证数据的最终一致性的问题线程池的隔离并行中为不同的任务指定不同的专用线程池防止一个慢任务拖垮其他任务的工作使用来进行链路的追踪具体是哪个环节出了问题然后数据库查慢日志仪表盘等等手段上下文的剪切计算组装好的上下文的总数如果超过预设阈值如则调用一个更便宜更快的模型如让它对上下文进行压缩和筛选请从以下信息中筛选出与用户问题最相关的部分并保持在个以内将压缩后的上下文用于最终的昂贵的模型如调用建立模型的路由用户问题首先经过一个分类器可以是小也可以是传统模型判断其意图是简单问答闲聊还是复杂推理根据分类结果将请求路由到不同成本和能力的模型幻觉脏数据处理在抽取实体和关系时可能产生幻觉导致错误的信息被存入长期记忆进而污染后续所有基于此记忆的回答创建一个黄金标准的测试集包含上百个有代表性的问题预期答案应检索到的上下文三元组自动化回归测试在每次系统有重大更新如更换模型修改后自动化地运行整个测试集并计算关键指标检索质量答案质量使用模式让等强模型来评估生成答案的准确性忠实度相关性并打分对比较重要的数据进行人工审核的处理用户层面可以点赞或者点踩然后我们重点分析点踩的那一部分数据模型的更换采用非阻塞与响应式编程这是现代构建高性能网络应用的黄金组合使用事件循环模型用极少数的线程如核心数就可以处理成千上万的并发连接线程不会因等待数据等待返回等待网络写入而被阻塞而是去处理其他事件数据从流出到写入响应给客户端的网络缓冲区全程不应在你的后端服务中发生显著的完整的数据聚合一种基于标准的服务端到客户端的单向消息推送协议它是为流式更新而生的服务器发送事件是一种允许服务器随时向客户端推送数据的技术从本质上讲它是在单个持久的连接上实现的从服务器到客户端的单向数据流客户端一旦与服务器的端点建立连接这个连接就会保持打开状态服务器可以随时通过这个连接以一种特定的文本格式将事件数据发送给客户端的美妙之处在于其协议极度简单服务器在响应时必须将的设置为之后发送的内容遵循以下格式这是最重要的字段用于承载你要发送的数据可以是一行也可以是多行这是第一行数据这是第二行数据在客户端这两行数据会被拼接成这是第一行数据这是第二行数据用于为事件命名如果省略事件的默认名称是通过命名事件你可以在前端为不同类型的消息绑定不同的监听器为每个事件设置一个唯一的这个的主要作用是实现断线重连如果连接意外中断浏览器在自动重连时会把上次接收到的值通过请求头发送给服务器服务器可以根据这个补发在断连期间可能丢失的数据告诉浏览器在连接断开后应该等待多少毫秒再尝试重连这表示秒后重试一个完整的消息块由一个空行分隔实例聊天机器人响应流我们的核心场景逐字或逐词地将的回答推送到前端实时通知如社交网络的你有新消息或电商的订单已发货金融数据更新股票价格加密货币行情等实时数据的推送新闻或体育比分直播将最新的事件和比分实时更新到页面系统监控仪表盘实时显示服务器的内存使用率等监控指标通过类提供了对的完美支持它以非阻塞的方式工作不会为每个连接都占用一个宝贵的线程一个基于自然语言生成查询的智能体框架该框架的核心作用是充当一个翻译器将用户输入的自然语言问题例如查询上个季度销售额最高的三个产品是什么自动转换成对应数据库可以执行的查询语句核心基本流程输入理解框架接收用户的自然语言输入意图识别与槽位填充利用大语言模型的自然语言理解能力分析问句的意图查询统计对比等并提取关键信息查询的指标过滤条件时间范围等数据库元数据理解框架需要理解目标数据库的结构信息包括表名列表字段类型表之间的关联关系主外键等这通常通过预先读取和处理数据库的来实现生成这是最核心的环节框架会将用户的意图关键信息与数据库的信息一同作为上下文构建成一个高效的提示然后提交给通义大语言模型大模型根据这些上下文信息生成准确的符合特定数据库方言如的查询语句执行与结果返回生成的语句被发送到目标数据库执行并将查询结果返回给用户框架可能还会对结果进行格式化或进一步的自然语言解释设计方式扩展优化基于大语言模型驱动轻量级与可扩展智能体框架链接与召回策略优化对于拥有成百上千张表的复杂数据库如何根据用户问题动态准确地选择最相关的表和字段是提升生成质量的关键可以引入更先进的向量化匹配和知识图谱技术来优化这一过程搜索处理模糊和同义词增强对业务术语别名和同义词的理解能力例如用户说查一下系统能自动关联到成交总额这一指标对应的字段复杂函数的处理窗口函数与复杂分析提升对需要使用窗口函数公共表达式等高级特性的复杂分析类问题的支持跨数据源查询支持用户的一个问题需要查询多个异构数据库才能回答的场景',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-20 17:24:41',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/rss2.xml" title="mengnankkのblog" type="application/rss+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">mengnankkのblog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://imgbed.mengnankk.asia/202407021650088.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imgbed.mengnankk.asia/202407021650088.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 1.05rem;">BF<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 1.05rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 1.05rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 1.05rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 1.05rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 1.05rem;">FI<sup>1</sup></a><a href="/tags/Go/" style="font-size: 1.05rem;">Go<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 1.05rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>12</sup></a><a href="/tags/XSS/" style="font-size: 1.05rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>2</sup></a><a href="/tags/football/" style="font-size: 1.05rem;">football<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>61</sup></a><a href="/tags/juc/" style="font-size: 1.05rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 1.05rem;">jvm<sup>2</sup></a><a href="/tags/leetcode/" style="font-size: 1.05rem;">leetcode<sup>10</sup></a><a href="/tags/markdown/" style="font-size: 1.05rem;">markdown<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 1.05rem;">mysql<sup>17</sup></a><a href="/tags/net/" style="font-size: 1.05rem;">net<sup>7</sup></a><a href="/tags/paper/" style="font-size: 1.05rem;">paper<sup>1</sup></a><a href="/tags/php/" style="font-size: 1.05rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 1.05rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 1.05rem;">python<sup>3</sup></a><a href="/tags/redis/" style="font-size: 1.05rem;">redis<sup>4</sup></a><a href="/tags/shell/" style="font-size: 1.05rem;">shell<sup>4</sup></a><a href="/tags/spring/" style="font-size: 1.05rem;">spring<sup>4</sup></a><a href="/tags/spring-boot/" style="font-size: 1.05rem;">spring boot<sup>14</sup></a><a href="/tags/sql/" style="font-size: 1.05rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>3</sup></a><a href="/tags/%E5%8E%8B%E6%B5%8B/" style="font-size: 1.05rem;">压测<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 1.05rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 1.05rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>20</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 1.05rem;">正则表达式<sup>2</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 1.05rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>9</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 1.05rem;">面试<sup>46</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">25</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">15</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">22</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%A0%88/" itemprop="url">技术栈</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/java/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>java</span></a><a class="article-meta__tags" href="/tags/springAI/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>springAI</span></a></span></div></div><h1 class="post-title" itemprop="name headline">AI技术源码分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-09-10T16:00:00.000Z" title="发表于 2025-09-11 00:00:00">2025-09-11</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-09-20T09:24:41.155Z" title="更新于 2025-09-20 17:24:41">2025-09-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">12k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>39分钟</span></span><span class="post-meta-separator"></span><span id="" data-flag-title="AI技术源码分析"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为济南"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>济南</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=4b7543c8-82eb-c73e-e489-4adfeccbdaa1"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.tokenlen.top/2025/09/11/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/springai/"><header><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%A0%88/" itemprop="url">技术栈</a><a href="/tags/java/" tabindex="-1" itemprop="url">java</a><a href="/tags/springAI/" tabindex="-1" itemprop="url">springAI</a><h1 id="CrawlerTitle" itemprop="name headline">AI技术源码分析</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">mengnankkzhou</span><time itemprop="dateCreated datePublished" datetime="2025-09-10T16:00:00.000Z" title="发表于 2025-09-11 00:00:00">2025-09-11</time><time itemprop="dateCreated datePublished" datetime="2025-09-20T09:24:41.155Z" title="更新于 2025-09-20 17:24:41">2025-09-20</time></header><h1>Spring AI Alibaba Graph</h1>
<p>旨在利用 Spring AI 作为桥梁，连接阿里巴巴的大语言模型（如通义千wen）和图数据库（如阿里云 GDB），以实现通过自然语言与复杂关联数据进行交互的目的。</p>
<p>底层核心原理是 <strong>Text-to-Cypher/Gremlin</strong>，即<strong>将用户的自然语言问题，通过大语言模型（LLM）动态翻译成图数据库的专业查询语言</strong>。</p>
<h2 id="设计思想">设计思想</h2>
<p>图数据库（Graph Database）非常擅长处理实体之间的复杂关系，例如社交网络中的“朋友的朋友”、金融风控中的“资金链路”、电商中的“共同购买”等。但要查询这些数据，需要使用专门的图查询语言，如 <strong>Gremlin</strong> (阿里云 GDB 支持) 或 <strong>Cypher</strong>。这些语言学习门槛高，普通业务人员无法直接使用。</p>
<p>“Spring AI Alibaba Graph”架构的核心思想就是解决这个问题：让 LLM 充当一个智能的“翻译官”。</p>
<p>流程：</p>
<p><strong>赋予 LLM 上下文知识 (Context Awareness)</strong>：一个通用的 LLM 不知道你的图数据库里有什么。因此，必须在查询时，动态地告诉 LLM 图的**“Schema”**（模式），包括：</p>
<ul>
<li><strong>节点标签 (Node Labels)</strong>：例如 <code>Person</code>（人）、<code>Company</code>（公司）、<code>Product</code>（产品）。</li>
<li><strong>边标签 (Edge Labels)</strong>：例如 <code>WORKS_FOR</code>（为…工作）、<code>INVESTED_IN</code>（投资了）、<code>BOUGHT</code>（购买了）。</li>
<li><strong>属性 (Properties)</strong>：每个节点和边上可能有的属性，例如 <code>Person</code> 节点有 <code>name</code>, <code>age</code> 属性。</li>
</ul>
<p><strong>利用 LLM 的代码生成能力 (Code Generation)</strong>：大语言模型本质上是一个强大的序列生成器，它不仅能生成文章，也能生成代码。通过<strong>精巧的提示工程 (Prompt Engineering)</strong>，我们可以引导 LLM 将用户的自然语言问题，结合我们提供的图 Schema，生成一段完全正确的 Gremlin 或 Cypher 查询代码。</p>
<p><strong>自动化执行与反馈</strong>：生成查询代码后，程序自动执行它，并将结果返回。为了提升用户体验，甚至可以将图数据库返回的结构化数据再次交给 LLM，让它用自然语言进行总结和概括。</p>
<h2 id="架构">架构</h2>
<p>实际流程：</p>
<p><strong>用户提问</strong>： 用户通过前端界面或 API，输入自然语言问题：“查询投资了‘阿里巴巴’的所有人的姓名”。</p>
<p><strong>Spring 应用接收</strong>： 一个基于 Spring Boot 和 Spring AI 构建的后端服务接收到这个请求。</p>
<p><strong>构建精确的 Prompt</strong>： 这是最关键的一步。程序会动态构建一个发给 LLM 的 Prompt，它通常包含以下部分：</p>
<ul>
<li><strong>入口</strong> : 开发者代码调用 <code>graphClient.query(&quot;查詢投資了阿里巴巴的所有人&quot;)</code> 。<br>
<strong>委派</strong> : <code>DefaultGraphClient</code> 将请求委派给 <code>graphChatService.chat(&quot;...&quot;)</code> 。<br>
<strong>检索(Retrieval)</strong> : <code>graphChatService</code> 首先调用其持有的 <code>graphStore.getSchema()</code> 方法。 <code>Neo4jGraphStore</code> （假设）会连接 Neo4j 数据库，执行 <code>CALL db.schema.visualization()</code> 或类似命令，获取 Schema 并格式化为文本。<br>
<strong>构建(Prompt Construction)</strong> : <code>graphChatService</code> 使用 <code>GraphChatPromptFactory</code> ，将上一步获取的 Schema 文本和用户问题填充到一个预设的模板中，生成最终的 <code>Prompt</code> 对象。<br>
<strong>生成(Generation)</strong> : <code>graphChatService</code> 调用 <code>chatClient.call(prompt)</code> 。 <code>spring-ai-alibaba-tongyi-starter</code> 捕获此调用，向通义千问 API 发送请求。<br>
<strong>解析(Parsing)</strong> : 通义千问返回一个包含 Cypher 查询的 <code>ChatResponse</code> 。 <code>graphChatService</code> 使用 <code>GraphCypherResponseParser</code> 从中提取出纯净的 Cypher 查询字符串。<br>
<strong>执行(Execution)</strong> : <code>graphChatService</code> 拿到查询字符串后，调用 <code>graphStore.execute(cypherQuery)</code> 。<strong>返回</strong> : <code>Neo4jGraphStore</code> 使用 Neo4j Java Driver 执行查询，并将结果返回。这个结果最终沿着调用链返回给开发者。</li>
</ul>
<h2 id="三大核心">三大核心</h2>
<p>GraphStore，图存储的统一抽象</p>
<p><strong>设计目的</strong> : 将上层的“Text-to-Query”逻辑与底层具体的图数据库（Neo4j, NebulaGraph, 阿里云 GDB 等）完全解耦。无论底层是什么图数据库，对上层来说，它们都只是一个 <code>GraphStore</code></p>
<p>核心方法：</p>
<p><code>getSchema()</code> : 这是实现 RAG 的<strong>信息来源</strong> 。此方法负责连接到底层数据库，并提取其 Schema 信息（节点标签、边标签、属性等），将其格式化为一个可以喂给 LLM 的字符串。</p>
<p><code>execute(String query)</code> : 这是<strong>执行查询</strong>的统一入口。它接收 LLM 生成的查询字符串（如 Cypher 或 Gremlin），并通过具体的数据库驱动来执行它，然后返回结果。</p>
<p><strong>设计模式</strong> : <strong>策略模式(Strategy Pattern)</strong> 。用户可以根据自己的数据库类型，注入不同的 <code>GraphStore</code> 实现（例如 <code>Neo4jGraphStore</code> , <code>TinkerPopGremlinGraphStore</code> ），而上层 <code>GraphClient</code> 的代码无需任何改动。一个抽象类的实现</p>
<p>问题and挑战：</p>
<ol>
<li><code>GraphStore.getSchema()</code> 的“信息密度”挑战</li>
</ol>
<p><strong>“提示词爆炸” (Prompt Explosion) 与成本问题</strong>：当图的 Schema 变得非常庞大时（成百上千种节点和边），<code>getSchema()</code> 返回的字符串会非常长。这不仅会急剧增加调用 LLM 的 Token 成本，更严重的是，过长的、充斥着大量无关信息的上下文，反而可能<strong>降低 LLM 的理解和推理能力</strong>，导致生成错误的查询。</p>
<p><strong>Schema 的“知识”密度不足</strong>：Schema 只定义了“结构”，但没有定义“语义”。例如，一个 <code>TRANSACTION</code> 的边，其 <code>amount</code> 属性是正是负代表什么业务含义？LLM 仅从 Schema 中无法得知。</p>
<p>解决：</p>
<p>一个更先进的 <code>GraphStore</code> 实现，不应该仅仅是“暴力”地返回整个 Schema。它应该进化为一个**“Schema 智能检索器”**：</p>
<ol>
<li><strong>Schema 知识图谱化/向量化</strong>：将图的 Schema 本身（节点标签、边标签、属性及其注释）也构建成一个小型知识图谱或将其向量化存储。</li>
<li><strong>两阶段 RAG</strong>：当用户提问时，<strong>第一阶段</strong>，先对用户的问题进行向量相似度搜索，从海量的 Schema 中<strong>检索出与问题最相关的子图 Schema</strong>（例如，问题关于“交易”，就只提取 <code>Account</code>, <code>Transaction</code> 等相关的节点和边）。<strong>第二阶段</strong>，再将这个高度相关的、精简的子图 Schema 喂给 LLM 去生成查询。</li>
<li><strong>动态数据样本</strong>：<code>getSchema()</code> 还可以被增强为 <code>getContext()</code>，除了返回 Schema，还能动态地从图中抓取几条与问题相关的<strong>实际数据样本</strong>（例如，几条交易记录），一并作为上下文提供给 LLM。这能极大地帮助 LLM 理解数据格式和语义，提升查询准确率。</li>
</ol>
<p>GraphClient ：面向用户的核心入口</p>
<p><strong>设计目的</strong> : 隐藏所有内部复杂的交互流程（获取 Schema -&gt; 构建 Prompt -&gt; 调用 LLM -&gt; 解析响应-&gt; 执行查询），为最终用户提供一个极其简单的接口。</p>
<p><strong>核心方法剖析</strong>:</p>
<ul>
<li><code>query(String question, ...)</code> : 这是最核心的方法。开发者只需要传入自然语言问题，就可以得到图数据库的查询结果。它的默认实现 <code>DefaultGraphClient</code> 会<strong>编排</strong>下面要讲的 <code>GraphChatService</code> 和 <code>GraphStore</code> 来完成整个流程。</li>
</ul>
<p>GraphChatService ：LLM 交互与智能的核心</p>
<p><strong>设计目的</strong> : 专门负责处理与大语言模型（LLM）之间的所有交互，实现核心的“Text-to-Query”转换逻辑。</p>
<p>核心：</p>
<p><strong>依赖注入</strong> : 它会被注入一个 <code>GraphStore</code> 实例和一个 Spring AI 的 <code>ChatClient</code> 实例。<br>
<strong>Prompt 工厂</strong> : 内部会使用一个 <code>GraphChatPromptFactory</code> 来创建 Prompt。这个工厂是<strong>提示工程(Prompt Engineering)</strong> 的具体体现，它会接收 <code>GraphStore.getSchema()</code> 获取到的 Schema 和用户问题，然后把它们组装成一个结构化、高质量的 Prompt 模板。<br>
<strong>调用 LLM</strong> : 它使用注入的 <code>ChatClient</code> 将生成的 Prompt 发送给 LLM（例如通义千问）。<strong>响应解析</strong> : 它还包含一个 <code>ResponseParser</code> 。因为 LLM 的返回内容可能不只是纯粹的查询语句（例如，可能包含在 Markdown 的 <code>cypher ...</code> 代码块中，或者有一些解释性的文字）， <code>ResponseParser</code> 负责从 LLM 的原始响应中<strong>精确地提取出可执行的查询代码</strong> 。这一步是保证系统稳定性的关键。</p>
<h1>Google GraphRAG</h1>
<p>Google GraphRAG 的核心目标是<strong>从非结构化文本中构建图，以优化 RAG 的检索效果</strong>。</p>
<p>传统的向量检索（Vector Search）只能找到与问题“表面相似”的文本片段，却忽略了文档内部和文档之间隐藏的<strong>深层语义关联</strong>。GraphRAG 的核心思想就是<strong>通过从文本中提取实体和关系来构建知识图谱，并利用图的社区结构来发现这些深层关联，从而为 LLM 提供更全面、更具上下文的背景信息</strong>。</p>
<p><strong>图的角色</strong>：在这里，图<strong>不是最终的知识库</strong>，而是一个为了提升检索质量而生成的**“中间索引结构”**。最终答案的来源（Source of Truth）依然是原始的文本。</p>
<hr>
<p>GraphRAG 的流程分为“离线索引”和“在线查询”两个阶段。</p>
<p><strong>阶段一：离线索引（数据预处理）</strong></p>
<ol>
<li><strong>实体与关系提取 (Information Extraction)</strong>：系统读取所有源文档（如 PDF, Word, TXT），利用 LLM 遍历这些文本，提取出关键的实体（人、事、物、概念）以及它们之间的关系。</li>
<li><strong>图谱构建 (Graph Construction)</strong>：将提取出的实体作为“节点”，关系作为“边”，构建一个全局的知识图谱。</li>
<li><strong>社区检测 (Community Detection)</strong>：在构建好的图上运行图算法（如 Leiden 算法），将整个图划分成若干个高内聚、低耦合的“语义社区”。每个社区代表了一组在语义上紧密相关的主题或事件。</li>
<li><strong>社区摘要 (Community Summarization)</strong>：利用 LLM 为每一个检测出的社区生成一个高度概括的摘要描述。</li>
</ol>
<p><strong>阶段二：在线查询（应答用户提问）</strong></p>
<ol>
<li><strong>用户提问</strong>：用户提出一个问题。</li>
<li><strong>多路检索 (Multi-path Retrieval)</strong>：系统并行地在两个层面上进行检索：
<ul>
<li><strong>全局检索</strong>：在所有“社区摘要”上进行向量检索，快速定位到与问题最相关的几个社区。</li>
<li><strong>局部检索</strong>：同时，也在所有原始文本块上进行传统的向量检索。</li>
</ul>
</li>
<li><strong>上下文构建 (Context Building)</strong>：这是 GraphRAG 的<strong>核心创新</strong>。一旦通过全局检索定位到了一个或多个相关社区，系统<strong>不再是只返回几个零散的文本块，而是将整个社区内的所有实体、关系、以及关联的原始文本块，作为一个完整的、结构化的上下文</strong>提供出来。</li>
<li><strong>生成答案 (Answer Generation)</strong>：将这个极其丰富且上下文完整的“社区信息包”喂给 LLM，让它基于这些信息生成最终的、高质量的答案。</li>
</ol>
<h1>知识图谱Graph-bulider</h1>
<h2 id="基本流程">基本流程</h2>
<ol>
<li>定义图谱模式</li>
</ol>
<p><strong>节点类型 (Entity Types):</strong> 定义你要抽取的实体类别，例如：<code>Person</code> (人物), <code>Organization</code> (组织), <code>Product</code> (产品), <code>Location</code> (地点)。</p>
<p><strong>关系类型 (Relation Types):</strong> 定义实体之间可能存在的关系，例如：<code>WORKS_AT</code> (任职于), <code>FOUNDED</code> (创立了), <code>LOCATED_IN</code> (位于)。</p>
<p><strong>属性 (Properties):</strong> 定义节点或关系可能包含的属性，例如 <code>Person</code> 节点可以有 <code>name</code>, <code>birth_date</code> 等属性。</p>
<p>类似于E-R图，实体对象，以及他们的关系和属性</p>
<ol start="2">
<li>数据准备与预处理</li>
</ol>
<p>收集用于信息抽取的原始非结构化文本数据，如新闻文章、公司报告、技术文档等。根据需要进行清洗，去除无关信息（如HTML标签、广告等）。</p>
<ol start="3">
<li>提示词promt工程，注入属性查询</li>
</ol>
<ul>
<li>在Prompt中清晰地列出预定义的节点类型和关系类型。</li>
<li>要求LLM以标准、易于解析的格式（如JSON、JSON-LD）返回结果。这对于后续的自动化处理至关重要。指定输入输出格式</li>
<li><strong>提供示例 (Few-shot Learning):</strong> 在Prompt中给出1-2个“输入文本 -&gt; 输出JSON”的例子，能极大提升LLM的抽取准确率和格式一致性。提供示例，便于LLM进行输入输出</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">你是一个信息抽取专家。请从下面的文本中，根据我提供的Schema，抽取出所有实体和关系。</span><br><span class="line"></span><br><span class="line"><span class="section"># Schema:</span></span><br><span class="line"><span class="bullet">-</span> 节点类型: Person, Company</span><br><span class="line"><span class="bullet">-</span> 关系类型: WORKS<span class="emphasis">_AT (从 Person 指向 Company)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"># 文本:</span></span><br><span class="line"><span class="emphasis">&quot;张三是阿里巴巴的一名算法工程师，而李四则在腾讯工作。&quot;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"># 输出格式 (JSON):</span></span><br><span class="line"><span class="emphasis">请严格按照以下JSON格式输出，不要添加任何额外解释：</span></span><br><span class="line"><span class="emphasis">&#123;</span></span><br><span class="line"><span class="emphasis">  &quot;entities&quot;: [</span></span><br><span class="line"><span class="emphasis">    &#123;&quot;id&quot;: &quot;张三&quot;, &quot;type&quot;: &quot;Person&quot;, &quot;properties&quot;: &#123;&#125;&#125;,</span></span><br><span class="line"><span class="emphasis">    &#123;&quot;id&quot;: &quot;李四&quot;, &quot;type&quot;: &quot;Person&quot;, &quot;properties&quot;: &#123;&#125;&#125;,</span></span><br><span class="line"><span class="emphasis">    &#123;&quot;id&quot;: &quot;阿里巴巴&quot;, &quot;type&quot;: &quot;Company&quot;, &quot;properties&quot;: &#123;&#125;&#125;,</span></span><br><span class="line"><span class="emphasis">    &#123;&quot;id&quot;: &quot;腾讯&quot;, &quot;type&quot;: &quot;Company&quot;, &quot;properties&quot;: &#123;&#125;&#125;</span></span><br><span class="line"><span class="emphasis">  ],</span></span><br><span class="line"><span class="emphasis">  &quot;relations&quot;: [</span></span><br><span class="line"><span class="emphasis">    &#123;&quot;source&quot;: &quot;张三&quot;, &quot;target&quot;: &quot;阿里巴巴&quot;, &quot;type&quot;: &quot;WORKS_</span>AT&quot;&#125;,</span><br><span class="line"><span class="code">    &#123;&quot;source&quot;: &quot;李四&quot;, &quot;target&quot;: &quot;腾讯&quot;, &quot;type&quot;: &quot;WORKS_AT&quot;&#125;</span></span><br><span class="line"><span class="code">  ]</span></span><br><span class="line"><span class="code">&#125;</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>调用LLM进行抽取</li>
</ol>
<p>将准备好的文本和精心设计的Prompt批量发送给LLM API,获取结构化的输出结果。</p>
<ol start="5">
<li>后处理与校验</li>
</ol>
<p><strong>格式校验:</strong> 验证返回的是否是合法的JSON。</p>
<p><strong>实体对齐/归一化:</strong> “阿里”、“阿里巴巴”、“Alibaba” 可能指向同一实体，需要进行归一化处理。</p>
<p><strong>关系校验:</strong> 检查关系是否符合Schema定义（例如，<code>WORKS_AT</code> 关系必须连接 <code>Person</code> 和 <code>Company</code>）。</p>
<p>6.数据持久化</p>
<p>将校验过的实体和关系数据转换为图数据库（如Neo4j）的查询语句（通常是Cypher），然后批量导入到数据库中，完成知识图谱的构建。</p>
<h2 id="查询语言-Cypher">查询语言 Cypher</h2>
<p>create node:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE (p:Person &#123;name: &#x27;Alice&#x27;, born: 1990&#125;);</span><br></pre></td></tr></table></figure>
<p>create friends:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MATCH (a:Person &#123;name: &#x27;Alice&#x27;&#125;), (b:Person &#123;name: &#x27;Bob&#x27;&#125;)</span><br><span class="line">CREATE (a)-[r:FRIENDS &#123;since: 2010&#125;]-&gt;(b);</span><br></pre></td></tr></table></figure>
<p>match node:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH (p:Person) RETURN p;</span><br></pre></td></tr></table></figure>
<p>match node by where:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 查找名字是&#x27;Alice&#x27;的人</span><br><span class="line">MATCH (p:Person &#123;name: &#x27;Alice&#x27;&#125;) RETURN p;</span><br><span class="line">// 使用WHERE子句进行更复杂的过滤</span><br><span class="line">MATCH (p:Person) WHERE p.born &gt; 1980 RETURN p.name, p.born;</span><br><span class="line">// 查找所有和&#x27;Alice&#x27;是朋友的人</span><br><span class="line">MATCH (a:Person &#123;name: &#x27;Alice&#x27;&#125;)-[:FRIENDS]-(friend)</span><br><span class="line">RETURN friend.name;</span><br></pre></td></tr></table></figure>
<p>set/update/remove:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 给&#x27;Alice&#x27;添加一个email属性</span><br><span class="line">MATCH (p:Person &#123;name: &#x27;Alice&#x27;&#125;) SET p.email = &#x27;alice@example.com&#x27;;</span><br><span class="line">// 移除&#x27;Alice&#x27;的born属性</span><br><span class="line">MATCH (p:Person &#123;name: &#x27;Alice&#x27;&#125;) REMOVE p.born;</span><br><span class="line">// 给&#x27;Alice&#x27;再添加一个Student标签</span><br><span class="line">MATCH (p:Person &#123;name: &#x27;Alice&#x27;&#125;) SET p:Student;</span><br></pre></td></tr></table></figure>
<p>friend:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 删除&#x27;Alice&#x27;和她所有朋友的关系</span><br><span class="line">MATCH (a:Person &#123;name: &#x27;Alice&#x27;&#125;)-[r:FRIENDS]-()</span><br><span class="line">DELETE r;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 删除没有关系的节点</span><br><span class="line">MATCH (p:Person &#123;name: &#x27;孤立的节点&#x27;&#125;) DELETE p;</span><br><span class="line"></span><br><span class="line">// 删除节点及其所有关联的关系 (非常常用)</span><br><span class="line">MATCH (p:Person &#123;name: &#x27;需要删除的人&#x27;&#125;) DETACH DELETE p;</span><br></pre></td></tr></table></figure>
<p>index:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX person_name_index FOR (p:Person) ON (p.name);</span><br><span class="line">CREATE CONSTRAINT person_name_unique ON (p:Person) ASSERT p.name IS UNIQUE;</span><br></pre></td></tr></table></figure>
<h2 id="优化检索">优化检索</h2>
<ol>
<li>智能分块：</li>
</ol>
<p><strong>按语义分块:</strong> 利用NLP库（如NLTK, spaCy）或LangChain中的<code>RecursiveCharacterTextSplitter</code>，尝试按句子、段落、Markdown标题等语义边界进行切分，并设置重叠区域（overlap）来保留上下文联系。</p>
<p><strong>面向实体/命题的分块:</strong> 对于更高级的应用，可以先用LLM提取出文本中的核心命题（Propositions）或实体关系，然后将这些结构化的信息作为检索单元。这能实现更精准的原子化信息检索。</p>
<p><strong>文档结构化解析:</strong> 针对PDF、HTML等文件，不仅仅是提取纯文本。解析其标题、表格、列表等结构化信息，并将这些元数据（Metadata）与文本块一同索引，对后续的元数据过滤至关重要。</p>
<ol start="2">
<li>优化嵌入模型：</li>
</ol>
<p><strong>选择合适的模型:</strong> 不同的模型有不同的优势。例如，<code>BGE (BAAI General Embedding)</code>系列模型在中英文任务上表现优异，而OpenAI的<code>text-embedding-3-large</code>则在多语言和综合性能上领先。你需要根据你的主要语种和应用场景进行选型和评测。</p>
<p><strong>领域微调 (Fine-tuning):</strong> 如果你的业务数据具有非常强的领域特性（如法律、医疗），通用Embedding模型可能无法很好地理解专业术语的语义。在这种情况下，使用领域数据对Embedding模型进行微调，可以显著提升检索效果。</p>
<p>数据清洗：去除文档中的噪声，如HTML标签、页眉页脚、广告语、不相关的图片描述等。</p>
<p><strong>添加元数据:</strong> 为每个文本块添加丰富的元数据，如来源文档、章节标题、作者、发布日期等。</p>
<p><strong>生成假设性问题 (Hypothetical Questions):</strong> 使用LLM为每个文本块生成几个它可能回答的问题，并将这些问题与文本块一起进行向量化。这样当用户的查询与某个假设性问题相似时，就能更容易地找到对应的原文。这个方法也称为“HyDE”（Hypothetical Document Embeddings），效果显著。</p>
<hr>
<p>检索：</p>
<ol start="3">
<li><strong>使用混合检索 (Hybrid Search)</strong></li>
</ol>
<p><strong>语义检索 (Dense Retrieval):</strong> 即向量检索，擅长理解概念、意图和模糊查询。</p>
<p><strong>关键词检索 (Sparse Retrieval):</strong> 如传统的BM25算法，擅长匹配精确的关键词、术语、ID等。</p>
<p><strong>优势:</strong> 当用户查询“Neo4j 5.18.0的新特性”时，关键词检索能精准定位到<code>5.18.0</code>这个版本号，而语义检索能理解“新特性”这个概念。两者结合，能大幅提升召回率和准确率。许多现代向量数据库（如Weaviate, Pinecone）都原生支持混合检索。</p>
<ol start="4">
<li><strong>优化参数</strong>：</li>
</ol>
<p>向量数据库通常使用近似最近邻（ANN）算法来加速检索，最主流的是<code>HNSW</code>和<code>IVF</code>。</p>
<ul>
<li><strong>HNSW (Hierarchical Navigable Small World):</strong>
<ul>
<li><code>ef_construction</code>: 构建索引时的邻居节点数，越高索引质量越好，但构建越慢。</li>
<li><code>ef_search</code>: 查询时搜索的邻居节点数，越高越精确，但延迟也越高。</li>
</ul>
</li>
<li><strong>IVF (Inverted File):</strong>
<ul>
<li><code>nlist</code>: 聚类中心的数量。</li>
<li><code>nprobe</code>: 查询时要搜索的聚类中心数量。</li>
</ul>
</li>
<li><strong>优化策略:</strong> 根据你的业务场景对延迟和精度的要求，通过实验来调整这些参数，找到最佳的平衡点。例如，对于离线分析任务，可以调高精度参数；对于在线实时问答，则需要优先保证低延迟。</li>
</ul>
<hr>
<p>检索后处理优化</p>
<ol start="5">
<li>重排序 (Re-ranking):</li>
</ol>
<p>在通过ANN算法快速召回（例如Top 20个）候选文档后，再使用一个更强大、更精确但计算量也更大的模型对这批候选结果进行重新排序。</p>
<ul>
<li><strong>工作原理:</strong> 初步检索使用的是<strong>双编码器（Bi-Encoder）模型，它独立地为query和document生成向量。而重排序通常使用交叉编码器（Cross-Encoder）模型，它将query和document同时</strong>输入模型进行计算，能更精准地判断两者间的相关性。</li>
<li><strong>效果:</strong> Re-ranker能有效地将最相关的文档从Top 20提升到Top 3，极大地改善了送给LLM的上下文质量。<code>BGE-Reranker</code> 是一个常用的开源模型。</li>
</ul>
<p>查询转换：</p>
<ol start="6">
<li>
<p><strong>查询重写:</strong> 让LLM将口语化的、模糊的查询改写为更清晰、更结构化的查询。</p>
</li>
<li>
<p><strong>子问题分解:</strong> 当用户提出一个复杂问题时（例如“对比A和B的优缺点并说明应用场景”），可以先让LLM将其分解成多个独立的子问题（“A的优点是什么？”、“B的优点是什么？”、“A的应用场景？”等），然后对每个子问题分别进行检索，最后汇总结果。</p>
</li>
</ol>
<p><strong>Step-Back Prompting:</strong> 让LLM从一个具体问题中提炼出一个更泛化、更高层次的问题，对这个高层次问题进行检索，获取更宏观的背景知识，有助于回答原始的具体问题。</p>
<ol start="8">
<li>多路路由：</li>
</ol>
<p><strong>建立多个子索引:</strong> 根据文档的主题或来源（如“技术文档索引”、“市场分析索引”、“法律条款索引”）建立不同的向量索引。</p>
<p><strong>查询路由器:</strong> 在检索前，先用一个LLM分类器（Router）来判断用户的查询属于哪个主题，然后仅在对应的子索引中进行检索。</p>
<p><strong>优势:</strong> 大大缩小了检索范围，提升了速度和精度，避免了不同主题间的知识干扰。</p>
<ol start="9">
<li>动态构建知识图谱</li>
</ol>
<p>一个 RAG 系统最怕的就是知识库过时和答案不可信（幻觉）。因此，让知识图谱能够动态更新，并让所有答案都可溯源，是最高阶的要求。</p>
<p><strong>目标</strong>: 将知识图谱的“构建”与“查询”打通，并为每一次查询结果提供“证据”。</p>
<ul>
<li><strong>实现知识抽取与写入流水线</strong>:创建一个**“知识抽取 Agent”<strong>，它持续地读取新的非结构化文档。利用 LLM 的信息抽取能力，将文本转化为结构化的“实体-关系-实体”三元组。将这些三元组转化为图数据库的写入语句（如 <code>MERGE</code>）。通过 <code>graphStore.execute(writeQuery)</code> 将新知识</strong>写入**知识图谱。</li>
<li><strong>为知识添加“证据”元数据</strong>，在执行上述写入操作时，最重要的一点是：<strong>为每一个创建的节点和关系，都附加上来源元数据</strong>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MERGE (p:Person &#123;name: &#x27;马云&#x27;&#125;)</span><br><span class="line">ON CREATE SET p.source = &#x27;2024年阿里巴巴年报.pdf&#x27;, p.page = 5</span><br><span class="line"></span><br><span class="line">MERGE (c:Company &#123;name: &#x27;阿里巴巴&#x27;&#125;)</span><br><span class="line">ON CREATE SET c.source = &#x27;2024年阿里巴巴年报.pdf&#x27;, c.page = 1</span><br></pre></td></tr></table></figure>
<p>修改 <code>GraphClient</code> 的返回结果，使其不仅包含数据，也包含数据对应的 <code>source</code> 等元数据。</p>
<p>在最终生成答案的 Prompt 中，明确指示 LLM：**“你必须根据提供的来源信息，为你的答案提供引用。”</p>
<h2 id="知识图谱的设计">知识图谱的设计</h2>
<h3 id="逻辑设计">逻辑设计</h3>
<p>1.初始化知识图谱走类似Google  GraphRAG</p>
<ul>
<li>首先将用户输入的信息，转换为三元组的形式，存储为节点和关系，注意使用meger函数，还需要标记来源，作为证据。</li>
<li>然后同样的数据，经过嵌入模型向量化，存储在向量数据库中。</li>
<li>根据输入的信息的相关度，新建子索引，细化处理分析</li>
</ul>
<p>2.已有知识图谱的cyher查询</p>
<ul>
<li>将输入的语言转为cyher语言进行查询，同时在向量数据库中进行关键词查询和语义搜索，两个数据库同时搜索出结果，将其放入重排模型进行topk查询，然后将最后结果交给LLM进行输出</li>
</ul>
<h3 id="模块设计">模块设计</h3>
<p>数据处理：</p>
<ol>
<li>
<p>数据源适配器，负责从不同数据源（本地文件系统、S3、SharePoint、PostgreSQL、REST API）拉取数据。为每种数据源实现一个独立的适配器插件，输出统一格式的<code>RawDocument</code>对象（包含内容、元数据、来源URL等）。</p>
</li>
<li>
<p>知识抽取服务，接收<code>RawDocument</code>，进行预处理、信息抽取和格式化。</p>
<p><strong>预处理:</strong> 清洗文本（去除HTML标签、无关字符）。</p>
<p><strong>智能分块 (Semantic Chunking):</strong> 使用<code>RecursiveCharacterTextSplitter</code>等策略，将长文本切分为有意义的<code>TextChunk</code>。</p>
<p><strong>LLM信息抽取:</strong> 设计包含<strong>Schema定义</strong>和<strong>JSON输出格式</strong>的Prompt，调用LLM，从<code>TextChunk</code>中抽取出实体、关系、属性，生成结构化的JSON数据。</p>
<p><strong>向量化:</strong> 调用Embedding模型，将每个<code>TextChunk</code>向量化。</p>
<p><strong>打包消息:</strong> 将结构化JSON和向量化的<code>TextChunk</code>打包成一个<code>KnowledgePacket</code>消息。</p>
</li>
</ol>
<p><strong>输出:</strong> 向消息队列（Kafka）的特定Topic（如<code>knowledge-ingestion</code>）发送<code>KnowledgePacket</code>消息。</p>
<ol start="3">
<li>异步写入消费者，订阅消息队列，实现双模态数据的持久化。</li>
</ol>
<p><strong>Graph写入消费者:</strong></p>
<ul>
<li>消费<code>KnowledgePacket</code>，解析其中的结构化JSON。</li>
<li>将其转换为幂等的<code>MERGE</code> Cypher语句。</li>
<li><strong>关键设计:</strong> 节点属性必须包含<code>source</code>（来源）、<code>chunk_id</code>（关联向量库）、<code>last_updated</code>等溯源信息。</li>
<li>批量写入Neo4j。</li>
</ul>
<p><strong>Vector写入消费者:</strong></p>
<ul>
<li>消费<code>KnowledgePacket</code>，提取<code>TextChunk</code>、向量和元数据。</li>
<li>元数据中必须包含从Graph写入后生成的<code>node_uuid</code>，用于反向关联。</li>
<li>根据预设策略（如按文档来源），将数据写入Vector DB的<strong>指定子索引/集合</strong>中。</li>
</ul>
<p>智能查询：将用户自然语言问题，高效、精准地转化为基于知识的答案。</p>
<ol>
<li>查询编排服务：作为查询流程的大脑，接收API Gateway转发的用户请求，编排整个查询过程。</li>
</ol>
<p><strong>NL-to-Cypher生成:</strong> 调用LLM，将用户问题转换为Cypher查询。<strong>增加安全防护：</strong> 对生成的Cypher进行语法校验和规则检查（如限制查询深度），防止恶意或低效查询。</p>
<p><strong>查询任务分发:</strong> <strong>并发地</strong>向三个执行器分发任务：</p>
<ul>
<li>Graph查询执行器（执行Cypher）</li>
<li>Vector语义查询执行器（执行向量相似度搜索）</li>
<li>Vector关键词查询执行器（执行全文检索或BM25）</li>
</ul>
<ol start="2">
<li>查询融合与重排引擎，收集并发查询的结果，进行融合、排序，筛选出最佳上下文。</li>
</ol>
<p><strong>结果规范化:</strong> 将三路查询返回的异构结果（图路径、文本块）转换为统一的<code>Evidence</code>对象列表。<code>Evidence</code>对象结构：<code>&#123; content: string, source: string, score: float, type: 'graph' | 'vector' &#125;</code>。</p>
<ul>
<li><em>处理技巧：</em> 对于Graph结果，需将其路径或节点属性“渲染”成一段通顺的文本作为<code>content</code>。</li>
</ul>
<p><strong>初步融合与去重:</strong> 合并三个列表，并根据内容相似性进行去重。</p>
<p><strong>调用重排模型 (Re-ranker):</strong> 将融合后的<code>Evidence</code>列表（例如Top 50）和原始用户问题一起发送给重排模型，模型会对每个<code>Evidence</code>与问题的相关性进行打分。</p>
<p><strong>筛选Top-K:</strong> 根据重排模型的得分，选出最相关的Top-K个（如Top 5）<code>Evidence</code>作为最终上下文。</p>
<p>3.LLM答案合成服务，基于筛选出的高质量上下文，生成最终答案。</p>
<p><strong>构建最终Prompt:</strong> 模板如下：<code>“请根据以下上下文信息，用严谨、专业的语气回答用户的问题。在回答时，请明确引用信息的来源。上下文：[...插入Top-K Evidence...]。用户问题：[...原始问题...]”</code></p>
<p><strong>调用LLM生成:</strong> 使用流式（Streaming）API调用LLM，将生成的答案实时返回给前端。</p>
<h3 id="数据Model设计">数据Model设计</h3>
<p>Graph (Neo4j):</p>
<p><strong>节点 (Labels):</strong> <code>:Document</code>, <code>:Entity</code>, <code>:Person</code>, <code>:Organization</code>, <code>:Concept</code> 等。</p>
<p><strong>节点属性 (Properties):</strong></p>
<ul>
<li><code>uuid</code>: 全局唯一标识符。</li>
<li><code>name</code>: 实体名称。</li>
<li><code>source_url</code>: 知识来源URL。</li>
<li><code>metadata</code>: 其他业务属性（JSON格式）。</li>
<li><code>created_at</code>, <code>updated_at</code>: 时间戳。</li>
</ul>
<p><strong>关系 (Types):</strong> <code>HAS_ENTITY</code>, <code>WORKS_AT</code>, <code>PARTNERS_WITH</code>, <code>RELATED_TO</code> 等。</p>
<p><strong>关系属性:</strong> <code>source</code>: 关系来源的文档或句子。<code>weight</code>: 关系强度。</p>
<p>Vector (Milvus):</p>
<p><strong>集合/Collection Schema:</strong></p>
<ul>
<li><code>chunk_id</code> (Primary Key, VarChar)</li>
<li><code>text_content</code> (String)</li>
<li><code>text_vector</code> (FloatVector, 1024 dims)</li>
<li><code>metadata</code> (JSON): <code>&#123; &quot;doc_id&quot;: &quot;...&quot;, &quot;doc_title&quot;: &quot;...&quot;, &quot;graph_node_uuid&quot;: &quot;...&quot; &#125;</code></li>
</ul>
<h3 id="分布式微服务设计">分布式微服务设计</h3>
<h3 id="遇到问题及其解决">遇到问题及其解决</h3>
<ol>
<li>数据库的一致性问题</li>
</ol>
<p>因为我们使用一个图数据库，一个向量库所以我们的数据库如何保证一致性呢？</p>
<p>写操作需要同时成功写入Neo4j和Milvus两个异构系统，无法使用传统的两阶段提交（2PC）实现分布式事务。</p>
<p>**解决方案：**采用“事务性发件箱（Transactional Outbox）+ 消息队列”模式，保证最终一致性。</p>
<p><strong>改造知识抽取服务:</strong></p>
<ul>
<li>当服务完成信息抽取和向量化后，<strong>不要直接向Kafka发消息</strong>。</li>
<li>而是在<strong>同一个本地数据库事务</strong>中，将<code>KnowledgePacket</code>存入一张本地的<code>outbox</code>表，并将业务数据的状态更新。这样保证了只要业务成功，要发送的消息就一定被持久化了。</li>
</ul>
<p><strong>引入消息中继（Message Relay）:</strong></p>
<ul>
<li>部署一个独立的服务（推荐使用xxl-job?），专门负责“扫描”<code>outbox</code>表。</li>
<li>一旦发现新消息，就将其可靠地投递到Kafka，并在成功投递后，标记或删除<code>outbox</code>表中的对应记录。</li>
</ul>
<p><strong>效果:</strong> 这个模式将“业务操作”和“消息发送”解耦，彻底避免了“业务成功但消息没发出去”或“消息发出去了但业务回滚了”的经典问题，保证了消息<strong>至少成功发布一次</strong>。</p>
<ol start="2">
<li>消息幂等的处理</li>
</ol>
<p>至少一次”的消息投递保证，意味着消费者可能会收到重复消息。同时，网络或消费者崩溃可能导致消息丢失。</p>
<p>依靠Kafka的持久性保证 + 消费者的幂等设计。</p>
<p><strong>防止消息丢失:</strong></p>
<ul>
<li><strong>生产者侧:</strong> 在消息中继服务中，设置Kafka Producer的<code>acks=all</code>，确保消息被所有ISR（In-sync Replicas）确认后才算成功。</li>
<li><strong>消费者侧:</strong> 关闭消费者的<code>enable.auto.commit</code>，改为<strong>手动提交偏移量</strong>。只有当数据成功写入Neo4j和Milvus后，才在代码中显式调用<code>consumer.commitSync()</code>。如果写入失败，程序抛出异常，偏移量不会被提交，下次重启后会重新消费这条消息。</li>
</ul>
<p><strong>保证消费者幂等:</strong></p>
<ul>
<li>在<code>KnowledgePacket</code>消息中，生成一个全局唯一的<code>event_id</code>。</li>
<li><strong>Graph写入消费者:</strong> <code>MERGE</code>操作天生就是幂等的，无需额外处理。</li>
<li><strong>Vector写入消费者:</strong> 在写入Milvus前，先根据<code>chunk_id</code>（主键）检查数据是否已存在。如果存在，则执行更新操作；如果不存在，则执行插入。或者，消费者可以维护一个已处理<code>event_id</code>的记录（例如存在Redis中，并设置TTL），在处理消息前先检查<code>event_id</code>是否已被处理。</li>
</ul>
<ol start="3">
<li>引入缓存来解决LLM记忆力的问题</li>
</ol>
<p>查询链路长，LLM调用成本高、延迟大；多轮对话需要维持上下文记忆。</p>
<p>引入Redis作为多级缓存和会话存储。</p>
<p><strong>多级缓存策略:</strong></p>
<ul>
<li><strong>缓存层1 (NL-to-Cypher):</strong> <code>Key: HASH(用户问题字符串)</code> -&gt; <code>Value: 生成的Cypher字符串</code>。对于高频、通用的问题，可以秒级响应。</li>
<li><strong>缓存层2 (查询结果):</strong> <code>Key: HASH(Cypher查询或向量查询)</code> -&gt; <code>Value: 序列化的查询结果</code>。对于“热点”数据查询，直接返回缓存结果，无需穿透到数据库。</li>
</ul>
<p><strong>缓存失效与更新:</strong></p>
<ul>
<li><strong>策略:</strong> 采用**TTL（Time-To-Live）**作为基本失效策略（例如，缓存1小时）。这是一种简单有效的折衷。</li>
<li><strong>进阶策略:</strong> 采用<strong>事件驱动的缓存失效</strong>。当知识沉淀流水线更新了某部分知识时，可以向一个专门的<code>cache-invalidation</code> Topic发送消息，订阅该Topic的服务负责精确地删除相关的Redis缓存。</li>
</ul>
<p><strong>LLM记忆性 (会话管理):</strong></p>
<ul>
<li><strong>方案:</strong> 使用Redis来存储每一轮对话的上下文。</li>
<li><strong>数据结构:</strong> 使用Redis的<code>LIST</code>或<code>ZSET</code>。<code>Key: conversation_id</code> -&gt; <code>Value: [消息1, 消息2, ...]</code>.</li>
<li><strong>流程:</strong>
<ol>
<li>用户发起新一轮对话时，传入<code>conversation_id</code>。</li>
<li>后端服务从Redis中加载最近的K轮对话历史。</li>
<li>将对话历史、当前问题、检索到的<code>Evidence</code>一起构建成Prompt，发送给LLM。</li>
<li>将当前的问答对（Q&amp;A）存回Redis的<code>conversation_id</code>对应的列表中。</li>
</ol>
</li>
<li><strong>框架集成:</strong> LangChain等框架的<code>ConversationBufferMemory</code>等记忆模块，可以很容易地与自定义的存储后端（如Redis）集成。</li>
</ul>
<ol start="4">
<li>冗余数据</li>
</ol>
<p>如何在两个物理隔离的数据库间建立逻辑引用，并优化存储成本。</p>
<p>通过ID关联，各司其职。</p>
<p><strong>Graph写入消费者先行:</strong> Graph消费者处理消息，通过<code>MERGE</code>操作在Neo4j中创建节点，<strong>Neo4j会自动为节点生成一个内部ID，但我们最好自己生成一个业务上的<code>uuid</code>并存为属性。</strong></p>
<p><strong>消息增强与转发:</strong> Graph消费者成功写入后，<strong>它需要将这个<code>uuid</code>写回消息中</strong>（或者发送一条包含<code>chunk_id</code>和<code>node_uuid</code>关联关系的新消息到另一个Topic）。</p>
<p><strong>Vector写入消费者后行:</strong> Vector消费者监听这条被“增强”后的消息，这样在写入Milvus时，它就能拿到对应的<code>graph_node_uuid</code>，并将其存入Vector记录的<code>metadata</code>字段中。</p>
<p><strong>效果:</strong> 这样就建立了一个从Vector到Graph的<strong>单向引用</strong>。查询时，可以从Vector结果中轻松找到对应的Graph节点，进行更深度的图遍历。</p>
<p><strong>成本优化:</strong> 再次强调，Neo4j中只存储结构化数据和少量元数据。完整的原始文本块只在Milvus中存储一份。需要时，通过上述ID关联进行查询。</p>
<ol start="5">
<li>异构结果的融合策略</li>
</ol>
<p><code>List&lt;GraphPath&gt;</code> 和 <code>List&lt;TextChunk&gt;</code> 如何合并成一个有序的 <code>List&lt;Evidence&gt;</code>。</p>
<p>渲染-规范-融合-去重</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">fuseAndNormalizeResults</span><span class="params">(graphResults, vectorResults, keywordResults)</span> &#123;</span><br><span class="line">    List&lt;Evidence&gt; evidenceList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- Step 1: Render &amp; Normalize Graph Results ---</span></span><br><span class="line">    <span class="keyword">for</span> (GraphPath path : graphResults) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">renderedText</span> <span class="operator">=</span> renderPathToText(path); <span class="comment">// 关键函数：将图路径转为自然语言描述</span></span><br><span class="line">        <span class="type">float</span> <span class="variable">score</span> <span class="operator">=</span> calculateGraphScore(path);     <span class="comment">// 关键函数：根据路径长度、关系权重等计算得分</span></span><br><span class="line">        evidenceList.add(<span class="keyword">new</span> <span class="title class_">Evidence</span>(renderedText, path.source, score, <span class="string">&quot;graph&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- Step 2: Normalize Vector &amp; Keyword Results ---</span></span><br><span class="line">    evidenceList.addAll(normalizeVectorResults(vectorResults, <span class="string">&quot;vector&quot;</span>));</span><br><span class="line">    evidenceList.addAll(normalizeVectorResults(keywordResults, <span class="string">&quot;keyword&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- Step 3: Reciprocal Rank Fusion (RRF) or simple score-based sort ---</span></span><br><span class="line">    <span class="comment">// 简单的做法是直接按分数排序，但RRF效果更好，能平衡不同召回源的排序偏差</span></span><br><span class="line">    <span class="comment">// 这里简化为排序</span></span><br><span class="line">    evidenceList.sort((e1, e2) -&gt; Float.compare(e2.getScore(), e1.getScore()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- Step 4: Deduplicate ---</span></span><br><span class="line">    <span class="comment">// 基于内容相似性（如Jaccard相似度）或ID进行去重，保留最高分的</span></span><br><span class="line">    List&lt;Evidence&gt; deduplicatedList = deduplicate(evidenceList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deduplicatedList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>网络延迟处理</li>
</ol>
<p>复杂的分布式调用链条；LLM生成代码的不可控性。</p>
<p>解决：全链路异步化 + 严格的防护栏与超时控制。</p>
<p><strong>降低延迟:</strong></p>
<ul>
<li><strong>全链路异步:</strong> 在Java后端，大量使用<code>CompletableFuture</code>，让三路查询、结果融合、LLM调用等IO密集型操作完全异步化，最大化利用计算资源。</li>
<li><strong>连接池:</strong> 确保所有数据库和外部服务的客户端都配置了合理的连接池。</li>
</ul>
<p><strong>Cypher稳定性与安全:</strong></p>
<ul>
<li><strong>模板化与参数化:</strong> 对于特定意图的查询，与其让LLM从头生成，不如预定义一些Cypher“查询模板”，让LLM只负责填充模板中的参数。这极大提升了稳定性和安全性。</li>
<li><strong>执行前静态分析:</strong> 在执行LLM生成的Cypher前，可以使用<code>openCypher</code>的<code>front-end</code>库在Java中对其进行<strong>AST（抽象语法树）解析</strong>。通过分析AST，可以实施非常精细的规则，例如：
<ul>
<li>禁止不带<code>LIMIT</code>的全图扫描。</li>
<li>限制<code>MATCH</code>路径的最大长度。</li>
<li>禁止写入操作（如<code>CREATE</code>, <code>DELETE</code>）。</li>
</ul>
</li>
<li><strong>运行时超时:</strong> 在Neo4j Java Driver中，为每个查询<strong>设置一个严格的执行超时时间</strong>。这是最后的、也是最有效的防线，可以防止一个糟糕的查询拖垮整个数据库。</li>
</ul>
<h1>提示词工程</h1>
<h1>AI记忆力&amp;多轮对话的实现</h1>
<h2 id="短期记忆">短期记忆</h2>
<p>使用滑动窗口来实现，固定窗口大小，</p>
<p>在每次请求时，只将最近的K轮对话（例如，最近5轮）作为上下文（Context）连同当前问题一起发送给LLM。</p>
<p>但是容易出现：</p>
<p><strong>上下文丢失 (Context Loss):</strong> 一旦对话超过K轮，最早的信息就会被永久丢弃。如果用户在第1轮提到的关键信息（如“我叫张三”），在第K+1轮时AI就忘了。</p>
<p><strong>记忆僵化:</strong> 无法识别哪些历史信息是重要的，哪些是无关紧要的闲聊。</p>
<p><strong>存储:</strong> 使用<code>Redis</code>的<code>LIST</code>数据结构是最佳选择。每个<code>conversation_id</code>对应一个<code>LIST</code>。</p>
<p><strong>数据模型:</strong> <code>LIST</code>中的每个元素是一个JSON字符串，如<code>&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;你好&quot;&#125;</code>。</p>
<p><strong>流程:</strong></p>
<ol>
<li>用户发来消息，附带<code>conversation_id</code>。</li>
<li>从Redis中用<code>LRANGE conversation_id 0 K-1</code>获取最近的K条记录。</li>
<li>将这K条记录和当前问题一起构建成Prompt。</li>
<li>获取LLM的回答后，将当前的用户问题和AI回答用<code>LPUSH</code>和<code>LTRIM</code>命令存入<code>LIST</code>，保持其大小不超过K。</li>
</ol>
<p><strong>框架支持:</strong> LangChain中的<code>ConversationBufferWindowMemory</code>就是这个模式的直接实现。</p>
<h2 id="中期记忆">中期记忆</h2>
<p>随着对话的进行，不再保留全部历史，而是调用LLM对越来越长的对话历史进行滚动总结，形成一个摘要。每次请求时，将“历史摘要 + 最近几轮对话”作为上下文。</p>
<p>可以作为中期记忆，作为每个会话结束的总结实现</p>
<p><strong>存储:</strong> 摘要可以存在<code>Redis</code>的<code>STRING</code>或<code>HASH</code>中，或者持久化到<code>PostgreSQL/MySQL</code>的某个字段。</p>
<p><strong>流程:</strong></p>
<ol>
<li>设定一个阈值N（例如，每5轮对话触发一次总结）。</li>
<li>当对话达到N轮时，启动一个后台任务或在当前请求中，将当前的“旧摘要 + N轮对话”发送给LLM，并附上Prompt：“请总结以下对话…”。</li>
<li>将LLM返回的新摘要更新到数据库中。</li>
<li>构建下一次请求的Prompt时，结构为：<code>&quot;这是我们之前的对话摘要：&#123;summary&#125;。接下来是最近的几轮对话：&#123;recent_history&#125;。用户问题：&#123;query&#125;&quot;</code>。</li>
</ol>
<p><strong>框架支持:</strong> LangChain中的<code>ConversationSummaryBufferMemory</code>提供了此功能。</p>
<h2 id="长期个性化记忆">长期个性化记忆</h2>
<p>这是一种<strong>结构化长期记忆</strong>的方案。在对话过程中，实时地使用一个LLM（或专门的NLU模型）来抽取出对话中出现的关键实体、属性和关系，并将这些结构化信息存入知识图谱（如Neo4j）或关系型数据库。</p>
<p>可以个性化存储用户的消息，可以深度思考跨会话的消息</p>
<ul>
<li>
<ol>
<li><strong>Schema设计:</strong> 在Neo4j中定义用户中心节点<code>:User</code>，以及<code>:Entity</code>, <code>:Preference</code>, <code>:Fact</code>等节点。</li>
<li><strong>异步抽取流程:</strong>
<ul>
<li>在每轮对话结束后，将对话内容发送到一个<strong>后台处理服务</strong>。</li>
<li>该服务调用LLM，Prompt为：“从以下文本中抽取出人名、地名、用户偏好等实体信息，并以JSON格式返回…”。</li>
<li>服务解析JSON，生成<code>MERGE</code> Cypher语句，如 <code>MERGE (u:User &#123;userId:'123'&#125;) MERGE (p:Preference &#123;type:'音乐', name:'周杰伦'&#125;) MERGE (u)-[:HAS_PREFERENCE]-&gt;(p)</code>，更新知识图谱。</li>
</ul>
</li>
<li><strong>查询与注入:</strong>
<ul>
<li>在每轮对话开始时，除了加载短期记忆，还要根据当前问题中的实体，查询知识图谱，获取相关背景知识。</li>
<li>例如，如果用户问“给我推荐几首歌”，可以先查询图谱中该用户的音乐偏好，然后将“该用户喜欢周杰伦”这个事实注入到最终的Prompt中，让LLM做出更个性化的推荐。</li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="记忆上下文构建">记忆上下文构建</h2>
<p>职责就是：根据当前的对话ID和用户输入，从各个记忆层中<strong>并行地</strong>获取相关信息，并按照预设的优先级和格式，组装成最终注入到LLM Prompt中的上下文（Context）。</p>
<p>API层接收到用户请求(<code>convId</code>, <code>userId</code>, <code>userQuery</code>)。</p>
<p>调用<code>MemoryContextBuilder.buildPromptContext()</code>。该方法内部<strong>并行</strong>启动三路记忆的加载。</p>
<p>构建器等待所有结果返回，然后按照<code>长期 -&gt; 中期 -&gt; 短期</code>的优先级组装成一个结构化的上下文字符串。</p>
<p>将组装好的<code>context</code>和<code>userQuery</code>填入最终的LLM Prompt模板中。</p>
<p>调用LLM，并将结果流式返回给用户。</p>
<p><strong>在后台</strong>，将当前的问答对<code>ChatMessage</code>异步地发送到Kafka的<code>conversation_turns</code> Topic，触发短期和长期记忆的更新。</p>
<p>通过会话超时或用户登出等事件，触发<code>conversation_ended</code>事件，更新中期记忆。</p>
<h2 id="性能问题解决">性能问题解决</h2>
<ol>
<li>查询链路P99延迟过高，在高并发下，即使用户平均响应时间尚可，但总有5%或1%的用户会经历无法忍受的慢响应。<code>MemoryContextBuilder</code>的并行设计虽好，但木桶的最短板决定了最终性能。</li>
</ol>
<ul>
<li>数据库层面：比如图数据库Neo4j中查询的信息都要加上索引，增快查询速度，使用<code>EXPLAIN</code>和<code>PROFILE</code>进行分析，防止全表扫描，合理配置堆内存和页缓存。</li>
<li>引入新的缓存，实现三级缓存架构，本地缓存，redis缓存，但是要注意数据的一致性，可以引用新的canel中间件来保证数据的最终一致性的问题</li>
<li>线程池的隔离，并行<code>CompletableFuture</code>中，为不同的任务指定不同的专用线程池（<code>Executor</code>）。防止一个慢任务拖垮其他任务的工作</li>
</ul>
<p>使用Jaeger/Zipkin来进行链路的追踪，具体是哪个环节出了问题，然后数据库查慢日志，Grafana仪表盘等等手段</p>
<ol start="2">
<li>上下文的剪切</li>
</ol>
<p>计算组装好的上下文的总Token数。</p>
<p>如果超过预设阈值（如6000 Token），则调用一个<strong>更便宜、更快的模型</strong>（如GPT-3.5-Turbo, Llama-3-8B），让它对上下文进行压缩和筛选，Prompt：“请从以下信息中，筛选出与用户问题‘{userQuery}’最相关的部分，并保持在2000个Token以内。”</p>
<p>将压缩后的上下文用于最终的、昂贵的模型（如GPT-4o）调用。</p>
<ol start="3">
<li>建立模型的路由</li>
</ol>
<p>用户问题首先经过一个分类器（可以是小LLM，也可以是传统模型），判断其意图是“简单问答”、“闲聊”还是“复杂推理”。根据分类结果，将请求路由到不同成本和能力的LLM模型。</p>
<ol start="4">
<li>幻觉脏数据处理</li>
</ol>
<p>LLM在抽取实体和关系时可能产生幻觉，导致错误的信息被存入“长期记忆”，进而污染后续所有基于此记忆的回答。</p>
<p>创建一个“黄金标准”的测试集，包含上百个有代表性的（问题，预期答案，应检索到的上下文）三元组。</p>
<p><strong>自动化回归测试:</strong> 在每次系统有重大更新（如更换Embedding模型、修改Prompt）后，自动化地运行整个测试集，并计算关键指标：</p>
<ul>
<li><strong>检索质量:</strong> <code>Precision@K</code>, <code>Recall@K</code>, <code>MRR</code> (Mean Reciprocal Rank)。</li>
<li><strong>答案质量:</strong> 使用 <code>LLM-as-a-Judge</code> 模式，让GPT-4等强模型来评估生成答案的准确性、忠实度、相关性，并打分。</li>
</ul>
<p>对比较重要的数据，进行人工审核的处理，用户层面可以点赞或者点踩，然后我们重点分析点踩的那一部分数据</p>
<ol start="5">
<li>IO模型的更换</li>
</ol>
<p>采用非阻塞I/O与响应式编程，<strong>Spring WebFlux + Project Reactor + Netty</strong>。这是现代Java构建高性能网络应用的黄金组合。</p>
<p>WebFlux使用事件循环（Event Loop）模型，用极少数的线程（如CPU核心数）就可以处理成千上万的并发连接。线程不会因等待数据（等待LLM返回token，等待网络写入）而被阻塞，而是去处理其他事件。</p>
<p>数据从LLM API流出，到写入响应给客户端的网络缓冲区，全程不应在你的后端服务中发生<strong>显著的、完整的</strong>数据聚合。</p>
<h1>SSE</h1>
<p>一种基于标准HTTP的、服务端到客户端的单向消息推送协议。它是为流式更新而生的。</p>
<p>Server-Sent Events（服务器发送事件）是一种<strong>允许服务器随时向客户端推送数据</strong>的Web技术。从本质上讲，它是在<strong>单个、持久的HTTP连接</strong>上实现的、<strong>从服务器到客户端的单向数据流</strong>。</p>
<p>客户端一旦与服务器的SSE端点建立连接，这个连接就会保持打开状态。服务器可以随时通过这个连接，以一种特定的文本格式，将事件（数据）发送给客户端。</p>
<p>SSE的美妙之处在于其协议极度简单。服务器在响应时，必须将HTTP Header的<code>Content-Type</code>设置为<code>text/event-stream</code>。之后发送的内容遵循以下格式：</p>
<ul>
<li>
<p><strong><code>data:</code></strong> 这是最重要的字段，用于承载你要发送的数据。可以是一行，也可以是多行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data: 这是第一行数据</span><br><span class="line">data: 这是第二行数据</span><br></pre></td></tr></table></figure>
<p>在客户端，这两行数据会被拼接成<code>&quot;这是第一行数据\n这是第二行数据&quot;</code>。</p>
</li>
<li>
<p><strong><code>event:</code></strong> 用于为事件命名。如果省略，事件的默认名称是<code>message</code>。通过命名事件，你可以在前端为不同类型的消息绑定不同的监听器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">event: user_login</span><br><span class="line">data: &#123;&quot;username&quot;: &quot;Alice&quot;, &quot;timestamp&quot;: 1678886400&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>id:</code></strong> 为每个事件设置一个唯一的ID。这个ID的主要作用是实现<strong>断线重连</strong>。如果连接意外中断，浏览器在自动重连时，会把上次接收到的<code>id</code>值通过<code>Last-Event-ID</code>请求头发送给服务器。服务器可以根据这个ID，补发在断连期间可能丢失的数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id: msg1</span><br><span class="line">data: some data</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>retry:</code></strong> 告诉浏览器在连接断开后，应该等待多少毫秒再尝试重连。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retry: 10000</span><br></pre></td></tr></table></figure>
<p>这表示10秒后重试。</p>
</li>
</ul>
<p><strong>一个完整的消息块由一个空行（<code>\n\n</code>）分隔。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">id: event-1</span><br><span class="line">event: temperature_update</span><br><span class="line">data: &#123;&quot;location&quot;: &quot;Tokyo&quot;, &quot;temp&quot;: 25.5&#125;</span><br><span class="line">retry: 5000</span><br><span class="line"></span><br><span class="line">id: event-2</span><br><span class="line">event: humidity_update</span><br><span class="line">data: &#123;&quot;location&quot;: &quot;Tokyo&quot;, &quot;humidity&quot;: 65&#125;</span><br><span class="line">retry: 5000</span><br></pre></td></tr></table></figure>
<p>实例：</p>
<p><strong>LLM聊天机器人响应流:</strong> (我们的核心场景) 逐字或逐词地将AI的回答推送到前端。</p>
<p><strong>实时通知:</strong> 如社交网络的“你有新消息”或电商的“订单已发货”。</p>
<p><strong>金融数据更新:</strong> 股票价格、加密货币行情等实时数据的推送。</p>
<p><strong>新闻或体育比分直播:</strong> 将最新的事件和比分实时更新到页面。</p>
<p><strong>系统监控仪表盘:</strong> 实时显示服务器的CPU、内存使用率等监控指标。</p>
<p>Spring Boot通过<code>SseEmitter</code>类，提供了对SSE的完美支持。它以非阻塞的方式工作，不会为每个连接都占用一个宝贵的线程。</p>
<h1>nl2sql</h1>
<p><strong>一个基于自然语言生成SQL查询（Natural Language to SQL, NL2SQL）的智能体框架</strong>。</p>
<p>该框架的核心作用是充当一个“翻译器”，将用户输入的自然语言问题（例如，“查询上个季度销售额最高的三个产品是什么？”）自动转换成对应数据库可以执行的SQL查询语句。</p>
<h2 id="核心">核心</h2>
<p>基本流程：</p>
<p><strong>输入理解 (Input Understanding)</strong>：框架接收用户的自然语言输入。</p>
<p><strong>意图识别与槽位填充</strong>：利用大语言模型的自然语言理解（NLU）能力，分析问句的意图（查询、统计、对比等）并提取关键信息（查询的指标、过滤条件、时间范围等）。</p>
<p><strong>数据库元数据理解 (Schema Understanding)</strong>：框架需要理解目标数据库的结构信息，包括表名、列表、字段类型、表之间的关联关系（主外键）等。这通常通过预先读取和处理数据库的<code>schema</code>来实现。</p>
<p><strong>SQL生成 (SQL Generation)</strong>：这是最核心的环节。框架会将用户的意图、关键信息与数据库的<code>schema</code>信息一同作为上下文（Context），构建成一个高效的提示（Prompt），然后提交给通义大语言模型。大模型根据这些上下文信息，生成准确的、符合特定数据库方言（如MySQL, PostgreSQL）的SQL查询语句。</p>
<p><strong>SQL执行与结果返回 (Execution &amp; Response)</strong>：生成的SQL语句被发送到目标数据库执行，并将查询结果返回给用户。框架可能还会对结果进行格式化或进一步的自然语言解释。</p>
<p>设计方式&amp;扩展优化：</p>
<p>基于大语言模型驱动，轻量级与可扩展，智能体框架</p>
<p>Schema链接与召回策略优化，对于拥有成百上千张表的复杂数据库，如何根据用户问题动态、准确地选择最相关的表和字段是提升SQL生成质量的关键。可以引入更先进的向量化匹配和知识图谱技术来优化这一过程。</p>
<p>搜索处理模糊和同义词，增强对业务术语、别名和同义词的理解能力，例如用户说“查一下GMV”，系统能自动关联到“成交总额”这一指标对应的字段。</p>
<p>复杂函数的处理，<strong>窗口函数与复杂分析</strong>：提升对需要使用窗口函数、公共表达式（CTE）等高级SQL特性的复杂分析类问题的支持。</p>
<p><strong>跨数据源查询</strong>：支持用户的一个问题需要查询多个异构数据库才能回答的场景。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">mengnankkzhou</div><div class="post-copyright__author_desc">不要走捏</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.tokenlen.top/2025/09/11/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/springai/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.tokenlen.top/2025/09/11/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/springai/')">AI技术源码分析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.tokenlen.top/2025/09/11/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/springai/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=AI技术源码分析&amp;url=https://blog.tokenlen.top/2025/09/11/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/springai/&amp;pic=https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=4b7543c8-82eb-c73e-e489-4adfeccbdaa1" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.tokenlen.top" target="_blank">mengnankkのblog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E6%8A%80%E6%9C%AF%E6%A0%88/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>技术栈<span class="categoryesPageCount">31</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/java/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>java<span class="tagsPageCount">61</span></a><a class="post-meta__box__tags" href="/tags/springAI/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>springAI<span class="tagsPageCount">1</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712179.jpg?_r_=66eda24b-5555-d375-8fb5-ddb70badb349" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/09/10/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/dubbo-alay/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712177.jpg?_r_=37473c5a-843c-bca3-919e-29b432b53db5" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Dubbo源码分析</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/12/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E8%BF%87%E7%A8%8B/new-stack/Neo4J1/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202408081510095.jpg?_r_=9da92e40-96d4-f901-8ec6-411f9da98d8c" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/07/19/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/leetcode/leetcodetotal2/" title="Leetcode HOT面试总结"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722379.jpg?_r_=1a92002b-156e-32b5-ae62-c2808e497810" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-19</div><div class="title">Leetcode HOT面试总结</div></div></a></div><div><a href="/2025/07/06/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/leetcode/leetcodehot2/" title="Leetcode HOT面试题目2"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837448.jpg?_r_=a193bc20-9950-9c86-4e25-165393701db9" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-06</div><div class="title">Leetcode HOT面试题目2</div></div></a></div><div><a href="/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/" title="日志系统设计"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712179.jpg?_r_=66eda24b-5555-d375-8fb5-ddb70badb349" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-10-09</div><div class="title">日志系统设计</div></div></a></div><div><a href="/2025/09/10/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/dubbo-alay/" title="Dubbo源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712177.jpg?_r_=37473c5a-843c-bca3-919e-29b432b53db5" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-10</div><div class="title">Dubbo源码分析</div></div></a></div><div><a href="/2025/09/08/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/spring-alay/" title="Spring源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712181.jpg?_r_=c8ff50e7-f761-77de-43f0-80b532eb932a" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-08</div><div class="title">Spring源码分析</div></div></a></div><div><a href="/2025/08/15/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/java-stack/juc3/" title="JUC-源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837602.jpg?_r_=21db0a9e-f058-ac9b-ea7c-923bbddb8fff" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-15</div><div class="title">JUC-源码分析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Valine</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">清风拂柳影，碧水映花香。</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">mengnankkzhou</h1><div class="author-info__desc">不要走捏</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/mengnankkkk" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/440831872" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410021212939.jpg) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Spring AI Alibaba Graph</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-number">1.1.</span> <span class="toc-text">设计思想</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83"><span class="toc-number">1.3.</span> <span class="toc-text">三大核心</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">Google GraphRAG</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">知识图谱Graph-bulider</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">基本流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80-Cypher"><span class="toc-number">3.2.</span> <span class="toc-text">查询语言 Cypher</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%A3%80%E7%B4%A2"><span class="toc-number">3.3.</span> <span class="toc-text">优化检索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.4.</span> <span class="toc-text">知识图谱的设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.4.1.</span> <span class="toc-text">逻辑设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.4.2.</span> <span class="toc-text">模块设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AEModel%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.4.3.</span> <span class="toc-text">数据Model设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.4.4.</span> <span class="toc-text">分布式微服务设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98%E5%8F%8A%E5%85%B6%E8%A7%A3%E5%86%B3"><span class="toc-number">3.4.5.</span> <span class="toc-text">遇到问题及其解决</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">提示词工程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">AI记忆力&amp;多轮对话的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%AD%E6%9C%9F%E8%AE%B0%E5%BF%86"><span class="toc-number">5.1.</span> <span class="toc-text">短期记忆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%9C%9F%E8%AE%B0%E5%BF%86"><span class="toc-number">5.2.</span> <span class="toc-text">中期记忆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%BF%E6%9C%9F%E4%B8%AA%E6%80%A7%E5%8C%96%E8%AE%B0%E5%BF%86"><span class="toc-number">5.3.</span> <span class="toc-text">长期个性化记忆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BF%86%E4%B8%8A%E4%B8%8B%E6%96%87%E6%9E%84%E5%BB%BA"><span class="toc-number">5.4.</span> <span class="toc-text">记忆上下文构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-number">5.5.</span> <span class="toc-text">性能问题解决</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">SSE</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">nl2sql</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83"><span class="toc-number">7.1.</span> <span class="toc-text">核心</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/" title="日志系统设计"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712179.jpg?_r_=66eda24b-5555-d375-8fb5-ddb70badb349" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="日志系统设计"/></a><div class="content"><a class="title" href="/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/" title="日志系统设计">日志系统设计</a><time datetime="2025-10-08T16:00:00.000Z" title="发表于 2025-10-09 00:00:00">2025-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/new-stack/k8s1/" title="K8S"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202408081510494.jpg?_r_=583d114a-88aa-be90-8598-c951d2856168" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S"/></a><div class="content"><a class="title" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/new-stack/k8s1/" title="K8S">K8S</a><time datetime="2025-09-24T16:00:00.000Z" title="发表于 2025-09-25 00:00:00">2025-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/k8s/" title="k8s八股分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=d1375943-681f-fc68-adc6-cae65f70b708" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s八股分析"/></a><div class="content"><a class="title" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/k8s/" title="k8s八股分析">k8s八股分析</a><time datetime="2025-09-24T16:00:00.000Z" title="发表于 2025-09-25 00:00:00">2025-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/cap/" title="分布式八股分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837447.jpg?_r_=388a2148-b95c-744b-57b3-25aa79d4e194" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式八股分析"/></a><div class="content"><a class="title" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/cap/" title="分布式八股分析">分布式八股分析</a><time datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/aicode/" title="aicode八股分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722380.jpg?_r_=6131513e-5917-371f-05ad-63bc31e37440" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="aicode八股分析"/></a><div class="content"><a class="title" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/aicode/" title="aicode八股分析">aicode八股分析</a><time datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Framework-Hexo-4e88f8?style=flat&logo=hexo" 
       title="博客框架为 Hexo" alt="Hexo">
</a>
<a style="margin-inline:5px" target="_blank" href="https://github.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Source-Github-24292f?style=flat&logo=github" 
       title="本站项目由 GitHub 托管" alt="GitHub">
</a>
<a style="margin-inline:5px" target="_blank" href="https://vercel.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-Vercel-000000?style=flat&logo=vercel" 
       title="使用 Vercel 部署" alt="Vercel">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.qlu.edu.cn/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/University-齐鲁工业大学-0056a2?style=flat&logo=university" 
       title="齐鲁工业大学" alt="齐鲁工业大学">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.aliyun.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-阿里云-ff6a00?style=flat&logo=aliyun" 
       title="使用阿里云服务" alt="阿里云">
</a>
<a style="margin-inline:5px" target="_blank" href="https://cloud.tencent.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-腾讯云-0a73b8?style=flat&logo=tencent-cloud" 
       title="使用腾讯云服务" alt="腾讯云">
</a></p>
</div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2025 By <a class="footer-bar-link" href="/" title="mengnankkzhou" target="_blank">mengnankkzhou</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="鲁ICP备2024110758号">鲁ICP备2024110758号</a><a class="footer-bar-link" href="https://blog.tokenlen.top/rss2.xml" title="Rss">Rss</a><a class="footer-bar-link cc" href="/pravite" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">192</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">56</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">26</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 0.88rem;">BF<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 0.88rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 0.88rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 0.88rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 0.88rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 0.88rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 0.88rem;">FI<sup>1</sup></a><a href="/tags/Go/" style="font-size: 0.88rem;">Go<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 0.88rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>12</sup></a><a href="/tags/XSS/" style="font-size: 0.88rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>2</sup></a><a href="/tags/football/" style="font-size: 0.88rem;">football<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>61</sup></a><a href="/tags/juc/" style="font-size: 0.88rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 0.88rem;">jvm<sup>2</sup></a><a href="/tags/leetcode/" style="font-size: 0.88rem;">leetcode<sup>10</sup></a><a href="/tags/markdown/" style="font-size: 0.88rem;">markdown<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>17</sup></a><a href="/tags/net/" style="font-size: 0.88rem;">net<sup>7</sup></a><a href="/tags/paper/" style="font-size: 0.88rem;">paper<sup>1</sup></a><a href="/tags/php/" style="font-size: 0.88rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 0.88rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 0.88rem;">python<sup>3</sup></a><a href="/tags/redis/" style="font-size: 0.88rem;">redis<sup>4</sup></a><a href="/tags/shell/" style="font-size: 0.88rem;">shell<sup>4</sup></a><a href="/tags/spring/" style="font-size: 0.88rem;">spring<sup>4</sup></a><a href="/tags/spring-boot/" style="font-size: 0.88rem;">spring boot<sup>14</sup></a><a href="/tags/sql/" style="font-size: 0.88rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>3</sup></a><a href="/tags/%E5%8E%8B%E6%B5%8B/" style="font-size: 0.88rem;">压测<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 0.88rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 0.88rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>20</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 0.88rem;">正则表达式<sup>2</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 0.88rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>9</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 0.88rem;">面试<sup>46</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 mengnankkzhou 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@3.2.2/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://comment.tokenlen.top/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, "siu~~~~~"))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://comment.tokenlen.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '3ZpuzQHHKWfFH59QFYmcuCvr-gzGzoHsz',
      appKey: '8DIvljObQp853ueQMZzpb9Gx',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Twikoo' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://comment.tokenlen.top/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>