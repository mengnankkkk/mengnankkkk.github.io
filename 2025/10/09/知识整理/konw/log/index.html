<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>日志系统设计 | mengnankkのblog</title><meta name="keywords" content="java,log"><meta name="author" content="mengnankkzhou"><meta name="copyright" content="mengnankkzhou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="日志系统设计"><meta name="application-name" content="日志系统设计"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="日志系统设计"><meta property="og:url" content="https://blog.tokenlen.top/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/index.html"><meta property="og:site_name" content="mengnankkのblog"><meta property="og:description" content="高并发日志系统设计 我们可以将整个日志生命周期划分为五个关键阶段：采集 -&amp;gt; 传输 -&amp;gt; 处理 -&amp;gt; 存储 -&amp;gt; 应用。 根本性设计：  结构化日志: 将不同日志封装成不同数据结构。 传输解耦: 使用 Kafka 作为日志总线。 分流消费: 一部分流式处理（热路径），一部分存"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712179.jpg?_r_=66eda24b-5555-d375-8fb5-ddb70badb349"><meta property="article:author" content="mengnankkzhou"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712179.jpg?_r_=66eda24b-5555-d375-8fb5-ddb70badb349"><meta name="description" content="高并发日志系统设计 我们可以将整个日志生命周期划分为五个关键阶段：采集 -&amp;gt; 传输 -&amp;gt; 处理 -&amp;gt; 存储 -&amp;gt; 应用。 根本性设计：  结构化日志: 将不同日志封装成不同数据结构。 传输解耦: 使用 Kafka 作为日志总线。 分流消费: 一部分流式处理（热路径），一部分存"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.tokenlen.top/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走啊，那种事情不要啊","backTitle":"♪(^∇^*)欢迎回家！！！！"},
  LA51: undefined,
  greetingBox: {"enable":"ture","default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://comment.tokenlen.top/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"\tbd9428de12b54b96b2f1b4e69aeee81f","mailMd5":"F37442226DA71492"},
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: mengnankkzhou","link":"链接: ","source":"来源: mengnankkのblog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'mengnankkのblog',
  title: '日志系统设计',
  postAI: '',
  pageFillDescription: '高并发日志系统设计, 结构设计, 数据传输, 数据处理, 数据存储, 日志应用高并发日志系统设计我们可以将整个日志生命周期划分为五个关键阶段采集传输处理存储应用根本性设计结构化日志将不同日志封装成不同数据结构传输解耦使用作为日志总线分流消费一部分流式处理热路径一部分存储冷路径结构设计统一日志规范会定义一个公共的日志基础所有日志都必须包含某些字段需要保证一致性确保任何来源的日志都有相同的核心结构便于机器解析和人类理解可关联性能够将分散在不同系统不同时间的日志串联起来形成完整的事件链可检索性优化核心字段使其易于索引和查询事件发生时间毫秒级精度格式必须是格式例如时区必须是协调世界时这消除了所有因服务器时区不同导致的混乱是分布式系统的唯一正确选择精度建议到毫秒级以应对高并发场景下的事件排序实践要点服务器必须启用网络时间协议进行时钟同步否则时间戳将失去意义应用名称命名应采用公司内唯一的标准化的命名规范例如来源通常通过环境变量或启动配置文件注入由系统保证其准确性作用日志聚合筛选告警路由的首要关键字实例标识传统物理机虚拟机环境下的机器名环境下的名称应自动识别环境并优先使用作用定位到产生日志的具体实例用于排查单点问题环境取值严格的枚举值如禁止出现等变体作用隔离不同环境的数据设置不同的告警阈值和日志保留策略用于分布式追踪这是打通日志链路监控的关键来源由网关服务入口的第一个中间件生成并通过请求头如标准的头在整个调用链中传递作用标识一次完整的用户请求通过搜索一个可以获得该请求流经所有微服务的全部日志标识本次调用链中的一个具体工作单元例如一次调用或数据库查询这是打通和的核心粘合剂业务关联标准遵循业界标准如实践指南用于开发调试生产环境默认应关闭记录关键业务流程节点如用户下单成功支付回调接收出现可恢复的非预期的状况但不影响主流程如外部调用重试成功发生错误导致当前操作失败需要研发人员关注导致应用崩溃的严重错误真正的日志消息体通常是对象格式强烈建议其本身也是一个对象而不是一个字符串反模式难以解析最佳实践字段在中可以保留一个字段用于人类快速阅读不同业务的日志可以在此基础上扩展自己的字段这个规范会写入公司技术文档成为开发标准日志公司会提供统一的日志开发者只需调用会自动完成结构化封装将日志信息组装成符合规范的或格式接口设计提供简洁的接口如内部实现内部维护一个包含所有基础字段如的上下文当被调用时它会合并基础上下文从请求上下文中注入的字段和用户传入的生成时间戳填充日志级别使用高性能的库如或库将整个对象序列化上下文注入自动从请求上下文中抓取等信息并注入日志在中通常使用是日志框架如提供的一种映射诊断上下文机制用于在多线程或分布式环境中动态地携带和记录上下文信息上下文存储以键值对的形式保存附加信息例如用户会话请求路径等线程关联每个线程都有自己的副本当线程将控制权传递给子线程或线程池时可选择将上下文复制或清空日志输出在日志格式化模板中使用占位符如中对应键的值就会被注入到最终的日志记录中在中利用包框架集成会提供中间件该中间件在请求处理的最外层运行负责从请求头解析等信息并将其放入当前线程协程的上下文中之后在本次请求生命周期内的任何日志记录调用都会自动从该上下文中提取信息并注入日志异步高性能写入内部有缓冲区和异步线程将日志写入本地文件或直接发送到对业务线程影响降到最低生产者业务线程调用时序列化后的日志被放入一个内存中的有界阻塞队列这个操作非常快业务线程几乎不会被阻塞消费者后台工作线程内部启动一个或多个后台线程这些线程持续地从队列中拉取日志批量处理为了提升效率后台线程不会来一条就写一条它会累积一个批次例如达到条日志或超过秒然后将整个批次一次性写入目标优雅关闭必须注册一个当应用进程关闭时该钩子会被触发确保将内存队列中剩余的日志全部刷出防止日志丢失动态采样与限流对于或高流量日志可以在配置中心控制其采样率防止打爆下游配置中心集成会与公司的配置中心如集成动态调整运维人员可以在配置中心动态调整日志级别和采样率无需重启应用例如可以下发配置对的所有级别日志进行的采样实现算法采样基于的后几位进行哈希取模确保对同一的日志要么全采要么全不采避免调用链断裂限流使用令牌桶算法平滑地限制日志产生的速率采集在每台机器或每个上部署一个日志采集如它的职责是多源采集监听的网络端口读取本地日志文件接收的等元数据附加自动为日志附加环境信息如机器标签等预处理简单的格式转换或过滤可靠转发将日志可靠地批量地发送到是日志数据离开业务机器前的最后一站是数据治理和可靠性的关键保障核心的职责多源采集主流通过插件读取应用写入本地的日志文件会记录文件读取的偏移量即使重启也能从上次的位置继续读取保证不重不漏通过协议或插件接收直接通过网络发送的日志这减少了磁盘但增加了网络依赖通过或插件采集操作系统和系统服务的日志元数据附加环境通常作为部署会通过获取自身所在的信息并通过上的查询本机所有的元数据当它处理一个日志文件时例如它可以根据文件路径反查出该日志属于哪个并将其和作为字段附加到日志记录中这是实现按元数据筛选日志的关键云环境可以请求云厂商的元数据服务如获取实例可用区等信息并附加预处理过滤在将日志发往之前可以根据规则丢弃不需要的日志例如丢弃所有健康检查的日志节省下游成本解析对于一些无法改造的仍在输出纯文本日志的遗留系统可以使用正则表达式库将其解析为结构化数据数据脱敏非常重要可以配置规则对日志中的敏感信息如身份证号银行卡号手机号进行识别和脱敏替换为确保敏感数据在离开节点前得到处理满足合规要求可靠转发缓冲机制这是可靠性的核心内存缓冲速度最快但如果进程崩溃缓冲区中的日志会丢失文件缓冲会将待发送的日志先写入本地磁盘上的一个缓冲文件即使进程崩溃或机器重启也能从文件中恢复数据这是生产环境的推荐配置重试与背压当后端集群不可用时的输出插件会启动带指数退避的重试机制如果持续不可用缓冲队列会逐渐堆积必须有背压机制即当缓冲区满时会减慢甚至暂停从输入源读取数据防止自身因内存耗尽而崩溃比较实用的几个数据传输精细化的策略特性自描述性名称应能清晰地表达其承载的数据内容来源和用途隔离性通过隔离不同业务不同敏感度的数据实现流量隔离和权限控制可扩展性命名规范应能支持公司业务的未来增长而不会变得混乱治理性易于自动化管理监控和实施成本分摊我们要保证每一类消息放在一块的话就可以使用分层命名规范推荐采用点分的层级结构格式如下数据类型顶级命名空间用于区分数据的大类例如示例业务单元对应公司的组织架构或核心业务领域例如示例应用名称产生数据的具体服务或应用示例数据内容描述中消息的具体内容或用途这是最能体现精细化的一层应用自身的业务和调试日志审计日志记录用户敏感操作的访问日志业务事件如示例申请流程禁止开发者随意创建必须通过自动化平台或流程申请申请时需要提供命名分区数副本因子预估流量数据保留策略和负责人信息分区策略目标确保数据均匀分布避免热点同时保证需要顺序处理的消息进入同一分区实践对于普通应用日志使用默认的轮询策略即可对于需要保证顺序性的日志如同一用户的操作日志必须在或层面指定分区键例如使用这样该用户的所有日志都会被发送到同一个分区消费者可以按序处理访问控制为每个设置严格的支付服务的生产者绝不应该有权限向用户中心的写入数据这通过的机制实现与公司的认证系统集成模式注册中心这是从能用到可靠的关键一步当日志结构发生变更如增加字段如果没有管理很容易导致下游消费程序崩溃如强制要求所有写入的日志消息都遵循预先注册的通常是或好处数据质量保证阻止不合规的数据进入前后向兼容可以管理的演进确保旧的消费者也能处理新版本的数据减小消息体积使用等二进制格式比体积更小传输效率更高流程定义开发者使用或文件定义日志的数据结构这个文件与代码一同存放在仓库中注册在流程中会有一个步骤是自动将新的或更新后的注册到此时会根据预设的兼容性策略进行检查生产者序列化应用的生产者在发送消息时将待发送的日志对象一个对象和信息交给序列化器序列化器会去查询并缓存该对应的唯一最终发送到的消息是一个二进制字节流其头部包含了这个消费者反序列化消费者收到二进制消息后从消息头部解析出使用这个去查询并缓存对应的写入方结合消费者本地的和写入方将二进制数据安全地反序列化为对象兼容性策略向后兼容默认且最推荐含义使用新版的消费者可以处理旧版产生的数据规则你可以删除字段或者添加带有默认值的可选字段你不能添加没有默认值的必填字段升级路径先升级所有消费者再升级生产者这是最安全的模式向前兼容含义使用旧版的消费者可以处理新版产生的数据规则你可以添加新字段或者删除可选字段你不能删除必填字段升级路径先升级生产者再升级消费者完全兼容含义同时满足向前和向后兼容规则只能添加或删除带有默认值的可选字段非常严格多集群与异地容灾为了保证日志系统的高可用性集群通常是跨可用区部署的对于核心业务甚至会使用等工具将日志数据流准实时地复制到另一个数据中心的集群实现异地容灾容灾等级与实践集群内高可用基础架构单个集群其节点分布在同一区域如东京的个不同可用区配置副本因子至少为保障能抵御单个节点或单个可用区的故障数据不丢失服务不中断会有短暂的切换这是所有生产环境的最低标准异地容灾推荐架构模式主备模式主集群位于主数据中心如东京承载所有实时的生产流量备集群位于异地容灾中心如大阪平时不直接服务业务同步工具使用或这些工具本质上是特殊的消费者和生产者从主集群消费数据然后生产到备集群对应的中故障切换监控与决策监控系统检测到主集群不可用由运维团队或自动化脚本决策启动切换执行切换停止主集群向备集群的同步任务将所有生产者和消费者的配置通常通过配置中心或指向备集群备集群晋升为主集群开始服务关键指标恢复点目标可能丢失多少数据取决于同步延迟通常在秒级到分钟级恢复时间目标完成切换需要多长时间取决于自动化程度通常在分钟级到小时级多活架构复杂架构模式两个或多个集群如东京和大阪同时对外提供服务挑战需要双向复制并解决循环复制和数据冲突的问题这对应用架构有侵入性要求例如消息体中必须包含时间戳或来源信息来解决冲突适用场景对日志系统来说模式过于复杂投入产出比不高它更适用于需要为全球用户提供最低延迟服务的核心交易系统对于日志主备模式是成本和可靠性之间最佳的平衡点数据处理流式处理使用或作为核心处理引擎核心任务实时告警基于规则或机器学习模型对错误日志性能异常如安全事件如注入尝试进行实时检测和告警通过钉钉等实时指标计算从日志中提取关键指标如调用次数错误率等并将其推送到监控系统如用于实时监控大盘数据丰富这是非常有价值的一步流处理任务可以关联外部数据源如服务来丰富日志内容例如将关联出用户的真实姓名所属部门等信息为后续分析提供更多维度数据存储热数据层秒级查询目标满足研发人员近期的如天内日志快速检索排查问题的需求技术栈或集群流程一个专门的消费组从读取数据经过简单的处理后写入配套工具或用于前端的可视化查询和仪表盘展示温冷数据层成本优化目标长期数月甚至数年存储所有日志满足审计合规要求和离线大数据分析的需求同时成本要低技术栈成本极低的对象存储如或自建的流程另一个消费组如从拉取全量日志转换为列式存储格式如这种格式极大地优化了分析查询的性能和存储成本按天或按小时分区存入数据湖数据仓库查询引擎使用等引擎对数据湖中的日志进行即席查询索引生命周期管理在中设置策略例如数据在高性能节点上保存天然后自动迁移到低成本节点保存天超过天的数据可以删除或快照到冷存储中这实现了成本和性能的最佳平衡日志应用统一查询入口提供一个平台可以同时查询热数据和冷数据数据湖用户无需关心底层存储差异可观测性平台将日志链路指标三者打通在日志查询界面点击一个能直接跳转到或中对应的分布式调用链看到完整的请求耗时和服务依赖关系智能运维基于海量历史日志数据训练异常检测模型平台能够自动发现与历史模式不符的异常日志进行智能告警甚至预测潜在的故障',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-10-09 15:44:36',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/rss2.xml" title="mengnankkのblog" type="application/rss+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">mengnankkのblog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://imgbed.mengnankk.asia/202407021650088.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://imgbed.mengnankk.asia/202407021650088.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 1.05rem;">BF<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 1.05rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 1.05rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 1.05rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 1.05rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 1.05rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 1.05rem;">FI<sup>1</sup></a><a href="/tags/Go/" style="font-size: 1.05rem;">Go<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 1.05rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>12</sup></a><a href="/tags/XSS/" style="font-size: 1.05rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>2</sup></a><a href="/tags/football/" style="font-size: 1.05rem;">football<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>61</sup></a><a href="/tags/juc/" style="font-size: 1.05rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 1.05rem;">jvm<sup>2</sup></a><a href="/tags/leetcode/" style="font-size: 1.05rem;">leetcode<sup>10</sup></a><a href="/tags/markdown/" style="font-size: 1.05rem;">markdown<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 1.05rem;">mysql<sup>17</sup></a><a href="/tags/net/" style="font-size: 1.05rem;">net<sup>7</sup></a><a href="/tags/paper/" style="font-size: 1.05rem;">paper<sup>1</sup></a><a href="/tags/php/" style="font-size: 1.05rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 1.05rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 1.05rem;">python<sup>3</sup></a><a href="/tags/redis/" style="font-size: 1.05rem;">redis<sup>4</sup></a><a href="/tags/shell/" style="font-size: 1.05rem;">shell<sup>4</sup></a><a href="/tags/spring/" style="font-size: 1.05rem;">spring<sup>4</sup></a><a href="/tags/spring-boot/" style="font-size: 1.05rem;">spring boot<sup>14</sup></a><a href="/tags/sql/" style="font-size: 1.05rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>3</sup></a><a href="/tags/%E5%8E%8B%E6%B5%8B/" style="font-size: 1.05rem;">压测<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 1.05rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 1.05rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>20</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 1.05rem;">正则表达式<sup>2</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 1.05rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 1.05rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>9</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 1.05rem;">面试<sup>46</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">25</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">15</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">16</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">22</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%A0%88/" itemprop="url">技术栈</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/java/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>java</span></a><a class="article-meta__tags" href="/tags/log/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>log</span></a></span></div></div><h1 class="post-title" itemprop="name headline">日志系统设计</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-10-08T16:00:00.000Z" title="发表于 2025-10-09 00:00:00">2025-10-09</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-10-09T07:44:36.768Z" title="更新于 2025-10-09 15:44:36">2025-10-09</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">5.4k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator"></span><span id="" data-flag-title="日志系统设计"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为济南"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>济南</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712179.jpg?_r_=66eda24b-5555-d375-8fb5-ddb70badb349"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.tokenlen.top/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/"><header><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%A0%88/" itemprop="url">技术栈</a><a href="/tags/java/" tabindex="-1" itemprop="url">java</a><a href="/tags/log/" tabindex="-1" itemprop="url">log</a><h1 id="CrawlerTitle" itemprop="name headline">日志系统设计</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">mengnankkzhou</span><time itemprop="dateCreated datePublished" datetime="2025-10-08T16:00:00.000Z" title="发表于 2025-10-09 00:00:00">2025-10-09</time><time itemprop="dateCreated datePublished" datetime="2025-10-09T07:44:36.768Z" title="更新于 2025-10-09 15:44:36">2025-10-09</time></header><h1>高并发日志系统设计</h1>
<p>我们可以将整个日志生命周期划分为五个关键阶段：<strong>采集 -&gt; 传输 -&gt; 处理 -&gt; 存储 -&gt; 应用</strong>。</p>
<p>根本性设计：</p>
<ul>
<li><strong>结构化日志</strong>: 将不同日志封装成不同数据结构。</li>
<li><strong>传输解耦</strong>: 使用 Kafka 作为日志总线。</li>
<li><strong>分流消费</strong>: 一部分流式处理（热路径），一部分存储（冷路径）。</li>
</ul>
<h2 id="结构设计">结构设计</h2>
<p>统一日志规范:</p>
<p>会定义一个公共的日志基础 Schema (Base Schema)，所有日志都必须包含某些字段，需要保证：</p>
<p><strong>一致性 (Consistency):</strong> 确保任何来源的日志都有相同的核心结构，便于机器解析和人类理解。</p>
<p><strong>可关联性 (Correlatability):</strong> 能够将分散在不同系统、不同时间的日志串联起来，形成完整的事件链。</p>
<p><strong>可检索性 (Searchability):</strong> 优化核心字段，使其易于索引和查询。</p>
<p><code>timestamp</code>: 事件发生时间（UTC, 毫秒级精度）。</p>
<ul>
<li><strong>格式:</strong> 必须是 <strong>ISO 8601</strong> 格式，例如 <code>2025-10-09T06:10:35.123Z</code>。</li>
<li><strong>时区:</strong> 必须是 <strong>UTC (协调世界时)</strong>。这消除了所有因服务器时区不同导致的混乱，是分布式系统的唯一正确选择。</li>
<li><strong>精度:</strong> 建议到<strong>毫秒</strong>级，以应对高并发场景下的事件排序。</li>
<li><strong>实践要点:</strong> 服务器必须启用 <strong>NTP (网络时间协议)</strong> 进行时钟同步，否则时间戳将失去意义。</li>
</ul>
<p><code>app_name</code>: 应用名称。</p>
<ul>
<li><strong>命名:</strong> 应采用公司内唯一的、标准化的命名规范，例如 <code>payment-service</code>, <code>user-center-api</code>。</li>
<li><strong>来源:</strong> 通常通过环境变量或启动配置文件注入，由CI/CD系统保证其准确性。</li>
<li><strong>作用:</strong> 日志聚合、筛选、告警路由的首要关键字。</li>
</ul>
<p><code>hostname</code> / <code>pod_name</code>: 实例标识。</p>
<ul>
<li><strong><code>hostname</code>:</strong> 传统物理机/虚拟机环境下的机器名。</li>
<li><strong><code>pod_name</code>:</strong> Kubernetes环境下的Pod名称。<strong>Agent应自动识别环境并优先使用 <code>pod_name</code></strong>。</li>
<li><strong>作用:</strong> 定位到产生日志的具体实例，用于排查单点问题。</li>
</ul>
<p><code>env</code>: 环境 (prod, staging, dev)</p>
<ul>
<li>
<p><strong>取值:</strong> 严格的枚举值，如 <code>prod</code>, <code>staging</code>, <code>test</code>, <code>dev</code>。禁止出现 <code>pre-prod</code>, <code>production</code> 等变体。</p>
</li>
<li>
<p><strong>作用:</strong> 隔离不同环境的数据，设置不同的告警阈值和日志保留策略。</p>
</li>
</ul>
<p><code>trace_id</code> / <code>span_id</code>: 用于分布式追踪，<strong>这是打通日志、链路、监控的关键</strong>。</p>
<p><strong>来源:</strong> 由API网关、服务入口的第一个中间件生成，并通过请求头（如 W3C Trace Context 标准的 <code>traceparent</code> 头）在整个调用链中传递。</p>
<p><strong>作用:</strong></p>
<ul>
<li><code>trace_id</code>: 标识一次完整的用户请求。通过搜索一个 <code>trace_id</code>，可以获得该请求流经所有微服务的全部日志。</li>
<li><code>span_id</code>: 标识本次调用链中的一个具体工作单元（例如一次RPC调用或数据库查询）。</li>
</ul>
<p><strong>这是打通 Logging 和 Tracing 的</strong> <strong>核心粘合剂</strong>。</p>
<p><code>user_id</code> / <code>device_id</code>: 业务关联ID。</p>
<p><code>log_level</code>: (INFO, WARN, ERROR)。</p>
<ul>
<li><strong>标准:</strong> 遵循业界标准，如 <code>DEBUG</code>, <code>INFO</code>, <code>WARN</code>, <code>ERROR</code>, <code>FATAL</code>。</li>
<li><strong>实践指南:</strong>
<ul>
<li><code>DEBUG</code>: 用于开发调试，<strong>生产环境默认应关闭</strong>。</li>
<li><code>INFO</code>: 记录关键业务流程节点，如“用户下单成功”、“支付回调接收”。</li>
<li><code>WARN</code>: 出现可恢复的、非预期的状况，但不影响主流程，如“外部API调用重试成功”。</li>
<li><code>ERROR</code>: 发生错误，导致当前操作失败，<strong>需要研发人员关注</strong>。</li>
<li><code>FATAL</code>: 导致应用崩溃的严重错误。</li>
</ul>
</li>
</ul>
<p><code>log_content</code>: 真正的日志消息体（通常是 JSON 对象）。</p>
<ul>
<li>
<p><strong>格式:</strong> <strong>强烈建议其本身也是一个JSON对象</strong>，而不是一个字符串。</p>
</li>
<li>
<p><strong>反模式:</strong> <code>log.info(&quot;User &quot; + userId + &quot; logged in from &quot; + ip)</code> -&gt; <code>log_content: &quot;User 123 logged in from 127.0.0.1&quot;</code> (难以解析)。</p>
</li>
<li>
<p><strong>最佳实践:</strong> <code>log.info(&quot;user login success&quot;, &#123;&quot;user_id&quot;: 123, &quot;login_ip&quot;: &quot;127.0.0.1&quot;&#125;)</code> -&gt; <code>log_content: &#123;&quot;message&quot;: &quot;user login success&quot;, &quot;user_id&quot;: 123, &quot;login_ip&quot;: &quot;127.0.0.1&quot;&#125;</code>。</p>
</li>
<li>
<p><strong>message字段:</strong> 在 <code>log_content</code> 中可以保留一个 <code>message</code> 字段用于人类快速阅读。</p>
</li>
<li>
<p>不同业务的日志可以在此基础上扩展自己的字段。这个规范会写入公司技术文档，成为开发标准。</p>
</li>
</ul>
<p>SDK:</p>
<p><strong>日志 SDK</strong>: 公司会提供统一的日志 SDK (for Java, Go, Python, etc.)。开发者只需调用 <code>log.info(&quot;user logged in&quot;, extra_fields=&#123;&quot;user_id&quot;: 123&#125;)</code>，SDK 会自动完成：</p>
<ul>
<li>
<p><strong>结构化封装</strong>：将日志信息组装成符合规范的 JSON 或 Protobuf 格式。</p>
<ul>
<li>
<p><strong>接口设计:</strong> 提供简洁的接口，如 <code>log.info(message, extra_fields_dict)</code>。</p>
<p><strong>内部实现:</strong> SDK内部维护一个包含所有基础字段（如<code>app_name</code>, <code>env</code>）的上下文。当 <code>log.info</code> 被调用时，它会：</p>
<ol>
<li>合并基础上下文、从请求上下文中注入的字段 (<code>trace_id</code>) 和用户传入的 <code>extra_fields</code>。</li>
<li>生成时间戳，填充日志级别。</li>
<li>使用高性能的JSON库（如 <code>sonic-go</code> for Go, <code>orjson</code> for Python）或Protobuf库将整个对象序列化。</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>上下文注入</strong>：自动从请求上下文中抓取 <code>trace_id</code> 等信息并注入日志。</p>
<ul>
<li>
<p>在<strong>Java</strong>中，通常使用 <code>ThreadLocal</code> + <code>MDC (Mapped Diagnostic Context)</code>。</p>
<ul>
<li>MDC 是日志框架（如 Log4j、SLF4J/Logback）提供的一种<strong>映射诊断上下文</strong>机制，用于在多线程或分布式环境中动态地携带和记录“上下文”信息。</li>
<li><strong>上下文存储</strong>：MDC 以键–值对的形式保存附加信息（例如用户 ID、会话 ID、请求路径等）。</li>
<li><strong>线程关联</strong>：每个线程都有自己的 MDC 副本，当线程将控制权传递给子线程或线程池时，可选择将上下文复制或清空。</li>
<li><strong>日志输出</strong>：在日志格式化模板中使用占位符（如 <code>%X&#123;userId&#125;</code>），MDC 中对应键的值就会被注入到最终的日志记录中。</li>
</ul>
<p>在<strong>Go</strong>中，利用 <code>context.Context</code> 包。</p>
<p><strong>Web框架集成:</strong> SDK会提供中间件（Middleware/Filter/Interceptor）。该中间件在请求处理的最外层运行，负责从请求头解析 <code>trace_id</code> 等信息，并将其放入当前线程/协程的上下文中。之后，在本次请求生命周期内的任何日志记录调用，SDK都会自动从该上下文中提取信息并注入日志。</p>
</li>
</ul>
</li>
<li>
<p><strong>异步高性能写入</strong>：内部有缓冲区和异步线程，将日志写入本地文件或直接发送到 Agent，对业务线程影响降到最低。</p>
<ul>
<li>
<p><strong>生产者 (业务线程):</strong> 调用 <code>log.info</code> 时，序列化后的日志被放入一个内存中的<strong>有界阻塞队列 (Bounded Blocking Queue)</strong>。这个操作非常快，业务线程几乎不会被阻塞。</p>
<p><strong>消费者 (后台工作线程):</strong> SDK内部启动一个或多个后台线程。这些线程持续地从队列中拉取日志。</p>
<p><strong>批量处理 (Batching):</strong> 为了提升I/O效率，后台线程不会来一条就写一条。它会累积一个批次（例如，达到1000条日志，或超过1秒），然后将整个批次一次性写入目标。</p>
<p><strong>优雅关闭 (Graceful Shutdown):</strong> SDK必须注册一个 <code>shutdown hook</code>。当应用进程关闭时，该钩子会被触发，确保将内存队列中剩余的日志全部刷出（flush），<strong>防止日志丢失</strong>。</p>
</li>
</ul>
</li>
<li>
<p><strong>动态采样与限流</strong>：对于 DEBUG 或高流量日志，可以在配置中心控制其采样率，防止打爆下游。</p>
<ul>
<li>
<p><strong>配置中心集成:</strong> SDK会与公司的配置中心（如 Nacos, Apollo, Consul）集成。</p>
<p><strong>动态调整:</strong> 运维人员可以在配置中心动态调整日志级别和采样率，无需重启应用。例如，可以下发配置：“对 <code>payment-service</code> 的所有 <code>INFO</code> 级别日志进行 10% 的采样”。</p>
<p><strong>实现算法:</strong></p>
<ul>
<li><strong>采样:</strong> 基于 <code>trace_id</code> 的后几位进行哈希取模，确保对同一trace的日志要么全采，要么全不采，避免调用链断裂。</li>
<li><strong>限流:</strong> 使用<strong>令牌桶 (Token Bucket)</strong> 算法，平滑地限制日志产生的速率。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>采集 Agent</strong>: 在每台机器或每个 K8s Node上部署一个日志采集 Agent（如 <strong>Fluentd</strong>, <strong>Logstash</strong>, <strong>Vector</strong>）。它的职责是：</p>
<ul>
<li><strong>多源采集</strong>: 监听 SDK 的网络端口、读取本地日志文件、接收 systemd 的 journald 等。</li>
<li><strong>元数据附加</strong>: 自动为日志附加环境信息，如机器 IP、K8s Pod 标签等。</li>
<li><strong>预处理</strong>: 简单的格式转换或过滤。</li>
<li><strong>可靠转发</strong>: 将日志可靠地、批量地发送到 Kafka。</li>
</ul>
<p>Agent 是日志数据离开业务机器前的最后一站，是数据治理和可靠性的关键保障。</p>
<p>核心的职责：</p>
<p><strong>多源采集 (Multi-Source Inputs):</strong></p>
<ul>
<li><strong>File Tailing (主流):</strong> 通过 <code>in_tail</code> 插件读取应用写入本地的日志文件。Agent会记录文件读取的偏移量（offset），即使Agent重启也能从上次的位置继续读取，保证不重不漏。</li>
<li><strong>Network Protocols:</strong> 通过 <code>in_forward</code> (Fluentd协议) 或 <code>in_tcp</code>/<code>in_udp</code> 插件接收SDK直接通过网络发送的日志。这减少了磁盘I/O，但增加了网络依赖。</li>
<li><strong>System Integration:</strong> 通过 <code>in_journald</code> 或 <code>in_syslog</code> 插件采集操作系统和系统服务的日志。</li>
</ul>
<p><strong>元数据附加 (Metadata Enrichment):</strong></p>
<ul>
<li><strong>K8s环境:</strong> Agent（通常作为DaemonSet部署）会通过<strong>Downward API</strong>获取自身所在的Pod信息，并通过<strong>Node上的Kubelet API</strong>查询本机所有Pod的元数据。当它处理一个日志文件时（例如 <code>/var/log/pods/&lt;pod_uid&gt;/&lt;container_name&gt;/0.log</code>），它可以根据文件路径反查出该日志属于哪个Pod、Namespace、Deployment，并将其<strong>Labels和Annotations</strong>作为字段附加到日志记录中。这是实现按K8s元数据筛选日志的关键。</li>
<li><strong>云环境:</strong> Agent可以请求云厂商的元数据服务（如AWS EC2 Metadata Service），获取实例ID、可用区、VPC等信息并附加。</li>
</ul>
<p><strong>预处理 (In-flight Processing):</strong></p>
<ul>
<li><strong>过滤 (Filtering):</strong> 在将日志发往Kafka之前，可以根据规则丢弃不需要的日志（例如，丢弃所有健康检查的日志），节省下游成本。</li>
<li><strong>解析 (Parsing):</strong> 对于一些无法改造的、仍在输出纯文本日志的遗留系统，Agent可以使用 <strong>Grok</strong> 正则表达式库将其解析为结构化数据。</li>
<li><strong>数据脱敏 (PII Masking):</strong> <strong>非常重要</strong>。Agent可以配置规则，对日志中的敏感信息（如身份证号、银行卡号、手机号）进行识别和脱敏（替换为<code>***</code>），确保敏感数据在离开节点前得到处理，满足合规要求。</li>
</ul>
<p><strong>可靠转发 (Reliable Forwarding):</strong></p>
<ul>
<li><strong>缓冲机制 (Buffering):</strong> 这是Agent可靠性的核心。
<ul>
<li><strong>内存缓冲 (Memory Buffer):</strong> 速度最快，但如果Agent进程崩溃，缓冲区中的日志会丢失。</li>
<li><strong>文件缓冲 (File Buffer):</strong> Agent会将待发送的日志先写入本地磁盘上的一个缓冲文件。即使进程崩溃或机器重启，也能从文件中恢复数据。这是<strong>生产环境的推荐配置</strong>。</li>
</ul>
</li>
<li><strong>重试与背压 (Retries &amp; Backpressure):</strong>
<ul>
<li>当后端Kafka集群不可用时，Agent的输出插件会启动带<strong>指数退避 (Exponential Backoff)</strong> 的重试机制。</li>
<li>如果Kafka持续不可用，缓冲队列会逐渐堆积。Agent必须有<strong>背压机制</strong>，即当缓冲区满时，会减慢甚至暂停从输入源读取数据，防止自身因内存耗尽而崩溃。</li>
</ul>
</li>
</ul>
<p>比较实用的几个agent:</p>
<p><strong>Fluentd</strong>,<strong>Logstash</strong>,Vector</p>
<h2 id="数据传输">数据传输</h2>
<p><strong>精细化的 Kafka Topic 策略</strong>:</p>
<p>特性：</p>
<ul>
<li>
<p><strong>自描述性 (Self-Describing):</strong> Topic 名称应能清晰地表达其承载的数据内容、来源和用途。</p>
<p><strong>隔离性 (Isolation):</strong> 通过 Topic 隔离不同业务、不同敏感度的数据，实现流量隔离和权限控制。</p>
<p><strong>可扩展性 (Scalability):</strong> 命名规范应能支持公司业务的未来增长，而不会变得混乱。</p>
<p><strong>治理性 (Governability):</strong> 易于自动化管理、监控和实施成本分摊。</p>
</li>
</ul>
<p>我们要保证每一类消息放在一块的话，就可以使用分层命名规范</p>
<p>推荐采用点分（<code>.</code>）的层级结构，格式如下： <strong><code>&lt;type&gt;.&lt;business_unit&gt;.&lt;app_name&gt;.&lt;data_content&gt;[-&lt;version&gt;]</code></strong></p>
<ul>
<li><strong><code>type</code> (数据类型):</strong> 顶级命名空间，用于区分数据的大类。例如：<code>logs</code>, <code>metrics</code>, <code>events</code>, <code>traces</code>。
<ul>
<li><em>示例:</em> <code>logs.</code></li>
</ul>
</li>
<li><strong><code>business_unit</code> (业务单元):</strong> 对应公司的组织架构或核心业务领域。例如：<code>payment</code>, <code>usercenter</code>, <code>infra</code>, <code>recommend</code>。
<ul>
<li><em>示例:</em> <code>logs.payment.</code></li>
</ul>
</li>
<li><strong><code>app_name</code> (应用名称):</strong> 产生数据的具体服务或应用。
<ul>
<li><em>示例:</em> <code>logs.payment.checkout-svc.</code></li>
</ul>
</li>
<li><strong><code>data_content</code> (数据内容):</strong> 描述 Topic 中消息的具体内容或用途，这是最能体现“精细化”的一层。
<ul>
<li><code>application</code>: 应用自身的业务和调试日志。</li>
<li><code>audit</code>: 审计日志，记录用户敏感操作。</li>
<li><code>access</code>: Nginx/Gateway 的访问日志。</li>
<li><code>event</code>: 业务事件，如 <code>order_created</code>。</li>
<li><em>示例:</em> <code>logs.payment.checkout-svc.application</code></li>
</ul>
</li>
</ul>
<p><strong>Topic 申请流程:</strong> 禁止开发者随意创建 Topic。必须通过<strong>自动化平台</strong>或 <strong>GitOps</strong> 流程申请。申请时需要提供 Topic 命名、分区数、副本因子、预估流量、数据保留策略和负责人信息。</p>
<p><strong>分区策略 (Partitioning Strategy):</strong></p>
<ul>
<li><strong>目标:</strong> 确保数据均匀分布，避免热点；同时保证需要顺序处理的消息进入同一分区。</li>
<li><strong>实践:</strong> 对于普通应用日志，使用默认的轮询策略即可。对于需要<strong>保证顺序性</strong>的日志（如同一用户的操作日志），必须在 SDK 或 Agent 层面<strong>指定分区键 (Partition Key)</strong>，例如使用 <code>user_id</code>。这样，该用户的所有日志都会被发送到同一个分区，消费者可以按序处理。</li>
</ul>
<p><strong>访问控制 (ACLs):</strong> 为每个 Topic 设置严格的 ACL。支付服务的生产者<strong>绝不应该</strong>有权限向用户中心的 Topic 写入数据。这通过 Kafka 的 ACL 机制实现，与公司的认证系统集成。</p>
<p><strong>Schema Registry (模式注册中心)</strong>:</p>
<ul>
<li><strong>这是从“能用”到“可靠”的关键一步</strong>。当日志结构发生变更（如增加字段），如果没有管理，很容易导致下游消费程序崩溃。</li>
<li>Schema Registry (如 Confluent Schema Registry) 强制要求所有写入 Kafka 的日志消息都遵循预先注册的 Schema (通常是 Avro 或 Protobuf)。</li>
<li><strong>好处</strong>：
<ul>
<li><strong>数据质量保证</strong>: 阻止不合规的数据进入 Kafka。</li>
<li><strong>前后向兼容</strong>: 可以管理 Schema 的演进，确保旧的消费者也能处理新版本的数据。</li>
<li><strong>减小消息体积</strong>: 使用 Avro 等二进制格式，比 JSON 体积更小，传输效率更高。</li>
</ul>
</li>
</ul>
<p>流程：</p>
<ul>
<li>
<p><strong>定义 Schema:</strong> 开发者使用 <code>.avsc</code> (Avro) 或 <code>.proto</code> (Protobuf) 文件定义日志的数据结构。这个文件与代码一同存放在 Git 仓库中。</p>
<p><strong>注册 Schema:</strong> 在 CI/CD 流程中，会有一个步骤是<strong>自动将新的或更新后的 Schema 注册到 Schema Registry</strong>。此时，Schema Registry 会根据预设的<strong>兼容性策略</strong>进行检查。</p>
<p><strong>生产者序列化:</strong> 应用的 Kafka 生产者在发送消息时：</p>
<ul>
<li>将待发送的日志对象（一个 Java/Go 对象）和 Schema 信息交给 Avro/Protobuf 序列化器。</li>
<li>序列化器会去 Schema Registry 查询（并缓存）该 Schema 对应的唯一 ID。</li>
<li>最终发送到 Kafka 的消息是一个<strong>二进制字节流</strong>，其头部包含了这个 Schema ID。</li>
</ul>
<p><strong>消费者反序列化:</strong> 消费者收到二进制消息后：</p>
<ul>
<li>从消息头部解析出 Schema ID。</li>
<li>使用这个 ID 去 Schema Registry 查询（并缓存）对应的写入方 Schema (Writer’s Schema)。</li>
<li>结合消费者本地的 Schema (Reader’s Schema) 和写入方 Schema，将二进制数据安全地反序列化为对象。、</li>
</ul>
</li>
</ul>
<p>兼容性策略：</p>
<p><strong><code>BACKWARD</code> (向后兼容 - 默认且最推荐):</strong></p>
<ul>
<li><strong>含义:</strong> 使用新版 Schema 的消费者<strong>可以</strong>处理旧版 Schema 产生的数据。</li>
<li><strong>规则:</strong> 你可以<strong>删除</strong>字段，或者<strong>添加</strong>带有默认值的可选字段。你<strong>不能添加</strong>没有默认值的必填字段。</li>
<li><strong>升级路径:</strong> <strong>先升级所有消费者，再升级生产者</strong>。这是最安全的模式。</li>
</ul>
<p><strong><code>FORWARD</code> (向前兼容):</strong></p>
<ul>
<li><strong>含义:</strong> 使用旧版 Schema 的消费者<strong>可以</strong>处理新版 Schema 产生的数据。</li>
<li><strong>规则:</strong> 你可以<strong>添加</strong>新字段，或者<strong>删除</strong>可选字段。你<strong>不能删除</strong>必填字段。</li>
<li><strong>升级路径:</strong> 先升级生产者，再升级消费者。</li>
</ul>
<p><strong><code>FULL</code> (完全兼容):</strong></p>
<ul>
<li><strong>含义:</strong> 同时满足向前和向后兼容。</li>
<li><strong>规则:</strong> 只能<strong>添加或删除</strong>带有默认值的可选字段。非常严格。</li>
</ul>
<p><strong>多集群与异地容灾</strong>:</p>
<ul>
<li>为了保证日志系统的高可用性，Kafka 集群通常是跨可用区（AZ）部署的。</li>
<li>对于核心业务，甚至会使用 <strong>MirrorMaker</strong> 等工具，将日志数据流准实时地复制到另一个数据中心的 Kafka 集群，实现异地容灾。</li>
</ul>
<p><strong>容灾等级与实践:</strong></p>
<ul>
<li><strong>L1: 集群内高可用 (Intra-Region HA - 基础):</strong>
<ul>
<li><strong>架构:</strong> 单个 Kafka 集群，其 Broker 节点分布在同一区域（如东京）的<strong>3个不同可用区 (AZ)</strong>。</li>
<li><strong>配置:</strong> <code>replication.factor</code> (副本因子) 至少为 <code>3</code>。</li>
<li><strong>保障:</strong> 能抵御单个节点或单个可用区的故障，数据不丢失，服务不中断（会有短暂的 Leader 切换）。这是<strong>所有生产环境的最低标准</strong>。</li>
</ul>
</li>
<li><strong>L2: 异地容灾 (Inter-Region DR - 推荐):</strong>
<ul>
<li><strong>架构模式:</strong> <strong>主-备模式 (Active-Passive)</strong>。
<ul>
<li><strong>主集群:</strong> 位于主数据中心（如东京），承载所有实时的生产流量。</li>
<li><strong>备集群:</strong> 位于异地容灾中心（如大阪），平时不直接服务业务。</li>
</ul>
</li>
<li><strong>同步工具:</strong> 使用 <strong>Confluent Replicator</strong> 或 <strong>Kafka MirrorMaker2</strong>。这些工具本质上是特殊的 Kafka 消费者和生产者，从主集群消费数据，然后生产到备集群对应的 Topic 中。</li>
<li><strong>故障切换 (Failover):</strong>
<ol>
<li><strong>监控与决策:</strong> 监控系统检测到主集群不可用，由运维团队或自动化脚本决策启动切换。</li>
<li><strong>执行切换:</strong>
<ul>
<li>停止主集群向备集群的同步任务。</li>
<li>将所有生产者和消费者的配置（通常通过配置中心或DNS）指向备集群。</li>
<li>备集群“晋升”为主集群，开始服务。</li>
</ul>
</li>
</ol>
</li>
<li><strong>关键指标:</strong>
<ul>
<li><strong>RPO (恢复点目标):</strong> 可能丢失多少数据。取决于同步延迟，通常在<strong>秒级到分钟级</strong>。</li>
<li><strong>RTO (恢复时间目标):</strong> 完成切换需要多长时间。取决于自动化程度，通常在<strong>分钟级到小时级</strong>。</li>
</ul>
</li>
</ul>
</li>
<li><strong>L3: 多活架构 (Active-Active - 复杂):</strong>
<ul>
<li><strong>架构模式:</strong> 两个或多个集群（如东京和大阪）<strong>同时对外提供服务</strong>。</li>
<li><strong>挑战:</strong> 需要<strong>双向复制</strong>，并解决<strong>循环复制</strong>和<strong>数据冲突</strong>的问题。这对应用架构有侵入性要求，例如，消息体中必须包含时间戳或来源信息来解决冲突。</li>
<li><strong>适用场景:</strong> 对日志系统来说，Active-Active 模式过于复杂，投入产出比不高。它更适用于需要为全球用户提供最低延迟服务的核心交易系统。对于日志，<strong>主-备模式是成本和可靠性之间最佳的平衡点</strong>。</li>
</ul>
</li>
</ul>
<h2 id="数据处理">数据处理</h2>
<p>流式处理：</p>
<p>使用 <strong>Apache Flink</strong> 或 <strong>Spark Streaming</strong> 作为核心处理引擎。</p>
<p><strong>核心任务</strong>:</p>
<ul>
<li><strong>实时告警</strong>: 基于规则或机器学习模型，对错误日志、性能异常（如RT &gt; 2s）、安全事件（如SQL注入尝试）进行实时检测和告警（通过钉钉、PagerDuty 等）。</li>
<li><strong>实时指标计算 (Logs-to-Metrics)</strong>: 从日志中提取关键指标，如 API 调用次数、错误率、QPS 等，并将其推送到监控系统（如 Prometheus），用于实时监控大盘。</li>
<li><strong>数据丰富 (Enrichment)</strong>: <strong>这是非常有价值的一步</strong>。流处理任务可以关联外部数据源（如 Redis, HBase, API服务）来丰富日志内容。例如，将 <code>user_id</code> 关联出用户的真实姓名、所属部门等信息，为后续分析提供更多维度。</li>
</ul>
<h2 id="数据存储">数据存储</h2>
<p><strong>热数据层 (Hot Tier - 秒级查询)</strong>:</p>
<ul>
<li><strong>目标</strong>: 满足研发人员近期的（如7天内）日志快速检索、排查问题的需求。</li>
<li><strong>技术栈</strong>: <strong>Elasticsearch</strong> 或 <strong>OpenSearch</strong> 集群。</li>
<li><strong>流程</strong>: 一个专门的消费组从 Kafka 读取数据，经过简单的处理后写入 Elasticsearch。</li>
<li><strong>配套工具</strong>: Kibana 或 Grafana 用于前端的可视化查询和仪表盘展示。</li>
</ul>
<p><strong>温/冷数据层 (Warm/Cold Tier - 成本优化)</strong>:</p>
<ul>
<li><strong>目标</strong>: 长期（数月甚至数年）存储所有日志，满足审计、合规要求和离线大数据分析的需求，同时成本要低。</li>
<li><strong>技术栈</strong>: 成本极低的对象存储，如 <strong>AWS S3</strong>, <strong>Google GCS</strong>, 或自建的 <strong>HDFS</strong>。</li>
<li><strong>流程</strong>:
<ul>
<li>另一个消费组（如 Kafka Connect, Logstash）从 Kafka 拉取全量日志。</li>
<li>转换为列式存储格式（如 <strong>Parquet</strong>, <strong>ORC</strong>），这种格式极大地优化了分析查询的性能和存储成本。</li>
<li>按天或按小时分区，存入数据湖/数据仓库。</li>
</ul>
</li>
<li><strong>查询引擎</strong>: 使用 <strong>Presto/Trino</strong>, <strong>Spark SQL</strong>, <strong>ClickHouse</strong> 等引擎对数据湖中的日志进行即席查询（Ad-hoc Query）。</li>
</ul>
<p><strong>索引生命周期管理 (ILM - Index Lifecycle Management)</strong>:</p>
<ul>
<li>在 Elasticsearch 中设置策略，例如：数据在高性能节点上保存7天（Hot），然后自动迁移到低成本节点（Warm）保存30天，超过30天的数据可以删除或快照到冷存储中。这实现了成本和性能的最佳平衡。</li>
</ul>
<h2 id="日志应用">日志应用</h2>
<p><strong>统一查询入口</strong>: 提供一个平台，可以同时查询热数据（Elasticsearch）和冷数据（数据湖），用户无需关心底层存储差异。</p>
<p><strong>可观测性平台 (Observability Platform)</strong>: <strong>将日志 (Logging)、链路 (Tracing)、指标 (Metrics) 三者打通</strong>。在日志查询界面，点击一个 <code>trace_id</code>，能直接跳转到 Jaeger 或 SkyWalking 中对应的分布式调用链，看到完整的请求耗时和服务依赖关系。</p>
<p><strong>AIOps (智能运维)</strong>: 基于海量历史日志数据，训练异常检测模型。平台能够自动发现与历史模式不符的异常日志，进行智能告警，甚至预测潜在的故障。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">mengnankkzhou</div><div class="post-copyright__author_desc">不要走捏</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.tokenlen.top/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.tokenlen.top/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/')">日志系统设计</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.tokenlen.top/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=日志系统设计&amp;url=https://blog.tokenlen.top/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/&amp;pic=https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712179.jpg?_r_=66eda24b-5555-d375-8fb5-ddb70badb349" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.tokenlen.top" target="_blank">mengnankkのblog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E6%8A%80%E6%9C%AF%E6%A0%88/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>技术栈<span class="categoryesPageCount">31</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/java/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>java<span class="tagsPageCount">61</span></a><a class="post-meta__box__tags" href="/tags/log/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>log<span class="tagsPageCount">1</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712179.jpg?_r_=66eda24b-5555-d375-8fb5-ddb70badb349" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/new-stack/k8s1/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202408081510494.jpg?_r_=583d114a-88aa-be90-8598-c951d2856168" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">K8S</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/07/19/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/leetcode/leetcodetotal2/" title="Leetcode HOT面试总结"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722379.jpg?_r_=1a92002b-156e-32b5-ae62-c2808e497810" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-19</div><div class="title">Leetcode HOT面试总结</div></div></a></div><div><a href="/2025/07/06/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/leetcode/leetcodehot2/" title="Leetcode HOT面试题目2"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837448.jpg?_r_=a193bc20-9950-9c86-4e25-165393701db9" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-06</div><div class="title">Leetcode HOT面试题目2</div></div></a></div><div><a href="/2025/09/11/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/springai/" title="AI技术源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=4b7543c8-82eb-c73e-e489-4adfeccbdaa1" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-11</div><div class="title">AI技术源码分析</div></div></a></div><div><a href="/2025/09/10/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/dubbo-alay/" title="Dubbo源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712177.jpg?_r_=37473c5a-843c-bca3-919e-29b432b53db5" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-10</div><div class="title">Dubbo源码分析</div></div></a></div><div><a href="/2025/09/08/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/spring-alay/" title="Spring源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712181.jpg?_r_=c8ff50e7-f761-77de-43f0-80b532eb932a" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-09-08</div><div class="title">Spring源码分析</div></div></a></div><div><a href="/2025/08/15/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/java-stack/juc3/" title="JUC-源码分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837602.jpg?_r_=21db0a9e-f058-ac9b-ea7c-923bbddb8fff" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-15</div><div class="title">JUC-源码分析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Valine</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407230955363.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">清风拂柳影，碧水映花香。</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">mengnankkzhou</h1><div class="author-info__desc">不要走捏</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/mengnankkkk" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/440831872" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410021212939.jpg) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">高并发日志系统设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.1.</span> <span class="toc-text">结构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93"><span class="toc-number">1.2.</span> <span class="toc-text">数据传输</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">数据处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">1.4.</span> <span class="toc-text">数据存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%BA%94%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">日志应用</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/" title="日志系统设计"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/20250126175712179.jpg?_r_=66eda24b-5555-d375-8fb5-ddb70badb349" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="日志系统设计"/></a><div class="content"><a class="title" href="/2025/10/09/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/konw/log/" title="日志系统设计">日志系统设计</a><time datetime="2025-10-08T16:00:00.000Z" title="发表于 2025-10-09 00:00:00">2025-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/new-stack/k8s1/" title="K8S"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202408081510494.jpg?_r_=583d114a-88aa-be90-8598-c951d2856168" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S"/></a><div class="content"><a class="title" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/new-stack/k8s1/" title="K8S">K8S</a><time datetime="2025-09-24T16:00:00.000Z" title="发表于 2025-09-25 00:00:00">2025-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/k8s/" title="k8s八股分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221811725.jpeg?_r_=d1375943-681f-fc68-adc6-cae65f70b708" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s八股分析"/></a><div class="content"><a class="title" href="/2025/09/25/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/k8s/" title="k8s八股分析">k8s八股分析</a><time datetime="2025-09-24T16:00:00.000Z" title="发表于 2025-09-25 00:00:00">2025-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/cap/" title="分布式八股分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202407221837447.jpg?_r_=388a2148-b95c-744b-57b3-25aa79d4e194" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式八股分析"/></a><div class="content"><a class="title" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/cap/" title="分布式八股分析">分布式八股分析</a><time datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/aicode/" title="aicode八股分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://skymirror-1322372781.cos.ap-beijing.myqcloud.com/202410051722380.jpg?_r_=6131513e-5917-371f-05ad-63bc31e37440" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="aicode八股分析"/></a><div class="content"><a class="title" href="/2025/09/24/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/pro/aicode/" title="aicode八股分析">aicode八股分析</a><time datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Framework-Hexo-4e88f8?style=flat&logo=hexo" 
       title="博客框架为 Hexo" alt="Hexo">
</a>
<a style="margin-inline:5px" target="_blank" href="https://github.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Source-Github-24292f?style=flat&logo=github" 
       title="本站项目由 GitHub 托管" alt="GitHub">
</a>
<a style="margin-inline:5px" target="_blank" href="https://vercel.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-Vercel-000000?style=flat&logo=vercel" 
       title="使用 Vercel 部署" alt="Vercel">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.qlu.edu.cn/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/University-齐鲁工业大学-0056a2?style=flat&logo=university" 
       title="齐鲁工业大学" alt="齐鲁工业大学">
</a>
<a style="margin-inline:5px" target="_blank" href="https://www.aliyun.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-阿里云-ff6a00?style=flat&logo=aliyun" 
       title="使用阿里云服务" alt="阿里云">
</a>
<a style="margin-inline:5px" target="_blank" href="https://cloud.tencent.com/">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Cloud-腾讯云-0a73b8?style=flat&logo=tencent-cloud" 
       title="使用腾讯云服务" alt="腾讯云">
</a></p>
</div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2025 By <a class="footer-bar-link" href="/" title="mengnankkzhou" target="_blank">mengnankkzhou</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="鲁ICP备2024110758号">鲁ICP备2024110758号</a><a class="footer-bar-link" href="https://blog.tokenlen.top/rss2.xml" title="Rss">Rss</a><a class="footer-bar-link cc" href="/pravite" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">192</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">56</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">26</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.tokenlen.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="图床"/><span class="back-menu-item-text">图床</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://img.mengnankk.top:9001/" title="mengnankk图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/13/64d8c2653332e.ico" alt="mengnankk图床"/><span class="back-menu-item-text">mengnankk图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 生活</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/Message/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 其他</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> home</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://status.mengnankk.asia/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 站点检测</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://home.tokenlen.top/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 心里话</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BF/" style="font-size: 0.88rem;">BF<sup>1</sup></a><a href="/tags/BigData/" style="font-size: 0.88rem;">BigData<sup>1</sup></a><a href="/tags/C/" style="font-size: 0.88rem;">C<sup>4</sup></a><a href="/tags/CE/" style="font-size: 0.88rem;">CE<sup>1</sup></a><a href="/tags/CSRF/" style="font-size: 0.88rem;">CSRF<sup>1</sup></a><a href="/tags/English/" style="font-size: 0.88rem;">English<sup>9</sup></a><a href="/tags/FI/" style="font-size: 0.88rem;">FI<sup>1</sup></a><a href="/tags/Go/" style="font-size: 0.88rem;">Go<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 0.88rem;">Hadoop<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>12</sup></a><a href="/tags/XSS/" style="font-size: 0.88rem;">XSS<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>2</sup></a><a href="/tags/football/" style="font-size: 0.88rem;">football<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>1</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>61</sup></a><a href="/tags/juc/" style="font-size: 0.88rem;">juc<sup>2</sup></a><a href="/tags/jvm/" style="font-size: 0.88rem;">jvm<sup>2</sup></a><a href="/tags/leetcode/" style="font-size: 0.88rem;">leetcode<sup>10</sup></a><a href="/tags/markdown/" style="font-size: 0.88rem;">markdown<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>17</sup></a><a href="/tags/net/" style="font-size: 0.88rem;">net<sup>7</sup></a><a href="/tags/paper/" style="font-size: 0.88rem;">paper<sup>1</sup></a><a href="/tags/php/" style="font-size: 0.88rem;">php<sup>5</sup></a><a href="/tags/pip/" style="font-size: 0.88rem;">pip<sup>1</sup></a><a href="/tags/python/" style="font-size: 0.88rem;">python<sup>3</sup></a><a href="/tags/redis/" style="font-size: 0.88rem;">redis<sup>4</sup></a><a href="/tags/shell/" style="font-size: 0.88rem;">shell<sup>4</sup></a><a href="/tags/spring/" style="font-size: 0.88rem;">spring<sup>4</sup></a><a href="/tags/spring-boot/" style="font-size: 0.88rem;">spring boot<sup>14</sup></a><a href="/tags/sql/" style="font-size: 0.88rem;">sql<sup>5</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>3</sup></a><a href="/tags/%E5%8E%8B%E6%B5%8B/" style="font-size: 0.88rem;">压测<sup>1</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91/" style="font-size: 0.88rem;">数字逻辑<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/" style="font-size: 0.88rem;">数据库原理<sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>20</sup></a><a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 0.88rem;">正则表达式<sup>2</sup></a><a href="/tags/%E6%AF%9B%E9%80%89/" style="font-size: 0.88rem;">毛选<sup>1</sup></a><a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">汇编语言<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>9</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 0.88rem;">面试<sup>46</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 mengnankkzhou 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.cbd.int/mathjax@3.2.2/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://comment.tokenlen.top/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, "siu~~~~~"))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://comment.tokenlen.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '3ZpuzQHHKWfFH59QFYmcuCvr-gzGzoHsz',
      appKey: '8DIvljObQp853ueQMZzpb9Gx',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Twikoo' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://comment.tokenlen.top/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>